<!DOCTYPE html>
<html>
<head>
    <title>Fleet-CTA Map Diagnostics</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
        }
        .status.pass { background: #86efac; color: #166534; }
        .status.fail { background: #fca5a5; color: #991b1b; }
        .status.pending { background: #fef08a; color: #854d0e; }
        #map {
            height: 400px;
            width: 100%;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-top: 10px;
        }
        code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }
        .log {
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-entry {
            margin: 4px 0;
        }
        .log-error { color: #fca5a5; }
        .log-success { color: #86efac; }
        .log-info { color: #93c5fd; }
    </style>
</head>
<body>
    <h1>Fleet-CTA Map Diagnostics</h1>
    <p>This page tests Google Maps API configuration and common issues.</p>

    <div class="test-section">
        <h2>1. Environment Configuration</h2>
        <p><strong>API Key Status:</strong> <span id="api-key-status" class="status pending">Checking...</span></p>
        <p><strong>API Key (first 10 chars):</strong> <code id="api-key-preview">Loading...</code></p>
        <p><strong>Current URL:</strong> <code id="current-url">Loading...</code></p>
    </div>

    <div class="test-section">
        <h2>2. Google Maps API Loading Test</h2>
        <p><strong>Status:</strong> <span id="maps-load-status" class="status pending">Loading...</span></p>
        <p><strong>Google Maps Available:</strong> <span id="maps-available">Checking...</span></p>
        <div id="map-load-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>3. Map Rendering Test</h2>
        <p><strong>Render Status:</strong> <span id="map-render-status" class="status pending">Pending...</span></p>
        <div id="map"></div>
        <div id="map-render-log" class="log" style="margin-top: 15px;"></div>
    </div>

    <div class="test-section">
        <h2>4. Console Errors</h2>
        <div id="console-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>5. Recommendations</h2>
        <div id="recommendations"></div>
    </div>

    <script>
        // Logging utilities
        const logToDiv = (divId, message, type = 'info') => {
            const div = document.getElementById(divId);
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            div.appendChild(entry);
            div.scrollTop = div.scrollHeight;
        };

        const consoleLog = document.getElementById('console-log');

        // Capture console errors
        const originalError = console.error;
        console.error = function(...args) {
            logToDiv('console-log', args.join(' '), 'error');
            originalError.apply(console, args);
        };

        const originalWarn = console.warn;
        console.warn = function(...args) {
            logToDiv('console-log', args.join(' '), 'info');
            originalWarn.apply(console, args);
        };

        // Test 1: Check API Key
        const API_KEY = 'AIzaSyCYed_P5MboiprRaPRzSSkYZpMUBG3g61M';

        document.getElementById('api-key-preview').textContent = API_KEY.substring(0, 10) + '...';
        document.getElementById('current-url').textContent = window.location.href;

        if (API_KEY && API_KEY.length > 20) {
            document.getElementById('api-key-status').textContent = 'Found';
            document.getElementById('api-key-status').className = 'status pass';
            logToDiv('map-load-log', 'API Key found in configuration', 'success');
        } else {
            document.getElementById('api-key-status').textContent = 'Missing';
            document.getElementById('api-key-status').className = 'status fail';
            logToDiv('map-load-log', 'API Key is missing or invalid', 'error');
        }

        // Test 2: Load Google Maps API
        logToDiv('map-load-log', 'Loading Google Maps JavaScript API...', 'info');

        window.initMap = function() {
            logToDiv('map-load-log', 'Google Maps API loaded successfully!', 'success');
            document.getElementById('maps-load-status').textContent = 'Loaded';
            document.getElementById('maps-load-status').className = 'status pass';
            document.getElementById('maps-available').textContent = 'Yes';

            // Test 3: Try to render map
            try {
                logToDiv('map-render-log', 'Attempting to create map instance...', 'info');

                const mapDiv = document.getElementById('map');
                const map = new google.maps.Map(mapDiv, {
                    center: { lat: 30.4383, lng: -84.2807 }, // Tallahassee
                    zoom: 12,
                    mapTypeControl: true,
                    streetViewControl: true,
                    fullscreenControl: true,
                });

                logToDiv('map-render-log', 'Map instance created successfully!', 'success');

                // Add a marker
                new google.maps.Marker({
                    position: { lat: 30.4383, lng: -84.2807 },
                    map: map,
                    title: 'Test Vehicle - Downtown Tallahassee',
                    label: 'V1'
                });

                logToDiv('map-render-log', 'Test marker added to map', 'success');

                document.getElementById('map-render-status').textContent = 'Success';
                document.getElementById('map-render-status').className = 'status pass';

                // Display success recommendations
                document.getElementById('recommendations').innerHTML = `
                    <div style="color: #166534; background: #dcfce7; padding: 15px; border-radius: 6px;">
                        <h3 style="margin-top: 0;">‚úÖ Google Maps is Working!</h3>
                        <p><strong>The map rendered successfully in this test.</strong></p>
                        <p>If the map isn't working in the Fleet-CTA application, check:</p>
                        <ul>
                            <li>Browser console errors in the main application (F12)</li>
                            <li>CSS issues (map container must have explicit height)</li>
                            <li>Component mounting/lifecycle issues</li>
                            <li>React Error Boundaries catching map errors</li>
                            <li>API key restrictions (check Google Cloud Console)</li>
                        </ul>
                    </div>
                `;

            } catch (error) {
                logToDiv('map-render-log', `Map rendering failed: ${error.message}`, 'error');
                document.getElementById('map-render-status').textContent = 'Failed';
                document.getElementById('map-render-status').className = 'status fail';

                document.getElementById('recommendations').innerHTML = `
                    <div style="color: #991b1b; background: #fee2e2; padding: 15px; border-radius: 6px;">
                        <h3 style="margin-top: 0;">‚ùå Map Rendering Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Possible causes:</p>
                        <ul>
                            <li>API key restrictions in Google Cloud Console</li>
                            <li>Billing not enabled for the project</li>
                            <li>Maps JavaScript API not enabled</li>
                            <li>Referrer restrictions blocking this domain</li>
                        </ul>
                    </div>
                `;
            }
        };

        window.gm_authFailure = function() {
            logToDiv('map-load-log', 'Google Maps Authentication Failure!', 'error');
            document.getElementById('maps-load-status').textContent = 'Auth Failed';
            document.getElementById('maps-load-status').className = 'status fail';
            document.getElementById('maps-available').textContent = 'Authentication Error';

            document.getElementById('recommendations').innerHTML = `
                <div style="color: #991b1b; background: #fee2e2; padding: 15px; border-radius: 6px;">
                    <h3 style="margin-top: 0;">üîí Authentication Failure</h3>
                    <p><strong>The Google Maps API key is invalid or restricted.</strong></p>
                    <p>To fix this:</p>
                    <ol>
                        <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console - Credentials</a></li>
                        <li>Check API key restrictions:
                            <ul>
                                <li><strong>API restrictions:</strong> Ensure "Maps JavaScript API" is allowed</li>
                                <li><strong>Application restrictions:</strong> Add your domain or use "None" for testing</li>
                            </ul>
                        </li>
                        <li>Verify billing is enabled for the project</li>
                        <li>Check if the API key is still valid (not expired or revoked)</li>
                    </ol>
                </div>
            `;
        };

        // Load the API
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap&libraries=places,geometry`;
        script.async = true;
        script.defer = true;

        script.onerror = function() {
            logToDiv('map-load-log', 'Failed to load Google Maps script', 'error');
            document.getElementById('maps-load-status').textContent = 'Load Failed';
            document.getElementById('maps-load-status').className = 'status fail';
            document.getElementById('maps-available').textContent = 'Script Load Error';
        };

        document.head.appendChild(script);
        logToDiv('map-load-log', 'Google Maps script tag added to page', 'info');
    </script>
</body>
</html>
