version: '3.8'

services:
  # Transcription worker - processes audio files
  transcription-worker:
    build:
      context: .
      target: ${BUILD_TARGET:-production}
    image: radio-fleet-transcription-worker:latest
    container_name: transcription-worker
    command: >
      celery -A app.celery_app worker
      --queues=transcription
      --loglevel=${LOG_LEVEL:-info}
      --concurrency=2
      --hostname=transcription@%h
    environment:
      - MODE=${MODE:-development}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      - AZURE_STORAGE_CONNECTION_STRING=${AZURE_STORAGE_CONNECTION_STRING}
      - AZURE_STORAGE_CONTAINER=${AZURE_STORAGE_CONTAINER:-radio-transmissions}
      - AZURE_SPEECH_KEY=${AZURE_SPEECH_KEY}
      - AZURE_SPEECH_REGION=${AZURE_SPEECH_REGION:-eastus}
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - radio-fleet-network
    volumes:
      - ./app:/app/app:ro
    healthcheck:
      test: ["CMD", "celery", "-A", "app.celery_app", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # NLP worker - processes transcripts
  nlp-worker:
    build:
      context: .
      target: ${BUILD_TARGET:-production}
    image: radio-fleet-nlp-worker:latest
    container_name: nlp-worker
    command: >
      celery -A app.celery_app worker
      --queues=nlp
      --loglevel=${LOG_LEVEL:-info}
      --concurrency=4
      --hostname=nlp@%h
    environment:
      - MODE=${MODE:-development}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      - ENABLE_ADVANCED_NLP=${ENABLE_ADVANCED_NLP:-false}
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - radio-fleet-network
    volumes:
      - ./app:/app/app:ro
    healthcheck:
      test: ["CMD", "celery", "-A", "app.celery_app", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Policy worker - evaluates policies and triggers actions
  policy-worker:
    build:
      context: .
      target: ${BUILD_TARGET:-production}
    image: radio-fleet-policy-worker:latest
    container_name: policy-worker
    command: >
      celery -A app.celery_app worker
      --queues=policy
      --loglevel=${LOG_LEVEL:-info}
      --concurrency=3
      --hostname=policy@%h
    environment:
      - MODE=${MODE:-development}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      - DEFAULT_OP_MODE=${DEFAULT_OP_MODE:-hitl}
      - POLICY_EVALUATION_TIMEOUT=${POLICY_EVALUATION_TIMEOUT:-30}
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - radio-fleet-network
    volumes:
      - ./app:/app/app:ro
    healthcheck:
      test: ["CMD", "celery", "-A", "app.celery_app", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Celery Beat scheduler for periodic tasks
  celery-beat:
    build:
      context: .
      target: ${BUILD_TARGET:-production}
    image: radio-fleet-celery-beat:latest
    container_name: celery-beat
    command: >
      celery -A app.celery_app beat
      --loglevel=${LOG_LEVEL:-info}
      --pidfile=/tmp/celerybeat.pid
    environment:
      - MODE=${MODE:-development}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - radio-fleet-network
    volumes:
      - ./app:/app/app:ro

  # Flower - Celery monitoring UI (optional, for development)
  flower:
    build:
      context: .
      target: ${BUILD_TARGET:-production}
    image: radio-fleet-flower:latest
    container_name: celery-flower
    command: >
      celery -A app.celery_app flower
      --port=5555
      --broker=${REDIS_URL:-redis://redis:6379/0}
    environment:
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
    depends_on:
      - redis
    ports:
      - "5555:5555"
    restart: unless-stopped
    networks:
      - radio-fleet-network
    profiles:
      - monitoring

  # Redis - Message broker and result backend
  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - radio-fleet-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  radio-fleet-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
