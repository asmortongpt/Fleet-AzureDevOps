#!/bin/bash
################################################################################
# SSO Configuration Verification Script
# Generated by Kimi 100-Agent SSO Diagnosis
################################################################################

echo "================================================================================"
echo "üîê Fleet-CTA SSO Configuration Verification"
echo "================================================================================"
echo ""

# Color codes
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Counters
PASSED=0
FAILED=0
WARNINGS=0

# Function to check and report
check_config() {
  local test_name="$1"
  local command="$2"
  local expected="$3"

  echo -n "Checking $test_name... "
  result=$(eval "$command")

  if [[ "$result" == "$expected" ]] || [[ -n "$result" && "$expected" == "NOT_EMPTY" ]]; then
    echo -e "${GREEN}‚úì PASS${NC}"
    ((PASSED++))
    return 0
  else
    echo -e "${RED}‚úó FAIL${NC}"
    echo "  Expected: $expected"
    echo "  Got: $result"
    ((FAILED++))
    return 1
  fi
}

check_warning() {
  local test_name="$1"
  local condition="$2"
  local message="$3"

  if eval "$condition"; then
    echo -e "${YELLOW}‚ö† WARNING${NC}: $test_name"
    echo "  $message"
    ((WARNINGS++))
  fi
}

echo "üìã PHASE 1: Environment Variables"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# Check .env file exists
if [ ! -f .env ]; then
  echo -e "${RED}‚úó FAIL${NC}: .env file not found"
  echo "  Please create .env from .env.example"
  exit 1
else
  echo -e "${GREEN}‚úì PASS${NC}: .env file exists"
  ((PASSED++))
fi

# Load .env
export $(cat .env | grep -v '^#' | xargs)

# Check Azure AD Client ID
check_config "VITE_AZURE_AD_CLIENT_ID" "echo '$VITE_AZURE_AD_CLIENT_ID'" "NOT_EMPTY"

# Check Azure AD Tenant ID
check_config "VITE_AZURE_AD_TENANT_ID" "echo '$VITE_AZURE_AD_TENANT_ID'" "NOT_EMPTY"

# Check if redirect URI is commented (should auto-detect)
if grep -q "^# VITE_AZURE_AD_REDIRECT_URI" .env || ! grep -q "^VITE_AZURE_AD_REDIRECT_URI" .env; then
  echo -e "${GREEN}‚úì PASS${NC}: VITE_AZURE_AD_REDIRECT_URI auto-detects (not hard-coded)"
  ((PASSED++))
else
  echo -e "${YELLOW}‚ö† WARNING${NC}: VITE_AZURE_AD_REDIRECT_URI is hard-coded"
  echo "  Consider commenting it out to auto-detect from window.location.origin"
  ((WARNINGS++))
fi

# Check backend port
BACKEND_PORT=${PORT:-3000}
echo -e "${GREEN}‚úì INFO${NC}: Backend configured for port $BACKEND_PORT"

echo ""
echo "üìã PHASE 2: File Structure"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# Check key files exist
FILES=(
  "src/main.tsx"
  "src/config/auth-config.ts"
  "src/lib/msal-config.ts"
  "src/contexts/AuthContext.tsx"
  "src/pages/Login.tsx"
  "src/pages/AuthCallback.tsx"
  "api/src/routes/auth.ts"
  "api/src/middleware/corsConfig.ts"
  "api/src/server.ts"
)

for file in "${FILES[@]}"; do
  if [ -f "$file" ]; then
    echo -e "${GREEN}‚úì PASS${NC}: $file exists"
    ((PASSED++))
  else
    echo -e "${RED}‚úó FAIL${NC}: $file not found"
    ((FAILED++))
  fi
done

echo ""
echo "üìã PHASE 3: Code Configuration"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# Check if MSAL is initialized in main.tsx
if grep -q "msalInstance.initialize()" src/main.tsx; then
  echo -e "${GREEN}‚úì PASS${NC}: MSAL instance initialization found in src/main.tsx"
  ((PASSED++))
else
  echo -e "${RED}‚úó FAIL${NC}: MSAL instance initialization NOT found in src/main.tsx"
  ((FAILED++))
fi

# Check if MsalProvider wraps the app
if grep -q "MsalProvider" src/main.tsx; then
  echo -e "${GREEN}‚úì PASS${NC}: MsalProvider wrapper found in src/main.tsx"
  ((PASSED++))
else
  echo -e "${RED}‚úó FAIL${NC}: MsalProvider wrapper NOT found in src/main.tsx"
  ((FAILED++))
fi

# Check if AuthCallback route exists
if grep -q "/auth/callback" src/main.tsx || grep -q "/auth/callback" src/App.tsx; then
  echo -e "${GREEN}‚úì PASS${NC}: /auth/callback route configured"
  ((PASSED++))
else
  echo -e "${YELLOW}‚ö† WARNING${NC}: /auth/callback route not found"
  ((WARNINGS++))
fi

# Check if backend token exchange endpoint exists
if grep -q "/microsoft/exchange" api/src/routes/auth.ts; then
  echo -e "${GREEN}‚úì PASS${NC}: Backend /microsoft/exchange endpoint exists"
  ((PASSED++))
else
  echo -e "${RED}‚úó FAIL${NC}: Backend /microsoft/exchange endpoint NOT found"
  ((FAILED++))
fi

# Check CORS configuration allows credentials
if grep -q "credentials: true" api/src/middleware/corsConfig.ts; then
  echo -e "${GREEN}‚úì PASS${NC}: CORS credentials enabled"
  ((PASSED++))
else
  echo -e "${RED}‚úó FAIL${NC}: CORS credentials NOT enabled"
  ((FAILED++))
fi

echo ""
echo "üìã PHASE 4: Package Dependencies"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# Check if MSAL packages are installed
if [ -d "node_modules/@azure/msal-browser" ]; then
  echo -e "${GREEN}‚úì PASS${NC}: @azure/msal-browser installed"
  ((PASSED++))
else
  echo -e "${RED}‚úó FAIL${NC}: @azure/msal-browser NOT installed"
  echo "  Run: npm install @azure/msal-browser"
  ((FAILED++))
fi

if [ -d "node_modules/@azure/msal-react" ]; then
  echo -e "${GREEN}‚úì PASS${NC}: @azure/msal-react installed"
  ((PASSED++))
else
  echo -e "${RED}‚úó FAIL${NC}: @azure/msal-react NOT installed"
  echo "  Run: npm install @azure/msal-react"
  ((FAILED++))
fi

echo ""
echo "üìã PHASE 5: Runtime Checks"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# Check if backend is running
if curl -s http://localhost:$BACKEND_PORT/health > /dev/null 2>&1; then
  echo -e "${GREEN}‚úì PASS${NC}: Backend is running on port $BACKEND_PORT"
  ((PASSED++))
else
  echo -e "${YELLOW}‚ö† WARNING${NC}: Backend NOT running on port $BACKEND_PORT"
  echo "  Start with: cd api-standalone && DB_HOST=localhost npm start"
  ((WARNINGS++))
fi

# Check if frontend dev server is running
if curl -s http://localhost:5173 > /dev/null 2>&1; then
  echo -e "${GREEN}‚úì PASS${NC}: Frontend dev server running on port 5173"
  ((PASSED++))
else
  echo -e "${YELLOW}‚ö† WARNING${NC}: Frontend dev server NOT running"
  echo "  Start with: npm run dev"
  ((WARNINGS++))
fi

echo ""
echo "================================================================================"
echo "üìä VERIFICATION SUMMARY"
echo "================================================================================"
echo -e "${GREEN}Passed:${NC}   $PASSED"
echo -e "${RED}Failed:${NC}   $FAILED"
echo -e "${YELLOW}Warnings:${NC} $WARNINGS"
echo ""

if [ $FAILED -eq 0 ]; then
  echo -e "${GREEN}‚úÖ SSO CONFIGURATION VERIFIED${NC}"
  echo ""
  echo "üìù Next Steps:"
  echo "  1. Ensure both frontend and backend are running"
  echo "  2. Navigate to http://localhost:5173/login"
  echo "  3. Click 'Sign in with Microsoft'"
  echo "  4. Check browser console for any MSAL errors"
  echo "  5. Check backend logs for token exchange"
  echo ""
  echo "üîç Azure AD App Registration Checklist:"
  echo "  ‚òê Redirect URI: http://localhost:5173/auth/callback"
  echo "  ‚òê Platform: Single-page application (SPA)"
  echo "  ‚òê Implicit grant: ID tokens ‚úì, Access tokens ‚úì"
  echo "  ‚òê API permissions: openid, profile, email, User.Read"
  echo ""
  echo "See SSO_DEBUG_GUIDE.md for detailed troubleshooting"
  exit 0
else
  echo -e "${RED}‚ùå SSO CONFIGURATION HAS ISSUES${NC}"
  echo ""
  echo "Please fix the failed checks above and run this script again."
  echo "See SSO_DEBUG_GUIDE.md for detailed fixes"
  exit 1
fi
