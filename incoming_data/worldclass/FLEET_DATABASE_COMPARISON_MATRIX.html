<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Database Schema Comparison Matrix</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .summary {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .summary-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .critical {
            border-left-color: #e74c3c;
        }

        .critical h3 {
            color: #e74c3c;
        }

        .warning {
            border-left-color: #f39c12;
        }

        .warning h3 {
            color: #f39c12;
        }

        .success {
            border-left-color: #27ae60;
        }

        .success h3 {
            color: #27ae60;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            color: #2c3e50;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .missing {
            background: #fee;
            color: #e74c3c;
        }

        .present {
            background: #efe;
            color: #27ae60;
        }

        .different {
            background: #fef3cd;
            color: #f39c12;
        }

        .action-plan {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #f39c12;
            margin-top: 30px;
        }

        .action-plan h3 {
            color: #f39c12;
            margin-bottom: 15px;
        }

        .action-item {
            padding: 10px;
            margin: 10px 0;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }

        .priority-high {
            border-left-color: #e74c3c;
        }

        .priority-medium {
            border-left-color: #f39c12;
        }

        .priority-low {
            border-left-color: #3498db;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .note {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }

        footer {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Fleet Database Schema Comparison Matrix</h1>
            <p class="subtitle">Comprehensive Analysis: schema.sql vs schema-simple.sql</p>
            <p class="subtitle">Generated: January 7, 2026</p>
        </header>

        <div class="summary">
            <h2>Executive Summary</h2>
            <div class="summary-grid">
                <div class="summary-card critical">
                    <h3>Missing Tables</h3>
                    <div class="value">1</div>
                    <p>damage_reports table missing</p>
                </div>
                <div class="summary-card warning">
                    <h3>Missing Columns</h3>
                    <div class="value">3</div>
                    <p>PostGIS geography columns</p>
                </div>
                <div class="summary-card warning">
                    <h3>Missing Indexes</h3>
                    <div class="value">4</div>
                    <p>Geospatial GIST indexes</p>
                </div>
                <div class="summary-card success">
                    <h3>Compatible Tables</h3>
                    <div class="value">30</div>
                    <p>Successfully migrated</p>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Missing Tables Section -->
            <div class="section">
                <h2>1. Missing Tables</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Table Name</th>
                            <th>Status in Simple Schema</th>
                            <th>Purpose</th>
                            <th>Impact</th>
                            <th>Dependencies</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>damage_reports</code></td>
                            <td><span class="status missing">MISSING</span></td>
                            <td>Tracks vehicle damage with 3D model integration (TripoSR)</td>
                            <td><strong>HIGH:</strong> No damage tracking or 3D model generation capability</td>
                            <td>vehicles, drivers, work_orders, inspections</td>
                        </tr>
                    </tbody>
                </table>

                <div class="note">
                    <strong>Note:</strong> The <code>damage_reports</code> table is critical for tracking vehicle damage and integrating with the TripoSR 3D model generation feature. This is a complete feature loss in the simple schema.
                </div>
            </div>

            <!-- Missing Columns Section -->
            <div class="section">
                <h2>2. Missing Columns (PostGIS Geography Type)</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Table</th>
                            <th>Missing Column</th>
                            <th>Column Type</th>
                            <th>Replacement in Simple Schema</th>
                            <th>Functionality Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>vehicles</code></td>
                            <td><code>location</code></td>
                            <td>GEOGRAPHY(POINT, 4326)</td>
                            <td>latitude + longitude (DECIMAL)</td>
                            <td>No native geospatial queries, manual distance calculations required</td>
                        </tr>
                        <tr>
                            <td><code>facilities</code></td>
                            <td><code>location</code></td>
                            <td>GEOGRAPHY(POINT, 4326)</td>
                            <td>latitude + longitude (DECIMAL)</td>
                            <td>No spatial indexing for facility searches</td>
                        </tr>
                        <tr>
                            <td><code>geofences</code></td>
                            <td><code>geometry</code></td>
                            <td>GEOGRAPHY(POLYGON, 4326)</td>
                            <td>polygon_coordinates (JSONB)</td>
                            <td>Manual point-in-polygon checks, no spatial indexes</td>
                        </tr>
                        <tr>
                            <td><code>charging_stations</code></td>
                            <td><code>location_point</code></td>
                            <td>GEOGRAPHY(POINT, 4326)</td>
                            <td>latitude + longitude (DECIMAL)</td>
                            <td>No efficient "find nearest charging station" queries</td>
                        </tr>
                    </tbody>
                </table>

                <div class="note">
                    <strong>Workaround:</strong> The simple schema uses separate latitude/longitude columns. Distance calculations must be done using the Haversine formula in application code or PostgreSQL functions instead of native PostGIS operators.
                </div>
            </div>

            <!-- Missing Indexes Section -->
            <div class="section">
                <h2>3. Missing Indexes</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Table</th>
                            <th>Missing Index</th>
                            <th>Index Type</th>
                            <th>Purpose</th>
                            <th>Performance Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>vehicles</code></td>
                            <td><code>idx_vehicles_location</code></td>
                            <td>GIST (PostGIS)</td>
                            <td>Spatial queries on vehicle locations</td>
                            <td>Slow "vehicles near point" queries, O(n) table scans</td>
                        </tr>
                        <tr>
                            <td><code>facilities</code></td>
                            <td><code>idx_facilities_location</code></td>
                            <td>GIST (PostGIS)</td>
                            <td>Spatial queries on facility locations</td>
                            <td>Slow "nearest facility" lookups</td>
                        </tr>
                        <tr>
                            <td><code>geofences</code></td>
                            <td><code>idx_geofences_geometry</code></td>
                            <td>GIST (PostGIS)</td>
                            <td>Point-in-polygon geofence checks</td>
                            <td>Inefficient geofence violation detection</td>
                        </tr>
                        <tr>
                            <td><code>damage_reports</code></td>
                            <td>All indexes</td>
                            <td>Multiple B-tree</td>
                            <td>Damage report queries</td>
                            <td>Table does not exist</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Missing Extensions Section -->
            <div class="section">
                <h2>4. Missing PostgreSQL Extensions</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Extension</th>
                            <th>Status in Simple Schema</th>
                            <th>Purpose</th>
                            <th>Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>postgis</code></td>
                            <td><span class="status missing">NOT ENABLED</span></td>
                            <td>Geospatial data types and functions</td>
                            <td>No native geographic queries, spatial indexes, or distance calculations</td>
                        </tr>
                        <tr>
                            <td><code>uuid-ossp</code></td>
                            <td><span class="status present">ENABLED</span></td>
                            <td>UUID generation functions</td>
                            <td>✓ Available in both schemas</td>
                        </tr>
                        <tr>
                            <td><code>pg_trgm</code></td>
                            <td><span class="status present">ENABLED</span></td>
                            <td>Trigram-based text search</td>
                            <td>✓ Available in both schemas</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Detailed Table Comparison -->
            <div class="section">
                <h2>5. Detailed Table-by-Table Comparison</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Table Name</th>
                            <th>Full Schema</th>
                            <th>Simple Schema</th>
                            <th>Differences</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>tenants</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>users</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>audit_logs</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>vehicles</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status different">⚠</span></td>
                            <td>Missing <code>location</code> GEOGRAPHY column, has lat/lng instead</td>
                        </tr>
                        <tr>
                            <td><code>drivers</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>facilities</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status different">⚠</span></td>
                            <td>Missing <code>location</code> GEOGRAPHY column</td>
                        </tr>
                        <tr>
                            <td><code>work_orders</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>maintenance_schedules</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>fuel_transactions</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>routes</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>geofences</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status different">⚠</span></td>
                            <td>Missing <code>geometry</code> GEOGRAPHY column, has <code>polygon_coordinates</code> JSONB instead</td>
                        </tr>
                        <tr>
                            <td><code>geofence_events</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>telemetry_data</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>inspection_forms</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>inspections</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>damage_reports</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status missing">✗</span></td>
                            <td><strong>TABLE MISSING</strong></td>
                        </tr>
                        <tr>
                            <td><code>safety_incidents</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>video_events</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>charging_stations</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status different">⚠</span></td>
                            <td>Missing <code>location_point</code> GEOGRAPHY column</td>
                        </tr>
                        <tr>
                            <td><code>charging_sessions</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>vendors</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>purchase_orders</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>communication_logs</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>policies</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>policy_violations</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                        <tr>
                            <td><code>notifications</code></td>
                            <td><span class="status present">✓</span></td>
                            <td><span class="status present">✓</span></td>
                            <td>Identical</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Action Plan -->
            <div class="action-plan">
                <h3>Recommended Action Plan</h3>

                <div class="action-item priority-high">
                    <strong>PRIORITY 1 - CRITICAL:</strong> Add <code>damage_reports</code> table
                    <p>• Create the damage_reports table with all columns as specified in schema.sql (lines 433-456)</p>
                    <p>• Add all related indexes for performance</p>
                    <p>• Enable TripoSR 3D model generation feature integration</p>
                    <p>• Link to vehicles, drivers, work_orders, and inspections tables</p>
                </div>

                <div class="action-item priority-high">
                    <strong>PRIORITY 2 - HIGH:</strong> Decide on PostGIS Migration Strategy
                    <p><strong>Option A:</strong> Enable PostGIS extension and migrate to GEOGRAPHY columns</p>
                    <p>  • Requires PostGIS installation on PostgreSQL server</p>
                    <p>  • Provides native geospatial queries and indexing</p>
                    <p>  • Better performance for location-based features</p>
                    <br>
                    <p><strong>Option B:</strong> Keep simple schema and implement application-level geospatial logic</p>
                    <p>  • Use Haversine formula for distance calculations</p>
                    <p>  • Implement point-in-polygon checks in application code</p>
                    <p>  • May have performance limitations at scale</p>
                </div>

                <div class="action-item priority-medium">
                    <strong>PRIORITY 3 - MEDIUM:</strong> Add Geospatial Helper Functions
                    <p>If staying with simple schema, create PostgreSQL functions for:</p>
                    <p>• <code>calculate_distance(lat1, lng1, lat2, lng2)</code> - Haversine formula</p>
                    <p>• <code>point_in_polygon(lat, lng, polygon_json)</code> - Geofence checking</p>
                    <p>• <code>find_nearest(lat, lng, table_name)</code> - Nearest facility/charging station</p>
                </div>

                <div class="action-item priority-medium">
                    <strong>PRIORITY 4 - MEDIUM:</strong> Update Application Code
                    <p>• Ensure all vehicle damage reporting features check for damage_reports table</p>
                    <p>• Update geofence logic to handle JSONB polygon_coordinates instead of GEOGRAPHY</p>
                    <p>• Test distance calculations with simple lat/lng columns</p>
                    <p>• Update API endpoints that rely on geospatial queries</p>
                </div>

                <div class="action-item priority-low">
                    <strong>PRIORITY 5 - LOW:</strong> Documentation Updates
                    <p>• Document the differences between full and simple schemas</p>
                    <p>• Create migration guide from simple to full PostGIS schema</p>
                    <p>• Update API documentation to reflect schema changes</p>
                    <p>• Add notes about geospatial query limitations</p>
                </div>
            </div>

            <!-- Missing Table Definition -->
            <div class="section">
                <h2>6. Complete damage_reports Table Definition</h2>
                <pre style="background: #2c3e50; color: #ecf0f1; padding: 20px; border-radius: 8px; overflow-x: auto;">
CREATE TABLE damage_reports (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
    reported_by UUID REFERENCES drivers(id) ON DELETE SET NULL,
    damage_description TEXT NOT NULL,
    damage_severity VARCHAR(20) NOT NULL CHECK (damage_severity IN ('minor', 'moderate', 'severe')),
    damage_location VARCHAR(255),
    photos TEXT[], -- Array of photo URLs
    triposr_task_id VARCHAR(255), -- TripoSR background task ID
    triposr_status VARCHAR(20) DEFAULT 'pending' CHECK (triposr_status IN ('pending', 'processing', 'completed', 'failed')),
    triposr_model_url TEXT, -- URL to generated GLB 3D model
    linked_work_order_id UUID REFERENCES work_orders(id) ON DELETE SET NULL,
    inspection_id UUID REFERENCES inspections(id) ON DELETE SET NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_damage_reports_tenant ON damage_reports(tenant_id);
CREATE INDEX idx_damage_reports_vehicle ON damage_reports(vehicle_id);
CREATE INDEX idx_damage_reports_inspection ON damage_reports(inspection_id);
CREATE INDEX idx_damage_reports_work_order ON damage_reports(linked_work_order_id);
CREATE INDEX idx_damage_reports_triposr_status ON damage_reports(triposr_status);
CREATE INDEX idx_damage_reports_created ON damage_reports(created_at DESC);

CREATE TRIGGER update_damage_reports_updated_at
    BEFORE UPDATE ON damage_reports
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
                </pre>
            </div>

            <!-- Feature Impact Analysis -->
            <div class="section">
                <h2>7. Feature Impact Analysis</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Requires PostGIS</th>
                            <th>Requires damage_reports</th>
                            <th>Status in Simple Schema</th>
                            <th>Workaround Available</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Vehicle Tracking</td>
                            <td>No</td>
                            <td>No</td>
                            <td><span class="status present">✓ Working</span></td>
                            <td>N/A</td>
                        </tr>
                        <tr>
                            <td>Find Nearest Vehicle</td>
                            <td>Recommended</td>
                            <td>No</td>
                            <td><span class="status different">⚠ Degraded</span></td>
                            <td>Yes - Haversine function</td>
                        </tr>
                        <tr>
                            <td>Geofence Alerts</td>
                            <td>Recommended</td>
                            <td>No</td>
                            <td><span class="status different">⚠ Degraded</span></td>
                            <td>Yes - Application logic</td>
                        </tr>
                        <tr>
                            <td>Route Optimization</td>
                            <td>No</td>
                            <td>No</td>
                            <td><span class="status present">✓ Working</span></td>
                            <td>N/A</td>
                        </tr>
                        <tr>
                            <td>Damage Reporting</td>
                            <td>No</td>
                            <td>Yes</td>
                            <td><span class="status missing">✗ Not Available</span></td>
                            <td>No - Table required</td>
                        </tr>
                        <tr>
                            <td>3D Damage Model Generation</td>
                            <td>No</td>
                            <td>Yes</td>
                            <td><span class="status missing">✗ Not Available</span></td>
                            <td>No - Table required</td>
                        </tr>
                        <tr>
                            <td>Maintenance Scheduling</td>
                            <td>No</td>
                            <td>No</td>
                            <td><span class="status present">✓ Working</span></td>
                            <td>N/A</td>
                        </tr>
                        <tr>
                            <td>Fuel Tracking</td>
                            <td>No</td>
                            <td>No</td>
                            <td><span class="status present">✓ Working</span></td>
                            <td>N/A</td>
                        </tr>
                        <tr>
                            <td>Driver Safety Scoring</td>
                            <td>No</td>
                            <td>No</td>
                            <td><span class="status present">✓ Working</span></td>
                            <td>N/A</td>
                        </tr>
                        <tr>
                            <td>Find Nearest Charging Station</td>
                            <td>Recommended</td>
                            <td>No</td>
                            <td><span class="status different">⚠ Degraded</span></td>
                            <td>Yes - Distance calculation</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>&copy; 2026 Fleet Management System - Database Schema Analysis</p>
            <p>Contact: admin@fleetmanagement.com</p>
        </footer>
    </div>
</body>
</html>