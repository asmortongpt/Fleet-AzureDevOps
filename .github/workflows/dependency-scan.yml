name: Dependency Scanning
# Task 1.7 from REMEDIATION_COMPLIANCE_PLAN.md
# Automated dependency vulnerability scanning for FedRAMP/SOC 2 compliance

on:
  push:
    branches: [main, develop, stage-*]
    paths:
      - '**/package.json'
      - '**/package-lock.json'
      - '**/yarn.lock'
      - '**/pnpm-lock.yaml'
  pull_request:
    branches: [main, develop]
    paths:
      - '**/package.json'
      - '**/package-lock.json'
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  # Job 1: npm audit with detailed reporting
  npm-audit-detailed:
    name: npm Audit Detailed
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace:
          - name: root
            path: '.'
          - name: server
            path: './server'
          - name: api
            path: './api'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '${{ matrix.workspace.path }}/package-lock.json'

      - name: Install dependencies
        working-directory: ${{ matrix.workspace.path }}
        run: |
          if [ -f package.json ]; then
            npm ci --ignore-scripts || npm install --ignore-scripts
          fi

      - name: Run npm audit (JSON)
        working-directory: ${{ matrix.workspace.path }}
        continue-on-error: true
        run: |
          if [ -f package.json ]; then
            npm audit --json > npm-audit.json || true

            # Display human-readable summary
            echo "ðŸ“Š Vulnerability Summary for ${{ matrix.workspace.name }}:"
            npm audit || true
          fi

      - name: Parse and report vulnerabilities
        working-directory: ${{ matrix.workspace.path }}
        run: |
          if [ -f npm-audit.json ]; then
            echo "## npm Audit Report: ${{ matrix.workspace.name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit.json)
            HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit.json)
            MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' npm-audit.json)
            LOW=$(jq -r '.metadata.vulnerabilities.low // 0' npm-audit.json)
            TOTAL=$(jq -r '.metadata.vulnerabilities.total // 0' npm-audit.json)

            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
            echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract top 5 critical/high vulnerabilities
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "### Top Vulnerabilities" >> $GITHUB_STEP_SUMMARY
              jq -r '.vulnerabilities | to_entries | .[] | select(.value.severity == "critical" or .value.severity == "high") | "- **\(.value.severity | ascii_upcase)**: \(.key) - \(.value.title)"' npm-audit.json | head -5 >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload npm audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-${{ matrix.workspace.name }}
          path: ${{ matrix.workspace.path }}/npm-audit.json
          retention-days: 30

      - name: Fail on critical vulnerabilities
        working-directory: ${{ matrix.workspace.path }}
        run: |
          if [ -f npm-audit.json ]; then
            CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit.json)

            if [ "$CRITICAL" -gt 0 ]; then
              echo "âŒ Found $CRITICAL critical vulnerabilities in ${{ matrix.workspace.name }}"
              exit 1
            fi
          fi

  # Job 2: Snyk vulnerability scanning
  snyk-scan:
    name: Snyk Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-results.json

      - name: Upload Snyk results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-results
          path: snyk-results.json
          retention-days: 30

  # Job 3: License compliance check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install license-checker
        run: npm install -g license-checker

      - name: Check licenses
        run: |
          echo "## License Compliance Report" > license-report.md
          echo "" >> license-report.md

          # Check root project
          if [ -f package.json ]; then
            echo "### Root Project" >> license-report.md
            license-checker --json > root-licenses.json || true

            # Check for prohibited licenses
            PROHIBITED="GPL-3.0,AGPL-3.0,LGPL-3.0"
            if grep -qE "$PROHIBITED" root-licenses.json; then
              echo "âŒ Found prohibited licenses!" >> license-report.md
              grep -E "$PROHIBITED" root-licenses.json >> license-report.md
            else
              echo "âœ… No prohibited licenses found" >> license-report.md
            fi

            echo "" >> license-report.md
          fi

          # Check server project
          if [ -f server/package.json ]; then
            cd server
            echo "### Server Project" >> ../license-report.md
            license-checker --json > ../server-licenses.json || true
            cd ..

            if grep -qE "$PROHIBITED" server-licenses.json; then
              echo "âŒ Found prohibited licenses!" >> license-report.md
              grep -E "$PROHIBITED" server-licenses.json >> license-report.md
            else
              echo "âœ… No prohibited licenses found" >> license-report.md
            fi
          fi

          cat license-report.md

      - name: Upload license report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: |
            license-report.md
            *-licenses.json
          retention-days: 90

  # Job 4: Outdated dependencies report
  outdated-dependencies:
    name: Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for outdated dependencies
        run: |
          echo "## Outdated Dependencies Report" > outdated-report.md
          echo "" >> outdated-report.md

          # Check root project
          if [ -f package.json ]; then
            echo "### Root Project" >> outdated-report.md
            npm outdated --json > root-outdated.json || true

            OUTDATED_COUNT=$(jq 'length' root-outdated.json)
            echo "Found $OUTDATED_COUNT outdated packages" >> outdated-report.md
            echo "" >> outdated-report.md

            if [ "$OUTDATED_COUNT" -gt 0 ]; then
              echo "| Package | Current | Wanted | Latest |" >> outdated-report.md
              echo "|---------|---------|--------|--------|" >> outdated-report.md
              jq -r 'to_entries | .[] | "| \(.key) | \(.value.current) | \(.value.wanted) | \(.value.latest) |"' root-outdated.json >> outdated-report.md
            fi
            echo "" >> outdated-report.md
          fi

          # Check server project
          if [ -f server/package.json ]; then
            cd server
            echo "### Server Project" >> ../outdated-report.md
            npm outdated --json > ../server-outdated.json || true
            cd ..

            OUTDATED_COUNT=$(jq 'length' server-outdated.json)
            echo "Found $OUTDATED_COUNT outdated packages" >> outdated-report.md
            echo "" >> outdated-report.md

            if [ "$OUTDATED_COUNT" -gt 0 ]; then
              echo "| Package | Current | Wanted | Latest |" >> outdated-report.md
              echo "|---------|---------|--------|--------|" >> outdated-report.md
              jq -r 'to_entries | .[] | "| \(.key) | \(.value.current) | \(.value.wanted) | \(.value.latest) |"' server-outdated.json >> outdated-report.md
            fi
          fi

          cat outdated-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload outdated report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outdated-dependencies
          path: |
            outdated-report.md
            *-outdated.json
          retention-days: 30

  # Job 5: Dependency summary
  dependency-summary:
    name: Dependency Summary
    runs-on: ubuntu-latest
    needs: [npm-audit-detailed, snyk-scan, license-check, outdated-dependencies]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dependency-artifacts

      - name: Generate comprehensive summary
        run: |
          echo "# Dependency Scanning Summary" > summary.md
          echo "" >> summary.md
          echo "**Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> summary.md
          echo "**Commit:** ${{ github.sha }}" >> summary.md
          echo "" >> summary.md
          echo "## Scan Results" >> summary.md
          echo "" >> summary.md
          echo "| Job | Status |" >> summary.md
          echo "|-----|--------|" >> summary.md
          echo "| npm audit | ${{ needs.npm-audit-detailed.result }} |" >> summary.md
          echo "| Snyk scan | ${{ needs.snyk-scan.result }} |" >> summary.md
          echo "| License check | ${{ needs.license-check.result }} |" >> summary.md
          echo "| Outdated check | ${{ needs.outdated-dependencies.result }} |" >> summary.md
          echo "" >> summary.md

          # Aggregate vulnerability counts
          echo "## Vulnerability Summary" >> summary.md
          echo "" >> summary.md

          TOTAL_CRITICAL=0
          TOTAL_HIGH=0
          TOTAL_MODERATE=0
          TOTAL_LOW=0

          for audit_file in dependency-artifacts/npm-audit-*/npm-audit.json; do
            if [ -f "$audit_file" ]; then
              CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' "$audit_file")
              HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' "$audit_file")
              MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' "$audit_file")
              LOW=$(jq -r '.metadata.vulnerabilities.low // 0' "$audit_file")

              TOTAL_CRITICAL=$((TOTAL_CRITICAL + CRITICAL))
              TOTAL_HIGH=$((TOTAL_HIGH + HIGH))
              TOTAL_MODERATE=$((TOTAL_MODERATE + MODERATE))
              TOTAL_LOW=$((TOTAL_LOW + LOW))
            fi
          done

          echo "| Severity | Total Count |" >> summary.md
          echo "|----------|-------------|" >> summary.md
          echo "| Critical | $TOTAL_CRITICAL |" >> summary.md
          echo "| High | $TOTAL_HIGH |" >> summary.md
          echo "| Moderate | $TOTAL_MODERATE |" >> summary.md
          echo "| Low | $TOTAL_LOW |" >> summary.md
          echo "" >> summary.md

          if [ "$TOTAL_CRITICAL" -gt 0 ]; then
            echo "âš ï¸ **ACTION REQUIRED:** Critical vulnerabilities detected!" >> summary.md
          elif [ "$TOTAL_HIGH" -gt 0 ]; then
            echo "âš ï¸ **WARNING:** High severity vulnerabilities detected" >> summary.md
          else
            echo "âœ… No critical or high severity vulnerabilities detected" >> summary.md
          fi

          cat summary.md
          cat summary.md >> $GITHUB_STEP_SUMMARY

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: dependency-summary
          path: summary.md
          retention-days: 90

      - name: Comment PR with summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
