name: Bundle Size Check

on:
  pull_request:
    branches: [main, develop, stage-*]
    paths:
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'tsconfig.json'
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  bundle-size:
    name: Analyze Bundle Size
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build current branch
        run: npm run build
        env:
          NODE_ENV: production

      - name: Analyze bundle size
        id: current-size
        run: |
          # Get main bundle size
          MAIN_FILE=$(find dist/assets/js -name "main-*.js" | head -1)
          MAIN_SIZE=$(du -k "$MAIN_FILE" | cut -f1)

          # Get total bundle size
          TOTAL_SIZE=$(du -sk dist/assets/js | cut -f1)

          # Get gzipped sizes
          TEMP_DIR=$(mktemp -d)
          cp "$MAIN_FILE" "$TEMP_DIR/main.js"
          gzip -9 "$TEMP_DIR/main.js"
          MAIN_GZIP=$(du -k "$TEMP_DIR/main.js.gz" | cut -f1)

          # Calculate total gzipped
          TOTAL_GZIP=0
          for file in dist/assets/js/*.js; do
            [ -f "$file" ] || continue
            cp "$file" "$TEMP_DIR/$(basename "$file")"
            gzip -9 "$TEMP_DIR/$(basename "$file")"
            SIZE=$(du -k "$TEMP_DIR/$(basename "$file").gz" | cut -f1)
            TOTAL_GZIP=$((TOTAL_GZIP + SIZE))
          done

          echo "main-size=$MAIN_SIZE" >> $GITHUB_OUTPUT
          echo "main-gzip=$MAIN_GZIP" >> $GITHUB_OUTPUT
          echo "total-size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          echo "total-gzip=$TOTAL_GZIP" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Current Bundle Sizes:"
          echo "  Main:  ${MAIN_SIZE}KB (${MAIN_GZIP}KB gzip)"
          echo "  Total: ${TOTAL_SIZE}KB (${TOTAL_GZIP}KB gzip)"

      - name: Run bundle size check
        id: budget-check
        run: |
          npm run build:check > bundle-report.txt 2>&1
          EXIT_CODE=$?
          echo "exitcode=$EXIT_CODE" >> $GITHUB_OUTPUT

          # Always show report, even if check fails
          cat bundle-report.txt

          exit $EXIT_CODE

      - name: Compare with base branch
        if: github.event_name == 'pull_request'
        id: compare
        run: |
          CURRENT_MAIN_GZIP=${{ steps.current-size.outputs.main-gzip }}
          CURRENT_TOTAL_GZIP=${{ steps.current-size.outputs.total-gzip }}

          # Fetch and checkout base branch
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}

          # Build base branch
          npm ci
          npm run build

          # Get base sizes
          BASE_MAIN=$(find dist/assets/js -name "main-*.js" | head -1)
          TEMP_DIR=$(mktemp -d)
          cp "$BASE_MAIN" "$TEMP_DIR/main.js"
          gzip -9 "$TEMP_DIR/main.js"
          BASE_MAIN_GZIP=$(du -k "$TEMP_DIR/main.js.gz" | cut -f1)

          # Calculate diff
          DIFF=$((CURRENT_MAIN_GZIP - BASE_MAIN_GZIP))
          PERCENT=$(awk "BEGIN {printf \"%.1f\", ($DIFF / $BASE_MAIN_GZIP) * 100}")

          echo "base-size=$BASE_MAIN_GZIP" >> $GITHUB_OUTPUT
          echo "diff=$DIFF" >> $GITHUB_OUTPUT
          echo "percent=$PERCENT" >> $GITHUB_OUTPUT

          echo "ðŸ“ˆ Comparison with ${{ github.base_ref }}:"
          echo "  Base:    ${BASE_MAIN_GZIP}KB gzip"
          echo "  Current: ${CURRENT_MAIN_GZIP}KB gzip"
          echo "  Diff:    ${DIFF}KB (${PERCENT}%)"

          # Check threshold
          if [ $(echo "$PERCENT > 10" | bc) -eq 1 ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "::warning::Bundle size increased by ${PERCENT}% (>10% threshold)"
          elif [ $(echo "$PERCENT > 5" | bc) -eq 1 ]; then
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "::warning::Bundle size increased by ${PERCENT}% (>5% threshold)"
          else
            echo "status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-stats-${{ github.sha }}
          path: |
            dist/stats.html
            bundle-report.txt
          retention-days: 14

      - name: Create PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const report = fs.readFileSync('bundle-report.txt', 'utf8')

            const currentMainGzip = '${{ steps.current-size.outputs.main-gzip }}'
            const currentTotalGzip = '${{ steps.current-size.outputs.total-gzip }}'
            const baseSize = '${{ steps.compare.outputs.base-size }}'
            const diff = '${{ steps.compare.outputs.diff }}'
            const percent = '${{ steps.compare.outputs.percent }}'
            const status = '${{ steps.compare.outputs.status }}'

            let statusEmoji = 'âœ…'
            let statusText = 'Passed'
            let statusColor = 'ðŸŸ¢'

            if (status === 'warning') {
              statusEmoji = 'âš ï¸'
              statusText = 'Warning'
              statusColor = 'ðŸŸ¡'
            } else if (status === 'failed') {
              statusEmoji = 'âŒ'
              statusText = 'Failed'
              statusColor = 'ðŸ”´'
            }

            const diffPrefix = diff > 0 ? '+' : ''
            const diffColor = diff > 0 ? 'ðŸ”º' : 'ðŸ”»'

            const body = `## ${statusEmoji} Bundle Size Report

            ### Comparison with \`${{ github.base_ref }}\`

            ${statusColor} **Status:** ${statusText}

            | Metric | Base | Current | Change |
            |--------|------|---------|--------|
            | **Initial Bundle (gzip)** | ${baseSize} KB | ${currentMainGzip} KB | ${diffColor} ${diffPrefix}${diff} KB (${diffPrefix}${percent}%) |
            | **Total Bundle (gzip)** | - | ${currentTotalGzip} KB | - |

            <details>
            <summary>ðŸ“‹ Full Bundle Analysis</summary>

            \`\`\`
            ${report}
            \`\`\`
            </details>

            ### ðŸ“Š View Detailed Analysis

            [View Bundle Treemap](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---

            **Thresholds:**
            - âœ… Pass: <5% increase
            - âš ï¸  Warning: 5-10% increase
            - âŒ Fail: >10% increase
            `

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            })

            const existingComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('Bundle Size Report')
            )

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              })
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              })
            }

      - name: Check failure threshold
        if: github.event_name == 'pull_request' && steps.compare.outputs.status == 'failed'
        run: |
          echo "::error::Bundle size increased by ${{ steps.compare.outputs.percent }}% (>10% threshold)"
          echo "This exceeds the maximum allowed increase."
          echo "Please optimize your bundle size before merging."
          echo ""
          echo "Suggestions:"
          echo "  â€¢ Use dynamic imports for large dependencies"
          echo "  â€¢ Check for duplicate dependencies (npm ls <package>)"
          echo "  â€¢ Use tree-shakeable imports (import { x } from 'lib')"
          echo "  â€¢ Consider lighter alternatives to heavy libraries"
          echo ""
          echo "View detailed analysis:"
          echo "  npm run build:analyze"
          exit 1

      - name: Success message
        if: success()
        run: |
          echo "âœ… Bundle size check passed!"
          echo ""
          echo "ðŸ“Š Bundle Stats:"
          echo "  â€¢ Initial: ${{ steps.current-size.outputs.main-gzip }}KB (gzip)"
          echo "  â€¢ Total: ${{ steps.current-size.outputs.total-gzip }}KB (gzip)"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "  â€¢ Change: ${{ steps.compare.outputs.diff }}KB (${{ steps.compare.outputs.percent }}%)"
          fi
