name: Production Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency deployment only)'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  ENVIRONMENT: production
  DEPLOYMENT_URL: ${{ secrets.AZURE_STATIC_WEB_APP_URL }}

jobs:
  # Pre-deployment validation
  quality-gates:
    name: Pre-Deployment Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: TypeScript compilation check
        run: npm run typecheck
        continue-on-error: false

      - name: Lint check
        run: npm run lint
        continue-on-error: false

      - name: Security audit
        run: |
          npm audit --audit-level=high --production || true
          npm audit --audit-level=critical --production
        continue-on-error: false

      - name: Check bundle size
        run: |
          npm run build
          BUNDLE_SIZE=$(du -sh dist | cut -f1)
          echo "Bundle size: $BUNDLE_SIZE"
          SIZE_NUM=$(echo $BUNDLE_SIZE | sed 's/M.*//')
          if [ $(echo "$SIZE_NUM > 10" | bc -l) -eq 1 ]; then
            echo "::error::Bundle size ($BUNDLE_SIZE) exceeds 10MB limit"
            exit 1
          fi
          echo "âœ“ Bundle size check passed: $BUNDLE_SIZE"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist/
          retention-days: 30

  # Run comprehensive tests
  test-suite:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: quality-gates
    if: ${{ !inputs.skip_tests }}
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run smoke tests
        run: npm run test:smoke
        env:
          APP_URL: http://localhost:5173

      - name: Run E2E critical path tests
        run: npx playwright test e2e/00-smoke-tests e2e/01-main-modules --project=chromium
        continue-on-error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  # Build and deploy to Azure Static Web Apps
  deploy:
    name: Deploy to Azure Static Web Apps
    runs-on: ubuntu-latest
    needs: [quality-gates, test-suite]
    if: ${{ always() && needs.quality-gates.result == 'success' && (needs.test-suite.result == 'success' || inputs.skip_tests) }}
    environment:
      name: production
      url: ${{ secrets.AZURE_STATIC_WEB_APP_URL }}
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build production bundle
        run: npm run build
        env:
          NODE_ENV: production
          VITE_APP_ENV: production
          VITE_AZURE_AD_CLIENT_ID: ${{ secrets.VITE_AZURE_AD_CLIENT_ID }}
          VITE_AZURE_AD_TENANT_ID: ${{ secrets.VITE_AZURE_AD_TENANT_ID }}
          VITE_AZURE_AD_REDIRECT_URI: ${{ secrets.AZURE_STATIC_WEB_APP_URL }}

      - name: Deploy to Azure Static Web Apps
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          output_location: "dist"
          skip_app_build: true
          skip_api_build: true

      - name: Deployment summary
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment URL**: ${{ secrets.AZURE_STATIC_WEB_APP_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # Post-deployment verification
  post-deployment-verification:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Wait for deployment to be live
        run: |
          echo "Waiting 60 seconds for deployment to propagate..."
          sleep 60

      - name: Run production smoke tests
        run: npx playwright test tests/smoke/production.smoke.test.ts --project=smoke
        env:
          PRODUCTION_URL: ${{ secrets.AZURE_STATIC_WEB_APP_URL }}
          APP_URL: ${{ secrets.AZURE_STATIC_WEB_APP_URL }}
        continue-on-error: false

      - name: Health check - Application loads
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.AZURE_STATIC_WEB_APP_URL }}")
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
            echo "âœ“ Health check passed: HTTP $HTTP_CODE"
          else
            echo "::error::Health check failed: HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Check response time
        run: |
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "${{ secrets.AZURE_STATIC_WEB_APP_URL }}")
          RESPONSE_MS=$(echo "$RESPONSE_TIME * 1000" | bc)
          echo "Response time: ${RESPONSE_MS}ms"
          if [ $(echo "$RESPONSE_TIME > 5" | bc -l) -eq 1 ]; then
            echo "::warning::Response time (${RESPONSE_MS}ms) exceeds 5s threshold"
          else
            echo "âœ“ Response time check passed: ${RESPONSE_MS}ms"
          fi

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: post-deployment-tests
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: Verification summary
        if: success()
        run: |
          echo "### âœ… Post-Deployment Verification Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All production smoke tests passed successfully." >> $GITHUB_STEP_SUMMARY
          echo "Application is healthy and responding correctly." >> $GITHUB_STEP_SUMMARY

  # Notify on success
  notify-success:
    name: Deployment Success Notification
    runs-on: ubuntu-latest
    needs: post-deployment-verification
    if: success()
    timeout-minutes: 5

    steps:
      - name: Success notification
        run: |
          echo "### ðŸŽ‰ Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** ${{ secrets.AZURE_STATIC_WEB_APP_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All quality gates passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment successful" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Post-deployment verification passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Application is healthy" >> $GITHUB_STEP_SUMMARY
