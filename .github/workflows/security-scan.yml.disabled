name: Security Scanning
# Task 1.7 from REMEDIATION_COMPLIANCE_PLAN.md
# Comprehensive security scanning for FedRAMP/SOC 2 compliance

on:
  push:
    branches: [main, develop, stage-*]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  # Job 1: TruffleHog - Secret Scanning
  trufflehog:
    name: TruffleHog Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for comprehensive scan

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified --fail

      - name: TruffleHog Results Summary
        if: always()
        run: |
          echo "✅ TruffleHog scan completed"
          echo "Scanned for secrets in git history and files"

  # Job 2: GitLeaks - Git History Secret Scanning
  gitleaks:
    name: GitLeaks Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Upload GitLeaks SARIF report
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: gitleaks

  # Job 3: Semgrep - SAST (Static Application Security Testing)
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan \
            --config=auto \
            --config=p/security-audit \
            --config=p/typescript \
            --config=p/react \
            --config=p/nodejs \
            --config=p/owasp-top-ten \
            --config=p/sql-injection \
            --config=p/xss \
            --json \
            --output=semgrep-results.json \
            --max-memory=4096 \
            --timeout=300 \
            --verbose

      - name: Upload Semgrep Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json
          retention-days: 30

      - name: Semgrep Results Summary
        if: always()
        run: |
          if [ -f semgrep-results.json ]; then
            echo "✅ Semgrep SAST scan completed"
            jq '.results | length' semgrep-results.json | xargs -I {} echo "Found {} potential issues"
          fi

  # Job 4: npm audit - Dependency Vulnerability Scanning
  npm-audit:
    name: npm Audit
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory: ['.', './server', './api']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '${{ matrix.directory }}/package-lock.json'

      - name: Run npm audit
        working-directory: ${{ matrix.directory }}
        run: |
          if [ -f package.json ]; then
            echo "Running npm audit in ${{ matrix.directory }}"
            npm audit --audit-level=moderate --json > npm-audit-results.json || true

            # Display summary
            if [ -f npm-audit-results.json ]; then
              echo "Audit Summary:"
              jq '.metadata.vulnerabilities' npm-audit-results.json
            fi
          else
            echo "No package.json found in ${{ matrix.directory }}, skipping"
          fi

      - name: Upload npm audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-${{ matrix.directory }}
          path: ${{ matrix.directory }}/npm-audit-results.json
          retention-days: 30

      - name: Fail on critical vulnerabilities
        working-directory: ${{ matrix.directory }}
        run: |
          if [ -f npm-audit-results.json ]; then
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit-results.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit-results.json)

            echo "Critical vulnerabilities: $CRITICAL"
            echo "High vulnerabilities: $HIGH"

            if [ "$CRITICAL" -gt 0 ]; then
              echo "❌ CRITICAL vulnerabilities found - build failed"
              exit 1
            fi
          fi

  # Job 5: Security Summary Report
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [trufflehog, gitleaks, semgrep, npm-audit]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-artifacts

      - name: Generate Security Summary
        run: |
          echo "# Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "**Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-summary.md
          echo "**Commit:** ${{ github.sha }}" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Scan Results" >> security-summary.md
          echo "" >> security-summary.md
          echo "| Tool | Status |" >> security-summary.md
          echo "|------|--------|" >> security-summary.md
          echo "| TruffleHog | ${{ needs.trufflehog.result }} |" >> security-summary.md
          echo "| GitLeaks | ${{ needs.gitleaks.result }} |" >> security-summary.md
          echo "| Semgrep | ${{ needs.semgrep.result }} |" >> security-summary.md
          echo "| npm audit | ${{ needs.npm-audit.result }} |" >> security-summary.md
          echo "" >> security-summary.md

          cat security-summary.md

      - name: Upload Security Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 90

      - name: Comment PR with Summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # Job 6: CodeQL Analysis (GitHub Advanced Security)
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript', 'typescript']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: +security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  # Job 7: OWASP Dependency Check
  owasp-dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'fleet-management'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7

      - name: Upload OWASP Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check
          path: reports/
          retention-days: 30
