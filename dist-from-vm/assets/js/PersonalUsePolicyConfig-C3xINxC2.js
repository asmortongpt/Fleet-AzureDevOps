import{r as e,R as a,j as s,B as r,bi as i,ae as o,d5 as t,bh as l,C as n}from"./react-core-hQu9tqS1.js";import{a as _,u as p,b as c}from"./query-vendor--Fe2N4Al.js";import{t as m}from"./index-savvei9t.js";import{p as d,h as u,A as h,w as f,T as x,a as v,b as j,c as g,C as y,d as w,e as N,i as b,f as S,y as k}from"./index-BDwglPMF.js";import{L as A}from"./label-C9sYRYKW.js";import{R as q,a as C}from"./radio-group-am2T2p6t.js";import{S as E}from"./separator-Dey2K2dP.js";import{S as R}from"./switch-9MiV1CpI.js";import"./lazy-modules-Bs19xeuI.js";import"./form-vendor-DKCvS-hL.js";import"./chart-vendor-DWRb53_H.js";import"./utils-vendor-Bojdf5C8.js";import"./mui-core-BKffG9O1.js";import"./react-router-cBrq_s0x.js";import"./three-helpers-DedzJcO9.js";import"./three-core-ZrcxJ5g9.js";import"./three-react-B1s7Iy2r.js";import"./ui-radix-C-X5Qx_8.js";import"./ui-dialogs-C2yTnBPV.js";import"./animation-vendor-Cf_i_fm0.js";import"./date-vendor-npJ7nI92.js";import"./ui-menus--48tEbqQ.js";var F=(e=>(e.MANAGER="manager",e.FLEET_ADMIN="fleet_admin",e.BOTH="both",e.NONE="none",e))(F||{});const P=()=>s.jsx("div",{className:"flex items-center justify-center h-64",children:s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}),T=({error:e,onRetry:a})=>s.jsxs(h,{variant:"destructive",className:"m-4",children:[s.jsx(n,{className:"h-4 w-4"}),s.jsx(k,{children:"Error"}),s.jsxs(f,{className:"flex items-center justify-between",children:[s.jsx("span",{children:e}),s.jsxs(u,{variant:"outline",size:"sm",onClick:a,children:[s.jsx(i,{className:"w-4 h-4 mr-2"}),"Retry"]})]})]}),D=({})=>{const n=_(),[k,D]=e.useState(!1),[I,M]=e.useState(!1),[O,z]=e.useState({allow_personal_use:!0,require_approval:!0,max_personal_miles_per_month:200,max_personal_miles_per_year:1e3,charge_personal_use:!1,personal_use_rate_per_mile:.25,approval_workflow:F.MANAGER,auto_approve_under_miles:50,notification_settings:{notify_at_percentage:80,notify_manager_on_exceed:!0,notify_driver_on_limit:!0,email_notifications:!0},effective_date:(new Date).toISOString().split("T")[0]}),{data:L,isLoading:B,error:G}=p({queryKey:["personal-use-policies"],queryFn:()=>(async()=>{const e=localStorage.getItem("token")||"",a=await fetch("/api/personal-use-policies",{headers:{Authorization:`Bearer ${e}`}});if(!a.ok)throw new Error("Failed to fetch");return a.json()})(),staleTime:1/0,gcTime:1/0});a.useEffect(()=>{G&&d.error("Failed to fetch policy:",G)},[G]);const U=L?.data||null;a.useEffect(()=>{U&&U.id&&z({allow_personal_use:U.allow_personal_use,require_approval:U.require_approval,max_personal_miles_per_month:U.max_personal_miles_per_month??void 0,max_personal_miles_per_year:U.max_personal_miles_per_year??void 0,charge_personal_use:U.charge_personal_use,personal_use_rate_per_mile:U.personal_use_rate_per_mile??void 0,approval_workflow:U.approval_workflow,auto_approve_under_miles:U.auto_approve_under_miles??void 0,notification_settings:U.notification_settings||{notify_at_80_percent:!0,notify_at_95_percent:!0,notify_on_charge:!0,notify_on_rejection:!0},effective_date:new Date(U.effective_date).toISOString().split("T")[0]})},[U]);const{mutate:$,isPending:H}=c({mutationFn:async()=>(async(e,a,s)=>{const r=localStorage.getItem("token")||"",i=await fetch(e,{method:"PUT",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:s?JSON.stringify(s):void 0});if(!i.ok){const e=await i.json();throw new Error(e.error||"Failed to perform action")}return i.json()})(`/api/personal-use-policies/${JSON.parse(localStorage.getItem("user")||"{}").tenant_id||""}`,0,{allow_personal_use:O.allow_personal_use,require_approval:O.require_approval,max_personal_miles_per_month:O.max_personal_miles_per_month??void 0,max_personal_miles_per_year:O.max_personal_miles_per_year??void 0,charge_personal_use:O.charge_personal_use,personal_use_rate_per_mile:O.personal_use_rate_per_mile??void 0,reporting_required:!0,approval_workflow:O.approval_workflow,notification_settings:O.notification_settings,auto_approve_under_miles:O.auto_approve_under_miles??void 0,effective_date:O.effective_date}),onSuccess:()=>{m.success("Policy saved successfully"),M(!1),n.invalidateQueries({queryKey:["personal-use-policies"]})},onError:e=>{d.error("Failed to save policy:",e),m.error(e.message||"Failed to save policy")}}),K=e=>{z(a=>({...a,...e})),M(!0)};return B?s.jsx(P,{}):G&&G instanceof Error&&"Failed to fetch"!==G.message?s.jsx(T,{error:G.message,onRetry:()=>n.invalidateQueries({queryKey:["personal-use-policies"]})}):s.jsxs("div",{className:"container mx-auto p-4 space-y-6",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[s.jsx(r,{className:"w-8 h-8"}),"Personal Use Policy Configuration"]}),s.jsx("p",{className:"text-muted-foreground mt-1",children:"Configure organization-wide personal vehicle use policies and limits"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(u,{variant:"outline",onClick:()=>{window.confirm("Reset all settings to default values?")&&(z({allow_personal_use:!0,require_approval:!0,max_personal_miles_per_month:200,max_personal_miles_per_year:1e3,charge_personal_use:!1,personal_use_rate_per_mile:.25,approval_workflow:F.MANAGER,auto_approve_under_miles:50,notification_settings:{notify_at_percentage:80,notify_manager_on_exceed:!0,notify_driver_on_limit:!0,email_notifications:!0},effective_date:(new Date).toISOString().split("T")[0]}),M(!0),m.info("Settings reset to defaults"))},children:[s.jsx(i,{className:"w-4 h-4 mr-2"}),"Reset to Defaults"]}),s.jsxs(u,{variant:"outline",onClick:()=>D(!k),children:[s.jsx(o,{className:"w-4 h-4 mr-2"}),k?"Hide":"Show"," Preview"]}),s.jsxs(u,{onClick:()=>{const e=(()=>{if(O.charge_personal_use){if(!O.personal_use_rate_per_mile||0>=O.personal_use_rate_per_mile)return"Rate per mile is required when charging is enabled";if(O.personal_use_rate_per_mile>.67)return"Rate cannot exceed federal IRS rate ($0.67/mile)"}if(O.max_personal_miles_per_month&&0>=O.max_personal_miles_per_month)return"Monthly limit must be greater than 0";if(O.max_personal_miles_per_year&&0>=O.max_personal_miles_per_year)return"Annual limit must be greater than 0";if(O.max_personal_miles_per_month&&O.max_personal_miles_per_year&&O.max_personal_miles_per_month>O.max_personal_miles_per_year)return"Annual limit should be greater than monthly limit";if(O.auto_approve_under_miles&&O.max_personal_miles_per_month&&O.auto_approve_under_miles>=O.max_personal_miles_per_month)return"Auto-approve threshold must be less than monthly limit";const e=new Date(O.effective_date),a=new Date;return a.setHours(0,0,0,0),a>e?"Effective date cannot be in the past":null})();e?m.error(e):window.confirm("Are you sure you want to save this policy? This will affect all drivers in your organization.")&&$()},disabled:H||!I,children:[s.jsx(t,{className:"w-4 h-4 mr-2"}),H?"Saving...":"Save Policy"]})]})]}),U&&s.jsxs(h,{children:[s.jsx(l,{className:"h-4 w-4"}),s.jsxs(f,{children:[s.jsx("strong",{children:"Current Policy:"})," Effective since"," ",new Date(U.effective_date).toLocaleDateString(),I&&" â€¢ You have unsaved changes"]})]}),s.jsxs(x,{defaultValue:"basic",className:"space-y-4",children:[s.jsxs(v,{children:[s.jsx(j,{value:"basic",children:"Basic Settings"}),s.jsx(j,{value:"limits",children:"Usage Limits"}),s.jsx(j,{value:"charging",children:"Charging"}),s.jsx(j,{value:"notifications",children:"Notifications"}),s.jsx(j,{value:"advanced",children:"Advanced"})]}),s.jsx(g,{value:"basic",className:"space-y-6",children:s.jsxs(y,{children:[s.jsxs(w,{children:[s.jsx(N,{children:"Personal Use Policy"}),s.jsx(b,{children:"Core settings for allowing and managing personal vehicle use"})]}),s.jsxs(S,{className:"space-y-6",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"space-y-0.5",children:[s.jsx(A,{htmlFor:"allow_personal_use",className:"text-base",children:"Allow Personal Use"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"Enable drivers to use company vehicles for personal trips"})]}),s.jsx(R,{id:"allow_personal_use",checked:O.allow_personal_use,onCheckedChange:e=>K({allow_personal_use:!0===e})})]}),s.jsx(E,{}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"space-y-0.5",children:[s.jsx(A,{htmlFor:"require_approval",className:"text-base",children:"Require Approval"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"Personal use trips must be approved by manager/admin"})]}),s.jsx(R,{id:"require_approval",checked:O.require_approval,onCheckedChange:e=>K({require_approval:!0===e}),disabled:!O.allow_personal_use})]}),O.require_approval&&s.jsxs("div",{className:"space-y-3 pl-6 border-l-2",children:[s.jsx(A,{className:"text-base",children:"Approval Workflow"}),s.jsx(q,{value:O.approval_workflow,onValueChange:e=>K({approval_workflow:e}),children:s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(C,{value:F.MANAGER,id:"manager"}),s.jsx(A,{htmlFor:"manager",className:"font-normal cursor-pointer",children:"Manager Approval - Direct manager ap"})]})})]})]})]})})]})]})};export{D as PersonalUsePolicyConfig};
