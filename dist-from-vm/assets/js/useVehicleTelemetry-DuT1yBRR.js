function e(e={}){const{enabled:c=!0,initialVehicles:o=[],onVehicleUpdate:l,onEmulatorEvent:u}=e,[i,d]=r.useState(new n(o.map(e=>[e.id,e]))),[g,p]=r.useState(new n),[h,f]=r.useState(null),[v,b]=r.useState(!1),[m,k]=r.useState(null),[w,S]=r.useState([]);r.useRef(i).current=i;const y=r.useCallback(e=>{switch(k(new Date),u?.(e),S(t=>[e,...t.slice(0,49)]),e.type){case"vehicle:telemetry":case"telemetry:update":{const{vehicleId:r,data:s}=e;if(!r)return;const a={vehicleId:r,timestamp:new Date(e.timestamp||Date.now()),gps:s?.gps,obd:s?.obd,driver:s?.driver,fuel:s?.fuel};d(e=>{const a=e.get(r);if(a){const n=new Map(e);return n.set(r,{...a,location:s?.gps?{lat:s.gps.latitude,lng:s.gps.longitude,latitude:s.gps.latitude,longitude:s.gps.longitude,address:a.location?.address??""}:a.location,speed:s?.gps?.speed??s?.obd?.speed??a.speed,status:t(a,s)}),n}return e}),p(e=>{const t=e.get(r)||[],s=new Map(e);return s.set(r,[...t.slice(-99),a]),s}),l?.(r,a);break}case"vehicle:position":case"gps:update":{const{vehicleId:t,latitude:r,longitude:s,speed:a,heading:n}=e;if(!t)return;d(e=>{const c=e.get(t);if(c){const o=new Map(e);return o.set(t,{...c,location:{lat:r,lng:s,latitude:r,longitude:s,address:c.location?.address??""},speed:a??c.speed,heading:n??c.heading,status:a>0?"active":"active"===c.status?"idle":c.status}),o}return e});break}case"vehicle:alert":case"alert":{const{vehicleId:t,severity:r}=e;t&&d(e=>{const s=e.get(t);if(s&&"critical"===r){const r=new Map(e);return r.set(t,{...s,status:"emergency"}),r}return e});break}case"emulator:stats":f(e.stats);break;case"emulator:started":b(!0);break;case"emulator:stopped":b(!1);break;case"vehicle:registered":{const{vehicle:t}=e;t&&d(e=>{const r=new Map(e);return r.set(t.id,t),r});break}case"fuel:update":{const{vehicleId:t,fuelLevel:r}=e;t&&d(e=>{const s=e.get(t);if(s){const a=new Map(e);return a.set(t,{...s,fuelLevel:r??s.fuelLevel}),a}return e});break}case"maintenance:alert":{const{vehicleId:t,urgency:r}=e;t&&"immediate"===r&&d(e=>{const r=e.get(t);if(r){const s=new Map(e);return s.set(t,{...r,status:"service"}),s}return e});break}case"ev:charging":case"charging:status":{const{vehicleId:t,isCharging:r,chargeLevel:s}=e;t&&d(e=>{const a=e.get(t);if(a){const n=new Map(e);return n.set(t,{...a,status:r?"charging":a.status,fuelLevel:s??a.fuelLevel}),n}return e});break}default:s.debug(`Unhandled telemetry message type: ${e.type}`)}},[l,u]),{isConnected:C,send:E,subscribe:M}=function(e={}){const{url:t=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/api/dispatch/ws`,reconnectInterval:n=3e3,reconnectAttempts:c=10,onOpen:o,onClose:l,onError:u,onMessage:i}=e,[d,g]=r.useState(!1),[p,h]=r.useState(null),f=r.useRef(null),v=r.useRef(0),b=r.useRef(new a),m=r.useCallback(()=>{if(f.current?.readyState!==WebSocket.OPEN)try{const e=new WebSocket(t);e.onopen=()=>{s.info("WebSocket connected"),g(!0),v.current=0,o?.()},e.onclose=()=>{s.info("WebSocket disconnected"),g(!1),f.current=null,l?.(),c>v.current&&(v.current++,s.info(`Reconnecting... (${v.current}/${c})`),setTimeout(m,n))},e.onerror=e=>{s.error("WebSocket error:",{error:e}),u?.(e)},e.onmessage=e=>{try{const t=JSON.parse(e.data);h(t),i?.(t);const r=b.current.get(t.type);r&&r.forEach(e=>e(t));const s=b.current.get("*");s&&s.forEach(e=>e(t))}catch(t){s.error("Error parsing WebSocket message:",{error:t})}},f.current=e}catch(e){s.error("Error creating WebSocket:",{error:e})}},[t,n,c,o,l,u,i]),k=r.useCallback(()=>{f.current&&(f.current.close(),f.current=null,g(!1))},[]),w=r.useCallback(e=>{f.current?.readyState===WebSocket.OPEN&&f.current.send(JSON.stringify(e))},[]),S=r.useCallback((e,t)=>(b.current.has(e)||b.current.set(e,new Set),b.current.get(e).add(t),()=>{const r=b.current.get(e);r&&(r.delete(t),0===r.size&&b.current.delete(e))}),[]);return r.useEffect(()=>(m(),()=>{k()}),[m,k]),{isConnected:d,lastMessage:p,send:w,subscribe:S,connect:m,disconnect:k}}({url:c?"ws://localhost:3001":void 0,onMessage:y});r.useEffect(()=>{if(!c)return;const e=[M("vehicle:telemetry",y),M("telemetry:update",y),M("vehicle:position",y),M("gps:update",y),M("vehicle:alert",y),M("alert",y),M("emulator:stats",y),M("emulator:started",y),M("emulator:stopped",y),M("vehicle:registered",y),M("fuel:update",y),M("maintenance:alert",y),M("ev:charging",y),M("charging:status",y),M("*",e=>s.debug("WebSocket event:",e.type))];return()=>{e.forEach(e=>e())}},[c,M,y]),r.useEffect(()=>{o.length>0&&d(new Map(o.map(e=>[e.id,e])))},[o]);const W=r.useCallback(()=>Array.from(i.values()),[i]),I=r.useCallback(e=>g.get(e)||[],[g]),L=r.useCallback(()=>{E({type:"emulator:getStats"})},[E]),R=r.useCallback(()=>{E({type:"emulator:start"})},[E]),O=r.useCallback(()=>{E({type:"emulator:stop"})},[E]);return{isConnected:C,isEmulatorRunning:v,lastUpdate:m,vehicles:W(),vehicleMap:i,getVehicle:e=>i.get(e),getVehicleTelemetry:I,recentEvents:w,emulatorStats:h,requestStats:L,startEmulator:R,stopEmulator:O,send:E}}function t(e,t){if(t?.driver?.harshBraking&&t?.driver?.harshAcceleration)return"emergency";if(t?.ev?.isCharging)return"charging";if(t?.obd?.dtcCodes?.length>0)return"service";const r=t?.gps?.speed??t?.obd?.speed??0;return r>2?"active":"active"===e.status&&2>r?"idle":e.status}import{r}from"./react-core-hQu9tqS1.js";import{p as s}from"./index-BDwglPMF.js";const a=globalThis.Map,n=globalThis.Map;export{e as u};
