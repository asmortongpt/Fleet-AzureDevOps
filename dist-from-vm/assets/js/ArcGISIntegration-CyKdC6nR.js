function e(){const[e,Y]=s.useState([]),[K,X]=s.useState(!1),[_,ee]=s.useState(!1),[se,ae]=s.useState(!0),[re,te]=s.useState(null),[ie,ne]=s.useState(new Map),[le,ce]=s.useState(!1),[oe,de]=s.useState(null),[me,he]=s.useState({name:"",description:"",serviceUrl:"",layerType:"feature",opacity:1,token:""}),[ue,pe]=s.useState(""),xe=s.useRef(null),ye=s.useRef(null),ge=s.useCallback(async(e=0)=>{try{ae(!0),te(null),xe.current=new AbortController;const e=await v.arcgisLayers.list();Y(e.map(e=>({...e,health:"unknown",lastChecked:void 0}))),fe()}catch(s){if(f.error("Failed to load ArcGIS layers:",s),3>e){const s=1e3*Math.pow(2,e);setTimeout(()=>ge(e+1),s)}else te(s instanceof Error?s.message:"Failed to load ArcGIS layers. Please refresh the page.")}finally{ae(!1)}},[]);s.useEffect(()=>(ge(),()=>{xe.current&&xe.current.abort(),ye.current&&clearInterval(ye.current)}),[ge]);const je=async e=>{try{return(await W.testServiceConnection(e.serviceUrl,e.authentication?.token)).success?"healthy":"error"}catch(s){return f.error(`Health check failed for layer ${e.name}:`,s),"error"}},fe=s.useCallback(()=>{ye.current&&clearInterval(ye.current),ye.current=setInterval(async()=>{Y(e=>((async()=>{const s=await Promise.all(e.map(async e=>{if(!e.enabled)return{...e,health:"unknown"};const s=await je(e);return{...e,health:s,lastChecked:new Date}}));Y(s)})(),e))},3e5)},[]),ve=s.useCallback(async()=>{const s=await Promise.all(e.map(async e=>{if(!e.enabled)return{...e,health:"unknown"};const s=await je(e);return{...e,health:s,lastChecked:new Date}}));Y(s)},[e]),we=s.useCallback((e,s)=>{ne(a=>{const r=new Map(a),t=r.get(e)||{loading:!1,error:null,lastUpdated:null};return r.set(e,{...t,...s}),r})},[]),be=s.useCallback(async()=>{if(me.serviceUrl){ce(!0),de(null);try{const e=await W.testServiceConnection(me.serviceUrl,me.token||void 0);if(e.success){const e=await W.fetchServiceCapabilities(me.serviceUrl,me.token||void 0);de({success:!0,message:"Successfully connected to ArcGIS service",details:{layerType:e.layerType,spatialReference:e.spatialReference,extent:e.extent,capabilities:e.supportedOperations}}),!me.name&&e.name&&he(s=>({...s,name:e.name??""})),!me.description&&e.description&&he(s=>({...s,description:e.description??""}))}else de(e)}catch(e){f.error("Connection test error:",e),de({success:!1,message:e instanceof Error?e.message:"Connection test failed"})}finally{ce(!1)}}else de({success:!1,message:"Please enter a service URL"})},[me]),Ne=s.useCallback(async()=>{if(me.name&&me.serviceUrl)if(e.some(e=>e.serviceUrl===me.serviceUrl))de({success:!1,message:"A layer with this service URL already exists"});else try{ce(!0);const e=await W.fetchServiceCapabilities(me.serviceUrl,me.token||void 0),s={id:`arcgis-${Date.now()}`,name:me.name,description:me.description||e.description,serviceUrl:me.serviceUrl,layerType:e.layerType,enabled:!0,opacity:me.opacity,minZoom:me.minZoom,maxZoom:me.maxZoom,refreshInterval:me.refreshInterval,authentication:me.token?{type:"token",token:me.token}:void 0,metadata:{capabilities:e,addedAt:(new Date).toISOString(),version:"2.0"},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},a={...s,health:"unknown"};Y(e=>[...e,a]),await Ee(s);const r=await je(a);Y(e=>e.map(e=>e.id===s.id?{...e,health:r,lastChecked:new Date}:e)),Te(),X(!1),de(null)}catch(s){f.error("Failed to add layer:",s),de({success:!1,message:s instanceof Error?s.message:"Failed to add layer"})}finally{ce(!1)}else de({success:!1,message:"Please provide a name and service URL"})},[me,e]),Se=s.useCallback(async s=>{const a=e.find(e=>e.id===s);if(a){Y(e=>e.map(e=>e.id===s?{...e,enabled:!e.enabled}:e));try{await v.arcgisLayers.update(s,{enabled:!a.enabled})}catch(r){f.error(`Failed to toggle layer ${s}:`,r),Y(e=>e.map(e=>e.id===s?{...e,enabled:a.enabled}:e))}}},[e]),ke=s.useCallback(async s=>{const a=e.find(e=>e.id===s);if(a){we(s,{loading:!0,error:null});try{Y(e=>e.filter(e=>e.id!==s)),await v.arcgisLayers.delete(s)}catch(r){f.error(`Failed to delete layer ${s}:`,r),Y(e=>[...e,a]),we(s,{loading:!1,error:r instanceof Error?r.message:"Failed to delete layer"})}finally{we(s,{loading:!1})}}},[e,we]),Ce=s.useCallback(async(s,a)=>{const r=e.find(e=>e.id===s);if(r){Y(e=>e.map(e=>e.id===s?{...e,opacity:a}:e));try{await v.arcgisLayers.update(s,{opacity:a})}catch(t){f.error(`Failed to update opacity for layer ${s}:`,t),Y(e=>e.map(e=>e.id===s?{...e,opacity:r.opacity}:e))}}},[e]),Ie=s.useCallback(async s=>{const a=e.find(e=>e.id===s);if(!a)return;const r=`arcgis-${Date.now()}`,t={...a,id:r,name:`${a.name} (Copy)`,health:"unknown",lastChecked:void 0,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};we(r,{loading:!0,error:null});try{Y(e=>[...e,t]),await Ee(t),we(r,{loading:!1,lastUpdated:new Date})}catch(i){f.error(`Failed to duplicate layer ${s}:`,i),Y(e=>e.filter(e=>e.id!==r)),we(r,{loading:!1,error:i instanceof Error?i.message:"Failed to duplicate layer"})}},[e,we]),Ae=s.useCallback(e=>{e>0&&Y(s=>{const a=[...s];return[a[e],a[e-1]]=[a[e-1],a[e]],a})},[]),Ue=s.useCallback(s=>{e.length-1>s&&Y(e=>{const a=[...e];return[a[s],a[s+1]]=[a[s+1],a[s]],a})},[e.length]),Te=s.useCallback(()=>{he({name:"",description:"",serviceUrl:"",layerType:"feature",opacity:1,token:""}),de(null)},[]),Ee=async e=>{try{await v.arcgisLayers.create(e)}catch(s){throw f.error("Failed to save layer to API:",s),s}},Fe=s.useCallback(()=>{const s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e,null,2)),a=document.createElement("a");a.setAttribute("href",s),a.setAttribute("download","arcgis-layers.json"),document.body.appendChild(a),a.click(),a.remove()},[e]),Le=s.useCallback(async()=>{try{const e=JSON.parse(ue);if(!Array.isArray(e))throw new Error("Invalid import data format");ae(!0);const s=await Promise.all(e.map(async e=>{const s={...e,id:`arcgis-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),health:"unknown",lastChecked:void 0};return await Ee(s),s}));Y(e=>[...e,...s]),ee(!1),pe("")}catch(e){f.error("Failed to import layers:",e),te(e instanceof Error?e.message:"Failed to import layers")}finally{ae(!1)}},[ue]),De=s.useMemo(()=>e.filter(e=>"healthy"===e.health),[e]),Pe=s.useMemo(()=>e.filter(e=>"warning"===e.health),[e]),Ge=s.useMemo(()=>e.filter(e=>"error"===e.health),[e]),Re=function(e){const a=s.useRef();return s.useEffect(()=>()=>{a.current&&clearTimeout(a.current)},[]),s.useCallback((...s)=>{a.current&&clearTimeout(a.current),a.current=setTimeout(()=>{e(...s)},300)},[e,300])}(Ce);return a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("h2",{className:"text-2xl font-bold",children:"ArcGIS Integration"}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(w,{open:K,onOpenChange:X,children:[a.jsx(b,{asChild:!0,children:a.jsxs(N,{children:[a.jsx(r,{className:"h-4 w-4 mr-2"}),"Add Layer"]})}),a.jsxs(S,{className:"sm:max-w-[425px]",children:[a.jsxs(k,{children:[a.jsx(C,{children:"Add New ArcGIS Layer"}),a.jsx(I,{children:"Configure a new ArcGIS layer integration."})]}),a.jsxs("div",{className:"grid gap-4 py-4",children:[a.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[a.jsx(H,{htmlFor:"name",className:"text-right",children:"Name"}),a.jsx(A,{id:"name",value:me.name,onChange:e=>he(s=>({...s,name:e.target.value})),className:"col-span-3"})]}),a.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[a.jsx(H,{htmlFor:"serviceUrl",className:"text-right",children:"Service URL"}),a.jsx(A,{id:"serviceUrl",value:me.serviceUrl,onChange:e=>he(s=>({...s,serviceUrl:e.target.value})),className:"col-span-3"})]}),a.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[a.jsx(H,{htmlFor:"token",className:"text-right",children:"Token"}),a.jsx(A,{id:"token",value:me.token,onChange:e=>he(s=>({...s,token:e.target.value})),placeholder:"Optional",className:"col-span-3"})]}),a.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[a.jsx(H,{className:"text-right",children:"Type"}),a.jsx("div",{className:"col-span-3",children:a.jsx(U,{value:me.layerType,onValueChange:e=>he(s=>({...s,layerType:e})),children:a.jsxs(T,{children:[a.jsx(E,{value:"feature",children:"Feature"}),a.jsx(E,{value:"tile",children:"Tile"}),a.jsx(E,{value:"image",children:"Image"}),a.jsx(E,{value:"dynamic",children:"Dynamic"}),a.jsx(E,{value:"wms",children:"WMS"})]})})})]}),a.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[a.jsx(H,{className:"text-right",children:"Opacity"}),a.jsx("div",{className:"col-span-3",children:a.jsx(V,{value:[me.opacity],min:0,max:1,step:.1,onValueChange:e=>he(s=>({...s,opacity:e[0]??1}))})})]}),a.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[a.jsx(H,{htmlFor:"description",className:"text-right",children:"Description"}),a.jsx(A,{id:"description",value:me.description,onChange:e=>he(s=>({...s,description:e.target.value})),className:"col-span-3"})]})]}),oe?a.jsxs(R,{className:oe.success?"border-green-500":"border-red-500",children:[oe.success?a.jsx(l,{className:"h-4 w-4 text-green-500"}):a.jsx(c,{className:"h-4 w-4 text-red-500"}),a.jsx(O,{children:oe.success?"Success":"Error"}),a.jsx($,{children:oe.message}),oe.details&&a.jsxs("div",{className:"mt-2 text-sm text-gray-600",children:[a.jsxs("div",{children:["Type: ",oe.details.layerType??"N/A"]}),a.jsxs("div",{children:["Capabilities: ",oe.details.capabilities?.join(", ")??"N/A"]})]})]}):null,a.jsxs(F,{children:[a.jsx(N,{type:"button",variant:"secondary",onClick:be,disabled:le,children:"Test Connection"}),a.jsx(N,{type:"submit",onClick:Ne,disabled:le,children:"Add Layer"})]})]})]}),a.jsxs(w,{open:_,onOpenChange:ee,children:[a.jsx(b,{asChild:!0,children:a.jsxs(N,{variant:"outline",children:[a.jsx(t,{className:"h-4 w-4 mr-2"}),"Import"]})}),a.jsxs(S,{className:"sm:max-w-[425px]",children:[a.jsxs(k,{children:[a.jsx(C,{children:"Import ArcGIS Layers"}),a.jsx(I,{children:"Paste your layer configuration JSON below."})]}),a.jsx("div",{className:"grid gap-4 py-4",children:a.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[a.jsx(H,{htmlFor:"importData",className:"text-right",children:"JSON Data"}),a.jsx("textarea",{id:"importData",value:ue,onChange:e=>pe(e.target.value),className:"col-span-3 h-32 border rounded-md p-2"})]})}),a.jsx(F,{children:a.jsx(N,{type:"submit",onClick:Le,disabled:se,children:"Import Layers"})})]})]}),a.jsxs(N,{variant:"outline",onClick:Fe,children:[a.jsx(i,{className:"h-4 w-4 mr-2"}),"Export"]}),a.jsxs(N,{variant:"outline",onClick:ve,disabled:se,children:[a.jsx(n,{className:"h-4 w-4 mr-2"}),"Refresh"]})]})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[a.jsxs(L,{children:[a.jsxs(D,{className:"flex flex-row items-center justify-between pb-2",children:[a.jsx(P,{className:"text-sm font-medium",children:"Healthy Layers"}),a.jsx(l,{className:"h-4 w-4 text-green-500"})]}),a.jsx(G,{children:a.jsx("div",{className:"text-2xl font-bold",children:De.length})})]}),a.jsxs(L,{children:[a.jsxs(D,{className:"flex flex-row items-center justify-between pb-2",children:[a.jsx(P,{className:"text-sm font-medium",children:"Warnings"}),a.jsx(c,{className:"h-4 w-4 text-yellow-500"})]}),a.jsx(G,{children:a.jsx("div",{className:"text-2xl font-bold",children:Pe.length})})]}),a.jsxs(L,{children:[a.jsxs(D,{className:"flex flex-row items-center justify-between pb-2",children:[a.jsx(P,{className:"text-sm font-medium",children:"Errors"}),a.jsx(o,{className:"h-4 w-4 text-red-500"})]}),a.jsx(G,{children:a.jsx("div",{className:"text-2xl font-bold",children:Ge.length})})]})]}),re&&a.jsxs(R,{variant:"destructive",children:[a.jsx(c,{className:"h-4 w-4"}),a.jsx(O,{children:"Error"}),a.jsx($,{children:re})]}),se?a.jsx("div",{className:"flex justify-center items-center h-64",children:a.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full"})}):a.jsxs(L,{children:[a.jsxs(D,{children:[a.jsx(P,{children:"ArcGIS Layers"}),a.jsx(M,{children:"Manage your ArcGIS layer integrations"})]}),a.jsx(G,{children:0===e.length?a.jsxs("div",{className:"text-center py-8 text-gray-500",children:[a.jsx(d,{className:"h-12 w-12 mx-auto mb-2 text-gray-400"}),a.jsx("p",{children:'No ArcGIS layers added yet. Click "Add Layer" to get started.'})]}):a.jsx("div",{className:"divide-y divide-gray-200",children:e.map((e,s)=>((e,s)=>{const r=ie.get(e.id),t=r?.loading??!1,i=r?.error;return a.jsxs("div",{className:"border-b last:border-b-0 py-3 flex items-center justify-between",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[e.enabled?a.jsx(h,{className:"h-4 w-4 text-green-500"}):a.jsx(u,{className:"h-4 w-4 text-gray-400"}),a.jsx("span",{className:"font-medium truncate",children:e.name}),a.jsx(J,{variant:"healthy"===e.health?"default":"destructive",children:e.health})]}),a.jsx("div",{className:"text-sm text-gray-500 truncate",children:e.description}),i&&a.jsx("div",{className:"text-xs text-red-500 mt-1",children:i})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(V,{className:"w-24",value:[e.opacity],min:0,max:1,step:.1,onValueChange:s=>Re(e.id,s[0]??0),disabled:t}),a.jsx(N,{variant:"ghost",size:"sm",onClick:()=>Se(e.id),disabled:t,children:a.jsx(e.enabled?u:h,{className:"h-4 w-4"})}),a.jsxs(q,{children:[a.jsx(z,{asChild:!0,children:a.jsx(N,{variant:"ghost",size:"sm",disabled:t,children:a.jsx(p,{className:"h-4 w-4"})})}),a.jsxs(Q,{align:"end",children:[a.jsxs(Z,{onClick:()=>Ie(e.id),children:[a.jsx(x,{className:"h-4 w-4 mr-2"}),"Duplicate"]}),a.jsxs(Z,{onClick:()=>Ae(s),children:[a.jsx(y,{className:"h-4 w-4 mr-2"}),"Move Up"]}),a.jsxs(Z,{onClick:()=>Ue(s),children:[a.jsx(g,{className:"h-4 w-4 mr-2"}),"Move Down"]}),a.jsx(B,{}),a.jsxs(Z,{onClick:()=>ke(e.id),className:"text-red-500",children:[a.jsx(j,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]})]})]},e.id)})(e,s))})})]}),a.jsxs(R,{children:[a.jsx(m,{className:"h-4 w-4"}),a.jsx(O,{children:"About ArcGIS Integration"}),a.jsx($,{children:"This module allows integration with ArcGIS REST services including FeatureServer, MapServer, and ImageServer endpoints. Add layers by providing service URLs and optional authentication tokens."})]})]})}import{r as s,j as a,br as r,bu as t,bj as i,ce as n,ah as l,C as c,by as o,cf as d,bh as m,ae as h,cg as u,ch as p,ci as x,bo as y,bp as g,cj as j}from"./react-core-hQu9tqS1.js";import{p as f,o as v,D as w,t as b,h as N,j as S,k,l as C,m as I,I as A,T as U,a as T,b as E,n as F,C as L,d as D,e as P,f as G,A as R,y as O,w as $,i as M,B as J,z as q,E as z,F as Q,G as Z,H as B}from"./index-BDwglPMF.js";import{L as H}from"./label-C9sYRYKW.js";import{S as V}from"./slider-DpXVN0eA.js";import"./lazy-modules-Bs19xeuI.js";import"./form-vendor-DKCvS-hL.js";import"./chart-vendor-DWRb53_H.js";import"./utils-vendor-Bojdf5C8.js";import"./mui-core-BKffG9O1.js";import"./react-router-cBrq_s0x.js";import"./query-vendor--Fe2N4Al.js";import"./three-helpers-DedzJcO9.js";import"./three-core-ZrcxJ5g9.js";import"./three-react-B1s7Iy2r.js";import"./ui-radix-C-X5Qx_8.js";import"./ui-dialogs-C2yTnBPV.js";import"./animation-vendor-Cf_i_fm0.js";import"./date-vendor-npJ7nI92.js";import"./ui-menus--48tEbqQ.js";const W=new class{async fetchServiceCapabilities(e,s){try{const a=new URL(e);a.searchParams.set("f","json"),s&&a.searchParams.set("token",s);const r=await fetch(a.toString());if(!r.ok)throw new Error(`Failed to fetch service capabilities: ${r.statusText}`);const t=await r.json();if(t.error)throw new Error(`ArcGIS Error: ${t.error.message||"Unknown error"}`);return{serviceUrl:e,name:t.name||t.mapName||"Unnamed Service",description:t.description||t.serviceDescription||"",layerType:this.detectLayerType(e,t),spatialReference:t.spatialReference||{wkid:4326},extent:t.fullExtent||t.extent||{xmin:-180,ymin:-90,xmax:180,ymax:90},layers:t.layers||[],fields:t.fields||[],supportedOperations:this.detectSupportedOperations(t)}}catch(a){throw f.error("Error fetching ArcGIS service capabilities:",{error:a}),a}}detectLayerType(e,s){const a=e.toLowerCase();return a.includes("/featureserver/")?"feature":a.includes("/mapserver/")&&a.includes("/tile")?"tile":a.includes("/mapserver/")&&!s.tileInfo?"dynamic":a.includes("/imageserver/")?"image":a.includes("wms")?"wms":s.tileInfo?"tile":"Feature Layer"===s.type?"feature":"dynamic"}detectSupportedOperations(e){const s=[];if(e.capabilities){const a=e.capabilities.toLowerCase();a.includes("query")&&s.push("query"),a.includes("create")&&s.push("create"),a.includes("update")&&s.push("update"),a.includes("delete")&&s.push("delete"),a.includes("editing")&&s.push("editing")}return e.supportedQueryFormats&&s.push("query"),e.hasAttachments&&s.push("attachments"),s}async testServiceConnection(e,s){try{return await this.fetchServiceCapabilities(e,s),{success:!0,message:"Successfully connected to ArcGIS service"}}catch(a){return{success:!1,message:a instanceof Error?a.message:"Failed to connect to service"}}}buildQueryUrl(e,s={}){const a=new URL(e.replace(/\/$/,"")+"/query"),r={f:"json",where:"1=1",outFields:"*",returnGeometry:!0,spatialRel:"esriSpatialRelIntersects",...s};return Object.entries(r).forEach(([e,s])=>{a.searchParams.set(e,String(s))}),a.toString()}async queryFeatures(e,s={}){try{const a={where:s.where||"1=1",outFields:s.outFields?.join(",")||"*",returnGeometry:!1!==s.returnGeometry,spatialRel:s.spatialRel||"esriSpatialRelIntersects",f:"json"};s.geometry&&(a.geometry=JSON.stringify(s.geometry),a.geometryType="esriGeometryEnvelope"),s.token&&(a.token=s.token);const r=this.buildQueryUrl(e,a),t=await fetch(r);if(!t.ok)throw new Error(`Query failed: ${t.statusText}`);const i=await t.json();if(i.error)throw new Error(`ArcGIS Query Error: ${i.error.message}`);return i}catch(a){throw f.error("Error querying ArcGIS features:",{error:a}),a}}getTileUrl(e,s,a,r,t){let i=`${e.replace(/\/$/,"")}/tile/${s}/${a}/${r}`;return t&&(i+=`?token=${t}`),i}getExportImageUrl(e,s,a,r,t={}){const i=new URL(e.replace(/\/$/,"")+"/export");return i.searchParams.set("bbox",s.join(",")),i.searchParams.set("size",`${a},${r}`),i.searchParams.set("format",t.format||"png32"),i.searchParams.set("transparent",String(!1!==t.transparent)),i.searchParams.set("f","image"),i.searchParams.set("bboxSR","4326"),i.searchParams.set("imageSR","3857"),t.layers&&i.searchParams.set("layers",t.layers),t.layerDefs&&i.searchParams.set("layerDefs",t.layerDefs),t.token&&i.searchParams.set("token",t.token),i.toString()}convertExtentToBBox(e){return[e.xmin,e.ymin,e.xmax,e.ymax]}featureToGeoJSON(e){return{type:"Feature",geometry:this.geometryToGeoJSON(e.geometry),properties:e.attributes||{}}}geometryToGeoJSON(e){return e?void 0!==e.x&&void 0!==e.y?{type:"Point",coordinates:[e.x,e.y]}:e.paths?{type:1===e.paths.length?"LineString":"MultiLineString",coordinates:1===e.paths.length?e.paths[0]:e.paths}:e.rings?{type:1===e.rings.length?"Polygon":"MultiPolygon",coordinates:1===e.rings.length?[e.rings[0]]:[e.rings]}:{type:"Point",coordinates:[0,0]}:{type:"Point",coordinates:[0,0]}}};export{e as ArcGISIntegration};
