function e(){const e=x(),{isAdmin:X,isFleetManager:Z,canViewFinancial:ee}=G(),[se,re]=s.useState(new Set),[ae,ie]=s.useState(null),[ne,te]=s.useState("approve"),[le,ce]=s.useState(""),[de,oe]=s.useState(""),[me,ue]=s.useState(null),[xe,je]=s.useState("pending"),[he,pe]=s.useState("all"),[ve,ge]=s.useState("");if(!(X||Z||ee))return r.jsx("div",{className:"p-6",children:r.jsx(v,{children:r.jsxs(g,{children:[r.jsx(f,{children:"Access Restricted"}),r.jsx(y,{children:"You do not have permission to view the reimbursement queue."})]})})});const{data:fe,isLoading:ye,error:be}=j({queryKey:["reimbursement-queue",xe,he],queryFn:()=>U(`/api/reimbursements?${(()=>{const e=new URLSearchParams;return xe&&"all"!==xe&&e.append("status",xe),he&&"all"!==he&&e.append("category",he),e.toString()})()}`),staleTime:3e4,gcTime:6e4});s.useEffect(()=>{be&&(b.error("Failed to fetch queue:",be),p.error("Failed to load reimbursement queue"))},[be]);const{data:Ne}=j({queryKey:["reimbursement-summary"],queryFn:()=>U("/api/reimbursements/queue/pending"),staleTime:3e4,gcTime:6e4,enabled:"pending"===xe}),we=fe?.data||[],qe=Ne?.summary||null,Ce=(e,s)=>{ie(e),te(s),ce(""),oe(e.request_amount.toString())},{mutate:Ae}=h({mutationFn:async()=>{if(!ae)throw new Error("No request selected");const e="approve"===ne?`/api/reimbursements/${ae.id}/approve`:`/api/reimbursements/${ae.id}/reject`,s="approve"===ne?{approved_amount:parseFloat(de),reviewer_notes:le}:{reviewer_notes:le};return W(e,"PATCH",s)},onSuccess:()=>{p.success("approve"===ne?`Approved $${de}`:"Reimbursement rejected"),ie(null),e.invalidateQueries({queryKey:["reimbursement-queue"]}),e.invalidateQueries({queryKey:["reimbursement-summary"]})},onError:e=>{b.error("Failed to review request:",e),p.error(e instanceof Error?e.message:"Failed to review request")}}),{mutate:Se}=h({mutationFn:async()=>{if(0===se.size)throw new Error("No requests selected");const e=Array.from(se).map(e=>W(`/api/reimbursements/${e}/approve`,"PATCH",{}));await Promise.all(e)},onSuccess:()=>{p.success(`Approved ${se.size} requests`),re(new Set),e.invalidateQueries({queryKey:["reimbursement-queue"]}),e.invalidateQueries({queryKey:["reimbursement-summary"]})},onError:e=>{b.error("Bulk approve failed:",e),p.error("Some approvals failed")}}),Re=we.filter(e=>!(ve&&!e.driver_name.toLowerCase().includes(ve.toLowerCase()))),ke=e=>{const s={pending:{variant:"outline",icon:a,label:"Pending"},approved:{variant:"secondary",icon:t,label:"Approved"},rejected:{variant:"destructive",icon:u,label:"Rejected"},paid:{variant:"default",icon:m,label:"Paid"}},i=s[e]||s.pending;return r.jsxs($,{variant:i.variant,className:"gap-1",children:[r.jsx(i.icon,{className:"w-3 h-3"}),i.label]})};return r.jsxs("div",{className:"p-6 space-y-6",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold",children:"Reimbursement Queue"}),r.jsx("p",{className:"text-muted-foreground",children:"Review and process driver reimbursement requests"})]}),"pending"===xe&&qe&&r.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[r.jsxs(v,{children:[r.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[r.jsx(f,{className:"text-sm font-medium",children:"Pending Requests"}),r.jsx(a,{className:"h-4 w-4 text-muted-foreground"})]}),r.jsxs(N,{children:[r.jsx("div",{className:"text-2xl font-bold",children:qe.total_pending}),r.jsx("p",{className:"text-xs text-muted-foreground",children:"Awaiting review"})]})]}),r.jsxs(v,{children:[r.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[r.jsx(f,{className:"text-sm font-medium",children:"Total Amount"}),r.jsx(i,{className:"h-4 w-4 text-muted-foreground"})]}),r.jsxs(N,{children:[r.jsxs("div",{className:"text-2xl font-bold",children:["$",qe.total_amount.toFixed(2)]}),r.jsx("p",{className:"text-xs text-muted-foreground",children:"Pending approval"})]})]}),r.jsxs(v,{children:[r.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[r.jsx(f,{className:"text-sm font-medium",children:"Avg Days Pending"}),r.jsx(a,{className:"h-4 w-4 text-muted-foreground"})]}),r.jsxs(N,{children:[r.jsx("div",{className:"text-2xl font-bold",children:qe.avg_days_pending?.toFixed(1)||"0.0"}),r.jsx("p",{className:"text-xs text-muted-foreground",children:"Average wait time"})]})]})]}),r.jsxs(v,{children:[r.jsx(g,{children:r.jsxs(f,{className:"flex items-center gap-2",children:[r.jsx(n,{className:"w-5 h-5"}),"Filters & Actions"]})}),r.jsxs(N,{className:"space-y-4",children:[r.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx(D,{children:"Status"}),r.jsxs(T,{value:xe,onValueChange:je,children:[r.jsx(E,{children:r.jsx(M,{})}),r.jsxs(K,{children:[r.jsx(L,{value:"all",children:"All"}),r.jsx(L,{value:"pending",children:"Pending"}),r.jsx(L,{value:"approved",children:"Approved"}),r.jsx(L,{value:"rejected",children:"Rejected"}),r.jsx(L,{value:"paid",children:"Paid"})]})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(D,{children:"Category"}),r.jsxs(T,{value:he,onValueChange:pe,children:[r.jsx(E,{children:r.jsx(M,{})}),r.jsxs(K,{children:[r.jsx(L,{value:"all",children:"All"}),r.jsx(L,{value:"fuel",children:"Fuel"}),r.jsx(L,{value:"maintenance",children:"Maintenance"}),r.jsx(L,{value:"insurance",children:"Insurance"}),r.jsx(L,{value:"other",children:"Other"})]})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(D,{children:"Driver"}),r.jsx(w,{placeholder:"Search driver...",value:ve,onChange:e=>ge(e.target.value)})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(D,{className:"invisible",children:"Actions"}),r.jsx(q,{onClick:()=>e.invalidateQueries({queryKey:["reimbursement-queue"]}),variant:"outline",className:"w-full",children:"Refresh"})]})]}),se.size>0&&r.jsx("div",{className:"flex gap-2 items-center",children:r.jsx(C,{children:r.jsxs(A,{className:"flex items-center justify-between",children:[r.jsxs("span",{children:[se.size," requests selected"]}),r.jsxs("div",{className:"flex gap-2",children:[(X||Z)&&r.jsxs(q,{onClick:()=>{0!==se.size?Se():p.error("No requests selected")},size:"sm",children:[r.jsx(t,{className:"w-4 h-4 mr-2"}),"Bulk Approve"]}),r.jsx(q,{onClick:()=>re(new Set),variant:"outline",size:"sm",children:"Clear Selection"})]})]})})})]})]}),r.jsxs(v,{children:[r.jsxs(g,{children:[r.jsx(f,{children:"Reimbursement Requests"}),r.jsxs(y,{children:[Re.length," requests"]})]}),r.jsx(N,{children:ye?r.jsx("div",{className:"text-center py-8",children:"Loading..."}):0===Re.length?r.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No reimbursement requests found"}):r.jsxs(I,{children:[r.jsx(O,{children:r.jsxs(Q,{children:[r.jsx(B,{className:"w-12",children:r.jsx(P,{checked:se.size===Re.length,onCheckedChange:e=>(e=>{re(e?new Set(we.map(e=>e.id)):new Set)})(!0===e)})}),r.jsx(B,{children:"Driver"}),r.jsx(B,{children:"Amount"}),r.jsx(B,{children:"Category"}),r.jsx(B,{children:"Expense Date"}),r.jsx(B,{children:"Status"}),r.jsx(B,{children:"Submitted"}),r.jsx(B,{className:"text-right",children:"Actions"})]})}),r.jsx(V,{children:Re.map(e=>r.jsxs(Q,{children:[r.jsx(H,{children:r.jsx(P,{checked:se.has(e.id),onCheckedChange:s=>((e,s)=>{const r=new Set(se);s?r.add(e):r.delete(e),re(r)})(e.id,!0===s)})}),r.jsx(H,{children:e.driver_name}),r.jsxs(H,{children:["$",e.request_amount.toFixed(2)]}),r.jsx(H,{children:e.category||"N/A"}),r.jsx(H,{children:J(new Date(e.expense_date),"MMM d, yyyy")}),r.jsx(H,{children:ke(e.status)}),r.jsx(H,{children:J(new Date(e.submitted_at),"MMM d, yyyy")}),r.jsx(H,{className:"text-right",children:r.jsxs("div",{className:"flex items-center justify-end gap-2",children:[r.jsxs(q,{variant:"outline",size:"sm",onClick:()=>Ce(e,"approve"),disabled:"pending"!==e.status||!X&&!Z,children:[r.jsx(l,{className:"w-3 h-3 mr-1"}),"Approve"]}),r.jsxs(q,{variant:"outline",size:"sm",onClick:()=>Ce(e,"reject"),disabled:"pending"!==e.status||!X&&!Z,children:[r.jsx(c,{className:"w-3 h-3 mr-1"}),"Reject"]}),r.jsx(q,{variant:"ghost",size:"sm",onClick:()=>ue(e.receipt_file_path||null),disabled:!e.receipt_file_path,children:r.jsx(d,{className:"w-4 h-4"})})]})})]},e.id))})]})})]}),ae&&r.jsx(S,{open:!!ae,onOpenChange:()=>ie(null),children:r.jsxs(R,{className:"sm:max-w-[425px]",children:[r.jsxs(k,{children:[r.jsx(F,{children:"approve"===ne?"Approve Reimbursement":"Reject Reimbursement"}),r.jsx(_,{children:"approve"===ne?"Review and approve the reimbursement amount.":"Provide a reason for rejecting this reimbursement."})]}),r.jsxs("div",{className:"grid gap-4 py-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx(D,{children:"Driver"}),r.jsx(w,{value:ae.driver_name,disabled:!0})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(D,{children:"Requested Amount"}),r.jsx(w,{value:`$${ae.request_amount.toFixed(2)}`,disabled:!0})]}),"approve"===ne&&r.jsxs("div",{className:"space-y-2",children:[r.jsx(D,{children:"Approved Amount"}),r.jsx(w,{type:"number",value:de,onChange:e=>oe(e.target.value)})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs(D,{children:["Reviewer Notes ","reject"===ne&&r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx(Y,{placeholder:"approve"===ne?"Optional notes":"Reason for rejection",value:le,onChange:e=>ce(e.target.value)})]})]}),r.jsxs(z,{children:[r.jsx(q,{type:"button",variant:"secondary",onClick:()=>ie(null),children:"Cancel"}),r.jsx(q,{type:"submit",variant:"approve"===ne?"default":"destructive",onClick:()=>{ae&&("reject"!==ne||le.trim()?"approve"===ne&&parseFloat(de)>ae.request_amount?p.error("Approved amount cannot exceed requested amount"):Ae():p.error("Rejection reason is required"))},children:r.jsxs(r.Fragment,"approve"===ne?{children:[r.jsx(l,{className:"w-4 h-4 mr-2"}),"Approve"]}:{children:[r.jsx(c,{className:"w-4 h-4 mr-2"}),"Reject"]})})]})]})}),me&&r.jsx(S,{open:!!me,onOpenChange:()=>ue(null),children:r.jsxs(R,{className:"max-w-3xl",children:[r.jsx(k,{children:r.jsx(F,{children:"View Receipt"})}),r.jsx("div",{className:"py-4",children:r.jsx("img",{src:me,alt:"Receipt",className:"w-full h-auto max-h-[60vh] object-contain"})}),r.jsxs(z,{children:[r.jsx(q,{asChild:!0,children:r.jsxs("a",{href:me,download:!0,target:"_blank",rel:"noopener noreferrer",children:[r.jsx(o,{className:"w-4 h-4 mr-2"}),"Download"]})}),r.jsx(q,{type:"button",variant:"secondary",onClick:()=>ue(null),children:"Close"})]})]})})]})}import{r as s,j as r,as as a,cD as i,bt as n,ah as t,bY as l,bs as c,ae as d,bj as o,c6 as m,by as u}from"./react-core-hQu9tqS1.js";import{a as x,u as j,b as h}from"./query-vendor--Fe2N4Al.js";import{t as p}from"./index-savvei9t.js";import{C as v,d as g,e as f,i as y,p as b,f as N,I as w,h as q,A as C,w as A,D as S,j as R,k,l as F,m as _,n as z,B as $}from"./index-BDwglPMF.js";import{C as P}from"./checkbox-J0MWk58s.js";import{L as D}from"./label-C9sYRYKW.js";import{S as T,a as E,b as M,c as K,d as L}from"./select-Bmd3s7f4.js";import{T as I,a as O,b as Q,c as B,d as V,e as H}from"./table-_lE51wjz.js";import{T as Y}from"./textarea-BOBjqKNu.js";import{u as G}from"./usePermissions-CvNvsKyo.js";import{I as J}from"./date-vendor-npJ7nI92.js";import"./lazy-modules-Bs19xeuI.js";import"./form-vendor-DKCvS-hL.js";import"./chart-vendor-DWRb53_H.js";import"./utils-vendor-Bojdf5C8.js";import"./mui-core-BKffG9O1.js";import"./react-router-cBrq_s0x.js";import"./three-helpers-DedzJcO9.js";import"./three-core-ZrcxJ5g9.js";import"./three-react-B1s7Iy2r.js";import"./ui-radix-C-X5Qx_8.js";import"./ui-dialogs-C2yTnBPV.js";import"./animation-vendor-Cf_i_fm0.js";import"./ui-menus--48tEbqQ.js";const U=async e=>{const s=localStorage.getItem("token"),r=await fetch(e,{headers:{Authorization:`Bearer ${s}`}});if(!r.ok)throw new Error("Failed to fetch");return r.json()},W=async(e,s,r)=>{const a=localStorage.getItem("token"),i=await fetch(e,{method:s,headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:r?JSON.stringify(r):void 0});if(!i.ok){const e=await i.json();throw new Error(e.error||"Failed to perform action")}return i.json()};export{e as ReimbursementQueue};
