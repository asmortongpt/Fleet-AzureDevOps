function e(){const e=x(),[Q,X]=s.useState("all"),[Y,Z]=s.useState("all"),[ee,se]=s.useState(""),[ae,ie]=s.useState(!1),[re,ne]=s.useState({charge_id:"",invoice_number:"",invoice_date:(new Date).toISOString().split("T")[0],due_date:new Date(Date.now()+2592e6).toISOString().split("T")[0]}),{data:le,isLoading:te,error:ce}=m({queryKey:["personal-use-charges",Q,Y],queryFn:()=>W(`/api/personal-use-charges?${(()=>{const e=new URLSearchParams;return"all"!==Q&&e.append("charge_period",Q),"all"!==Y&&e.append("charge_status",Y),e.toString()})()}`),staleTime:3e4,gcTime:6e4});s.useEffect(()=>{ce&&(v.error("Failed to fetch charges:",ce),u.error("Failed to load billing data"))},[ce]);const{data:de}=m({queryKey:["personal-use-charges-summary"],queryFn:()=>W("/api/personal-use-charges/summary"),staleTime:3e4,gcTime:6e4}),oe=le?.data||[],he=de?.data||null,{mutate:xe,isPending:me}=j({mutationFn:async()=>H(`/api/personal-use-charges/${re.charge_id}`,"PATCH",{charge_status:"invoiced",invoice_number:re.invoice_number,invoice_date:re.invoice_date,due_date:re.due_date}),onSuccess:()=>{u.success(`Invoice ${re.invoice_number} generated`),ie(!1),e.invalidateQueries({queryKey:["personal-use-charges"]})},onError:e=>{v.error("Failed to generate invoice:",e),u.error(e instanceof Error?e.message:"Failed to generate invoice")}}),{mutate:je,isPending:ue}=j({mutationFn:async e=>H(`/api/personal-use-charges/${e}`,"PATCH",{charge_status:"paid",paid_at:(new Date).toISOString()}),onSuccess:()=>{u.success("Charge marked as paid"),e.invalidateQueries({queryKey:["personal-use-charges"]})},onError:e=>{v.error("Failed to mark as paid:",e),u.error("Failed to update charge status")}}),ve=oe.filter(e=>!(ee&&e.driver_name&&!e.driver_name.toLowerCase().includes(ee.toLowerCase()))),ge=e=>{const s={pending:{variant:"outline",icon:r,label:"Pending"},invoiced:{variant:"secondary",icon:n,label:"Invoiced"},billed:{variant:"default",icon:c,label:"Billed"},paid:{variant:"default",icon:l,label:"Paid"},waived:{variant:"secondary",icon:l,label:"Waived"}},i=s[e]||s.pending;return a.jsxs(A,{variant:i.variant,className:"gap-1",children:[a.jsx(i.icon,{className:"w-3 h-3"}),i.label]})};return a.jsxs("div",{className:"p-6 space-y-6",children:[a.jsxs("div",{children:[a.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[a.jsx(i,{className:"w-8 h-8"}),"Charges & Billing"]}),a.jsx("p",{className:"text-muted-foreground",children:"Manage personal use charges, invoicing, and payment tracking"})]}),he&&a.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[a.jsxs(g,{children:[a.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[a.jsx(f,{className:"text-sm font-medium",children:"Pending Charges"}),a.jsx(r,{className:"h-4 w-4 text-muted-foreground"})]}),a.jsxs(y,{children:[a.jsxs("div",{className:"text-2xl font-bold",children:["$",he.total_pending.toFixed(2)]}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Awaiting invoice"})]})]}),a.jsxs(g,{children:[a.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[a.jsx(f,{className:"text-sm font-medium",children:"Billed"}),a.jsx(n,{className:"h-4 w-4 text-muted-foreground"})]}),a.jsxs(y,{children:[a.jsxs("div",{className:"text-2xl font-bold",children:["$",he.total_billed.toFixed(2)]}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Invoiced, awaiting payment"})]})]}),a.jsxs(g,{children:[a.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[a.jsx(f,{className:"text-sm font-medium",children:"Paid"}),a.jsx(l,{className:"h-4 w-4 text-muted-foreground"})]}),a.jsxs(y,{children:[a.jsxs("div",{className:"text-2xl font-bold",children:["$",he.total_paid.toFixed(2)]}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Total collected"})]})]}),a.jsxs(g,{children:[a.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[a.jsx(f,{className:"text-sm font-medium",children:"Overdue"}),a.jsx(t,{className:"h-4 w-4 text-destructive"})]}),a.jsxs(y,{children:[a.jsxs("div",{className:"text-2xl font-bold text-destructive",children:["$",he.total_overdue.toFixed(2)]}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Past due date"})]})]})]}),a.jsxs(g,{children:[a.jsx(p,{children:a.jsx(f,{children:"Filters"})}),a.jsx(y,{className:"space-y-4",children:a.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(M,{children:"Billing Period"}),a.jsxs(L,{value:Q,onValueChange:X,children:[a.jsx(O,{children:a.jsx(q,{})}),a.jsxs(B,{children:[a.jsx(E,{value:"all",children:"All Periods"}),a.jsx(E,{value:V(new Date,"yyyy-MM"),children:"Current Month"}),a.jsx(E,{value:V(new Date(Date.now()-2592e6),"yyyy-MM"),children:"Last Month"})]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(M,{children:"Status"}),a.jsxs(L,{value:Y,onValueChange:Z,children:[a.jsx(O,{children:a.jsx(q,{})}),a.jsxs(B,{children:[a.jsx(E,{value:"all",children:"All Status"}),a.jsx(E,{value:"pending",children:"Pending"}),a.jsx(E,{value:"invoiced",children:"Invoiced"}),a.jsx(E,{value:"billed",children:"Billed"}),a.jsx(E,{value:"paid",children:"Paid"}),a.jsx(E,{value:"waived",children:"Waived"})]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(M,{children:"Driver"}),a.jsx(b,{placeholder:"Search driver...",value:ee,onChange:e=>se(e.target.value)})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(M,{className:"invisible",children:"Actions"}),a.jsx(N,{onClick:()=>e.invalidateQueries({queryKey:["personal-use-charges"]}),variant:"outline",className:"w-full",children:"Refresh"})]})]})})]}),a.jsxs(w,{defaultValue:"charges",children:[a.jsxs(_,{children:[a.jsxs(S,{value:"charges",children:[a.jsx(c,{className:"w-4 h-4 mr-2"}),"Charge Records"]}),a.jsxs(S,{value:"analytics",children:[a.jsx(d,{className:"w-4 h-4 mr-2"}),"Analytics"]})]}),a.jsx(C,{value:"charges",children:a.jsxs(g,{children:[a.jsxs(p,{children:[a.jsx(f,{children:"Charge Records"}),a.jsxs(D,{children:[ve.length," charges"]})]}),a.jsx(y,{children:te?a.jsx("div",{className:"text-center py-8",children:"Loading..."}):0===ve.length?a.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No charges found"}):a.jsxs(R,{children:[a.jsx(z,{children:a.jsxs(J,{children:[a.jsx(K,{children:"Driver"}),a.jsx(K,{children:"Period"}),a.jsx(K,{children:"Miles"}),a.jsx(K,{children:"Rate"}),a.jsx(K,{children:"Amount"}),a.jsx(K,{children:"Status"}),a.jsx(K,{children:"Invoice #"}),a.jsx(K,{children:"Due Date"}),a.jsx(K,{children:"Actions"})]})}),a.jsx(G,{children:ve.map(e=>{return a.jsxs(J,{className:(s=e.due_date,s&&new Date(s)<new Date?"bg-destructive/5":""),children:[a.jsx(U,{children:a.jsx("div",{className:"font-medium",children:e.driver_name||"Unknown Driver"})}),a.jsx(U,{children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(o,{className:"w-4 h-4 text-muted-foreground"}),e.charge_period]})}),a.jsx(U,{children:e.miles_charged}),a.jsxs(U,{children:["$",e.rate_per_mile.toFixed(2)]}),a.jsxs(U,{className:"font-medium",children:["$",e.total_charge.toFixed(2)]}),a.jsx(U,{children:ge(e.charge_status)}),a.jsx(U,{children:e.invoice_number||"-"}),a.jsx(U,{children:e.due_date||"-"}),a.jsx(U,{children:a.jsxs("div",{className:"flex items-center gap-2",children:["pending"===e.charge_status&&a.jsx(N,{size:"sm",variant:"outline",onClick:()=>(e=>{const s=`INV-${Date.now()}`;ne({charge_id:e.id,invoice_number:s,invoice_date:(new Date).toISOString().split("T")[0],due_date:new Date(Date.now()+2592e6).toISOString().split("T")[0]}),ie(!0)})(e),children:"Generate Invoice"}),"invoiced"===e.charge_status&&a.jsx(N,{size:"sm",variant:"outline",onClick:()=>je(e.id),disabled:ue,children:"Mark as Paid"}),e.invoice_number&&a.jsx(N,{size:"sm",variant:"ghost",onClick:()=>(async e=>{try{const s=localStorage.getItem("token"),a=await fetch(`/api/personal-use-charges/${e.id}/invoice`,{headers:{Authorization:`Bearer ${s}`}});if(!a.ok)throw new Error("Failed to download invoice");const i=await a.blob(),r=window.URL.createObjectURL(i),n=document.createElement("a");n.href=r,n.setAttribute("download",`${e.invoice_number||"invoice"}.pdf`),document.body.appendChild(n),n.click(),n.remove()}catch(s){v.error("Failed to download invoice:",s),u.error("Failed to download invoice")}})(e),children:a.jsx(h,{className:"w-4 h-4"})})]})})]},e.id);var s})})]})})]})}),a.jsxs(C,{value:"analytics",children:[a.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[a.jsxs(g,{children:[a.jsx(p,{children:a.jsx(f,{children:"Monthly Billing Trend"})}),a.jsx(y,{children:a.jsx("div",{className:"flex items-end justify-between h-40 gap-2",children:[2400,3200,2800,4100,3600,4500,3900,4200,5100,4800,5400,5800].map((e,s)=>a.jsxs("div",{className:"flex-1 flex flex-col items-center gap-1",children:[a.jsx("div",{className:"w-full bg-blue-500 rounded-t",style:{height:e/60+"px"}}),a.jsx("span",{className:"text-[9px] text-muted-foreground",children:["J","F","M","A","M","J","J","A","S","O","N","D"][s]})]},s))})})]}),a.jsxs(g,{children:[a.jsx(p,{children:a.jsx(f,{children:"Collection Rate"})}),a.jsx(y,{className:"space-y-4",children:[{label:"Paid on Time",value:78,color:"bg-green-500"},{label:"Paid Late",value:15,color:"bg-yellow-500"},{label:"Overdue",value:5,color:"bg-red-500"},{label:"Waived",value:2,color:"bg-gray-500"}].map(e=>a.jsxs("div",{className:"space-y-1",children:[a.jsxs("div",{className:"flex justify-between text-sm",children:[a.jsx("span",{children:e.label}),a.jsxs("span",{className:"font-medium",children:[e.value,"%"]})]}),a.jsx("div",{className:"w-full bg-accent/20 rounded-full h-2",children:a.jsx("div",{className:`${e.color} h-2 rounded-full`,style:{width:`${e.value}%`}})})]},e.label))})]})]}),a.jsxs(g,{className:"mt-4",children:[a.jsxs(p,{children:[a.jsx(f,{children:"Top Personal Use Drivers"}),a.jsx(D,{children:"Highest personal use charges this period"})]}),a.jsx(y,{children:a.jsxs(R,{children:[a.jsx(z,{children:a.jsxs(J,{children:[a.jsx(K,{children:"Driver"}),a.jsx(K,{children:"Total Miles"}),a.jsx(K,{children:"Total Charges"}),a.jsx(K,{children:"Status"})]})}),a.jsx(G,{children:[{name:"John Smith",miles:542,charges:270.45,status:"paid"},{name:"Maria Garcia",miles:428,charges:214,status:"invoiced"},{name:"James Wilson",miles:356,charges:178,status:"pending"},{name:"Sarah Johnson",miles:289,charges:144.5,status:"paid"}].map(e=>a.jsxs(J,{children:[a.jsx(U,{className:"font-medium",children:e.name}),a.jsx(U,{children:e.miles}),a.jsxs(U,{children:["$",e.charges.toFixed(2)]}),a.jsx(U,{children:ge(e.status)})]},e.name))})]})})]})]})]}),a.jsx(F,{open:ae,onOpenChange:ie,children:a.jsxs(I,{children:[a.jsxs(k,{children:[a.jsx(P,{children:"Generate Invoice"}),a.jsx(T,{children:"Create an invoice for this personal use charge."})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(M,{children:"Invoice Number"}),a.jsx(b,{value:re.invoice_number,onChange:e=>ne({...re,invoice_number:e.target.value})})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(M,{children:"Invoice Date"}),a.jsx(b,{type:"date",value:re.invoice_date,onChange:e=>ne({...re,invoice_date:e.target.value})})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(M,{children:"Due Date"}),a.jsx(b,{type:"date",value:re.due_date,onChange:e=>ne({...re,due_date:e.target.value})})]})]}),a.jsxs($,{children:[a.jsx(N,{variant:"outline",onClick:()=>ie(!1),children:"Cancel"}),a.jsx(N,{onClick:()=>{xe()},disabled:me,children:"Generate Invoice"})]})]})})]})}import{r as s,j as a,aK as i,as as r,aq as n,ah as l,C as t,cD as c,b5 as d,bq as o,bj as h}from"./react-core-hQu9tqS1.js";import{a as x,u as m,b as j}from"./query-vendor--Fe2N4Al.js";import{t as u}from"./index-savvei9t.js";import{p as v,C as g,d as p,e as f,f as y,I as b,h as N,T as w,a as _,b as S,c as C,i as D,D as F,j as I,k,l as P,m as T,n as $,B as A}from"./index-BDwglPMF.js";import{L as M}from"./label-C9sYRYKW.js";import{S as L,a as O,b as q,c as B,d as E}from"./select-Bmd3s7f4.js";import{T as R,a as z,b as J,c as K,d as G,e as U}from"./table-_lE51wjz.js";import{I as V}from"./date-vendor-npJ7nI92.js";import"./lazy-modules-Bs19xeuI.js";import"./form-vendor-DKCvS-hL.js";import"./chart-vendor-DWRb53_H.js";import"./utils-vendor-Bojdf5C8.js";import"./mui-core-BKffG9O1.js";import"./react-router-cBrq_s0x.js";import"./three-helpers-DedzJcO9.js";import"./three-core-ZrcxJ5g9.js";import"./three-react-B1s7Iy2r.js";import"./ui-radix-C-X5Qx_8.js";import"./ui-dialogs-C2yTnBPV.js";import"./animation-vendor-Cf_i_fm0.js";import"./ui-menus--48tEbqQ.js";const W=async e=>{const s=localStorage.getItem("token"),a=await fetch(e,{headers:{Authorization:`Bearer ${s}`}});if(!a.ok)throw new Error("Failed to fetch");return a.json()},H=async(e,s,a)=>{const i=localStorage.getItem("token"),r=await fetch(e,{method:s,headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:a?JSON.stringify(a):void 0});if(!r.ok){const e=await r.json();throw new Error(e.error||"Failed to perform action")}return r.json()};export{e as ChargesAndBilling};
