# Fleet Management Multi-Agent Orchestration Configuration
# This config defines quality gates, deployment commands, and verification endpoints

# Agent Configuration
agents:
  orchestrator:
    max_iterations: 10
    max_no_progress_iterations: 3
    log_file: "logs/orchestrator.log"
    dry_run: false  # Set to true for testing without executing commands

  codex:
    model: "gpt-4"
    temperature: 0.2
    max_tokens: 4000
    system_prompt: |
      You are CodexAgent, an expert DevOps engineer specializing in Azure deployments.
      Your task is to analyze errors and generate unified git patches that fix issues.

      Key principles:
      - Never delete Azure resources
      - Never rotate secrets
      - Prefer minimal, surgical changes
      - Always use Azure CLI auth (no Docker service connections)
      - Focus on build/deployment failures
      - Generate patches in unified diff format

      Current context:
      - Stack: React + Vite (Node 20), Nginx, Docker
      - Registry: fleetproductionacr.azurecr.io
      - Deploy: Azure Kubernetes Service (AKS)
      - Common issue: ACR build OOM (4GB limit) -> use Azure DevOps hosted agents (7GB)

  jules:
    model: "gpt-4"
    temperature: 0.1
    max_tokens: 2000
    system_prompt: |
      You are JulesAgent, a senior code reviewer focused on security and best practices.
      Your task is to review patches and approve/reject them with clear reasoning.

      Approval criteria:
      - No hardcoded secrets
      - Parameterized queries only ($1,$2,$3)
      - No security header removals
      - No unsafe shell commands
      - Changes are minimal and targeted
      - Follows project conventions

      Rejection criteria:
      - Security vulnerabilities introduced
      - Breaks existing functionality
      - Overly broad changes
      - Missing safety mechanisms

      Respond with: APPROVE or REJECT followed by your reasoning.

# Quality Gates (must pass before proceeding)
quality_gates:
  install:
    command: "npm install --legacy-peer-deps"
    timeout: 600  # 10 minutes
    required: true

  lint:
    command: "npm run lint"
    timeout: 180  # 3 minutes
    required: true

  test:
    command: "npm run test:smoke"
    timeout: 300  # 5 minutes
    required: false  # Optional - don't block on test failures

  build:
    command: "npm run build"
    timeout: 900  # 15 minutes
    required: true

# Deployment Configuration
deployment:
  environments:
    staging:
      name: "staging"
      namespace: "fleet-management-staging"
      registry: "fleetproductionacr.azurecr.io"
      image_name: "fleet-frontend"
      health_endpoint: "https://fleet-staging.capitaltechalliance.com/health"
      verification_endpoints:
        - url: "https://fleet-staging.capitaltechalliance.com"
          expected_status: 200
          timeout: 10
        - url: "https://fleet-staging.capitaltechalliance.com/api/health"
          expected_status: 200
          timeout: 5

    prod:
      name: "prod"
      namespace: "fleet-management"
      registry: "fleetproductionacr.azurecr.io"
      image_name: "fleet-frontend"
      health_endpoint: "https://fleet.capitaltechalliance.com/health"
      require_manual_approval: true
      verification_endpoints:
        - url: "https://fleet.capitaltechalliance.com"
          expected_status: 200
          timeout: 10
        - url: "https://fleet.capitaltechalliance.com/api/health"
          expected_status: 200
          timeout: 5

# Azure Configuration
azure:
  subscription_id: "${AZURE_SUBSCRIPTION_ID}"  # Optional, falls back to az cli default
  resource_group: "fleet-production"
  aks_cluster: "fleet-aks-cluster"
  acr_name: "fleetproductionacr"

  # Azure CLI commands
  commands:
    login_check: "az account show"
    acr_login: "az acr login --name fleetproductionacr"
    aks_credentials: "az aks get-credentials --resource-group fleet-production --name fleet-aks-cluster"
    acr_build: "az acr build --registry fleetproductionacr --image {image_name}:{tag} --file Dockerfile ."

# Docker Build Configuration
docker:
  # Use Azure DevOps hosted agents instead of ACR build for large builds
  use_devops_agent: true
  devops_agent_memory: "7GB"
  acr_build_memory: "4GB"  # Known limit that causes SIGKILL

  build_args:
    - "CACHE_BUST=$(Build.BuildId)"

  # Build strategy selection
  strategy:
    # If build size > 3GB, use DevOps hosted agent
    size_threshold_gb: 3.0
    # If ACR build fails with SIGKILL, auto-switch to DevOps agent
    auto_switch_on_oom: true

# Kubernetes Configuration
kubernetes:
  apply_timeout: 300
  rollout_timeout: 600

  # Health check configuration
  health_checks:
    initial_delay: 30
    interval: 10
    max_attempts: 30

  # Pod selector labels
  selectors:
    staging: "app=fleet-frontend,environment=staging"
    prod: "app=fleet-frontend,environment=prod"

# Verification Configuration
verification:
  smoke_tests:
    script: "scripts/smoke_test.sh"
    timeout: 120

  health_checks:
    retries: 5
    retry_delay: 10

  critical_flows:
    - name: "Homepage Load"
      endpoint: "/"
      expected_status: 200

    - name: "API Health"
      endpoint: "/api/health"
      expected_status: 200

    - name: "Static Assets"
      endpoint: "/assets/index.js"
      expected_status: 200

# Safety Configuration
safety:
  # Operations that require explicit approval
  require_approval:
    - "delete"
    - "drop"
    - "remove_resource"
    - "rotate_secret"

  # Blacklisted commands
  forbidden_commands:
    - "rm -rf /"
    - "kubectl delete namespace"
    - "az group delete"
    - "DROP DATABASE"

  # Git safety
  git:
    require_clean_state: true
    create_backup_branch: true
    backup_prefix: "backup/pre-orchestration"

  # Maximum changes per iteration
  max_files_changed: 10
  max_lines_changed: 500

# Logging Configuration
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

  # Log to both file and console
  handlers:
    - type: "file"
      path: "logs/orchestrator.log"
      max_bytes: 10485760  # 10MB
      backup_count: 5

    - type: "console"
      stream: "stdout"

# Notification Configuration (optional)
notifications:
  enabled: false
  channels:
    - type: "email"
      recipients: ["andrew.m@capitaltechalliance.com"]
      on_events: ["failure", "success"]
