import express, { Request, Response } from 'express'
import jwt from 'jsonwebtoken'
import { exchangeMicrosoftCode, getMicrosoftUserInfo, findOrCreateUserFromMicrosoft } from '../middleware/microsoft-auth'
import { createAuditLog } from '../middleware/audit'

const router = express.Router()

/**
 * @openapi
 * /api/auth/microsoft/callback:
 *   get:
 *     summary: Microsoft OAuth callback endpoint
 *     description: Handles the OAuth callback from Microsoft Azure AD and creates/links user accounts
 *     tags:
 *       - Authentication
 *     parameters:
 *       - in: query
 *         name: code
 *         required: true
 *         schema:
 *           type: string
 *         description: Authorization code from Microsoft
 *       - in: query
 *         name: state
 *         schema:
 *           type: string
 *         description: Optional tenant ID for multi-tenant applications
 *       - in: query
 *         name: error
 *         schema:
 *           type: string
 *         description: Error code if authentication failed
 *       - in: query
 *         name: error_description
 *         schema:
 *           type: string
 *         description: Error description if authentication failed
 *     responses:
 *       302:
 *         description: Redirects to frontend with JWT token or error
 *       400:
 *         description: Missing authorization code
 *       500:
 *         description: Authentication failed
 */
router.get('/microsoft/callback', async (req: Request, res: Response) => {
  try {
    const { code, state, error, error_description } = req.query

    // Handle OAuth errors
    if (error) {
      console.error('Microsoft OAuth error:', error, error_description)
      const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173'
      return res.redirect(`${frontendUrl}/login?error=${error}&error_description=${encodeURIComponent(error_description as string || '')}`)
    }

    if (!code) {
      return res.status(400).json({ error: 'Authorization code required' })
    }

    // Determine redirect URI based on request origin
    let redirectUri: string
    const origin = req.headers.origin || req.headers.referer

    if (origin?.includes('localhost')) {
      redirectUri = 'http://localhost:5173/auth/callback'
    } else if (origin?.includes('68.220.148.2')) {
      redirectUri = 'http://68.220.148.2/auth/callback'
    } else {
      // Default to environment variable or localhost
      redirectUri = process.env.AZURE_AD_REDIRECT_URI || 'http://localhost:5173/auth/callback'
    }

    console.log('Microsoft auth callback - using redirect URI:', redirectUri)

    // Exchange code for tokens
    const tokens = await exchangeMicrosoftCode(code as string, redirectUri)

    // Get user info from Microsoft Graph
    const userInfo = await getMicrosoftUserInfo(tokens.access_token)

    // Parse state to get tenant_id (or use default demo tenant)
    const tenantId = (state as string) || '11111111-1111-1111-1111-111111111111'

    // Find or create user
    const user = await findOrCreateUserFromMicrosoft(userInfo, tenantId)

    // Generate JWT token
    const jwtToken = jwt.sign(
      {
        id: user.id,
        email: user.email,
        role: user.role,
        tenant_id: user.tenant_id,
        microsoft_id: user.microsoft_id,
        auth_provider: 'microsoft'
      },
      process.env.JWT_SECRET || 'changeme',
      { expiresIn: '24h' }
    )

    // Create audit log
    await createAuditLog(
      user.tenant_id,
      user.id,
      'LOGIN',
      'users',
      user.id,
      {
        email: user.email,
        provider: 'microsoft',
        microsoft_id: user.microsoft_id
      },
      req.ip || null,
      req.get('User-Agent') || null,
      'success',
      'Microsoft SSO login successful'
    )

    // Redirect to frontend with token
    const frontendUrl = redirectUri.replace('/auth/callback', '')
    res.redirect(`${frontendUrl}/auth/success?token=${jwtToken}`)
  } catch (error: any) {
    console.error('Microsoft auth callback error:', error)

    // Create audit log for failed attempt
    try {
      await createAuditLog(
        null,
        null,
        'LOGIN',
        'users',
        null,
        {
          provider: 'microsoft',
          error: error.message
        },
        req.ip || null,
        req.get('User-Agent') || null,
        'failure',
        `Microsoft SSO login failed: ${error.message}`
      )
    } catch (auditError) {
      console.error('Failed to create audit log:', auditError)
    }

    const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173'
    res.redirect(`${frontendUrl}/login?error=auth_failed&message=${encodeURIComponent(error.message)}`)
  }
})

/**
 * @openapi
 * /api/auth/microsoft/login:
 *   get:
 *     summary: Get Microsoft login URL
 *     description: Returns the Microsoft OAuth authorization URL for client-side redirects
 *     tags:
 *       - Authentication
 *     parameters:
 *       - in: query
 *         name: tenant_id
 *         schema:
 *           type: string
 *         description: Optional tenant ID for multi-tenant applications
 *       - in: query
 *         name: redirect_uri
 *         schema:
 *           type: string
 *         description: Custom redirect URI (must be registered in Azure AD)
 *     responses:
 *       200:
 *         description: Microsoft login URL
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 login_url:
 *                   type: string
 *                   description: Microsoft OAuth authorization URL
 */
router.get('/microsoft/login', (req: Request, res: Response) => {
  const { tenant_id, redirect_uri } = req.query

  const clientId = process.env.AZURE_CLIENT_ID || '80fe6628-1dc4-41fe-894f-919b12ecc994'
  const tenantId = process.env.AZURE_TENANT_ID || '0ec14b81-7b82-45ee-8f3d-cbc31ced5347'
  const redirectUri = (redirect_uri as string) || process.env.AZURE_AD_REDIRECT_URI || 'http://localhost:5173/auth/callback'

  const params = new URLSearchParams({
    client_id: clientId,
    response_type: 'code',
    redirect_uri: redirectUri,
    response_mode: 'query',
    scope: 'openid profile email User.Read',
    state: (tenant_id as string) || '11111111-1111-1111-1111-111111111111',
    prompt: 'select_account'
  })

  const loginUrl = `https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/authorize?${params}`

  res.json({ login_url: loginUrl })
})

export default router
