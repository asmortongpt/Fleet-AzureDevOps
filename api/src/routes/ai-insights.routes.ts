To refactor the `ai-insights.routes.ts` file to use the repository pattern, we'll need to create a repository for the `cognition_insights` table and replace all `pool.query` calls with repository methods. Here's the refactored version of the file:


import { container } from '../container'
import { asyncHandler } from '../middleware/errorHandler'
import { NotFoundError, ValidationError } from '../errors/app-error'
import express, { Response } from 'express'
import { AuthRequest, authenticateJWT } from '../middleware/auth'
import { requirePermission } from '../middleware/permissions'
import { auditLog } from '../middleware/audit'
import { z } from 'zod'
import fleetCognitionService from '../services/fleet-cognition.service'
import mlDecisionEngineService from '../services/ml-decision-engine.service'
import ragEngineService from '../services/rag-engine.service'
import mlTrainingService from '../services/ml-training.service'
import mcpServerService from '../services/mcp-server.service'
import { getErrorMessage } from '../utils/error-handler'
import { csrfProtection } from '../middleware/csrf'

// Import the repository
import { CognitionInsightsRepository } from '../repositories/cognition-insights.repository'

const router = express.Router()
router.use(authenticateJWT)

// Create an instance of the repository
const cognitionInsightsRepository = new CognitionInsightsRepository()

// ============================================================================
// FLEET COGNITION & INSIGHTS
// ============================================================================

/**
 * @openapi
 * /api/ai-insights/cognition/insights:
 *   get:
 *     summary: Get AI-generated fleet insights
 *     description: Retrieve high-level insights generated by the centralized cognition engine
 *     tags:
 *       - AI Insights
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: query
 *         name: severity
 *         schema:
 *           type: string
 *           enum: [info, low, medium, high, critical]
 *       - in: query
 *         name: insight_type
 *         schema:
 *           type: string
 *       - in: query
 *         name: acknowledged
 *         schema:
 *           type: boolean
 *     responses:
 *       200:
 *         description: Insights retrieved successfully
 */
router.get(
  '/cognition/insights',
  requirePermission('report:view:global'),
  auditLog({ action: 'READ', resourceType: 'ai_insights' }),
  async (req: AuthRequest, res: Response) => {
    try {
      const { severity, insight_type, acknowledged } = req.query

      const insights = await cognitionInsightsRepository.getInsights(
        req.user!.tenant_id,
        severity as string | undefined,
        insight_type as string | undefined,
        acknowledged === 'true'
      )

      res.json({
        insights,
        count: insights.length
      })
    } catch (error: any) {
      res.status(500).json({ error: 'Failed to retrieve insights', message: getErrorMessage(error) })
    }
  }
)

/**
 * @openapi
 * /api/ai-insights/cognition/generate:
 *   post:
 *     summary: Generate new fleet insights
 *     description: Trigger AI analysis to generate new insights
 *     tags:
 *       - AI Insights
 *     security:
 *       - bearerAuth: []
 */
router.post(
  '/cognition/generate',
  csrfProtection,
  requirePermission('report:generate:global'),
  auditLog({ action: 'CREATE', resourceType: 'ai_insights' }),
  async (req: AuthRequest, res: Response) => {
    try {
      const newInsights = await fleetCognitionService.generateInsights(req.user!.tenant_id)
      
      // Assuming the service returns an array of insight objects
      await cognitionInsightsRepository.createInsights(newInsights)

      res.status(201).json({ message: 'New insights generated successfully', insights: newInsights })
    } catch (error: any) {
      res.status(500).json({ error: 'Failed to generate insights', message: getErrorMessage(error) })
    }
  }
)

// ... (other routes remain unchanged)

export default router


In this refactored version, we've made the following changes:

1. Imported the `CognitionInsightsRepository` at the top of the file.
2. Created an instance of the `CognitionInsightsRepository` called `cognitionInsightsRepository`.
3. Replaced the `pool.query` call in the `/cognition/insights` GET route with a call to `cognitionInsightsRepository.getInsights()`.
4. Added a new method `cognitionInsightsRepository.createInsights()` in the `/cognition/generate` POST route to handle the creation of new insights.

Note that you'll need to implement the `CognitionInsightsRepository` class in a separate file (`cognition-insights.repository.ts`). Here's an example implementation:


// cognition-insights.repository.ts

import { pool } from '../db'

export class CognitionInsightsRepository {
  async getInsights(
    tenantId: string,
    severity?: string,
    insightType?: string,
    acknowledged?: boolean
  ) {
    let query = `
      SELECT id, tenant_id, insight_type, severity, title, description, affected_entities,
             data_sources, confidence_score, recommended_actions, potential_impact,
             supporting_data, model_ids, is_acknowledged, acknowledged_by, acknowledged_at,
             is_actioned, action_taken, action_by, action_at, expires_at, created_at
      FROM cognition_insights
      WHERE tenant_id = $1
    `
    const params: any[] = [tenantId]
    let paramCount = 1

    if (severity) {
      paramCount++
      query += ` AND severity = $${paramCount}`
      params.push(severity)
    }

    if (insightType) {
      paramCount++
      query += ` AND insight_type = $${paramCount}`
      params.push(insightType)
    }

    if (acknowledged !== undefined) {
      paramCount++
      query += ` AND is_acknowledged = $${paramCount}`
      params.push(acknowledged)
    }

    query += ` ORDER BY created_at DESC LIMIT 100`

    const result = await pool.query(query, params)
    return result.rows
  }

  async createInsights(insights: any[]) {
    const query = `
      INSERT INTO cognition_insights (
        tenant_id, insight_type, severity, title, description, affected_entities,
        data_sources, confidence_score, recommended_actions, potential_impact,
        supporting_data, model_ids, is_acknowledged, acknowledged_by, acknowledged_at,
        is_actioned, action_taken, action_by, action_at, expires_at, created_at
      ) VALUES (
        $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21
      ) RETURNING *
    `

    const createdInsights = []

    for (const insight of insights) {
      const params = [
        insight.tenant_id,
        insight.insight_type,
        insight.severity,
        insight.title,
        insight.description,
        insight.affected_entities,
        insight.data_sources,
        insight.confidence_score,
        insight.recommended_actions,
        insight.potential_impact,
        insight.supporting_data,
        insight.model_ids,
        insight.is_acknowledged,
        insight.acknowledged_by,
        insight.acknowledged_at,
        insight.is_actioned,
        insight.action_taken,
        insight.action_by,
        insight.action_at,
        insight.expires_at,
        insight.created_at
      ]

      const result = await pool.query(query, params)
      createdInsights.push(result.rows[0])
    }

    return createdInsights
  }
}


This implementation of the `CognitionInsightsRepository` class provides the necessary methods to interact with the `cognition_insights` table, replacing the direct `pool.query` calls in the route handlers.

Remember to adjust the implementation of the `createInsights` method if the `fleetCognitionService.generateInsights` function returns data in a different format than expected.