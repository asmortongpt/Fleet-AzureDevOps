import { container } from '../container'
import { asyncHandler } from '../middleware/errorHandler'
import { NotFoundError, ValidationError } from '../errors/app-error'
import express, { Response } from 'express'
import { AuthRequest, authenticateJWT } from '../middleware/auth'
import { requirePermission } from '../middleware/permissions'
import { auditLog } from '../middleware/audit'
import { z } from 'zod'
import fleetCognitionService from '../services/fleet-cognition.service'
import mlDecisionEngineService from '../services/ml-decision-engine.service'
import ragEngineService from '../services/rag-engine.service'
import mlTrainingService from '../services/ml-training.service'
import mcpServerService from '../services/mcp-server.service'
import { getErrorMessage } from '../utils/error-handler'
import { csrfProtection } from '../middleware/csrf'
import { aiProcessingLimiter } from '../middleware/rateLimiter'

// Import the repository
import { CognitionInsightsRepository } from '../repositories/cognition-insights.repository'

const router = express.Router()
router.use(authenticateJWT)

// Create an instance of the repository
const cognitionInsightsRepository = new CognitionInsightsRepository()

// ============================================================================
// FLEET COGNITION & INSIGHTS
// ============================================================================

/**
 * @openapi
 * /api/ai-insights/cognition/insights:
 *   get:
 *     summary: Get AI-generated fleet insights
 *     description: Retrieve high-level insights generated by the centralized cognition engine
 *     tags:
 *       - AI Insights
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: query
 *         name: severity
 *         schema:
 *           type: string
 *           enum: [info, low, medium, high, critical]
 *       - in: query
 *         name: insight_type
 *         schema:
 *           type: string
 *       - in: query
 *         name: acknowledged
 *         schema:
 *           type: boolean
 *     responses:
 *       200:
 *         description: Insights retrieved successfully
 */
router.get(
  '/cognition/insights',
  requirePermission('report:view:global'),
  auditLog({ action: 'READ', resourceType: 'ai_insights' }),
  async (req: AuthRequest, res: Response) => {
    try {
      const { severity, insight_type, acknowledged } = req.query

      const insights = await cognitionInsightsRepository.getInsights(
        req.user!.tenant_id,
        severity as string | undefined,
        insight_type as string | undefined,
        acknowledged === 'true'
      )

      res.json({
        insights,
        count: insights.length
      })
    } catch (error: any) {
      res.status(500).json({ error: 'Failed to retrieve insights', message: getErrorMessage(error) })
    }
  }
)

/**
 * @openapi
 * /api/ai-insights/cognition/generate:
 *   post:
 *     summary: Generate new fleet insights
 *     description: Trigger AI analysis to generate new insights
 *     tags:
 *       - AI Insights
 *     security:
 *       - bearerAuth: []
 */
router.post(
  '/cognition/generate',
  aiProcessingLimiter,
  csrfProtection,
  requirePermission('report:generate:global'),
  auditLog({ action: 'CREATE', resourceType: 'ai_insights' }),
  async (req: AuthRequest, res: Response) => {
    try {
      const newInsights = await fleetCognitionService.generateInsights(req.user!.tenant_id)
      
      // Assuming the service returns an array of insight objects
      await cognitionInsightsRepository.createInsights(newInsights)

      res.status(201).json({ message: 'New insights generated successfully', insights: newInsights })
    } catch (error: any) {
      res.status(500).json({ error: 'Failed to generate insights', message: getErrorMessage(error) })
    }
  }
)

/**
 * @openapi
 * /api/ai-insights/cognition/insights/{id}:
 *   put:
 *     summary: Acknowledge an insight
 *     description: Mark an insight as acknowledged
 *     tags:
 *       - AI Insights
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *     responses:
 *       200:
 *         description: Insight acknowledged successfully
 *       404:
 *         description: Insight not found
 */
router.put(
  '/cognition/insights/:id',
  csrfProtection,
  requirePermission('report:update:global'),
  auditLog({ action: 'UPDATE', resourceType: 'ai_insights' }),
  async (req: AuthRequest, res: Response) => {
    try {
      const { id } = req.params

      const updatedInsight = await cognitionInsightsRepository.acknowledgeInsight(id, req.user!.tenant_id)

      if (!updatedInsight) {
        throw new NotFoundError('Insight not found')
      }

      res.json({ message: 'Insight acknowledged successfully', insight: updatedInsight })
    } catch (error: any) {
      if (error instanceof NotFoundError) {
        res.status(404).json({ error: error.message })
      } else {
        res.status(500).json({ error: 'Failed to acknowledge insight', message: getErrorMessage(error) })
      }
    }
  }
)

export default router