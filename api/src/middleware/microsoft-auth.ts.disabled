import { Request, Response, NextFunction } from 'express'
import axios from 'axios'
import jwt from 'jsonwebtoken'
import pool from '../config/database'

interface MicrosoftTokenResponse {
  access_token: string
  id_token: string
  token_type: string
  expires_in: number
  refresh_token?: string
}

interface MicrosoftUserInfo {
  sub?: string
  id?: string
  name: string
  email?: string
  preferred_username?: string
  userPrincipalName?: string
  displayName?: string
  givenName?: string
  surname?: string
}

/**
 * Exchange Microsoft authorization code for access tokens
 */
export async function exchangeMicrosoftCode(code: string, redirectUri: string): Promise<MicrosoftTokenResponse> {
  const tokenEndpoint = `https://login.microsoftonline.com/${process.env.AZURE_TENANT_ID}/oauth2/v2.0/token`

  const params = new URLSearchParams({
    client_id: process.env.AZURE_CLIENT_ID!,
    client_secret: process.env.AZURE_CLIENT_SECRET!,
    code,
    redirect_uri: redirectUri,
    grant_type: 'authorization_code',
    scope: 'openid profile email User.Read'
  })

  try {
    const response = await axios.post<MicrosoftTokenResponse>(tokenEndpoint, params, {
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    })
    return response.data
  } catch (error: any) {
    console.error('Microsoft token exchange error:', error.response?.data || error.message)
    throw new Error(`Failed to exchange authorization code: ${error.response?.data?.error_description || error.message}`)
  }
}

/**
 * Get Microsoft user information using access token
 */
export async function getMicrosoftUserInfo(accessToken: string): Promise<MicrosoftUserInfo> {
  try {
    const response = await axios.get('https://graph.microsoft.com/v1.0/me', {
      headers: {
        Authorization: `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      }
    })
    return response.data
  } catch (error: any) {
    console.error('Microsoft user info error:', error.response?.data || error.message)
    throw new Error(`Failed to get user info: ${error.response?.data?.error?.message || error.message}`)
  }
}

/**
 * Find or create user from Microsoft account information
 */
export async function findOrCreateUserFromMicrosoft(
  userInfo: MicrosoftUserInfo,
  tenantId: string
): Promise<any> {
  // Extract email - try multiple fields
  const email = (userInfo.email || userInfo.preferred_username || userInfo.userPrincipalName)?.toLowerCase()
  const microsoftId = userInfo.sub || userInfo.id
  const displayName = userInfo.displayName || userInfo.name
  const firstName = userInfo.givenName || displayName?.split(' ')[0] || 'User'
  const lastName = userInfo.surname || displayName?.split(' ').slice(1).join(' ') || ''

  if (!email) {
    throw new Error('Could not extract email from Microsoft user info')
  }

  if (!microsoftId) {
    throw new Error('Could not extract user ID from Microsoft user info')
  }

  // First, try to find user by microsoft_id
  const userByMsId = await pool.query(
    'SELECT * FROM users WHERE microsoft_id = $1',
    [microsoftId]
  )

  if (userByMsId.rows.length > 0) {
    // Update last login
    await pool.query(
      'UPDATE users SET last_login_at = NOW() WHERE id = $1',
      [userByMsId.rows[0].id]
    )
    return userByMsId.rows[0]
  }

  // Check if user exists by email
  const existingUser = await pool.query(
    'SELECT * FROM users WHERE email = $1 AND tenant_id = $2',
    [email, tenantId]
  )

  if (existingUser.rows.length > 0) {
    // Link Microsoft account to existing user
    await pool.query(
      'UPDATE users SET microsoft_id = $1, last_login_at = NOW() WHERE id = $2',
      [microsoftId, existingUser.rows[0].id]
    )
    return { ...existingUser.rows[0], microsoft_id: microsoftId }
  }

  // Create new user
  try {
    const result = await pool.query(
      `INSERT INTO users (
        tenant_id, email, microsoft_id, first_name, last_name, role, is_active, last_login_at
      ) VALUES ($1, $2, $3, $4, $5, 'viewer', true, NOW())
      RETURNING *`,
      [tenantId, email, microsoftId, firstName, lastName]
    )

    return result.rows[0]
  } catch (error: any) {
    console.error('Error creating user from Microsoft account:', error)
    throw new Error(`Failed to create user: ${error.message}`)
  }
}

/**
 * Middleware to verify Microsoft authentication
 */
export async function verifyMicrosoftAuth(req: Request, res: Response, next: NextFunction) {
  try {
    const authHeader = req.headers.authorization
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({ error: 'No authorization token provided' })
    }

    const token = authHeader.substring(7)

    // Verify JWT token
    const decoded = jwt.verify(token, process.env.JWT_SECRET || 'changeme') as any

    // Attach user info to request
    req.user = decoded

    next()
  } catch (error: any) {
    console.error('Microsoft auth verification error:', error.message)
    return res.status(401).json({ error: 'Invalid or expired token' })
  }
}
