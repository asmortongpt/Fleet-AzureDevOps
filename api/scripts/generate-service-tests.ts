#!/usr/bin/env tsx
/**
 * Test Generator Script
 * Automatically generates comprehensive unit tests for all services
 * Agent 5: Test Coverage & QA Specialist
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

interface ServiceMethod {
  name: string;
  params: string[];
  isAsync: boolean;
}

interface ServiceInfo {
  fileName: string;
  className: string;
  methods: ServiceMethod[];
}

function analyzeServiceFile(filePath: string): ServiceInfo | null {
  const content = fs.readFileSync(filePath, 'utf-8');
  const fileName = path.basename(filePath);

  // Extract class name
  const classMatch = content.match(/export\s+class\s+(\w+)/);
  if (!classMatch) {
    console.log(`  ‚ö†Ô∏è  No class found in ${fileName}`);
    return null;
  }

  const className = classMatch[1];

  // Extract methods
  const methods: ServiceMethod[] = [];
  const methodRegex = /(async\s+)?(\w+)\s*\([^)]*\)\s*[:{\s]/g;
  let match;

  while ((match = methodRegex.exec(content)) !== null) {
    const isAsync = !!match[1];
    const methodName = match[2];

    // Skip constructor and private methods
    if (methodName === 'constructor' || methodName.startsWith('_')) {
      continue;
    }

    methods.push({
      name: methodName,
      params: [], // We'll keep this simple for now
      isAsync
    });
  }

  return {
    fileName,
    className,
    methods
  };
}

function generateTestFile(serviceInfo: ServiceInfo): string {
  const { fileName, className, methods } = serviceInfo;
  const servicePath = `../services/${fileName}`;

  return `import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { ${className} } from '${servicePath.replace('.ts', '')}';

/**
 * Unit tests for ${className}
 * Generated by: Agent 5 Test Generator
 * Coverage target: 95%+
 */

describe('${className}', () => {
  let service: ${className};
  let mockDb: any;
  let mockLogger: any;

  beforeEach(() => {
    // Mock database
    mockDb = {
      query: vi.fn(),
      transaction: vi.fn(),
    };

    // Mock logger
    mockLogger = {
      info: vi.fn(),
      error: vi.fn(),
      warn: vi.fn(),
    };

    // Initialize service with mocks
    // TODO: Adjust constructor parameters based on actual service
    service = new ${className}(mockDb, mockLogger);
  });

  afterEach(() => {
    vi.clearAllMocks();
  });

${methods.map(method => generateMethodTests(method, className)).join('\n\n')}

  // Tenant isolation tests
  describe('tenant isolation', () => {
    it('should enforce tenant boundaries', ${methods[0]?.isAsync ? 'async ' : ''}() => {
      // TODO: Test that tenant A cannot access tenant B's data
      // This is critical for multi-tenant security
      ${methods[0]?.isAsync ? 'await ' : ''}expect(true).toBe(true);
    });
  });

  // Error handling tests
  describe('error handling', () => {
    it('should handle database errors gracefully', ${methods[0]?.isAsync ? 'async ' : ''}() => {
      mockDb.query.mockRejectedValue(new Error('Database error'));

      // TODO: Test error handling for each method
      ${methods[0]?.isAsync ? 'await ' : ''}expect(true).toBe(true);
    });

    it('should log errors appropriately', ${methods[0]?.isAsync ? 'async ' : ''}() => {
      // TODO: Verify error logging
      ${methods[0]?.isAsync ? 'await ' : ''}expect(true).toBe(true);
    });
  });
});
`;
}

function generateMethodTests(method: ServiceMethod, className: string): string {
  const { name, isAsync } = method;

  return `  describe('${name}', () => {
    it('should ${name} successfully - happy path', ${isAsync ? 'async ' : ''}() => {
      // Arrange
      const testData = {
        // TODO: Add appropriate test data
      };

      // Act
      const result = ${isAsync ? 'await ' : ''}service.${name}(testData);

      // Assert
      expect(result).toBeDefined();
      // TODO: Add specific assertions
    });

    it('should handle invalid input', ${isAsync ? 'async ' : ''}() => {
      // Arrange
      const invalidData = null;

      // Act & Assert
      ${isAsync ? 'await ' : ''}expect(${isAsync ? 'async ' : ''}() => {
        ${isAsync ? 'await ' : ''}service.${name}(invalidData);
      }).${isAsync ? 'rejects.' : ''}toThrow();
    });

    it('should validate required fields', ${isAsync ? 'async ' : ''}() => {
      // TODO: Test field validation
      expect(true).toBe(true);
    });

    it('should enforce business rules', ${isAsync ? 'async ' : ''}() => {
      // TODO: Test business logic
      expect(true).toBe(true);
    });
  });`;
}

async function main() {
  const servicesDir = path.join(__dirname, '../src/services');
  const testsDir = path.join(__dirname, '../src/__tests__/services');

  // Create tests directory if it doesn't exist
  if (!fs.existsSync(testsDir)) {
    fs.mkdirSync(testsDir, { recursive: true });
  }

  // Get all service files
  const serviceFiles = fs.readdirSync(servicesDir)
    .filter(file => file.endsWith('.ts') && !file.endsWith('.test.ts'));

  console.log(`\nüß™ Test Generator - Agent 5\n`);
  console.log(`Found ${serviceFiles.length} service files\n`);

  let generated = 0;
  let skipped = 0;

  for (const file of serviceFiles) {
    const servicePath = path.join(servicesDir, file);
    const testFileName = file.replace('.ts', '.test.ts');
    const testPath = path.join(testsDir, testFileName);

    // Skip if test already exists
    if (fs.existsSync(testPath)) {
      console.log(`  ‚è≠Ô∏è  ${file} - test exists`);
      skipped++;
      continue;
    }

    const serviceInfo = analyzeServiceFile(servicePath);

    if (!serviceInfo || serviceInfo.methods.length === 0) {
      console.log(`  ‚ö†Ô∏è  ${file} - no methods found`);
      skipped++;
      continue;
    }

    const testContent = generateTestFile(serviceInfo);
    fs.writeFileSync(testPath, testContent);

    console.log(`  ‚úÖ ${file} - ${serviceInfo.methods.length} methods`);
    generated++;
  }

  console.log(`\nüìä Summary:`);
  console.log(`  Generated: ${generated} test files`);
  console.log(`  Skipped: ${skipped} files`);
  console.log(`  Total: ${serviceFiles.length} services\n`);
  console.log(`‚ö†Ô∏è  Next steps:`);
  console.log(`  1. Review generated tests in ${testsDir}`);
  console.log(`  2. Fill in TODO items with actual test logic`);
  console.log(`  3. Run: npm run test:coverage`);
  console.log(`  4. Iterate until 95%+ coverage achieved\n`);
}

main().catch(console.error);
