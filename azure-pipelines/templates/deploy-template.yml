# ============================================================================
# Deploy to Kubernetes Template
# ============================================================================
jobs:
  - deployment: DeployToProduction
    displayName: 'Deploy to Production'
    pool:
      vmImage: 'ubuntu-latest'
    environment: 'fleet-production'  # Create this environment in Azure DevOps
    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self
              displayName: 'Checkout code'
              clean: true

            # ==================================================================
            # Azure Login & AKS Context
            # ==================================================================
            - task: AzureCLI@2
              displayName: 'Get AKS Credentials'
              inputs:
                azureSubscription: 'fleet-azure-subscription'  # Service connection name
                scriptType: 'bash'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  az aks get-credentials \
                    --resource-group $(aksResourceGroup) \
                    --name $(aksCluster) \
                    --overwrite-existing

            # ==================================================================
            # Create Namespace
            # ==================================================================
            - task: Kubernetes@1
              displayName: 'Create namespace if not exists'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: 'fleet-azure-subscription'
                azureResourceGroup: '$(aksResourceGroup)'
                kubernetesCluster: '$(aksCluster)'
                command: 'apply'
                arguments: '-f $(Build.SourcesDirectory)/k8s/namespace.yaml'

            # ==================================================================
            # Create/Update Secrets from Azure Key Vault
            # ==================================================================
            - task: AzureKeyVault@2
              displayName: 'Fetch secrets from Key Vault'
              inputs:
                azureSubscription: 'fleet-azure-subscription'
                KeyVaultName: 'fleet-keyvault'  # Your Key Vault name
                SecretsFilter: '*'
                RunAsPreJob: false

            - task: Kubernetes@1
              displayName: 'Create/Update Kubernetes secrets'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: 'fleet-azure-subscription'
                azureResourceGroup: '$(aksResourceGroup)'
                kubernetesCluster: '$(aksCluster)'
                namespace: '$(namespace)'
                command: 'create'
                arguments: |
                  secret generic fleet-secrets \
                  --from-literal=database-url="$(DATABASE-URL)" \
                  --from-literal=jwt-secret="$(JWT-SECRET)" \
                  --from-literal=azure-maps-key="$(AZURE-MAPS-KEY)" \
                  --from-literal=openai-api-key="$(OPENAI-API-KEY)" \
                  --from-literal=anthropic-api-key="$(ANTHROPIC-API-KEY)" \
                  --dry-run=client -o yaml | kubectl apply -f -

            # ==================================================================
            # Save Current Deployment State (for rollback)
            # ==================================================================
            - script: |
                # Get current image tags
                API_IMAGE=$(kubectl get deployment fleet-api -n $(namespace) -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "")
                FRONTEND_IMAGE=$(kubectl get deployment fleet-frontend -n $(namespace) -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "")

                echo "##vso[task.setvariable variable=previousApiImage;isOutput=true]$API_IMAGE"
                echo "##vso[task.setvariable variable=previousFrontendImage;isOutput=true]$FRONTEND_IMAGE"

                echo "Previous API image: ${API_IMAGE}"
                echo "Previous Frontend image: ${FRONTEND_IMAGE}"

                # Save to file for rollback stage
                echo "$API_IMAGE" > $(Build.ArtifactStagingDirectory)/previous-api-image.txt
                echo "$FRONTEND_IMAGE" > $(Build.ArtifactStagingDirectory)/previous-frontend-image.txt
              displayName: 'Save current deployment state'
              name: saveState

            - task: PublishPipelineArtifact@1
              displayName: 'Publish deployment state'
              inputs:
                targetPath: '$(Build.ArtifactStagingDirectory)'
                artifact: 'deployment-state'
                publishLocation: 'pipeline'

            # ==================================================================
            # Apply Kubernetes Manifests
            # ==================================================================
            - task: Kubernetes@1
              displayName: 'Apply ConfigMap'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: 'fleet-azure-subscription'
                azureResourceGroup: '$(aksResourceGroup)'
                kubernetesCluster: '$(aksCluster)'
                namespace: '$(namespace)'
                command: 'apply'
                arguments: '-f $(Build.SourcesDirectory)/k8s/configmap.yaml'

            - task: Kubernetes@1
              displayName: 'Apply Network Policies'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: 'fleet-azure-subscription'
                azureResourceGroup: '$(aksResourceGroup)'
                kubernetesCluster: '$(aksCluster)'
                namespace: '$(namespace)'
                command: 'apply'
                arguments: '-f $(Build.SourcesDirectory)/k8s/network-policy.yaml'

            # ==================================================================
            # Update API Deployment
            # ==================================================================
            - task: KubernetesManifest@0
              displayName: 'Deploy API to AKS'
              inputs:
                action: 'deploy'
                kubernetesServiceConnection: 'fleet-aks-connection'  # Service connection
                namespace: '$(namespace)'
                manifests: |
                  $(Build.SourcesDirectory)/k8s/api-deployment.yaml
                containers: |
                  $(registryLoginServer)/fleet-api:$(imageTag)
                imagePullSecrets: |
                  acr-secret

            # Alternative: Update image directly
            - task: Kubernetes@1
              displayName: 'Update API deployment image'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: 'fleet-azure-subscription'
                azureResourceGroup: '$(aksResourceGroup)'
                kubernetesCluster: '$(aksCluster)'
                namespace: '$(namespace)'
                command: 'set'
                arguments: 'image deployment/fleet-api fleet-api=$(registryLoginServer)/fleet-api:$(imageTag)'

            # ==================================================================
            # Update Frontend Deployment
            # ==================================================================
            - task: KubernetesManifest@0
              displayName: 'Deploy Frontend to AKS'
              inputs:
                action: 'deploy'
                kubernetesServiceConnection: 'fleet-aks-connection'
                namespace: '$(namespace)'
                manifests: |
                  $(Build.SourcesDirectory)/k8s/frontend-deployment.yaml
                containers: |
                  $(registryLoginServer)/fleet-frontend:$(imageTag)
                imagePullSecrets: |
                  acr-secret

            - task: Kubernetes@1
              displayName: 'Update Frontend deployment image'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: 'fleet-azure-subscription'
                azureResourceGroup: '$(aksResourceGroup)'
                kubernetesCluster: '$(aksCluster)'
                namespace: '$(namespace)'
                command: 'set'
                arguments: 'image deployment/fleet-frontend fleet-frontend=$(registryLoginServer)/fleet-frontend:$(imageTag)'

            # ==================================================================
            # Wait for Rollout
            # ==================================================================
            - task: Kubernetes@1
              displayName: 'Wait for API rollout'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: 'fleet-azure-subscription'
                azureResourceGroup: '$(aksResourceGroup)'
                kubernetesCluster: '$(aksCluster)'
                namespace: '$(namespace)'
                command: 'rollout'
                arguments: 'status deployment/fleet-api --timeout=5m'

            - task: Kubernetes@1
              displayName: 'Wait for Frontend rollout'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: 'fleet-azure-subscription'
                azureResourceGroup: '$(aksResourceGroup)'
                kubernetesCluster: '$(aksCluster)'
                namespace: '$(namespace)'
                command: 'rollout'
                arguments: 'status deployment/fleet-frontend --timeout=5m'

            # ==================================================================
            # Apply Supporting Resources
            # ==================================================================
            - task: Kubernetes@1
              displayName: 'Apply Ingress'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: 'fleet-azure-subscription'
                azureResourceGroup: '$(aksResourceGroup)'
                kubernetesCluster: '$(aksCluster)'
                namespace: '$(namespace)'
                command: 'apply'
                arguments: '-f $(Build.SourcesDirectory)/k8s/ingress.yaml'

            - task: Kubernetes@1
              displayName: 'Apply HPA'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: 'fleet-azure-subscription'
                azureResourceGroup: '$(aksResourceGroup)'
                kubernetesCluster: '$(aksCluster)'
                namespace: '$(namespace)'
                command: 'apply'
                arguments: '-f $(Build.SourcesDirectory)/k8s/hpa.yaml'

            - task: Kubernetes@1
              displayName: 'Apply PDB'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: 'fleet-azure-subscription'
                azureResourceGroup: '$(aksResourceGroup)'
                kubernetesCluster: '$(aksCluster)'
                namespace: '$(namespace)'
                command: 'apply'
                arguments: '-f $(Build.SourcesDirectory)/k8s/pdb.yaml'

            # ==================================================================
            # Verify Deployment
            # ==================================================================
            - script: |
                echo "=========================================="
                echo "Deployment Verification"
                echo "=========================================="
                kubectl get pods -n $(namespace)
                kubectl get services -n $(namespace)
                kubectl get ingress -n $(namespace)
                echo "=========================================="
              displayName: 'Verify deployment resources'

            # ==================================================================
            # Run Database Migrations (if applicable)
            # ==================================================================
            - task: Kubernetes@1
              displayName: 'Run database migrations'
              inputs:
                connectionType: 'Azure Resource Manager'
                azureSubscriptionEndpoint: 'fleet-azure-subscription'
                azureResourceGroup: '$(aksResourceGroup)'
                kubernetesCluster: '$(aksCluster)'
                namespace: '$(namespace)'
                command: 'apply'
                arguments: '-f $(Build.SourcesDirectory)/k8s/production-migration-job.yaml'

            - script: |
                # Wait for migration job to complete
                kubectl wait --for=condition=complete --timeout=10m \
                  job/production-database-migration -n $(namespace) || true

                # Get migration logs
                echo "Migration logs:"
                kubectl logs -n $(namespace) job/production-database-migration --tail=100

                # Check job status
                JOB_STATUS=$(kubectl get job production-database-migration -n $(namespace) -o jsonpath='{.status.succeeded}')
                if [ "$JOB_STATUS" = "1" ]; then
                  echo "##vso[task.complete result=Succeeded;]Database migration completed successfully"
                else
                  echo "##vso[task.logissue type=warning]Database migration may have failed - check logs"
                fi
              displayName: 'Wait for database migration'
              continueOnError: true
