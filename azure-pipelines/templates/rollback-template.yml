# ============================================================================
# Rollback Deployment Template
# ============================================================================
jobs:
  - job: RollbackDeployment
    displayName: 'Rollback Deployment'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - checkout: self
        displayName: 'Checkout code'
        clean: true

      # ==================================================================
      # Azure Login & AKS Context
      # ==================================================================
      - task: AzureCLI@2
        displayName: 'Get AKS Credentials'
        inputs:
          azureSubscription: 'FleetManagement-ServiceConnection'
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
            az aks get-credentials \
              --resource-group $(aksResourceGroup) \
              --name $(aksCluster) \
              --overwrite-existing

      # ==================================================================
      # Download Previous Deployment State
      # ==================================================================
      - task: DownloadPipelineArtifact@2
        displayName: 'Download deployment state'
        inputs:
          artifactName: 'deployment-state'
          targetPath: '$(Pipeline.Workspace)/deployment-state'
        continueOnError: true

      # ==================================================================
      # Rollback Fleet App Deployment
      # ==================================================================
      - script: |
          echo "=========================================="
          echo "INITIATING ROLLBACK DUE TO DEPLOYMENT FAILURE"
          echo "=========================================="
          echo "Build ID: $(Build.BuildId)"
          echo "Source Version: $(Build.SourceVersion)"
          echo "=========================================="

          # Try to read previous image from artifact
          if [ -f "$(Pipeline.Workspace)/deployment-state/previous-fleet-app-image.txt" ]; then
            PREVIOUS_IMAGE=$(cat $(Pipeline.Workspace)/deployment-state/previous-fleet-app-image.txt)
            echo "Found previous image: $PREVIOUS_IMAGE"

            if [ -n "$PREVIOUS_IMAGE" ]; then
              echo "Rolling back to: $PREVIOUS_IMAGE"
              kubectl set image deployment/fleet-app \
                fleet-app=$PREVIOUS_IMAGE \
                -n $(namespace)
              kubectl rollout status deployment/fleet-app -n $(namespace) --timeout=3m
            else
              echo "No previous image found, using kubectl rollout undo"
              kubectl rollout undo deployment/fleet-app -n $(namespace)
              kubectl rollout status deployment/fleet-app -n $(namespace) --timeout=3m
            fi
          else
            echo "Deployment state artifact not found, using kubectl rollout undo"
            kubectl rollout undo deployment/fleet-app -n $(namespace)
            kubectl rollout status deployment/fleet-app -n $(namespace) --timeout=3m
          fi
        displayName: 'Rollback fleet-app deployment'
        continueOnError: false

      # ==================================================================
      # Verify Rollback
      # ==================================================================
      - script: |
          echo "=========================================="
          echo "Verifying rollback..."
          echo "=========================================="
          kubectl get pods -n $(namespace) -l app=fleet-app
          kubectl get deployments -n $(namespace)
          echo "=========================================="
        displayName: 'Verify rollback'

      # ==================================================================
      # Test Health Endpoints After Rollback
      # ==================================================================
      - script: |
          echo "Waiting 30 seconds for services to stabilize after rollback..."
          sleep 30

          echo "Testing API health endpoint after rollback..."
          curl --fail $(productionUrl)/api/health && \
            echo "##vso[task.complete result=Succeeded;]API health check passed after rollback"

          echo "Testing Frontend health endpoint after rollback..."
          curl --fail $(productionUrl)/ && \
            echo "##vso[task.complete result=Succeeded;]Frontend health check passed after rollback"
        displayName: 'Test health endpoints after rollback'
        continueOnError: true

      # ==================================================================
      # Send Rollback Notification (via script - no external task needed)
      # ==================================================================
      - script: |
          echo "=========================================="
          echo "ROLLBACK COMPLETED"
          echo "=========================================="
          echo "Build ID: $(Build.BuildId)"
          echo "Source Version: $(Build.SourceVersion)"
          echo "Rollback Reason: Smoke tests failed"
          echo "=========================================="
          echo ""
          echo "##vso[task.logissue type=error]ROLLBACK EXECUTED: Deployment was rolled back due to smoke test failure"
          echo ""
          echo "Check pipeline logs at:"
          echo "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
          echo ""
          echo "Manual verification recommended."
          echo "=========================================="
        displayName: 'Send rollback notification'
