# ============================================================================
# Fleet Agent Workers - Docker Compose Configuration
# ============================================================================
# This compose file is a template for deploying worker agents.
# Copy and customize for each VM deployment.
# ============================================================================

version: '3.8'

services:
  # Agent D - Facilities & Assets Repositories
  agent-d:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fleet-agent-d
    hostname: agent-d
    environment:
      # Agent Configuration
      AGENT_NAME: agent-d
      AGENT_ROLE: facilities-repos
      LLM_MODEL: claude-sonnet-4

      # Orchestrator Connection
      ORCHESTRATOR_URL: http://172.191.51.49:3000

      # GitHub Authentication
      GITHUB_TOKEN: ${GITHUB_TOKEN}

      # Anthropic API
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}

      # Polling Configuration
      POLL_INTERVAL: 30000
      HEARTBEAT_INTERVAL: 60000

      # Repository Path
      REPO_PATH: /workspace/Fleet
    volumes:
      # Mount Git credentials
      - ~/.gitconfig:/home/fleetagent/.gitconfig:ro
      - ~/.ssh:/home/fleetagent/.ssh:ro

      # Mount repository (clone on first run)
      - fleet-repo-agent-d:/workspace/Fleet
    restart: unless-stopped
    networks:
      - fleet-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Agent E - Incidents & Compliance Repositories
  agent-e:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fleet-agent-e
    hostname: agent-e
    environment:
      AGENT_NAME: agent-e
      AGENT_ROLE: incidents-repos
      LLM_MODEL: claude-sonnet-4
      ORCHESTRATOR_URL: http://172.191.51.49:3000
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      POLL_INTERVAL: 30000
      HEARTBEAT_INTERVAL: 60000
      REPO_PATH: /workspace/Fleet
    volumes:
      - ~/.gitconfig:/home/fleetagent/.gitconfig:ro
      - ~/.ssh:/home/fleetagent/.ssh:ro
      - fleet-repo-agent-e:/workspace/Fleet
    restart: unless-stopped
    networks:
      - fleet-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  fleet-repo-agent-d:
    driver: local
  fleet-repo-agent-e:
    driver: local

networks:
  fleet-network:
    driver: bridge
