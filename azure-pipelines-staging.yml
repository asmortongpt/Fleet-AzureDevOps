# Azure DevOps Staging Environment Deployment Pipeline
# Manual trigger only
# Target: Staging Kubernetes environment

trigger: none

pr: none

pool:
  vmImage: 'ubuntu-latest'

parameters:
  - name: version
    displayName: 'Version to deploy (e.g., v1.2.3)'
    type: string
    default: ''

variables:
  - group: fleet-staging-vars  # Variable group in Azure DevOps
  NODE_VERSION: '20.x'
  ENVIRONMENT: 'staging'
  NAMESPACE: 'fleet-management-staging'
  REGISTRY: fleetappregistry.azurecr.io
  IMAGE_NAME_FRONTEND: fleet-frontend
  IMAGE_NAME_API: fleet-api
  AKS_CLUSTER: 'fleet-aks-cluster'
  AKS_RESOURCE_GROUP: 'fleet-management-rg'
  VERSION: ${{ parameters.version }}

stages:
  # ====================================
  # Stage 1: Pre-Flight Checks
  # ====================================
  - stage: PreFlight
    displayName: 'Pre-Flight Checks'
    jobs:
      - job: ValidateVersion
        displayName: 'Validate Version'
        timeoutInMinutes: 5
        steps:
          - script: |
              VERSION="${{ parameters.version }}"
              if [[ -z "$VERSION" ]]; then
                echo "❌ Version parameter is required"
                exit 1
              fi
              if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                echo "❌ Invalid version format. Expected format: v1.2.3"
                exit 1
              fi
              echo "✅ Version format valid: $VERSION"
            displayName: 'Validate version format'

          - script: |
              echo "✅ Environment: $(ENVIRONMENT)"
              echo "✅ Version: $(VERSION)"
              echo "✅ Namespace: $(NAMESPACE)"
              echo "✅ Registry: $(REGISTRY)"
            displayName: 'Display configuration'

  # ====================================
  # Stage 2: Build Images
  # ====================================
  - stage: Build
    displayName: 'Build & Push Images'
    dependsOn: PreFlight
    jobs:
      - job: BuildAndPush
        displayName: 'Build Docker Images'
        timeoutInMinutes: 30
        steps:
          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: login
              containerRegistry: $(ACR_SERVICE_CONNECTION)

          - task: Docker@2
            displayName: 'Build Frontend Image'
            inputs:
              command: build
              repository: $(IMAGE_NAME_FRONTEND)
              dockerfile: Dockerfile
              tags: |
                staging-$(VERSION)
                staging-latest
              arguments: |
                --build-arg NODE_ENV=staging
                --build-arg BUILD_DATE=$(Build.BuildId)
                --build-arg VCS_REF=$(Build.SourceVersion)
                --build-arg VERSION=$(VERSION)

          - task: Docker@2
            displayName: 'Push Frontend Image'
            inputs:
              command: push
              repository: $(IMAGE_NAME_FRONTEND)
              tags: |
                staging-$(VERSION)
                staging-latest

          - task: Docker@2
            displayName: 'Build API Image'
            inputs:
              command: build
              repository: $(IMAGE_NAME_API)
              dockerfile: api/Dockerfile
              context: api
              tags: |
                staging-$(VERSION)
                staging-latest
              arguments: |
                --build-arg NODE_ENV=staging
                --build-arg BUILD_DATE=$(Build.BuildId)
                --build-arg VCS_REF=$(Build.SourceVersion)
                --build-arg VERSION=$(VERSION)

          - task: Docker@2
            displayName: 'Push API Image'
            inputs:
              command: push
              repository: $(IMAGE_NAME_API)
              tags: |
                staging-$(VERSION)
                staging-latest

          # Security scan
          - script: |
              docker run --rm aquasec/trivy image --severity HIGH,CRITICAL \
                $(REGISTRY)/$(IMAGE_NAME_API):staging-$(VERSION)
              docker run --rm aquasec/trivy image --severity HIGH,CRITICAL \
                $(REGISTRY)/$(IMAGE_NAME_FRONTEND):staging-$(VERSION)
            displayName: 'Security scan images'
            continueOnError: true

  # ====================================
  # Stage 3: Deploy to Kubernetes
  # ====================================
  - stage: Deploy
    displayName: 'Deploy to Staging'
    dependsOn: Build
    jobs:
      - deployment: DeployToK8s
        displayName: 'Deploy to Kubernetes'
        timeoutInMinutes: 20
        environment: 'fleet-staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Get AKS credentials'
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az aks get-credentials \
                        --resource-group $(AKS_RESOURCE_GROUP) \
                        --name $(AKS_CLUSTER) \
                        --overwrite-existing

                - task: Kubernetes@1
                  displayName: 'Create namespace if not exists'
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscriptionEndpoint: $(AZURE_SERVICE_CONNECTION)
                    azureResourceGroup: $(AKS_RESOURCE_GROUP)
                    kubernetesCluster: $(AKS_CLUSTER)
                    command: 'apply'
                    arguments: '-f - <<EOF
                      apiVersion: v1
                      kind: Namespace
                      metadata:
                        name: $(NAMESPACE)
                      EOF'

                - task: Kubernetes@1
                  displayName: 'Create/Update Secrets'
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscriptionEndpoint: $(AZURE_SERVICE_CONNECTION)
                    azureResourceGroup: $(AKS_RESOURCE_GROUP)
                    kubernetesCluster: $(AKS_CLUSTER)
                    namespace: $(NAMESPACE)
                    command: 'create'
                    arguments: 'secret generic fleet-secrets --from-literal=database-url="$(STAGING_DATABASE_URL)" --from-literal=jwt-secret="$(STAGING_JWT_SECRET)" --from-literal=azure-maps-key="$(AZURE_MAPS_KEY)" --dry-run=client -o yaml | kubectl apply -f -'

                - task: Kubernetes@1
                  displayName: 'Deploy API'
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscriptionEndpoint: $(AZURE_SERVICE_CONNECTION)
                    azureResourceGroup: $(AKS_RESOURCE_GROUP)
                    kubernetesCluster: $(AKS_CLUSTER)
                    namespace: $(NAMESPACE)
                    command: 'set'
                    arguments: 'image deployment/fleet-api fleet-api=$(REGISTRY)/$(IMAGE_NAME_API):staging-$(VERSION)'

                - task: Kubernetes@1
                  displayName: 'Wait for API rollout'
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscriptionEndpoint: $(AZURE_SERVICE_CONNECTION)
                    azureResourceGroup: $(AKS_RESOURCE_GROUP)
                    kubernetesCluster: $(AKS_CLUSTER)
                    namespace: $(NAMESPACE)
                    command: 'rollout'
                    arguments: 'status deployment/fleet-api --timeout=10m'

                - task: Kubernetes@1
                  displayName: 'Deploy Frontend'
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscriptionEndpoint: $(AZURE_SERVICE_CONNECTION)
                    azureResourceGroup: $(AKS_RESOURCE_GROUP)
                    kubernetesCluster: $(AKS_CLUSTER)
                    namespace: $(NAMESPACE)
                    command: 'set'
                    arguments: 'image deployment/fleet-frontend fleet-frontend=$(REGISTRY)/$(IMAGE_NAME_FRONTEND):staging-$(VERSION)'

                - task: Kubernetes@1
                  displayName: 'Wait for Frontend rollout'
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscriptionEndpoint: $(AZURE_SERVICE_CONNECTION)
                    azureResourceGroup: $(AKS_RESOURCE_GROUP)
                    kubernetesCluster: $(AKS_CLUSTER)
                    namespace: $(NAMESPACE)
                    command: 'rollout'
                    arguments: 'status deployment/fleet-frontend --timeout=10m'

                - task: Kubernetes@1
                  displayName: 'Display deployment status'
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscriptionEndpoint: $(AZURE_SERVICE_CONNECTION)
                    azureResourceGroup: $(AKS_RESOURCE_GROUP)
                    kubernetesCluster: $(AKS_CLUSTER)
                    namespace: $(NAMESPACE)
                    command: 'get'
                    arguments: 'all'

  # ====================================
  # Stage 4: Integration Tests
  # ====================================
  - stage: IntegrationTests
    displayName: 'Integration Tests'
    dependsOn: Deploy
    jobs:
      - job: RunTests
        displayName: 'Run Integration Tests'
        timeoutInMinutes: 20
        steps:
          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: |
              npm ci
            displayName: 'Install dependencies'

          - script: |
              echo "Waiting for services to stabilize..."
              sleep 60
            displayName: 'Wait for services'

          - script: |
              npx playwright install --with-deps chromium
            displayName: 'Install Playwright'

          - script: |
              npm run test:smoke
            displayName: 'Run smoke tests'
            env:
              TEST_URL: https://fleet-staging.capitaltechalliance.com
              API_URL: https://fleet-staging.capitaltechalliance.com/api
            continueOnError: true

          - script: |
              npm run test:main
            displayName: 'Run integration tests'
            env:
              TEST_URL: https://fleet-staging.capitaltechalliance.com
              API_URL: https://fleet-staging.capitaltechalliance.com/api
            continueOnError: true

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results/*.xml'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish test artifacts'
            condition: always()
            inputs:
              PathtoPublish: 'playwright-report'
              ArtifactName: 'integration-test-report'

  # ====================================
  # Stage 5: Notification
  # ====================================
  - stage: Notify
    displayName: 'Send Notifications'
    dependsOn:
      - Deploy
      - IntegrationTests
    condition: always()
    jobs:
      - job: SendNotifications
        displayName: 'Notify Team'
        steps:
          - script: |
              if [ "$(Agent.JobStatus)" == "Succeeded" ]; then
                echo "✅ Staging deployment successful"
                STATUS="success"
                MESSAGE="Staging environment deployed successfully"
              else
                echo "❌ Staging deployment failed"
                STATUS="failure"
                MESSAGE="Staging environment deployment failed"
              fi

              echo "##vso[task.setvariable variable=DEPLOYMENT_STATUS]$STATUS"
              echo "##vso[task.setvariable variable=DEPLOYMENT_MESSAGE]$MESSAGE"
            displayName: 'Determine deployment status'

          - script: |
              echo "## Fleet Management - Staging Deployment Summary"
              echo "Status: $(DEPLOYMENT_MESSAGE)"
              echo "Version: $(VERSION)"
              echo "Build ID: $(Build.BuildId)"
              echo "Commit: $(Build.SourceVersion)"
              echo "Images:"
              echo "  - Frontend: $(REGISTRY)/$(IMAGE_NAME_FRONTEND):staging-$(VERSION)"
              echo "  - API: $(REGISTRY)/$(IMAGE_NAME_API):staging-$(VERSION)"
            displayName: 'Print summary'
