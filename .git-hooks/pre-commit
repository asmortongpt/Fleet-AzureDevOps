#!/bin/bash
# Pre-commit hook to prevent large files and potential security issues
# This hook runs automatically before each commit

set -e

echo "Running pre-commit checks..."

# Configuration
MAX_FILE_SIZE=5242880  # 5MB in bytes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to format file size
format_size() {
    local size=$1
    if [ $size -ge 1048576 ]; then
        echo "$((size/1024/1024))MB"
    else
        echo "$((size/1024))KB"
    fi
}

# Check for large files (>5MB)
echo "Checking for large files..."
LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | while read file; do
  if [ -f "$file" ]; then
    # Use stat command (different syntax for macOS vs Linux)
    if [[ "$OSTYPE" == "darwin"* ]]; then
        size=$(stat -f%z "$file" 2>/dev/null)
    else
        size=$(stat -c%s "$file" 2>/dev/null)
    fi

    if [ "$size" -gt "$MAX_FILE_SIZE" ]; then
      formatted_size=$(format_size $size)
      echo "$file ($formatted_size)"
    fi
  fi
done)

if [ -n "$LARGE_FILES" ]; then
  echo -e "${RED}❌ ERROR: Large files detected (>5MB):${NC}"
  echo "$LARGE_FILES"
  echo ""
  echo -e "${YELLOW}Please use Git LFS for large files:${NC}"
  echo "  git lfs track '*.extension'"
  echo "  git add .gitattributes"
  echo "  git add your-large-file"
  echo ""
  echo "Supported LFS extensions: .glb, .gltf, .obj, .fbx, .mp4, .webm, .zip, .tar.gz, .dmg, .pkg"
  exit 1
fi

# Check for potential hardcoded secrets
echo "Checking for potential secrets..."
SECRETS_FOUND=false

# Get all staged files except hook files and documentation
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -v "^.git-hooks/" | grep -v "CONTRIBUTING.md" | grep -v "README.md" | grep -v "^docs/" || true)

if [ -n "$STAGED_FILES" ]; then
    # Get the actual diff content
    DIFF_CONTENT=$(git diff --cached -- $STAGED_FILES 2>/dev/null || true)

    # Check for actual secret values, not just examples in documentation
    # Skip lines with comments or example markers
    SECRET_CONTENT=$(echo "$DIFF_CONTENT" | grep -v "^[+#].*[Bb]ad\|[Ee]xample\|[Dd]on't\|❌" || true)

    if echo "$SECRET_CONTENT" | grep -E "password\s*=\s*['\"][^'\"]{8,}" > /dev/null 2>&1; then
        SECRETS_FOUND=true
        echo -e "${RED}❌ ERROR: Potential hardcoded password detected${NC}"
    fi

    if echo "$DIFF_CONTENT" | grep -E "(api_key|apiKey|API_KEY)\s*=\s*['\"][A-Za-z0-9]{20,}" > /dev/null 2>&1; then
        SECRETS_FOUND=true
        echo -e "${RED}❌ ERROR: Potential hardcoded API key detected${NC}"
    fi

    if echo "$DIFF_CONTENT" | grep -E "-----BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY-----" > /dev/null 2>&1; then
        SECRETS_FOUND=true
        echo -e "${RED}❌ ERROR: Private key detected${NC}"
    fi

    if echo "$DIFF_CONTENT" | grep -E "sk-[A-Za-z0-9]{20,}" > /dev/null 2>&1; then
        SECRETS_FOUND=true
        echo -e "${RED}❌ ERROR: Potential OpenAI API key detected${NC}"
    fi

    if echo "$DIFF_CONTENT" | grep -E "ghp_[A-Za-z0-9]{36,}" > /dev/null 2>&1; then
        SECRETS_FOUND=true
        echo -e "${RED}❌ ERROR: Potential GitHub PAT detected${NC}"
    fi
fi

if [ "$SECRETS_FOUND" = true ]; then
    echo ""
    echo -e "${YELLOW}Please use environment variables or Azure Key Vault for secrets${NC}"
    echo "  - Add secrets to .env file (ensure .env is in .gitignore)"
    echo "  - Use Azure Key Vault for production secrets"
    echo "  - Reference: .env.example for required variables"
    exit 1
fi

# Check for node_modules or other common bloat
echo "Checking for common bloat patterns..."
BLOAT_PATTERNS=(
    "node_modules/"
    "dist/"
    "build/"
    ".next/"
    "coverage/"
    "*.log"
    ".DS_Store"
)

BLOAT_FOUND=false
for pattern in "${BLOAT_PATTERNS[@]}"; do
    if git diff --cached --name-only | grep -E "$pattern" > /dev/null; then
        if [ "$BLOAT_FOUND" = false ]; then
            echo -e "${YELLOW}⚠️  WARNING: Potential bloat files detected${NC}"
            BLOAT_FOUND=true
        fi
        echo -e "${YELLOW}  Files matching: $pattern${NC}"
    fi
done

if [ "$BLOAT_FOUND" = true ]; then
    echo ""
    echo -e "${YELLOW}Consider adding these to .gitignore:${NC}"
    echo "  - build artifacts (dist/, build/, .next/)"
    echo "  - dependencies (node_modules/, vendor/)"
    echo "  - logs (*.log)"
    echo "  - OS files (.DS_Store, Thumbs.db)"
    echo ""
    read -p "Continue with commit anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for debugging code
echo "Checking for debugging code..."
if git diff --cached | grep -E "(console\.log|debugger|TODO|FIXME|XXX)" > /dev/null; then
    echo -e "${YELLOW}⚠️  WARNING: Debugging code detected (console.log, debugger, TODO, FIXME)${NC}"
    echo "Consider removing debugging statements before committing"
fi

echo -e "${GREEN}✅ All pre-commit checks passed!${NC}"
exit 0
