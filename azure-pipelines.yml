# ============================================================================
# Fleet Management System - Azure DevOps CI/CD Pipeline
# ============================================================================
# This pipeline replaces GitHub Actions with Azure DevOps Pipelines
#
# Features:
# - Multi-stage pipeline (Build, Test, Security, Deploy)
# - SBOM generation (SPDX + CycloneDX)
# - Container scanning (Trivy)
# - Secret detection
# - Automatic rollback on failure
# - Health checks / smoke tests
# ============================================================================

trigger:
  branches:
    include:
      - main
      - develop
      - stage-*
  paths:
    exclude:
      - README.md
      - docs/**
      - '*.md'

pr:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/**
      - '*.md'

# ============================================================================
# VARIABLES
# ============================================================================
variables:
  - group: fleet-production-vars  # Create this variable group in Azure DevOps
  - group: fleet-secrets          # Create this variable group with secrets

  # Pipeline variables
  - name: nodeVersion
    value: '20.x'
  - name: registryName
    value: 'fleetacr'
  - name: registryLoginServer
    value: 'fleetacr.azurecr.io'
  - name: aksCluster
    value: 'fleet-aks-cluster'
  - name: aksResourceGroup
    value: 'fleet-management-rg'
  - name: namespace
    value: 'fleet-management'
  - name: productionUrl
    value: 'https://fleet.capitaltechalliance.com'
  - name: imageTag
    value: '$(Build.SourceVersion)'
  - name: isProdBranch
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  - name: isDevelopBranch
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/develop')]

# ============================================================================
# BUILD AGENT POOL
# ============================================================================
pool:
  vmImage: 'ubuntu-latest'

# ============================================================================
# STAGES
# ============================================================================
stages:
  # ==========================================================================
  # STAGE 1: LINT & TYPE CHECK
  # ==========================================================================
  - stage: Lint
    displayName: 'Lint & Type Check'
    jobs:
      - template: azure-pipelines/templates/lint-template.yml

  # ==========================================================================
  # STAGE 2: UNIT TESTS
  # ==========================================================================
  - stage: Test
    displayName: 'Unit Tests'
    dependsOn: []  # Run in parallel with Lint
    jobs:
      - template: azure-pipelines/templates/test-template.yml

  # ==========================================================================
  # STAGE 3: BUILD VERIFICATION
  # ==========================================================================
  - stage: Build
    displayName: 'Build Verification'
    dependsOn:
      - Lint
      - Test
    jobs:
      - template: azure-pipelines/templates/build-template.yml

  # ==========================================================================
  # STAGE 4: DOCKER BUILD & PUSH
  # ==========================================================================
  - stage: Docker
    displayName: 'Build & Push Docker Images'
    dependsOn: Build
    condition: and(succeeded(), or(eq(variables.isProdBranch, true), eq(variables.isDevelopBranch, true)))
    jobs:
      - template: azure-pipelines/templates/docker-template.yml

  # ==========================================================================
  # STAGE 5: SECURITY SCANNING
  # ==========================================================================
  - stage: Security
    displayName: 'Security Scanning'
    dependsOn: Docker
    condition: and(succeeded(), or(eq(variables.isProdBranch, true), eq(variables.isDevelopBranch, true)))
    jobs:
      - template: azure-pipelines/templates/security-template.yml

  # ==========================================================================
  # STAGE 6: DEPLOY TO KUBERNETES
  # ==========================================================================
  - stage: Deploy
    displayName: 'Deploy to Kubernetes'
    dependsOn: Security
    condition: and(succeeded(), eq(variables.isProdBranch, true))
    jobs:
      - template: azure-pipelines/templates/deploy-template.yml

  # ==========================================================================
  # STAGE 7: SMOKE TESTS
  # ==========================================================================
  - stage: SmokeTest
    displayName: 'Smoke Tests'
    dependsOn: Deploy
    condition: and(succeeded(), eq(variables.isProdBranch, true))
    jobs:
      - template: azure-pipelines/templates/smoke-test-template.yml

  # ==========================================================================
  # STAGE 8: ROLLBACK (On failure)
  # ==========================================================================
  - stage: Rollback
    displayName: 'Rollback Deployment'
    dependsOn:
      - Deploy
      - SmokeTest
    condition: failed()
    jobs:
      - template: azure-pipelines/templates/rollback-template.yml
