# Fleet Production Deployment Pipeline
# Azure DevOps CI/CD for Docker Compose Multi-Service Application

trigger:
  branches:
    include:
      - main
      - stage-a/*
  paths:
    exclude:
      - '*.md'
      - 'docs/**'

variables:
  - group: fleet-production-secrets  # Variable group in Azure DevOps
  - name: imageRepository
    value: 'ctafleet'
  - name: containerRegistry
    value: 'fleetacr.azurecr.io'
  - name: dockerComposeFile
    value: 'docker-compose.production.yml'
  - name: azureSubscription
    value: 'Azure-Production'
  - name: resourceGroup
    value: 'fleet-production-rg'
  - name: keyVaultName
    value: 'fleet-secrets-0d326d71'

stages:
  - stage: Build
    displayName: 'Build and Push Docker Images'
    jobs:
      - job: BuildImages
        displayName: 'Build All Services'
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - checkout: self
            fetchDepth: 1
          
          - task: AzureKeyVault@2
            displayName: 'Fetch Secrets from Key Vault'
            inputs:
              azureSubscription: '$(azureSubscription)'
              KeyVaultName: '$(keyVaultName)'
              SecretsFilter: '*'
              RunAsPreJob: true
          
          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: login
              containerRegistry: $(containerRegistry)
          
          - script: |
              echo "Creating production .env file..."
              cat > .env.production << ENVEOF
              POSTGRES_DB=fleetdb
              POSTGRES_USER=fleetadmin
              POSTGRES_PASSWORD=$(DATABASE-PASSWORD)
              POSTGRES_PORT=5432
              REDIS_PASSWORD=$(redis-password)
              REDIS_PORT=6379
              API_PORT=3000
              JWT_SECRET=$(jwt-secret)
              JWT_EXPIRES_IN=1h
              FRONTEND_PORT=80
              AZURE_OPENAI_ENDPOINT=$(azure-openai-endpoint)
              AZURE_OPENAI_KEY=$(azure-openai-key)
              AZURE_STORAGE_CONNECTION_STRING=$(azure-storage-connection-string)
              MS_GRAPH_CLIENT_ID=$(AZURE-AD-CLIENT-ID)
              MS_GRAPH_CLIENT_SECRET=$(AZURE-AD-CLIENT-SECRET)
              APPLICATION_INSIGHTS_CONNECTION_STRING=$(app-insights-connection-string)
              VITE_AZURE_MAPS_SUBSCRIPTION_KEY=$(azure-maps-key)
              GRAFANA_ADMIN_USER=admin
              GRAFANA_ADMIN_PASSWORD=GrafanaFleet2024!
              GRAFANA_ROOT_URL=https://fleet-monitoring.azurewebsites.net
              CORS_ORIGIN=*
              NODE_ENV=production
              VITE_ENVIRONMENT=production
              ENVIRONMENT=production
              CACHE_BUST=$(Build.BuildId)
              ENVEOF
              echo "‚úÖ Environment file created"
            displayName: 'Create Production Environment File'
          
          - script: |
              docker-compose -f $(dockerComposeFile) build \
                --build-arg BUILDKIT_INLINE_CACHE=1 \
                --parallel
            displayName: 'Build Docker Images'
            env:
              DOCKER_BUILDKIT: 1
              COMPOSE_DOCKER_CLI_BUILD: 1
          
          - script: |
              docker-compose -f $(dockerComposeFile) push
            displayName: 'Push Images to ACR'
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Docker Compose Files'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'

  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployContainers
        displayName: 'Deploy to Azure Container Instances'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'fleet-staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: drop
                
                - task: AzureCLI@2
                  displayName: 'Deploy to Azure Container Instances'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "üöÄ Deploying Fleet to Azure Container Instances..."
                      
                      # Create resource group if not exists
                      az group create --name $(resourceGroup)-staging --location eastus2
                      
                      # Deploy PostgreSQL
                      az container create \
                        --resource-group $(resourceGroup)-staging \
                        --name fleet-postgres-staging \
                        --image postgres:15-alpine \
                        --dns-name-label fleet-postgres-staging \
                        --ports 5432 \
                        --environment-variables \
                          POSTGRES_DB=fleetdb \
                          POSTGRES_USER=fleetadmin \
                        --secure-environment-variables \
                          POSTGRES_PASSWORD=$(DATABASE-PASSWORD) \
                        --cpu 2 --memory 4
                      
                      # Deploy Redis
                      az container create \
                        --resource-group $(resourceGroup)-staging \
                        --name fleet-redis-staging \
                        --image redis:7-alpine \
                        --dns-name-label fleet-redis-staging \
                        --ports 6379 \
                        --command-line "redis-server --requirepass $(redis-password)" \
                        --cpu 1 --memory 2
                      
                      # Deploy API
                      az container create \
                        --resource-group $(resourceGroup)-staging \
                        --name fleet-api-staging \
                        --image $(containerRegistry)/$(imageRepository)-api:$(Build.BuildId) \
                        --registry-login-server $(containerRegistry) \
                        --registry-username $(ACR_USERNAME) \
                        --registry-password $(ACR_PASSWORD) \
                        --dns-name-label fleet-api-staging \
                        --ports 3000 \
                        --environment-variables \
                          NODE_ENV=production \
                          PORT=3000 \
                        --secure-environment-variables \
                          DATABASE_URL="postgresql://fleetadmin:$(DATABASE-PASSWORD)@fleet-postgres-staging.eastus2.azurecontainer.io:5432/fleetdb" \
                          REDIS_URL="redis://:$(redis-password)@fleet-redis-staging.eastus2.azurecontainer.io:6379" \
                          JWT_SECRET=$(jwt-secret) \
                        --cpu 2 --memory 4
                      
                      # Deploy Frontend
                      az container create \
                        --resource-group $(resourceGroup)-staging \
                        --name fleet-frontend-staging \
                        --image $(containerRegistry)/$(imageRepository)-frontend:$(Build.BuildId) \
                        --registry-login-server $(containerRegistry) \
                        --registry-username $(ACR_USERNAME) \
                        --registry-password $(ACR_PASSWORD) \
                        --dns-name-label fleet-staging \
                        --ports 80 443 \
                        --cpu 1 --memory 2
                      
                      echo "‚úÖ Deployment complete!"
                      echo "üåê Frontend: https://fleet-staging.eastus2.azurecontainer.io"
                      echo "üîå API: https://fleet-api-staging.eastus2.azurecontainer.io"
                
                - task: AzureCLI@2
                  displayName: 'Health Check'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "üè• Running health checks..."
                      sleep 30  # Wait for containers to start
                      
                      API_URL="http://fleet-api-staging.eastus2.azurecontainer.io:3000/api/health"
                      FRONTEND_URL="http://fleet-staging.eastus2.azurecontainer.io"
                      
                      # Check API health
                      if curl -f -s "$API_URL" | grep -q "healthy"; then
                        echo "‚úÖ API is healthy"
                      else
                        echo "‚ùå API health check failed"
                        exit 1
                      fi
                      
                      # Check Frontend
                      if curl -f -s "$FRONTEND_URL" > /dev/null; then
                        echo "‚úÖ Frontend is accessible"
                      else
                        echo "‚ùå Frontend health check failed"
                        exit 1
                      fi

  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: DeployStaging
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployProduction
        displayName: 'Deploy to Production ACI'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'fleet-production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: drop
                
                - task: AzureCLI@2
                  displayName: 'Deploy to Production'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "üöÄ Deploying Fleet to Production..."
                      
                      az group create --name $(resourceGroup) --location eastus2
                      
                      # Production deployments (same as staging but with -prod suffix)
                      az container create \
                        --resource-group $(resourceGroup) \
                        --name fleet-postgres-prod \
                        --image postgres:15-alpine \
                        --dns-name-label fleet-postgres-prod \
                        --ports 5432 \
                        --environment-variables POSTGRES_DB=fleetdb POSTGRES_USER=fleetadmin \
                        --secure-environment-variables POSTGRES_PASSWORD=$(DATABASE-PASSWORD) \
                        --cpu 4 --memory 8
                      
                      az container create \
                        --resource-group $(resourceGroup) \
                        --name fleet-redis-prod \
                        --image redis:7-alpine \
                        --dns-name-label fleet-redis-prod \
                        --ports 6379 \
                        --command-line "redis-server --requirepass $(redis-password)" \
                        --cpu 2 --memory 4
                      
                      az container create \
                        --resource-group $(resourceGroup) \
                        --name fleet-api-prod \
                        --image $(containerRegistry)/$(imageRepository)-api:$(Build.BuildId) \
                        --registry-login-server $(containerRegistry) \
                        --registry-username $(ACR_USERNAME) \
                        --registry-password $(ACR_PASSWORD) \
                        --dns-name-label fleet-api-prod \
                        --ports 3000 \
                        --environment-variables NODE_ENV=production PORT=3000 \
                        --secure-environment-variables \
                          DATABASE_URL="postgresql://fleetadmin:$(DATABASE-PASSWORD)@fleet-postgres-prod.eastus2.azurecontainer.io:5432/fleetdb" \
                          REDIS_URL="redis://:$(redis-password)@fleet-redis-prod.eastus2.azurecontainer.io:6379" \
                          JWT_SECRET=$(jwt-secret) \
                        --cpu 4 --memory 8
                      
                      az container create \
                        --resource-group $(resourceGroup) \
                        --name fleet-frontend-prod \
                        --image $(containerRegistry)/$(imageRepository)-frontend:$(Build.BuildId) \
                        --registry-login-server $(containerRegistry) \
                        --registry-username $(ACR_USERNAME) \
                        --registry-password $(ACR_PASSWORD) \
                        --dns-name-label fleet-production \
                        --ports 80 443 \
                        --cpu 2 --memory 4
                      
                      echo "‚úÖ Production deployment complete!"
                      echo "üåê Production URL: https://fleet-production.eastus2.azurecontainer.io"
