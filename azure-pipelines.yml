# Fleet Management - Docker Build & Deploy Pipeline
# Builds with Microsoft-hosted agents (7GB RAM) to bypass ACR build agent limits
trigger:
  branches:
    include:
      - main
      - stage-a/*
  paths:
    exclude:
      - '*.md'
      - 'docs/**'

pr:
  branches:
    include:
      - main

variables:
  nodeVersion: '20.x'
  dockerRegistryServiceConnection: 'fleetproductionacr'
  imageRepository: 'fleet-frontend'
  containerRegistry: 'fleetproductionacr.azurecr.io'
  dockerfilePath: 'Dockerfile'
  tag: '$(Build.BuildId)'

pool:
  vmImage: 'ubuntu-latest'  # 7GB RAM (vs ACR's 4GB limit)

stages:
  - stage: DockerBuild
    displayName: 'Docker Build & Push'
    jobs:
      - job: BuildDockerImage
        displayName: 'Build Docker Image'
        timeoutInMinutes: 45  # Extended for large Vite build
        steps:
          - checkout: self
            clean: true

          - script: |
              echo "##[section]Build Agent Resources"
              echo "Memory: $(free -h | grep Mem | awk '{print $2}')"
              echo "Disk: $(df -h / | tail -1 | awk '{print $4}')"
              echo "CPU: $(nproc) cores"
            displayName: 'Show Agent Resources'

          - task: Docker@2
            displayName: 'Build Docker Image'
            inputs:
              command: 'build'
              repository: '$(imageRepository)'
              dockerfile: '$(dockerfilePath)'
              tags: |
                $(tag)
                latest
              arguments: '--build-arg CACHE_BUST=$(Build.BuildId)'

          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: 'login'
              containerRegistry: '$(dockerRegistryServiceConnection)'

          - task: Docker@2
            displayName: 'Push to ACR'
            inputs:
              command: 'push'
              repository: '$(imageRepository)'
              containerRegistry: '$(dockerRegistryServiceConnection)'
              tags: |
                $(tag)
                latest

          - script: |
              echo "##[section]Build Summary"
              echo "âœ… Image: $(containerRegistry)/$(imageRepository):$(tag)"
              echo "âœ… Image: $(containerRegistry)/$(imageRepository):latest"
              echo "ðŸŽ¯ Ready for AKS deployment"
            displayName: 'Build Summary'
