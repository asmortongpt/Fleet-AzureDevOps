{
  "agent_id": 6,
  "name": "Vehicles Routes Types",
  "file": "api/src/routes/vehicles.ts",
  "status": "success",
  "content": "import { Router, Request, Response } from \"express\"\n\nimport { cacheService } from '../config/cache';\nimport logger from '../config/logger'; // Wave 10: Add Winston logger\nimport { container } from '../container'\nimport { NotFoundError, ValidationError } from '../errors/app-error'\nimport { authenticateJWT } from '../middleware/auth';\nimport { doubleCsrfProtection as csrfProtection } from '../middleware/csrf'\nimport { asyncHandler } from '../middleware/errorHandler'\nimport { policyEnforcement } from '../middleware/policy-enforcement';\nimport { requireRBAC, Role, PERMISSIONS } from '../middleware/rbac';\nimport { validateBody, validateQuery, validateParams, validateAll } from '../middleware/validate';\nimport { VehicleService } from '../modules/fleet/services/vehicle.service'\nimport {\n  vehicleCreateSchema,\n  vehicleUpdateSchema,\n  vehicleQuerySchema,\n  vehicleIdSchema\n} from '../schemas/vehicles.schema';\nimport { TYPES } from '../types'\n\nconst router = Router()\n\n// SECURITY: All routes require authentication\nrouter.use(authenticateJWT)\n\n// GET all vehicles - Requires authentication, any role can read\n// CRIT-B-003: Added query parameter validation\nrouter.get(\"/\",\n  requireRBAC({\n    roles: [Role.ADMIN, Role.MANAGER, Role.USER, Role.GUEST],\n    permissions: [PERMISSIONS.VEHICLE_READ],\n    enforceTenantIsolation: true,\n    resourceType: 'vehicle'\n  }),\n  validateQuery(vehicleQuerySchema),\n  asyncHandler(async (req: Request, res: Response) => {\n    const { page = 1, pageSize = 20, search, status } = req.query\n    const tenantId = (req as any).user?.tenant_id\n\n    if (!tenantId) {\n      throw new ValidationError('Tenant ID is required')\n    }\n\n    // Wave 12 (Revised): Cache-aside pattern\n    const cacheKey = `vehicles:list:${tenantId}:${page}:${pageSize}:${search || ''}:${status || ''}`\n    const cached = await cacheService.get<{ data: any[], total: number }>(cacheKey)\n\n    if (cached) {\n      return res.json(cached)\n    }\n\n    // Use DI-resolved VehicleService instead of emulator\n    const vehicleService = container.get<VehicleService>(TYPES.VehicleService)\n\n    // Get all vehicles for this tenant\n    let vehicles = await vehicleService.getAllVehicles(tenantId)\n\n    // Apply filters (in future, move this to service layer)\n    if (search && typeof search === 'string') {\n      const searchLower = search.toLowerCase()\n      vehicles = vehicles.filter((v: any) =>\n        v.make?.toLowerCase().includes(searchLower) ||\n        v.model?.toLowerCase().includes(searchLower) ||\n        v.vin?.toLowerCase().includes(searchLower) ||\n        v.license_plate?.toLowerCase().includes(searchLower)\n      )\n    }\n\n    if (status && typeof status === 'string') {\n      vehicles = vehicles.filter((v: any) => v.status === status)\n    }\n\n    // Apply pagination\n    const total = vehicles.length\n    const offset = (Number(page) - 1) * Number(pageSize)\n    const data = vehicles.slice(offset, offset + Number(pageSize))\n\n    const result = { data, total }\n\n    // Cache for 5 minutes (300 seconds)\n    await cacheService.set(cacheKey, result, 300)\n\n    logger.info('Fetched vehicles', { tenantId, count: data.length, total })\n    res.json(result)\n  })\n)\n\n// GET vehicle by ID - Requires authentication + tenant isolation\n// CRIT-B-003: Added URL parameter validation\nrouter.get(\"/:id\",\n  requireRBAC({\n    roles: [Role.ADMIN, Role.MANAGER, Role.USER, Role.GUEST],\n    permissions: [PERMISSIONS.VEHICLE_READ],\n    enforceTenantIsolation: true,\n    resourceType: 'vehicle'\n  }),\n  validateParams(vehicleIdSchema),\n  asyncHandler(async (req: Request, res: Response) => {\n    try {\n      const tenantId = (req as any).user?.tenant_id\n      const vehicleId = req.params.id // Keep as string (UUID)\n\n      if (!tenantId) {\n        throw new ValidationError('Tenant ID is required')\n      }\n\n      // Validate UUID format (already done by validateParams, but add runtime check)\n      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i\n      if (!uuidRegex.test(vehicleId)) {\n        return res.status(400).json({\n          error: 'Invalid vehicle ID format',\n          message: 'Vehicle ID must be a valid UUID'\n        })\n      }\n\n      // Wave 12 (Revised): Cache-aside pattern for single vehicle\n      const cacheKey = `vehicle:${tenantId}:${vehicleId}`\n      const cached = await cacheService.get<any>(cacheKey)\n\n      if (cached) {\n        logger.debug('Vehicle cache hit', { vehicleId, tenantId })\n        return res.json({ data: cached })\n      }\n\n      // Use DI-resolved VehicleService\n      const vehicleService = container.get<VehicleService>(TYPES.VehicleService)\n      const vehicle = await vehicleService.getVehicleById(vehicleId, tenantId)\n\n      if (!vehicle) {\n        return res.status(404).json({\n          error: 'Vehicle not found',\n          message: `Vehicle with ID ${vehicleId} not found or does not belong to your organization`\n        })\n      }\n\n      // Cache for 10 minutes (600 seconds)\n      await cacheService.set(cacheKey, vehicle, 600)\n\n      logger.info('Fetched vehicle', { vehicleId, tenantId })\n      res.json({ data: vehicle })\n    } catch (error: any) {\n      // Handle specific database errors\n      if (error.code === '22P02') {\n        // PostgreSQL invalid UUID format\n        return res.status(400).json({\n          error: 'Invalid vehicle ID format',\n          message: 'Vehicle ID must be a valid UUID'\n        })\n      }\n\n      // Re-throw other errors to be handled by error middleware\n      throw error\n    }\n  })\n)\n\n// GET vehicle trips - Requires authentication + tenant isolation\nrouter.get(\"/:id/trips\",\n  requireRBAC({\n    roles: [Role.ADMIN, Role.MANAGER, Role.USER, Role.GUEST],\n    permissions: [PERMISSIONS.VEHICLE_READ],\n    enforceTenantIsolation: true,\n    resourceType: 'vehicle'\n  }),\n  validateParams(vehicleIdSchema),\n  asyncHandler(async (req: Request, res: Response) => {\n    const tenantId = (req as any).user?.tenant_id\n    const vehicleId = req.params.id\n\n    if (!tenantId) {\n      throw new ValidationError('Tenant ID is required')\n    }\n\n    // Cache key for trips\n    const cacheKey = `vehicle:${tenantId}:${vehicleId}:trips`\n    const cached = await cacheService.get<any[]>(cacheKey)\n\n    if (cached) {\n      logger.debug('Vehicle trips cache hit', { vehicleId, tenantId })\n      return res.json(cached)\n    }\n\n    // TODO: Implement actual trip fetching from database\n    // For now, return demo data to match frontend expectations\n    const demoTrips = [\n      {\n        id: `trip-${vehicleId}-1`,\n        status: 'completed',\n        driver_name: 'John Doe',\n        start_time: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),\n        duration: '2h 30m',\n        start_location: '123 Main St, City, State',\n        end_location: '456 Oak Ave, City, State',\n        distance: 45.2,\n        avg_speed: 35.5,\n        fuel_used: 3.2\n      },\n      {\n        id: `trip-${vehicleId}-2`,\n        status: 'completed',\n        driver_name: 'Jane Smith',\n        start_time: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),\n        duration: '1h 45m',\n        start_location: '789 Elm St, City, State',\n        end_location: '321 Pine Rd, City, State',\n        distance: 28.7,\n        avg_speed: 32.1,\n        fuel_used: 2.1\n      }\n    ]\n\n    // Cache for 5 minutes\n    await cacheService.set(cacheKey, demoTrips, 300)\n\n    logger.info('Fetched vehicle trips', { vehicleId, tenantId, count: demoTrips.length })\n    res.json(demoTrips)\n  })\n)\n\n// POST create vehicle - Requires admin or manager role\n// CRIT-B-003: Comprehensive input validation with sanitization\nrouter.post(\"/\",\n  csrfProtection,\n  policyEnforcement(['FLT-SAF-001'], { mode: 'warn', includeInResponse: true }),\n  requireRBAC({\n    roles: [Role.ADMIN, Role.MANAGER],\n    permissions: [PERMISSIONS.VEHICLE_CREATE],\n    enforceTenantIsolation: true,\n    resourceType: 'vehicle'\n  }),\n  validateBody(vehicleCreateSchema),\n  asyncHandler(async (req: Request, res: Response) => {\n    const tenantId = (req as any).user?.tenant_id\n\n    if (!tenantId) {\n      throw new ValidationError('Tenant ID is required')\n    }\n\n    // Validate required fields\n    if (!req.body.make || !req.body.model || !req.body.year) {\n      throw new ValidationError('Make, model, and year are required')\n    }\n\n    // Use DI-resolved VehicleService\n    const vehicleService = container.get<VehicleService>(TYPES.VehicleService)\n    const vehicle = await vehicleService.createVehicle(req.body, tenantId)\n\n    // Wave 12 (Revised): Invalidate list cache on create\n    // In production with Redis, use SCAN to find and delete matching keys\n    // For now, we rely on TTL expiration\n    logger.info('Vehicle created', { vehicleId: vehicle.id, tenantId })\n\n    res.status(201).json({ data: vehicle })\n  })\n)\n\n// PUT update vehicle - Requires admin or manager role + tenant isolation\n// CRIT-B-003: Validates both URL params and request body\nrouter.put(\"/:id\",\n  csrfProtection,\n  policyEnforcement(['FLT-SAF-001'], { mode: 'warn', includeInResponse: true }),\n  requireRBAC({\n    roles: [Role.ADMIN, Role.MANAGER],\n    permissions: [PERMISSIONS.VEHICLE_UPDATE],\n    enforceTenantIsolation: true,\n    resourceType: 'vehicle'\n  }),\n  validateAll({\n    params: vehicleIdSchema,\n    body: vehicleUpdateSchema\n  }),\n  asyncHandler(async (req: Request, res: Response) => {\n    try {\n      const tenantId = (req as any).user?.tenant_id\n      const vehicleId = req.params.id // Keep as string (UUID)\n\n      if (!tenantId) {\n        throw new ValidationError('Tenant ID is required')\n      }\n\n      // Use DI-resolved VehicleService\n      const vehicleService = container.get<VehicleService>(TYPES.VehicleService)\n\n      // VehicleService.updateVehicle will throw error if vehicle not found or access denied\n      const vehicle = await vehicleService.updateVehicle(vehicleId, req.body, tenantId)\n\n      if (!vehicle) {\n        return res.status(404).json({\n          error: 'Vehicle not found',\n          message: `Vehicle with ID ${vehicleId} not found or does not belong to your organization`\n        })\n      }\n\n      // Wave 12 (Revised): Invalidate cache on update\n      const cacheKey = `vehicle:${tenantId}:${vehicleId}`\n      await cacheService.del(cacheKey)\n\n      logger.info('Vehicle updated', { vehicleId, tenantId })\n      res.json({ data: vehicle })\n    } catch (error: any) {\n      if (error.code === '22P02') {\n        return res.status(400).json({\n          error: 'Invalid vehicle ID format',\n          message: 'Vehicle ID must be a valid UUID'\n        })\n      }\n      throw error\n    }\n  })\n)\n\n// DELETE vehicle\n// CRIT-B-003: Added URL parameter validation\nrouter.delete(\"/:id\",\n  csrfProtection,\n  policyEnforcement(['FLT-SAF-001'], { mode: 'warn', includeInResponse: true }),\n  requireRBAC({\n    roles: [Role.ADMIN, Role.MANAGER],\n    permissions: [PERMISSIONS.VEHICLE_DELETE],\n    enforceTenantIsolation: true,\n    resourceType: 'vehicle'\n  }),\n  validateParams(vehicleIdSchema),\n  asyncHandler(async (req: Request, res: Response) => {\n    try {\n      const tenantId = (req as any).user?.tenant_id\n      const vehicleId = req.params.id // Keep as string (UUID)\n\n      if (!tenantId) {\n        throw new ValidationError('Tenant ID is required')\n      }\n\n      // Use DI-resolved VehicleService\n      const vehicleService = container.get<VehicleService>(TYPES.VehicleService)\n      const deleted = await vehicleService.deleteVehicle(vehicleId, tenantId)\n\n      if (!deleted) {\n        return res.status(404).json({\n          error: 'Vehicle not found',\n          message: `Vehicle with ID ${vehicleId} not found or does not belong to your organization`\n        })\n      }\n\n      // Wave 12 (Revised): Invalidate cache on delete\n      const cacheKey = `vehicle:${tenantId}:${vehicleId}`\n      await cacheService.del(cacheKey)\n\n      logger.info('Vehicle deleted', { vehicleId, tenantId })\n      res.json({ message: \"Vehicle deleted successfully\" })\n    } catch (error: any) {\n      if (error.code === '22P02') {\n        return res.status(400).json({\n          error: 'Invalid vehicle ID format',\n          message: 'Vehicle ID must be a valid UUID'\n        })\n      }\n      throw error\n    }\n  })\n)\n\n// GET vehicle statistics - Requires authentication + tenant isolation\nrouter.get(\"/statistics\",\n  requireRBAC({\n    roles: [Role.ADMIN, Role.MANAGER, Role.USER],\n    permissions: [PERMISSIONS.VEHICLE_READ],\n    enforceTenantIsolation: true,\n    resourceType: 'vehicle'\n  }),\n  asyncHandler(async (req: Request, res: Response) => {\n    const tenantId = (req as any).user?.tenant_id\n\n    if (!tenantId) {\n      throw new ValidationError('Tenant ID is required')\n    }\n\n    // Cache key for statistics\n    const cacheKey = `vehicle:statistics:${tenantId}`\n    const cached = await cacheService.get<any>(cacheKey)\n\n    if (cached) {\n      logger.debug('Vehicle statistics cache hit', { tenantId })\n      return res.json(cached)\n    }\n\n    // Use DI-resolved VehicleService\n    const vehicleService = container.get<VehicleService>(TYPES.VehicleService)\n    const vehicles = await vehicleService.getAllVehicles(tenantId)\n\n    // Calculate statistics\n    const statistics = {\n      total: vehicles.length,\n      byStatus: {\n        active: vehicles.filter((v: any) => v.status === 'active').length,\n        inactive: vehicles.filter((v: any) =>",
  "timestamp": "2026-01-18T16:21:48.527933"
}