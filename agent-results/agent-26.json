{
  "agent_id": 26,
  "name": "Dockerfile",
  "file": "Dockerfile",
  "status": "success",
  "content": "FROM node:18-alpine AS builder\n\nWORKDIR /app\n\n# Copy package files\nCOPY package*.json ./\nCOPY .npmrc ./\n\n# Install dependencies with legacy peer deps\nRUN npm ci --legacy-peer-deps\n\n# Copy source code\nCOPY . .\n\n# Build the application\nRUN npm run build\n\n# Production stage\nFROM nginx:alpine\n\n# Create nginx user with UID 1001\nRUN addgroup -g 1001 -S nginx-app && \\\n    adduser -u 1001 -S nginx-app -G nginx-app\n\n# Create required directories with proper permissions\nRUN mkdir -p /var/cache/nginx /var/run /var/log/nginx /usr/share/nginx/html && \\\n    chown -R nginx-app:nginx-app /var/cache/nginx /var/run /var/log/nginx /usr/share/nginx/html && \\\n    chmod -R 755 /var/cache/nginx /var/run /var/log/nginx\n\n# Copy application files from builder\nCOPY --from=builder --chown=nginx-app:nginx-app /app/dist/ /usr/share/nginx/html/\n\n# Configure nginx with proxy temp paths for read-only filesystem\nRUN echo 'proxy_temp_path /var/cache/nginx/proxy_temp; \\\n    client_body_temp_path /var/cache/nginx/client_temp; \\\n    fastcgi_temp_path /var/cache/nginx/fastcgi_temp; \\\n    uwsgi_temp_path /var/cache/nginx/uwsgi_temp; \\\n    scgi_temp_path /var/cache/nginx/scgi_temp; \\\n    \\\n    server { \\\n    listen 8080; \\\n    root /usr/share/nginx/html; \\\n    index index.html; \\\n    \\\n    # ================================================================ \\\n    # Security Headers \\\n    # ================================================================ \\\n    \\\n    # Prevent clickjacking attacks - only allow same origin iframes \\\n    add_header X-Frame-Options \"DENY\" always; \\\n    \\\n    # Prevent MIME type sniffing \\\n    add_header X-Content-Type-Options \"nosniff\" always; \\\n    \\\n    # Enable XSS protection (legacy browsers) \\\n    add_header X-XSS-Protection \"1; mode=block\" always; \\\n    \\\n    # Control referrer information sent with requests \\\n    add_header Referrer-Policy \"strict-origin-when-cross-origin\" always; \\\n    \\\n    # Control which browser features and APIs can be used \\\n    add_header Permissions-Policy \"geolocation=(self), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=(self)\" always; \\\n    \\\n    # Content Security Policy - Comprehensive protection against XSS and injection attacks \\\n    # Allows: \\\n    #   - Self-hosted assets \\\n    #   - Google Maps API (maps.googleapis.com, maps.gstatic.com) \\\n    #   - DiceBear avatars API (api.dicebear.com) \\\n    #   - Google Fonts (fonts.googleapis.com, fonts.gstatic.com) \\\n    #   - CDN resources (cdn.jsdelivr.net, unpkg.com) \\\n    #   - WebSocket connections for real-time features \\\n    #   - Data URLs for inline images and fonts \\\n    #   - Blob URLs for dynamic content \\\n    add_header Content-Security-Policy \"default-src '\\''self'\\''; script-src '\\''self'\\'' '\\''unsafe-inline'\\'' '\\''unsafe-eval'\\'' https://maps.googleapis.com https://cdn.jsdelivr.net https://unpkg.com; style-src '\\''self'\\'' '\\''unsafe-inline'\\'' https://fonts.googleapis.com; font-src '\\''self'\\'' https://fonts.gstatic.com data:; img-src '\\''self'\\'' data: https: blob: https://api.dicebear.com https://maps.googleapis.com https://maps.gstatic.com; connect-src '\\''self'\\'' wss: ws: https://maps.googleapis.com https://api.dicebear.com https://*.azure.com https://*.windows.net; frame-src '\\''self'\\'' https://login.microsoftonline.com; worker-src '\\''self'\\'' blob:; object-src '\\''none'\\''; base-uri '\\''self'\\''; form-action '\\''self'\\''; frame-ancestors '\\''none'\\'';\" always; \\\n    \\\n    # Enable HSTS for production (uncomment when serving over HTTPS) \\\n    # add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains; preload\" always; \\\n    \\\n    # ================================================================ \\\n    # Application Routes \\\n    # ================================================================ \\\n    \\\n    location / { \\\n    try_files $uri $uri/ /index.html; \\\n    \\\n    # Cache control for HTML files - never cache \\\n    location = /index.html { \\\n    add_header Cache-Control \"no-cache, no-store, must-revalidate\" always; \\\n    add_header Pragma \"no-cache\" always; \\\n    add_header Expires \"0\" always; \\\n    } \\\n    } \\\n    \\\n    # Static assets caching \\\n    location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ { \\\n    expires 1y; \\\n    add_header Cache-Control \"public, immutable\" always; \\\n    access_log off; \\\n    } \\\n    \\\n    # API proxy with WebSocket support \\\n    location /api/ { \\\n    proxy_pass http://fleet-api-service.fleet-management.svc.cluster.local/api/; \\\n    proxy_ssl_verify off; \\\n    proxy_ssl_server_name on; \\\n    proxy_http_version 1.1; \\\n    proxy_set_header Host fleet-api-service.fleet-management.svc.cluster.local; \\\n    proxy_set_header X-Real-IP $remote_addr; \\\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; \\\n    proxy_set_header X-Forwarded-Proto $scheme; \\\n    proxy_set_header Upgrade $http_upgrade; \\\n    proxy_set_header Connection \"upgrade\"; \\\n    proxy_buffering on; \\\n    proxy_buffer_size 4k; \\\n    proxy_buffers 8 4k; \\\n    proxy_busy_buffers_size 8k; \\\n    proxy_connect_timeout 60s; \\\n    proxy_send_timeout 60s; \\\n    proxy_read_timeout 60s; \\\n    \\\n    # Hide backend server information \\\n    proxy_hide_header X-Powered-By; \\\n    proxy_hide_header Server; \\\n    } \\\n    \\\n    # Health check endpoint \\\n    location /ready { \\\n    access_log off; \\\n    return 200 \"OK\"; \\\n    add_header Content-Type text/plain; \\\n    } \\\n    \\\n    # Deny access to hidden files (security) \\\n    location ~ /\\. { \\\n    deny all; \\\n    access_log off; \\\n    log_not_found off; \\\n    } \\\n    \\\n    # Deny access to backup and sensitive files \\\n    location ~* \\.(env|log|git|sql|md|sh|yml|yaml|bak|swp|~)$ { \\\n    deny all; \\\n    access_log off; \\\n    log_not_found off; \\\n    } \\\n    }' > /etc/nginx/conf.d/default.conf && \\\n    # Create proxy temp directories\n    mkdir -p /var/cache/nginx/proxy_temp /var/cache/nginx/client_temp /var/cache/nginx/fastcgi_temp /var/cache/nginx/uwsgi_temp /var/cache/nginx/scgi_temp && \\\n    chown -R nginx-app:nginx-app /var/cache/nginx && \\\n    # Update nginx.conf to run as non-root\n    sed -i 's/user  nginx;/user  nginx-app;/g' /etc/nginx/nginx.conf && \\\n    # Allow nginx to write to necessary directories\n    touch /var/run/nginx.pid && \\\n    chown nginx-app:nginx-app /var/run/nginx.pid\n\nUSER nginx-app\nEXPOSE 8080",
  "timestamp": "2026-01-18T16:21:48.537594"
}