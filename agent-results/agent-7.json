{
  "agent_id": 7,
  "name": "Dashboard RBAC",
  "file": "api/src/middleware/rbac.ts",
  "status": "success",
  "content": "```typescript\n/**\n * Role-Based Access Control (RBAC) Middleware\n * CRIT-F-003: Comprehensive RBAC implementation\n *\n * This module implements a hierarchical role-based access control system\n * with granular permissions and tenant isolation.\n *\n * Security Features:\n * - Role hierarchy: admin > manager > user > guest\n * - Permission-based route protection\n * - Tenant isolation (users can only access their own tenant's data)\n * - Audit logging for all authorization decisions\n * - Cache-based permission lookup for performance\n *\n * @module middleware/rbac\n */\n\nimport { Response, NextFunction } from 'express'\n\nimport pool from '../config/database'\nimport logger from '../config/logger'\n\nimport { AuthRequest } from './auth'\nimport { getUserPermissions, clearPermissionCache } from './permissions'\n\n// ============================================================================\n// ROLE DEFINITIONS\n// ============================================================================\n\n/**\n * Role hierarchy (higher roles inherit all permissions from lower roles)\n */\nexport enum Role {\n  ADMIN = 'admin',\n  SECURITY_ADMIN = 'security-admin',\n  FLEET_MANAGER = 'fleet-manager',\n  MANAGER = 'manager',\n  MAINTENANCE_TECH = 'maintenance-tech',\n  COMPLIANCE_OFFICER = 'compliance-officer',\n  ANALYST = 'analyst',\n  DRIVER = 'driver',\n  USER = 'user',\n  VIEWER = 'viewer',\n  GUEST = 'guest'\n}\n\n/**\n * Role hierarchy map - each role includes all lower roles\n */\nconst ROLE_HIERARCHY: Record<Role, Role[]> = {\n  [Role.ADMIN]: [Role.ADMIN, Role.SECURITY_ADMIN, Role.FLEET_MANAGER, Role.MANAGER, Role.MAINTENANCE_TECH, Role.COMPLIANCE_OFFICER, Role.ANALYST, Role.DRIVER, Role.USER, Role.VIEWER, Role.GUEST],\n  [Role.SECURITY_ADMIN]: [Role.SECURITY_ADMIN, Role.VIEWER, Role.GUEST],\n  [Role.FLEET_MANAGER]: [Role.FLEET_MANAGER, Role.MANAGER, Role.MAINTENANCE_TECH, Role.ANALYST, Role.DRIVER, Role.USER, Role.VIEWER, Role.GUEST],\n  [Role.MANAGER]: [Role.MANAGER, Role.USER, Role.VIEWER, Role.GUEST],\n  [Role.MAINTENANCE_TECH]: [Role.MAINTENANCE_TECH, Role.VIEWER, Role.GUEST],\n  [Role.COMPLIANCE_OFFICER]: [Role.COMPLIANCE_OFFICER, Role.VIEWER, Role.GUEST],\n  [Role.ANALYST]: [Role.ANALYST, Role.VIEWER, Role.GUEST],\n  [Role.DRIVER]: [Role.DRIVER, Role.USER, Role.VIEWER, Role.GUEST],\n  [Role.USER]: [Role.USER, Role.VIEWER, Role.GUEST],\n  [Role.VIEWER]: [Role.VIEWER, Role.GUEST],\n  [Role.GUEST]: [Role.GUEST]\n}\n\n/**\n * Check if a user's role satisfies the required role(s)\n * Respects role hierarchy (admin can access manager routes, etc.)\n */\nexport function hasRole(userRole: string, requiredRoles: string[]): boolean {\n  const normalizedUserRole = userRole.toLowerCase() as Role\n  const hierarchy = ROLE_HIERARCHY[normalizedUserRole] || [normalizedUserRole]\n\n  return requiredRoles.some(required =>\n    hierarchy.includes(required.toLowerCase() as Role)\n  )\n}\n\n// ============================================================================\n// PERMISSION DEFINITIONS\n// ============================================================================\n\n/**\n * Standard permission format: resource:action:scope\n * Examples:\n * - vehicle:read:own\n * - vehicle:create:team\n * - vehicle:delete:global\n * - user:manage:global\n */\n\nexport const PERMISSIONS = {\n  // Vehicle permissions\n  VEHICLE_CREATE: 'vehicle:create',\n  VEHICLE_READ: 'vehicle:read',\n  VEHICLE_UPDATE: 'vehicle:update',\n  VEHICLE_DELETE: 'vehicle:delete',\n\n  // Driver permissions\n  DRIVER_CREATE: 'driver:create',\n  DRIVER_READ: 'driver:read',\n  DRIVER_UPDATE: 'driver:update',\n  DRIVER_DELETE: 'driver:delete',\n\n  // Maintenance permissions\n  MAINTENANCE_CREATE: 'maintenance:create',\n  MAINTENANCE_READ: 'maintenance:read',\n  MAINTENANCE_UPDATE: 'maintenance:update',\n  MAINTENANCE_DELETE: 'maintenance:delete',\n  MAINTENANCE_APPROVE: 'maintenance:approve',\n\n  // Work order permissions\n  WORK_ORDER_CREATE: 'work_order:create',\n  WORK_ORDER_READ: 'work_order:read',\n  WORK_ORDER_UPDATE: 'work_order:update',\n  WORK_ORDER_DELETE: 'work_order:delete',\n  WORK_ORDER_APPROVE: 'work_order:approve',\n\n  // Report permissions\n  REPORT_VIEW: 'report:view',\n  REPORT_EXPORT: 'report:export',\n  REPORT_SCHEDULE: 'report:schedule',\n\n  // Admin permissions\n  USER_MANAGE: 'user:manage',\n  ROLE_MANAGE: 'role:manage',\n  AUDIT_VIEW: 'audit:view',\n  SETTINGS_MANAGE: 'settings:manage',\n\n  // Fuel transaction permissions\n  FUEL_CREATE: 'fuel:create',\n  FUEL_READ: 'fuel:read',\n  FUEL_UPDATE: 'fuel:update',\n  FUEL_DELETE: 'fuel:delete',\n\n  // Document permissions\n  DOCUMENT_UPLOAD: 'document:upload',\n  DOCUMENT_READ: 'document:read',\n  DOCUMENT_DELETE: 'document:delete',\n\n  // Facility permissions\n  FACILITY_CREATE: 'facility:create',\n  FACILITY_READ: 'facility:read',\n  FACILITY_UPDATE: 'facility:update',\n  FACILITY_DELETE: 'facility:delete',\n\n  // Incident permissions\n  INCIDENT_CREATE: 'incident:create',\n  INCIDENT_READ: 'incident:read',\n  INCIDENT_UPDATE: 'incident:update',\n  INCIDENT_DELETE: 'incident:delete',\n\n  // Inspection permissions\n  INSPECTION_CREATE: 'inspection:create',\n  INSPECTION_READ: 'inspection:read',\n  INSPECTION_UPDATE: 'inspection:update',\n  INSPECTION_DELETE: 'inspection:delete',\n\n  // Safety alert permissions\n  SAFETY_ALERT_CREATE: 'safety_alert:create',\n  SAFETY_ALERT_READ: 'safety_alert:read',\n  SAFETY_ALERT_UPDATE: 'safety_alert:update',\n  SAFETY_ALERT_DELETE: 'safety_alert:delete',\n  SAFETY_METRICS_READ: 'safety_metrics:read',\n\n  // Analytics permissions\n  ANALYTICS_READ: 'analytics:read',\n\n  // Reports permissions\n  REPORTS_READ: 'reports:read'\n} as const\n\n// ============================================================================\n// RBAC MIDDLEWARE FUNCTIONS\n// ============================================================================\n\n/**\n * Middleware to require specific role(s)\n * Supports role hierarchy - higher roles can access lower role routes\n *\n * @param roles - Array of acceptable roles\n * @returns Express middleware function\n *\n * @example\n * router.post('/vehicles', requireRole([Role.ADMIN, Role.MANAGER]), handler)\n */\nexport function requireRole(roles: string[]) {\n  return async (req: AuthRequest, res: Response, next: NextFunction) => {\n    if (!req.user) {\n      logger.warn('RBAC: No user in request (authentication required)', {\n        path: req.path,\n        method: req.method\n      })\n      return res.status(401).json({\n        error: 'Authentication required',\n        code: 'AUTH_REQUIRED'\n      })\n    }\n\n    const userRole = req.user.role\n\n    if (!hasRole(userRole, roles)) {\n      logger.warn('RBAC: Insufficient role', {\n        userId: req.user.id,\n        userRole,\n        requiredRoles: roles,\n        path: req.path,\n        method: req.method\n      })\n\n      await logAuthorizationFailure({\n        userId: req.user.id,\n        tenantId: req.user.tenant_id,\n        action: `${req.method} ${req.path}`,\n        reason: 'Insufficient role',\n        requiredRoles: roles,\n        userRole,\n        ipAddress: req.ip,\n        userAgent: req.get('user-agent') || ''\n      })\n\n      return res.status(403).json({\n        error: 'Insufficient permissions',\n        required: roles,\n        current: userRole,\n        code: 'INSUFFICIENT_ROLE'\n      })\n    }\n\n    logger.debug('RBAC: Role check passed', {\n      userId: req.user.id,\n      userRole,\n      requiredRoles: roles,\n      path: req.path\n    })\n\n    next()\n  }\n}\n\n/**\n * Middleware to require specific permission(s)\n * More granular than role-based checks\n *\n * @param permissions - Array of required permissions (user must have at least one)\n * @param requireAll - If true, user must have ALL permissions (default: false)\n * @returns Express middleware function\n *\n * @example\n * router.delete('/vehicles/:id', requirePermission([PERMISSIONS.VEHICLE_DELETE]), handler)\n */\nexport function requirePermission(permissions: string[], requireAll: boolean = false) {\n  return async (req: AuthRequest, res: Response, next: NextFunction) => {\n    if (!req.user) {\n      logger.warn('RBAC: No user in request (authentication required)', {\n        path: req.path,\n        method: req.method\n      })\n      return res.status(401).json({\n        error: 'Authentication required',\n        code: 'AUTH_REQUIRED'\n      })\n    }\n\n    try {\n      const userPermissions = await getUserPermissions(req.user.id)\n\n      const hasRequiredPermissions = requireAll\n        ? permissions.every(p => userPermissions.has(p))\n        : permissions.some(p => userPermissions.has(p))\n\n      if (!hasRequiredPermissions) {\n        logger.warn('RBAC: Insufficient permissions', {\n          userId: req.user.id,\n          userRole: req.user.role,\n          requiredPermissions: permissions,\n          userPermissions: Array.from(userPermissions),\n          requireAll,\n          path: req.path,\n          method: req.method\n        })\n\n        await logAuthorizationFailure({\n          userId: req.user.id,\n          tenantId: req.user.tenant_id,\n          action: `${req.method} ${req.path}`,\n          reason: 'Insufficient permissions',\n          requiredPermissions: permissions,\n          userPermissions: Array.from(userPermissions),\n          ipAddress: req.ip,\n          userAgent: req.get('user-agent') || ''\n        })\n\n        return res.status(403).json({\n          error: 'Insufficient permissions',\n          required: permissions,\n          code: 'INSUFFICIENT_PERMISSIONS'\n        })\n      }\n\n      logger.debug('RBAC: Permission check passed', {\n        userId: req.user.id,\n        requiredPermissions: permissions,\n        path: req.path\n      })\n\n      next()\n    } catch (error) {\n      logger.error('RBAC: Permission check failed', {\n        error,\n        userId: req.user.id,\n        permissions\n      })\n      return res.status(500).json({\n        error: 'Internal server error',\n        code: 'PERMISSION_CHECK_FAILED'\n      })\n    }\n  }\n}\n\n/**\n * Middleware to enforce tenant isolation\n * Ensures users can only access resources within their tenant\n *\n * @param resourceType - Type of resource being accessed\n * @returns Express middleware function\n *\n * @example\n * router.get('/vehicles', requireTenantIsolation('vehicle'), handler)\n */\nexport function requireTenantIsolation(resourceType?: string) {\n  return async (req: AuthRequest, res: Response, next: NextFunction) => {\n    if (!req.user) {\n      return res.status(401).json({\n        error: 'Authentication required',\n        code: 'AUTH_REQUIRED'\n      })\n    }\n\n    // Admin users bypass tenant isolation (they can access all tenants)\n    if (req.user.role === Role.ADMIN) {\n      return next()\n    }\n\n    // For list endpoints, add tenant_id filter to query\n    if (req.method === 'GET' && !req.params.id) {\n      // Modify query to include tenant filter\n      req.query.tenant_id = req.user.tenant_id\n      logger.debug('RBAC: Added tenant filter to query', {\n        userId: req.user.id,\n        tenantId: req.user.tenant_id,\n        resourceType\n      })\n      return next()\n    }\n\n    // For individual resource access, verify tenant ownership\n    if (req.params.id) {\n      try {\n        const resourceId = req.params.id\n        const tenantOwned = await verifyTenantOwnership(\n          req.user.tenant_id,\n          resourceType || 'unknown',\n          resourceId\n        )\n\n        if (!tenantOwned) {\n          logger.warn('RBAC: Tenant isolation violation attempt', {\n            userId: req.user.id,\n            userTenantId: req.user.tenant_id,\n            resourceType,\n            resourceId,\n            path: req.path\n          })\n\n          await logAuthorizationFailure({\n            userId: req.user.id,\n            tenantId: req.user.tenant_id,\n            action: `${req.method} ${req.path}`,\n            reason: 'Tenant isolation violation',\n            resourceType,\n            resourceId,\n            ipAddress: req.ip,\n            userAgent: req.get('user-agent') || ''\n          })\n\n          // Return 404 instead of 403 to prevent information disclosure\n          return res.status(404).json({\n            error: `${resourceType} not found`,\n            code: 'NOT_FOUND'\n          })\n        }\n\n        next()\n      } catch (error) {\n        logger.error('RBAC: Tenant isolation check failed', {\n          error,\n          userId: req.user.id,\n          resourceType,\n          resourceId: req.params.id\n        })\n        return res.status(500).json({\n          error: 'Internal server error',\n          code: 'TENANT_CHECK_FAILED'\n        })\n      }\n    } else {\n      next()\n    }\n  }\n}\n\n/**\n * Combined middleware for complete RBAC protection\n * Enforces: authentication + role + permissions + tenant isolation\n *\n * @param config - RBAC configuration\n * @returns Express middleware function\n *\n * @example\n * router.post('/vehicles',\n *   requireRBAC({\n *     roles: [Role.ADMIN, Role.MANAGER],\n *     permissions: [PERMISSIONS.VEHICLE_CREATE],\n *     enforceIsolation: true,\n *     resourceType: 'vehicle'\n *   }),\n *   handler\n * )\n */\nexport function requireRBAC(config: {\n  roles?: string[]\n  permissions?: string[]\n  requireAllPermissions?: boolean\n  enforceTenantIsolation?: boolean\n  resourceType?: string\n}) {\n  const middlewares: any[] = []\n\n  // Add role check if roles specified\n  if (config.roles && config.roles.length > 0) {\n    middlewares.push(requireRole(config.roles))\n  }\n\n  // Add permission check if permissions specified\n  if (config.permissions && config.permissions.length > 0) {\n    middlewares.push(requirePermission(config.permissions, config.requireAllPermissions))\n  }\n\n  // Add tenant isolation if enabled\n  if (config.enforceTenantIsolation) {\n    middlewares.push(requireTenantIsolation(config.resourceType))\n  }\n\n  // Return combined middleware\n  return (req: AuthRequest, res: Response, next: NextFunction) =>",
  "timestamp": "2026-01-18T16:21:48.528641"
}