#!/usr/bin/env node
/**
 * Generate runtime-config.js dynamically based on deployment environment
 * This ensures the correct URLs are used for each deployment target
 *
 * Usage:
 *   node scripts/generate-runtime-config.js [environment]
 *
 * Environments:
 *   - development (default)
 *   - staging
 *   - production
 */

const fs = require('fs');
const path = require('path');

// Get environment from command line or default to development
const environment = process.argv[2] || process.env.NODE_ENV || 'development';

console.log(`üîß Generating runtime-config.js for environment: ${environment}`);

// Environment-specific configuration
const configs = {
  development: {
    VITE_AZURE_AD_CLIENT_ID: process.env.VITE_AZURE_AD_CLIENT_ID || "baae0851-0c24-4214-8587-e3fabc46bd4a",
    VITE_AZURE_AD_TENANT_ID: process.env.VITE_AZURE_AD_TENANT_ID || "0ec14b81-7b82-45ee-8f3d-cbc31ced5347",
    VITE_AZURE_AD_REDIRECT_URI: process.env.VITE_AZURE_AD_REDIRECT_URI || "http://localhost:5173/auth/callback",
    VITE_API_BASE_URL: process.env.VITE_API_BASE_URL || "http://localhost:3000",
    VITE_API_URL: process.env.VITE_API_URL || "http://localhost:3000",
    VITE_AZURE_MAPS_SUBSCRIPTION_KEY: process.env.VITE_AZURE_MAPS_SUBSCRIPTION_KEY || "",
    VITE_ENVIRONMENT: "development",
    VITE_BUILD_VERSION: process.env.BUILD_BUILDID || "dev",
    ENABLE_AI_AGENTS: true,
    ENABLE_VIDEO_ANALYTICS: true,
    ENABLE_PREDICTIVE_MAINTENANCE: true,
    ENABLE_REAL_TIME_TRACKING: true
  },

  staging: {
    VITE_AZURE_AD_CLIENT_ID: process.env.VITE_AZURE_AD_CLIENT_ID || "baae0851-0c24-4214-8587-e3fabc46bd4a",
    VITE_AZURE_AD_TENANT_ID: process.env.VITE_AZURE_AD_TENANT_ID || "0ec14b81-7b82-45ee-8f3d-cbc31ced5347",
    VITE_AZURE_AD_REDIRECT_URI: process.env.VITE_AZURE_AD_REDIRECT_URI || "https://green-pond-0f040980f.3.azurestaticapps.net/auth/callback",
    VITE_API_BASE_URL: process.env.VITE_API_BASE_URL || "https://green-pond-0f040980f.3.azurestaticapps.net/api",
    VITE_API_URL: process.env.VITE_API_URL || "https://green-pond-0f040980f.3.azurestaticapps.net/api",
    VITE_AZURE_MAPS_SUBSCRIPTION_KEY: process.env.VITE_AZURE_MAPS_SUBSCRIPTION_KEY || "",
    VITE_ENVIRONMENT: "staging",
    VITE_BUILD_VERSION: process.env.BUILD_BUILDID || "staging",
    ENABLE_AI_AGENTS: true,
    ENABLE_VIDEO_ANALYTICS: true,
    ENABLE_PREDICTIVE_MAINTENANCE: true,
    ENABLE_REAL_TIME_TRACKING: true
  },

  production: {
    VITE_AZURE_AD_CLIENT_ID: process.env.VITE_AZURE_AD_CLIENT_ID || "baae0851-0c24-4214-8587-e3fabc46bd4a",
    VITE_AZURE_AD_TENANT_ID: process.env.VITE_AZURE_AD_TENANT_ID || "0ec14b81-7b82-45ee-8f3d-cbc31ced5347",
    VITE_AZURE_AD_REDIRECT_URI: process.env.VITE_AZURE_AD_REDIRECT_URI || "https://fleet.capitaltechalliance.com/auth/callback",
    VITE_API_BASE_URL: process.env.VITE_API_BASE_URL || "https://fleet.capitaltechalliance.com/api",
    VITE_API_URL: process.env.VITE_API_URL || "https://fleet.capitaltechalliance.com/api",
    VITE_AZURE_MAPS_SUBSCRIPTION_KEY: process.env.VITE_AZURE_MAPS_SUBSCRIPTION_KEY || "",
    VITE_ENVIRONMENT: "production",
    VITE_BUILD_VERSION: process.env.BUILD_BUILDID || new Date().toISOString(),
    ENABLE_AI_AGENTS: true,
    ENABLE_VIDEO_ANALYTICS: true,
    ENABLE_PREDICTIVE_MAINTENANCE: true,
    ENABLE_REAL_TIME_TRACKING: true
  }
};

// Get configuration for the specified environment
const config = configs[environment];

if (!config) {
  console.error(`‚ùå Invalid environment: ${environment}`);
  console.error(`   Valid environments: ${Object.keys(configs).join(', ')}`);
  process.exit(1);
}

// Generate the runtime config file content
const configContent = `// Runtime configuration for ${environment} environment
// Auto-generated on ${new Date().toISOString()}
// DO NOT EDIT THIS FILE MANUALLY - it will be overwritten on next build

window.__RUNTIME_CONFIG__ = ${JSON.stringify(config, null, 2)};
`;

// Determine output paths
const publicPath = path.join(process.cwd(), 'public', 'runtime-config.js');
const distPath = path.join(process.cwd(), 'dist', 'runtime-config.js');

// Write to public directory (for development)
try {
  fs.mkdirSync(path.dirname(publicPath), { recursive: true });
  fs.writeFileSync(publicPath, configContent, 'utf8');
  console.log(`‚úÖ Generated: ${publicPath}`);
} catch (error) {
  console.error(`‚ùå Failed to write to public directory: ${error.message}`);
}

// Write to dist directory (for production build)
try {
  fs.mkdirSync(path.dirname(distPath), { recursive: true });
  fs.writeFileSync(distPath, configContent, 'utf8');
  console.log(`‚úÖ Generated: ${distPath}`);
} catch (error) {
  console.warn(`‚ö†Ô∏è  Dist directory not found (this is OK during development): ${error.message}`);
}

console.log(`\nüìã Configuration Summary:`);
console.log(`   Environment: ${environment}`);
console.log(`   Redirect URI: ${config.VITE_AZURE_AD_REDIRECT_URI}`);
console.log(`   API Base URL: ${config.VITE_API_BASE_URL}`);
console.log(`   Build Version: ${config.VITE_BUILD_VERSION}`);
console.log(`\n‚ú® Runtime configuration generated successfully!\n`);
