# ============================================================================
# Fleet Management System - Azure Static Web Apps Pipeline
# ============================================================================
# Simplified pipeline for deploying to Azure Static Web Apps
# ============================================================================

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/**
      - '*.md'

pr:
  branches:
    include:
      - main
      - develop

variables:
  - group: fleet-production-vars
  - group: fleet-secrets
  - name: nodeVersion
    value: '20.x'

pool:
  vmImage: 'ubuntu-latest'

stages:
  # ==========================================================================
  # STAGE 1: BUILD
  # ==========================================================================
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildJob
        displayName: 'Build Frontend'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - script: |
              npm ci
            displayName: 'Install Dependencies'

          - script: |
              npm run lint || echo "Lint completed with warnings"
            displayName: 'Run Linter'
            continueOnError: true

          - script: |
              npm run build
            displayName: 'Build Production'
            env:
              NODE_ENV: production

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Build Artifact'
            inputs:
              targetPath: 'dist'
              artifact: 'fleet-dist'
              publishLocation: 'pipeline'

  # ==========================================================================
  # STAGE 2: DEPLOY TO AZURE STATIC WEB APPS
  # ==========================================================================
  - stage: Deploy
    displayName: 'Deploy to Azure'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToSWA
        displayName: 'Deploy to Static Web App'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  displayName: 'Download Build Artifact'
                  inputs:
                    artifact: 'fleet-dist'
                    path: '$(Pipeline.Workspace)/dist'

                - task: AzureStaticWebApp@0
                  displayName: 'Deploy to Azure Static Web Apps'
                  inputs:
                    app_location: '$(Pipeline.Workspace)/dist'
                    skip_app_build: true
                    azure_static_web_apps_api_token: $(SWA_DEPLOYMENT_TOKEN)

  # ==========================================================================
  # STAGE 3: SMOKE TEST
  # ==========================================================================
  - stage: SmokeTest
    displayName: 'Smoke Tests'
    dependsOn: Deploy
    condition: succeeded()
    jobs:
      - job: SmokeTestJob
        displayName: 'Run Smoke Tests'
        steps:
          - script: |
              echo "Running smoke tests against production..."
              RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://green-pond-0f040980f.3.azurestaticapps.net)
              if [ "$RESPONSE" = "200" ]; then
                echo "Smoke test PASSED: Application returned HTTP 200"
              else
                echo "Smoke test FAILED: Application returned HTTP $RESPONSE"
                exit 1
              fi
            displayName: 'Health Check'

          - script: |
              echo "Verifying critical assets..."
              curl -sf https://green-pond-0f040980f.3.azurestaticapps.net/manifest.json > /dev/null && echo "PWA manifest OK" || echo "PWA manifest missing"
              curl -sf https://green-pond-0f040980f.3.azurestaticapps.net/sw.js > /dev/null && echo "Service worker OK" || echo "Service worker missing"
            displayName: 'Asset Verification'
