apiVersion: v1
kind: ConfigMap
metadata:
  name: migration-scripts
  namespace: fleet-management-staging
data:
  run-migrations.sh: |
    #!/bin/bash
    set -e

    echo "==================================="
    echo "Fleet Database Migration - STAGING"
    echo "==================================="
    echo ""

    # Database connection settings
    export PGHOST=fleet-postgres-service
    export PGPORT=5432
    export PGDATABASE=fleetdb_staging
    export PGUSER=fleetadmin

    echo "Starting migration process..."
    echo ""

    # Step 1: Apply base schema
    echo "[1/5] Applying base schema..."
    psql -f /migrations/database/schema.sql 2>&1 | grep -v "NOTICE:" || true
    echo "✓ Base schema applied"
    echo ""

    # Step 2: Apply indexes
    echo "[2/5] Creating indexes..."
    psql -f /migrations/database/indexes.sql 2>&1 | grep -v "NOTICE:" || true
    echo "✓ Indexes created"
    echo ""

    # Step 3: Apply orchestration schema
    echo "[3/5] Applying orchestration schema..."
    psql -f /migrations/database/orchestration-schema.sql 2>&1 | grep -v "NOTICE:" || true
    echo "✓ Orchestration schema applied"
    echo ""

    # Step 4: Apply api/src migrations
    echo "[4/5] Applying API migrations..."
    for migration in /migrations/api/src/migrations/*.sql; do
        if [ -f "$migration" ]; then
            filename=$(basename "$migration")
            echo "  Applying: $filename"
            psql -f "$migration" 2>&1 | grep -v "NOTICE:" || echo "  Warning: $filename may have issues (continuing...)"
        fi
    done
    echo "✓ API migrations applied"
    echo ""

    # Step 5: Apply api/db migrations
    echo "[5/5] Applying database migrations..."
    for migration in /migrations/api/db/migrations/*.sql; do
        if [ -f "$migration" ]; then
            filename=$(basename "$migration")
            echo "  Applying: $filename"
            psql -f "$migration" 2>&1 | grep -v "NOTICE:" || echo "  Warning: $filename may have issues (continuing...)"
        fi
    done
    echo "✓ Database migrations applied"
    echo ""

    # Final verification
    echo "Verifying migration results..."
    table_count=$(psql -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public';")
    echo "Total tables in database: $table_count"
    echo ""

    if [ "$table_count" -gt 200 ]; then
        echo "✓ Migration completed successfully!"
        echo "✓ Database has $table_count tables (expected 200+)"
    else
        echo "⚠ Migration completed but table count is lower than expected"
        echo "  Expected: 200+ tables"
        echo "  Actual: $table_count tables"
    fi

    echo ""
    echo "==================================="
    echo "Migration Complete"
    echo "==================================="
---
apiVersion: batch/v1
kind: Job
metadata:
  name: staging-database-migration
  namespace: fleet-management-staging
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: Never
      volumes:
        - name: migration-scripts
          configMap:
            name: migration-scripts
            defaultMode: 0755
        - name: migration-files
          emptyDir: {}
      initContainers:
        - name: copy-migrations
          image: busybox:1.36
          command: ['/bin/sh', '-c']
          args:
            - |
              echo "Preparing migration files..."
              mkdir -p /migrations/database
              mkdir -p /migrations/api/src/migrations
              mkdir -p /migrations/api/db/migrations
              echo "Migration directories created"
          volumeMounts:
            - name: migration-files
              mountPath: /migrations
      containers:
        - name: migrate
          image: postgres:15-alpine
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: fleet-secrets
                  key: DB_PASSWORD
          command: ['/bin/sh', '-c']
          args:
            - |
              echo "Installing git..."
              apk add --no-cache git bash

              echo "Cloning Fleet repository..."
              cd /tmp
              git clone --depth 1 --branch stage-a/requirements-inception https://github.com/asmortongpt/Fleet.git

              echo "Copying migration files..."
              cp -r /tmp/Fleet/database/* /migrations/database/ || true
              cp -r /tmp/Fleet/api/src/migrations/* /migrations/api/src/migrations/ || true
              cp -r /tmp/Fleet/api/db/migrations/* /migrations/api/db/migrations/ || true

              echo "Running migrations..."
              /scripts/run-migrations.sh
          volumeMounts:
            - name: migration-scripts
              mountPath: /scripts
            - name: migration-files
              mountPath: /migrations
