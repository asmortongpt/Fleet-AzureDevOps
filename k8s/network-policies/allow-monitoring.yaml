# Allow Monitoring Network Policy
# Allows Prometheus to scrape metrics from all pods
#
# SECURITY NOTE: This policy allows metrics collection from the monitoring
# namespace only, enabling observability while maintaining security

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-monitoring
  namespace: fleet-management
  labels:
    app: fleet
    policy-type: ingress
    target: monitoring
  annotations:
    description: "Allow Prometheus to scrape metrics from all pods"
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
        - namespaceSelector:
            matchLabels:
              name: ctafleet-monitoring
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        # API metrics port
        - port: 3000
          protocol: TCP
        # Python services metrics ports
        - port: 8000
          protocol: TCP
        - port: 8001
          protocol: TCP
        - port: 8002
          protocol: TCP
        # Node exporter
        - port: 9100
          protocol: TCP
        # PostgreSQL exporter
        - port: 9187
          protocol: TCP
        # Redis exporter
        - port: 9121
          protocol: TCP
---
# Also apply to ctafleet namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-monitoring
  namespace: ctafleet
  labels:
    app: fleet
    policy-type: ingress
    target: monitoring
  annotations:
    description: "Allow Prometheus to scrape metrics from all pods"
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
        - namespaceSelector:
            matchLabels:
              name: ctafleet-monitoring
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        # API metrics port
        - port: 3000
          protocol: TCP
        # Python services metrics ports
        - port: 8000
          protocol: TCP
        - port: 8001
          protocol: TCP
        - port: 8002
          protocol: TCP
        # Node exporter
        - port: 9100
          protocol: TCP
        # PostgreSQL exporter
        - port: 9187
          protocol: TCP
        # Redis exporter
        - port: 9121
          protocol: TCP
---
# Staging namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-monitoring
  namespace: ctafleet-staging
  labels:
    app: fleet
    policy-type: ingress
    target: monitoring
  annotations:
    description: "Allow Prometheus to scrape metrics from all pods"
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
        - namespaceSelector:
            matchLabels:
              name: ctafleet-monitoring
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        # API metrics port
        - port: 3000
          protocol: TCP
        # Python services metrics ports
        - port: 8000
          protocol: TCP
        - port: 8001
          protocol: TCP
        - port: 8002
          protocol: TCP
        # Node exporter
        - port: 9100
          protocol: TCP
        # PostgreSQL exporter
        - port: 9187
          protocol: TCP
        # Redis exporter
        - port: 9121
          protocol: TCP
