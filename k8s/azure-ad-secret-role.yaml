---
# ServiceAccount for applications that need Azure AD integration
# SECURITY: Use dedicated ServiceAccount instead of 'default'
# SECURITY: automountServiceAccountToken disabled - secrets accessed via volume mounts only
apiVersion: v1
kind: ServiceAccount
metadata:
  name: fleet-azure-ad-reader
  namespace: fleet-management
  labels:
    app: fleet-api
    component: authentication
    security.fleet.io/least-privilege: "true"
automountServiceAccountToken: false

---
# Role with minimal permissions - read only specific secret
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: azure-ad-secret-reader
  namespace: fleet-management
rules:
# Restrict to only the specific secret needed for Azure AD
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["azure-ad-secret"]
  verbs: ["get"]
# No list, watch, create, update, delete permissions

---
# RoleBinding with dedicated ServiceAccount
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: fleet-api-azure-ad-secret-binding
  namespace: fleet-management
subjects:
# Use dedicated ServiceAccount instead of 'default'
- kind: ServiceAccount
  name: fleet-azure-ad-reader
  namespace: fleet-management
roleRef:
  kind: Role
  name: azure-ad-secret-reader
  apiGroup: rbac.authorization.k8s.io
