# Retool Helm Chart Values for Fleet Management System
# Deployment: Self-Hosted Retool on Kubernetes
# Integration: Fleet PostgreSQL Database

# =============================================================================
# Image Configuration
# =============================================================================
image:
  repository: tryretool/backend
  tag: "3.58.0"  # Latest stable version
  pullPolicy: IfNotPresent

# =============================================================================
# Retool Configuration
# =============================================================================
config:
  # License key (use trial or commercial license)
  # Get trial license from: https://retool.com/self-hosted
  license Key: ""  # Add your Retool license key here

  # Encryption key for securing sensitive data (generated via openssl)
  encryptionKey: "WAEn/9a0w8CmU0LA3cRt4eSPaqVKj70HShR4k9GsSjHFVnoV"

  # JWT secret for authentication token signing
  jwtSecret: "TOmcMjs8/T3lZEkXOgWzZkYbhScehHPQbIuYFr0Y9dqfyfaU"

  # Cookie security settings
  useInsecureCookies: false  # Set true for HTTP, false for HTTPS

  # Database Configuration - Connect to Fleet PostgreSQL
  postgresql:
    host: "postgres-service.fleet-management.svc.cluster.local"
    port: 5432
    db: "retool"  # Separate database for Retool (will be created)
    user: "postgres"
    password: ""  # Will be set via existingSecret
    ssl:
      enabled: false  # Enable if using SSL for PostgreSQL

  # Use existing Fleet database secret for PostgreSQL password
  existingSecrets:
    postgresql:
      secretName: "fleet-api-secrets"
      passwordKey: "DB_PASSWORD"

  # Additional environment variables
  extraEnvVars:
    - name: RETOOL_HOST
      value: "retool.fleet.capitaltechalliance.com"
    - name: NODE_ENV
      value: "production"
    - name: LOG_LEVEL
      value: "info"

# =============================================================================
# Disable Built-in PostgreSQL (use Fleet's existing PostgreSQL)
# =============================================================================
postgresql:
  enabled: false  # We're using the existing Fleet PostgreSQL

# =============================================================================
# Workflows Configuration
# =============================================================================
workflows:
  enabled: true
  replicas: 1

  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "500m"

# Code Executor for workflows
codeExecutor:
  enabled: true
  replicas: 1

  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "500m"

# =============================================================================
# Main API Configuration
# =============================================================================
api:
  replicas: 2  # High availability

  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

  # Liveness probe
  livenessProbe:
    httpGet:
      path: /api/checkHealth
      port: 3000
    initialDelaySeconds: 30
    periodSeconds: 30

  # Readiness probe
  readinessProbe:
    httpGet:
      path: /api/checkHealth
      port: 3000
    initialDelaySeconds: 10
    periodSeconds: 10

# =============================================================================
# Frontend Jobs Server
# =============================================================================
jobRunner:
  replicas: 1

  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "500m"

# =============================================================================
# Service Configuration
# =============================================================================
service:
  type: ClusterIP
  port: 3000
  annotations: {}

# =============================================================================
# Ingress Configuration for Production Access
# =============================================================================
ingress:
  enabled: true
  className: "nginx"  # Using nginx ingress controller

  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

  hosts:
    - host: retool.fleet.capitaltechalliance.com
      paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: retool
              port:
                number: 3000

  tls:
    - secretName: retool-tls
      hosts:
        - retool.fleet.capitaltechalliance.com

# =============================================================================
# Persistence (for uploads and temporary files)
# =============================================================================
persistence:
  enabled: true
  storageClass: "default"
  accessMode: ReadWriteOnce
  size: 10Gi

# =============================================================================
# Security Context
# =============================================================================
securityContext:
  runAsUser: 1000
  runAsNonRoot: true
  fsGroup: 1000

# =============================================================================
# Pod Security Policy
# =============================================================================
podSecurityContext:
  seccompProfile:
    type: RuntimeDefault

# =============================================================================
# Network Policy
# =============================================================================
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress

# =============================================================================
# Monitoring and Observability
# =============================================================================
serviceMonitor:
  enabled: true  # Enable Prometheus monitoring
  namespace: fleet-management
  labels:
    prometheus: kube-prometheus

# =============================================================================
# Datadog Integration (uses existing Datadog agent)
# =============================================================================
env:
  - name: DD_AGENT_HOST
    valueFrom:
      fieldRef:
        fieldPath: status.hostIP
  - name: DD_SERVICE
    value: "retool"
  - name: DD_ENV
    value: "production"
  - name: DD_VERSION
    value: "3.58.0"

# =============================================================================
# Resource Scheduling
# =============================================================================
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - retool
          topologyKey: kubernetes.io/hostname

# =============================================================================
# Additional Configuration
# =============================================================================

# Autoscaling (optional - disable for initial deployment)
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80

# Init job to create Retool database
initJob:
  enabled: true
  command:
    - /bin/bash
    - -c
    - |
      export PGPASSWORD="$DB_PASSWORD"
      psql -h postgres-service.fleet-management.svc.cluster.local -U postgres -d postgres -c "CREATE DATABASE retool;" || echo "Database retool already exists"
  env:
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: fleet-api-secrets
          key: DB_PASSWORD
