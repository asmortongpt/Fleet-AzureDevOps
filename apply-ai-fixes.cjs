#!/usr/bin/env node
/**
 * Apply AI-Generated Fixes to Fleet Repository
 * Retrieves fixes from Azure VM database and applies them to local codebase
 */

const { execSync } = require('child_process');
const fs = require('fs').promises;
const path = require('path');

const REPO_ROOT = '/Users/andrewmorton/Documents/GitHub/Fleet';
const MIN_CONFIDENCE_SCORE = 0.85;

// Helper to get fixes from Azure VM database
async function getFixesFromVM() {
  console.log('ğŸ“¡ Retrieving fixes from Azure VM database...');

  const cmd = `ssh azureuser@172.173.175.71 'docker exec -i qa-postgres psql -U qauser -d fleet_qa -t -A -F "|" -c "SELECT file_path, issue_type, confidence_score, suggested_fix FROM cag_fix_requests WHERE suggested_fix IS NOT NULL AND LENGTH(suggested_fix) > 500 AND confidence_score >= ${MIN_CONFIDENCE_SCORE} ORDER BY confidence_score DESC LIMIT 100"'`;

  const output = execSync(cmd, { encoding: 'utf-8' });
  const lines = output.trim().split('\n');

  const fixes = [];
  for (const line of lines) {
    if (!line.trim()) continue;
    const parts = line.split('|');
    if (parts.length >= 4) {
      fixes.push({
        filePath: parts[0].replace('/home/azureuser/fleet-analysis/', ''),
        issueType: parts[1],
        confidenceScore: parseFloat(parts[2]),
        suggestedFix: parts.slice(3).join('|') // In case fix contains | character
      });
    }
  }

  console.log(`âœ… Retrieved ${fixes.length} high-quality fixes`);
  return fixes;
}

// Extract code block from markdown fix
function extractCodeFromFix(suggestedFix) {
  const codeBlockRegex = /```typescript\s*([\s\S]*?)```/g;
  const matches = [...suggestedFix.matchAll(codeBlockRegex)];

  if (matches.length === 0) {
    return null;
  }

  // Return the largest code block (usually the complete fixed code)
  return matches.reduce((longest, match) =>
    match[1].length > longest.length ? match[1] : longest,
    matches[0][1]
  ).trim();
}

async function applyPerformanceFixes(fixes) {
  console.log('');
  console.log('ğŸš€ APPLYING PERFORMANCE OPTIMIZATIONS');
  console.log('='.repeat(80));

  const perfFixes = fixes.filter(f => f.issueType === 'performance-fix');
  console.log(`Found ${perfFixes.length} performance fixes to apply`);

  // Create feature branch
  execSync('git checkout main', { cwd: REPO_ROOT, stdio: 'pipe' });
  execSync('git pull origin main', { cwd: REPO_ROOT, stdio: 'pipe' });

  try {
    execSync('git checkout -b ai-qa-performance-optimizations', { cwd: REPO_ROOT, stdio: 'pipe' });
  } catch (e) {
    // Branch might exist, switch to it
    execSync('git checkout ai-qa-performance-optimizations', { cwd: REPO_ROOT, stdio: 'pipe' });
  }

  let appliedCount = 0;
  const applied = [];

  for (const fix of perfFixes.slice(0, 30)) { // Apply top 30 fixes
    const fullPath = path.join(REPO_ROOT, fix.filePath);
    console.log(`\nğŸ“ ${fix.filePath}`);
    console.log(`   Confidence: ${fix.confidenceScore}`);

    // Check if file exists
    try {
      await fs.access(fullPath);
    } catch (e) {
      console.log(`   âš ï¸  File not found, skipping`);
      continue;
    }

    // Extract new code
    const newCode = extractCodeFromFix(fix.suggestedFix);
    if (!newCode) {
      console.log(`   âš ï¸  Could not extract code, skipping`);
      continue;
    }

    // Create backup
    const backup = `${fullPath}.ai-backup`;
    await fs.copyFile(fullPath, backup);

    // Apply fix
    await fs.writeFile(fullPath, newCode, 'utf-8');
    console.log(`   âœ… Applied (backup: ${path.basename(backup)})`);

    appliedCount++;
    applied.push({
      file: fix.filePath,
      confidence: fix.confidenceScore
    });
  }

  if (appliedCount > 0) {
    // Commit changes
    execSync('git add -A', { cwd: REPO_ROOT });

    const commitMsg = `feat: AI-generated performance optimizations (${appliedCount} fixes)

Applied ${appliedCount} performance optimizations with ${MIN_CONFIDENCE_SCORE}+ confidence:
${applied.map(a => `- ${a.file} (${a.confidence})`).slice(0, 10).join('\n')}

Generated by Fleet AI QA System
- Multi-AI analysis (Grok + OpenAI + Claude)
- "Is this the best you can do?" quality loop
- Average confidence: ${(applied.reduce((sum, a) => sum + a.confidence, 0) / applied.length).toFixed(2)}

Co-Authored-By: AI QA System <qa@fleet.ai>`;

    execSync(`git commit -m "${commitMsg.replace(/"/g, '\\"')}"`, { cwd: REPO_ROOT });
    console.log(`\nâœ… Committed ${appliedCount} performance fixes`);
  }

  return appliedCount;
}

async function applyTestFixes(fixes) {
  console.log('');
  console.log('ğŸ§ª APPLYING TEST GENERATION');
  console.log('='.repeat(80));

  const testFixes = fixes.filter(f => f.issueType === 'test-fix');
  console.log(`Found ${testFixes.length} test generation fixes to apply`);

  execSync('git checkout main', { cwd: REPO_ROOT, stdio: 'pipe' });

  try {
    execSync('git checkout -b ai-qa-test-generation', { cwd: REPO_ROOT, stdio: 'pipe' });
  } catch (e) {
    execSync('git checkout ai-qa-test-generation', { cwd: REPO_ROOT, stdio: 'pipe' });
  }

  let appliedCount = 0;

  for (const fix of testFixes) {
    const originalPath = fix.filePath;
    const testPath = originalPath.replace(/\.tsx?$/, '.test.ts');
    const fullTestPath = path.join(REPO_ROOT, testPath);

    console.log(`\nğŸ“ Creating ${testPath}`);
    console.log(`   Confidence: ${fix.confidenceScore}`);

    const testCode = extractCodeFromFix(fix.suggestedFix);
    if (!testCode) {
      console.log(`   âš ï¸  Could not extract code, skipping`);
      continue;
    }

    // Ensure directory exists
    await fs.mkdir(path.dirname(fullTestPath), { recursive: true });

    // Write test file
    await fs.writeFile(fullTestPath, testCode, 'utf-8');
    console.log(`   âœ… Test file created`);

    appliedCount++;
  }

  if (appliedCount > 0) {
    execSync('git add -A', { cwd: REPO_ROOT });

    const commitMsg = `test: AI-generated comprehensive test suites (${appliedCount} files)

Added ${appliedCount} test files generated by AI QA System:
- Unit tests with edge cases
- Integration tests
- Mock data and fixtures
- Comprehensive coverage

Generated by Fleet AI QA System

Co-Authored-By: AI QA System <qa@fleet.ai>`;

    execSync(`git commit -m "${commitMsg.replace(/"/g, '\\"')}"`, { cwd: REPO_ROOT });
    console.log(`\nâœ… Committed ${appliedCount} test files`);
  }

  return appliedCount;
}

async function main() {
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘         APPLY AI-GENERATED FIXES TO FLEET REPOSITORY                       â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('');
  console.log(`Repository: ${REPO_ROOT}`);
  console.log(`Min Confidence: ${MIN_CONFIDENCE_SCORE}`);
  console.log('');

  try {
    // Get fixes from VM
    const fixes = await getFixesFromVM();

    // Apply performance fixes
    const perfCount = await applyPerformanceFixes(fixes);

    // Apply test fixes
    const testCount = await applyTestFixes(fixes);

    console.log('');
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘                         âœ… APPLICATION COMPLETE                             â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('');
    console.log('ğŸ“Š SUMMARY:');
    console.log(`   âœ… Performance fixes applied: ${perfCount}`);
    console.log(`   âœ… Test files created: ${testCount}`);
    console.log('');
    console.log('ğŸ”„ NEXT STEPS:');
    console.log('   1. Review changes: git diff ai-qa-performance-optimizations');
    console.log('   2. Run tests: npm test');
    console.log('   3. Push branches: git push -u origin ai-qa-performance-optimizations');
    console.log('   4. Create PR on GitHub');
    console.log('');

  } catch (error) {
    console.error('âŒ Error:', error.message);
    process.exit(1);
  }
}

main();
