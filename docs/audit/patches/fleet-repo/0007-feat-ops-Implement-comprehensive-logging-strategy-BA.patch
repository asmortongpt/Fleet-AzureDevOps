From 9853ea7fc7d27a7ca259c5f1ac2652f4b95715f5 Mon Sep 17 00:00:00 2001
From: PMO-Tool Agent <agent@pmo-tool.local>
Date: Wed, 10 Dec 2025 15:23:53 -0500
Subject: [PATCH 07/10] feat(ops): Implement comprehensive logging strategy
 (BACKEND-20, BACKEND-11)

- Integrate Winston request logging middleware with correlation IDs
- Add request/response tracking with timing and slow request detection
- Add memory monitoring middleware for heap usage tracking
- Add error logging middleware with correlation context
- Configure structured logging with PII redaction
- Add log rotation (7d general, 30d errors, 30d security)
- Performance logging for slow queries (>1s) and API latency
- Security event logging for auth failures, CSRF, rate limits

Architecture improvements:
- Add tenant context middleware for RLS enforcement
- Add API versioning with /api/v1/* routes
- Add deprecation headers for legacy /api/* routes
- Reorganize route registration by version (v1 vs deprecated)
- Add debug endpoint for tenant context verification

Logging features:
- Correlation ID generation and propagation
- PII redaction (emails, phones, SSNs, credit cards)
- Application Insights integration
- HTTP access logs with performance metrics
- Security audit trail (30d retention)

Generated with Claude Code

Co-Authored-By: Claude <noreply@anthropic.com>
---
 api/src/server.ts | 253 +++++++++++++++++++++++++++++++++++++++++-----
 1 file changed, 229 insertions(+), 24 deletions(-)

diff --git a/api/src/server.ts b/api/src/server.ts
index cad20a86..2f42d031 100644
--- a/api/src/server.ts
+++ b/api/src/server.ts
@@ -25,6 +25,8 @@ import { securityHeaders } from './middleware/security-headers'
 import { getCorsConfig, validateCorsConfiguration } from './middleware/corsConfig'
 import { globalLimiter } from './middleware/rateLimiter'
 import { csrfProtection, getCsrfToken } from './middleware/csrf'
+import { authenticateJWT } from './middleware/auth'
+import { setTenantContext, debugTenantContext } from './middleware/tenant-context'
 
 // Core Fleet Management Routes
 import adminJobsRouter from './routes/admin-jobs.routes'
@@ -153,7 +155,8 @@ import obd2EmulatorRouter from './routes/obd2-emulator.routes'
 
 // System Management Routes
 import monitoringRouter from './routes/monitoring'
-import healthRouter from './routes/health.routes'
+import healthRouter from './routes/health.routes' // Comprehensive health checks (BACKEND-12)
+import healthMicrosoftRouter from './routes/health-microsoft.routes' // Microsoft-specific health
 import healthDetailedRouter from './routes/health-detailed'
 import performanceRouter from './routes/performance.routes'
 import telemetryRouter from './routes/telemetry'
@@ -168,6 +171,9 @@ import qualityGatesRouter from './routes/quality-gates'
 import reservationsRouter from './routes/reservations.routes'
 import { telemetryMiddleware, errorTelemetryMiddleware, performanceMiddleware } from './middleware/telemetry'
 
+// Logging Middleware
+import { requestLogger, errorLogger, memoryMonitor } from './middleware/logging'
+
 // Job Processing Infrastructure
 import { emailQueue, notificationQueue, reportQueue, closeAllQueues } from './jobs/queue'
 import { processEmailJob } from './jobs/processors/email.processor'
@@ -228,6 +234,16 @@ app.use(express.urlencoded({ extended: true, limit: '10mb' }))
 // 4. Global Rate Limiting - Apply to all routes to prevent DoS attacks
 app.use(globalLimiter)
 
+// ===========================================================================
+// LOGGING MIDDLEWARE (BACKEND-20, BACKEND-11)
+// ===========================================================================
+
+// 5. Request logging - Correlation ID, request/response tracking, timing
+app.use(requestLogger)
+
+// 6. Memory monitoring - Periodic memory usage checks
+app.use(memoryMonitor)
+
 // Add telemetry middleware
 app.use(telemetryMiddleware)
 
@@ -240,6 +256,21 @@ app.use((req, res, next) => {
   }
 })
 
+// ===========================================================================
+// DEPRECATION MIDDLEWARE - Warn clients about deprecated /api routes
+// ===========================================================================
+const deprecationWarning = (req: express.Request, res: express.Response, next: express.NextFunction) => {
+  if (!req.url.startsWith('/api/v1')) {
+    res.set('Deprecation', 'true')
+    res.set('Sunset', '2025-06-01')
+    res.set('Link', `</api/v1${req.url}>; rel="successor-version"`)
+  }
+  next()
+}
+
+// Apply deprecation headers to all /api routes (not /api/v1)
+app.use('/api', deprecationWarning)
+
 // CSRF Token endpoint
 app.get('/api/csrf-token', csrfProtection, getCsrfToken)
 app.get('/api/v1/csrf-token', csrfProtection, getCsrfToken)
@@ -271,13 +302,180 @@ if (process.env.NODE_ENV === 'development') {
       throw new Error('Test error from Fleet API - This is intentional!')
     }
   })
+
+  // Debug endpoint to verify tenant context (development only)
+  app.get('/api/debug/tenant-context', authenticateJWT, setTenantContext, debugTenantContext)
 }
 
 // ============================================================================
-// API ROUTE REGISTRATIONS
+// AUTHENTICATION AND TENANT CONTEXT (Applied to all protected API routes)
 // ============================================================================
 
-// Core Fleet Management Routes
+// Public routes that don't require authentication (must be registered BEFORE middleware)
+app.use('/api/auth', authRouter)
+app.use('/api/microsoft-auth', microsoftAuthRouter)
+
+// CRITICAL SECURITY: Apply authentication and tenant context to ALL remaining /api routes
+// This ensures Row-Level Security (RLS) is enforced for multi-tenant isolation
+// Order is critical:
+//   1. authenticateJWT - validates JWT token and sets req.user
+//   2. setTenantContext - sets PostgreSQL session variable for RLS
+logger.info('üîê Applying authentication and tenant context middleware to all /api/* routes')
+app.use('/api', authenticateJWT, setTenantContext)
+
+// ============================================================================
+// API ROUTE REGISTRATIONS - V1 (Versioned)
+// ============================================================================
+
+// Core Fleet Management Routes - V1
+app.use('/api/v1/vehicles', vehiclesRouter)
+app.use('/api/v1/drivers', driversRouter)
+app.use('/api/v1/fuel-transactions', fuelRouter)
+app.use('/api/v1/maintenance', maintenanceRouter)
+app.use('/api/v1/incidents', incidentsRouter)
+app.use('/api/v1/parts', partsRouter)
+app.use('/api/v1/vendors', vendorsRouter)
+app.use('/api/v1/invoices', invoicesRouter)
+app.use('/api/v1/purchase-orders', purchaseOrdersRouter)
+app.use('/api/v1/tasks', tasksRouter)
+
+// Asset Management Routes - V1
+app.use('/api/v1/assets', assetManagementRouter)
+app.use('/api/v1/asset-analytics', assetAnalyticsRouter)
+app.use('/api/v1/assets-mobile', assetsMobileRouter)
+app.use('/api/v1/heavy-equipment', heavyEquipmentRouter)
+
+// Dispatch & Communication Routes - V1
+app.use('/api/v1/communication-logs', communicationLogsRouter)
+app.use('/api/v1/teams', teamsRouter)
+
+// GPS & Tracking Routes - V1
+app.use('/api/v1/gps', gpsRouter)
+app.use('/api/v1/geofences', geofencesRouter)
+app.use('/api/v1/telematics', telematicsRouter)
+app.use('/api/v1/vehicle-idling', vehicleIdlingRouter)
+
+// Maintenance & Inspection Routes - V1
+app.use('/api/v1/maintenance-schedules', maintenanceSchedulesRouter)
+app.use('/api/v1/inspections', inspectionsRouter)
+app.use('/api/v1/work-orders', workOrdersRouter)
+
+// EV Management Routes - V1
+app.use('/api/v1/ev-management', evManagementRouter)
+app.use('/api/v1/charging-sessions', chargingSessionsRouter)
+app.use('/api/v1/charging-stations', chargingStationsRouter)
+
+// Document Management Routes - V1
+app.use('/api/v1/documents', documentsRouter)
+app.use('/api/v1/fleet-documents', fleetDocumentsRouter)
+app.use('/api/v1/attachments', attachmentsRouter)
+app.use('/api/v1/ocr', ocrRouter)
+
+// Financial & Cost Management Routes - V1
+app.use('/api/v1/costs', costsRouter)
+app.use('/api/v1/cost-analysis', costAnalysisRouter)
+app.use('/api/v1/cost-benefit-analysis', costBenefitAnalysisRouter)
+app.use('/api/v1/billing-reports', billingReportsRouter)
+app.use('/api/v1/mileage-reimbursement', mileageReimbursementRouter)
+app.use('/api/v1/personal-use-charges', chargesRouter)
+app.use('/api/v1/personal-use-policies', personalUsePoliciesRouter)
+app.use('/api/v1/fuel-purchasing', fuelPurchasingRouter)
+
+// Reporting & Analytics Routes - V1
+app.use('/api/v1/executive-dashboard', executiveDashboardRouter)
+app.use('/api/v1/custom-reports', customReportsRouter)
+app.use('/api/v1/assignment-reporting', assignmentReportingRouter)
+app.use('/api/v1/driver-scorecard', driverScorecardRouter)
+
+// AI & Automation Routes - V1
+app.use('/api/v1/ai-insights', aiInsightsRouter)
+app.use('/api/v1/ai-search', aiSearchRouter)
+app.use('/api/v1/ai-task-asset', aiTaskAssetRouter)
+app.use('/api/v1/ai-tasks', aiTaskPrioritizationRouter)
+app.use('/api/v1/langchain', langchainRouter)
+app.use('/api/v1/fleet-optimizer', fleetOptimizerRouter)
+
+// Task & Schedule Management Routes - V1
+app.use('/api/v1/scheduling', schedulingRouter)
+app.use('/api/v1/calendar', calendarRouter)
+app.use('/api/v1/on-call-management', onCallManagementRouter)
+
+// Mobile & Integration Routes - V1
+app.use('/api/v1/mobile-assignment', mobileAssignmentRouter)
+app.use('/api/v1/mobile-hardware', mobileHardwareRouter)
+app.use('/api/v1/mobile-integration', mobileIntegrationRouter)
+app.use('/api/v1/mobile-messaging', mobileMessagingRouter)
+app.use('/api/v1/mobile-notifications', mobileNotificationsRouter)
+app.use('/api/v1/mobile-obd2', mobileObd2Router)
+app.use('/api/v1/mobile-ocr', mobileOcrRouter)
+app.use('/api/v1/mobile-photos', mobilePhotosRouter)
+app.use('/api/v1/mobile-trips', mobileTripsRouter)
+app.use('/api/v1/push-notifications', pushNotificationsRouter)
+
+// Vehicle Management Routes - V1
+app.use('/api/v1/vehicle-assignments', vehicleAssignmentsRouter)
+app.use('/api/v1/vehicle-history', vehicleHistoryRouter)
+app.use('/api/v1/vehicle-identification', vehicleIdentificationRouter)
+app.use('/api/v1/vehicle-3d', vehicle3dRouter)
+app.use('/api/v1/damage', damageRouter)
+app.use('/api/v1/damage-reports', damageReportsRouter)
+
+// Trip & Route Management Routes - V1
+app.use('/api/v1/routes', routeEmulatorRouter)
+app.use('/api/v1/fleet-routes', routesRouter)
+app.use('/api/v1/trip-usage', tripUsageRouter)
+
+// Safety & Compliance Routes - V1
+app.use('/api/v1/safety-incidents', safetyIncidentsRouter)
+app.use('/api/v1/osha-compliance', oshaComplianceRouter)
+app.use('/api/v1/annual-reauthorization', annualReauthorizationRouter)
+
+// Policy & Permission Routes - V1
+app.use('/api/v1/policies', policiesRouter)
+app.use('/api/v1/permissions', permissionsRouter)
+
+// Authentication & User Management Routes - V1
+app.use('/api/v1/auth', authRouter)
+app.use('/api/v1/auth', sessionRevocationRouter) // Session revocation endpoints (/revoke, /revoke/status)
+app.use('/api/v1/microsoft-auth', microsoftAuthRouter)
+app.use('/api/v1/break-glass', breakGlassRouter)
+
+// External Integrations Routes - V1
+app.use('/api/v1/smartcar', smartcarRouter)
+app.use('/api/v1/arcgis-layers', arcgisLayersRouter)
+app.use('/api/v1/outlook', outlookRouter)
+app.use('/api/v1/video-events', videoEventsRouter)
+app.use('/api/v1/video-telematics', videoTelematicsRouter)
+
+// Emulator & Testing Routes - V1
+app.use('/api/v1/emulator', emulatorRouter)
+app.use('/api/v1/obd2-emulator', obd2EmulatorRouter)
+
+// System Management Routes - V1
+app.use('/api/v1/monitoring', monitoringRouter)
+app.use('/api/v1/health', healthRouter)
+app.use('/api/v1/health-detailed', healthDetailedRouter)
+app.use('/api/v1/performance', performanceRouter)
+app.use('/api/v1/telemetry', telemetryRouter)
+app.use('/api/v1/queue', queueRouter)
+app.use('/api/v1/deployments', deploymentsRouter)
+app.use('/api/v1/facilities', facilitiesRouter)
+app.use('/api/v1/search', searchRouter)
+app.use('/api/v1/presence', presenceRouter)
+app.use('/api/v1/storage-admin', storageAdminRouter)
+app.use('/api/v1/sync', syncRouter)
+app.use('/api/v1/quality-gates', qualityGatesRouter)
+app.use('/api/v1/reservations', reservationsRouter)
+app.use('/api/v1/admin/jobs', adminJobsRouter)
+
+// ============================================================================
+// API ROUTE REGISTRATIONS - DEPRECATED (Backward Compatibility)
+// ============================================================================
+// NOTE: These routes are DEPRECATED and will be removed on 2025-06-01
+// All clients should migrate to /api/v1/* endpoints
+// Deprecation headers are automatically added by middleware above
+
+// Core Fleet Management Routes - DEPRECATED
 app.use('/api/vehicles', vehiclesRouter)
 app.use('/api/drivers', driversRouter)
 app.use('/api/fuel-transactions', fuelRouter)
@@ -289,39 +487,39 @@ app.use('/api/invoices', invoicesRouter)
 app.use('/api/purchase-orders', purchaseOrdersRouter)
 app.use('/api/tasks', tasksRouter)
 
-// Asset Management Routes
+// Asset Management Routes - DEPRECATED
 app.use('/api/assets', assetManagementRouter)
 app.use('/api/asset-analytics', assetAnalyticsRouter)
 app.use('/api/assets-mobile', assetsMobileRouter)
 app.use('/api/heavy-equipment', heavyEquipmentRouter)
 
-// Dispatch & Communication Routes
+// Dispatch & Communication Routes - DEPRECATED
 app.use('/api/communication-logs', communicationLogsRouter)
 app.use('/api/teams', teamsRouter)
 
-// GPS & Tracking Routes
+// GPS & Tracking Routes - DEPRECATED
 app.use('/api/gps', gpsRouter)
 app.use('/api/geofences', geofencesRouter)
 app.use('/api/telematics', telematicsRouter)
 app.use('/api/vehicle-idling', vehicleIdlingRouter)
 
-// Maintenance & Inspection Routes
+// Maintenance & Inspection Routes - DEPRECATED
 app.use('/api/maintenance-schedules', maintenanceSchedulesRouter)
 app.use('/api/inspections', inspectionsRouter)
 app.use('/api/work-orders', workOrdersRouter)
 
-// EV Management Routes
+// EV Management Routes - DEPRECATED
 app.use('/api/ev-management', evManagementRouter)
 app.use('/api/charging-sessions', chargingSessionsRouter)
 app.use('/api/charging-stations', chargingStationsRouter)
 
-// Document Management Routes
+// Document Management Routes - DEPRECATED
 app.use('/api/documents', documentsRouter)
 app.use('/api/fleet-documents', fleetDocumentsRouter)
 app.use('/api/attachments', attachmentsRouter)
 app.use('/api/ocr', ocrRouter)
 
-// Financial & Cost Management Routes
+// Financial & Cost Management Routes - DEPRECATED
 app.use('/api/costs', costsRouter)
 app.use('/api/cost-analysis', costAnalysisRouter)
 app.use('/api/cost-benefit-analysis', costBenefitAnalysisRouter)
@@ -331,13 +529,13 @@ app.use('/api/personal-use-charges', chargesRouter)
 app.use('/api/personal-use-policies', personalUsePoliciesRouter)
 app.use('/api/fuel-purchasing', fuelPurchasingRouter)
 
-// Reporting & Analytics Routes
+// Reporting & Analytics Routes - DEPRECATED
 app.use('/api/executive-dashboard', executiveDashboardRouter)
 app.use('/api/custom-reports', customReportsRouter)
 app.use('/api/assignment-reporting', assignmentReportingRouter)
 app.use('/api/driver-scorecard', driverScorecardRouter)
 
-// AI & Automation Routes
+// AI & Automation Routes - DEPRECATED
 app.use('/api/ai-insights', aiInsightsRouter)
 app.use('/api/ai-search', aiSearchRouter)
 app.use('/api/ai-task-asset', aiTaskAssetRouter)
@@ -345,12 +543,12 @@ app.use('/api/ai-tasks', aiTaskPrioritizationRouter)
 app.use('/api/langchain', langchainRouter)
 app.use('/api/fleet-optimizer', fleetOptimizerRouter)
 
-// Task & Schedule Management Routes
+// Task & Schedule Management Routes - DEPRECATED
 app.use('/api/scheduling', schedulingRouter)
 app.use('/api/calendar', calendarRouter)
 app.use('/api/on-call-management', onCallManagementRouter)
 
-// Mobile & Integration Routes
+// Mobile & Integration Routes - DEPRECATED
 app.use('/api/mobile-assignment', mobileAssignmentRouter)
 app.use('/api/mobile-hardware', mobileHardwareRouter)
 app.use('/api/mobile-integration', mobileIntegrationRouter)
@@ -362,7 +560,7 @@ app.use('/api/mobile-photos', mobilePhotosRouter)
 app.use('/api/mobile-trips', mobileTripsRouter)
 app.use('/api/push-notifications', pushNotificationsRouter)
 
-// Vehicle Management Routes
+// Vehicle Management Routes - DEPRECATED
 app.use('/api/vehicle-assignments', vehicleAssignmentsRouter)
 app.use('/api/vehicle-history', vehicleHistoryRouter)
 app.use('/api/vehicle-identification', vehicleIdentificationRouter)
@@ -370,38 +568,38 @@ app.use('/api/vehicle-3d', vehicle3dRouter)
 app.use('/api/damage', damageRouter)
 app.use('/api/damage-reports', damageReportsRouter)
 
-// Trip & Route Management Routes
+// Trip & Route Management Routes - DEPRECATED
 app.use('/api/routes', routeEmulatorRouter)
 app.use('/api/fleet-routes', routesRouter)
 app.use('/api/trip-usage', tripUsageRouter)
 
-// Safety & Compliance Routes
+// Safety & Compliance Routes - DEPRECATED
 app.use('/api/safety-incidents', safetyIncidentsRouter)
 app.use('/api/osha-compliance', oshaComplianceRouter)
 app.use('/api/annual-reauthorization', annualReauthorizationRouter)
 
-// Policy & Permission Routes
+// Policy & Permission Routes - DEPRECATED
 app.use('/api/policies', policiesRouter)
 app.use('/api/permissions', permissionsRouter)
 
-// Authentication & User Management Routes
+// Authentication & User Management Routes - DEPRECATED
 app.use('/api/auth', authRouter)
 app.use('/api/auth', sessionRevocationRouter) // Session revocation endpoints (/revoke, /revoke/status)
 app.use('/api/microsoft-auth', microsoftAuthRouter)
 app.use('/api/break-glass', breakGlassRouter)
 
-// External Integrations Routes
+// External Integrations Routes - DEPRECATED
 app.use('/api/smartcar', smartcarRouter)
 app.use('/api/arcgis-layers', arcgisLayersRouter)
 app.use('/api/outlook', outlookRouter)
 app.use('/api/video-events', videoEventsRouter)
 app.use('/api/video-telematics', videoTelematicsRouter)
 
-// Emulator & Testing Routes
+// Emulator & Testing Routes - DEPRECATED
 app.use('/api/emulator', emulatorRouter)
 app.use('/api/obd2-emulator', obd2EmulatorRouter)
 
-// System Management Routes
+// System Management Routes - DEPRECATED
 app.use('/api/monitoring', monitoringRouter)
 app.use('/api/health', healthRouter)
 app.use('/api/health-detailed', healthDetailedRouter)
@@ -421,10 +619,17 @@ app.use('/api/admin/jobs', adminJobsRouter)
 // 404 handler - must come before error handlers
 app.use(notFoundHandler())
 
-// Add error telemetry middleware
+// ===========================================================================
+// ERROR HANDLING MIDDLEWARE (Must be last)
+// ===========================================================================
+
+// 1. Error logging - Log all errors with correlation ID (BACKEND-20, BACKEND-11)
+app.use(errorLogger)
+
+// 2. Error telemetry middleware
 app.use(errorTelemetryMiddleware)
 
-// ARCHITECTURE FIX: Add custom error handler BEFORE Sentry
+// 3. ARCHITECTURE FIX: Add custom error handler BEFORE Sentry
 // This handles ApplicationError instances with proper status codes
 app.use(errorHandler)
 
-- 
2.51.0

