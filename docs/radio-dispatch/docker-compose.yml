version: '3.9'

services:
  # Infrastructure
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: radio_fleet
      POSTGRES_USER: radio_fleet
      POSTGRES_PASSWORD: dev_password_change_me
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U radio_fleet"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Message broker (local Kafka alternative to Azure Event Hubs/Service Bus)
  redpanda:
    image: docker.redpanda.com/vectorized/redpanda:latest
    command:
      - redpanda
      - start
      - --smp
      - '1'
      - --reserve-memory
      - 0M
      - --overprovisioned
      - --node-id
      - '0'
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:29092,OUTSIDE://0.0.0.0:9092
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:29092,OUTSIDE://localhost:9092
    ports:
      - "9092:9092"
      - "9644:9644"
      - "29092:29092"
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend API
  api:
    build:
      context: ./services/api
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql://radio_fleet:dev_password_change_me@postgres:5432/radio_fleet
      REDIS_URL: redis://redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: redpanda:29092
      OIDC_AUTHORITY: ${OIDC_AUTHORITY:-https://login.microsoftonline.com/common/v2.0}
      OIDC_CLIENT_ID: ${OIDC_CLIENT_ID:-dev-client-id}
      OIDC_CLIENT_SECRET: ${OIDC_CLIENT_SECRET:-dev-client-secret}
      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING:-UseDevelopmentStorage=true}
      MODE: development
      LOG_LEVEL: INFO
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    volumes:
      - ./services/api:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Celery Workers
  worker-transcription:
    build:
      context: ./services/workers
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://radio_fleet:dev_password_change_me@postgres:5432/radio_fleet
      REDIS_URL: redis://redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: redpanda:29092
      AZURE_SPEECH_KEY: ${AZURE_SPEECH_KEY:-}
      AZURE_SPEECH_REGION: ${AZURE_SPEECH_REGION:-eastus}
      WORKER_TYPE: transcription
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./services/workers:/app
    command: celery -A app.celery_app worker -Q transcription -l info

  worker-nlp:
    build:
      context: ./services/workers
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://radio_fleet:dev_password_change_me@postgres:5432/radio_fleet
      REDIS_URL: redis://redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: redpanda:29092
      WORKER_TYPE: nlp
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./services/workers:/app
    command: celery -A app.celery_app worker -Q nlp -l info

  worker-policy:
    build:
      context: ./services/workers
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://radio_fleet:dev_password_change_me@postgres:5432/radio_fleet
      REDIS_URL: redis://redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: redpanda:29092
      WORKER_TYPE: policy
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./services/workers:/app
    command: celery -A app.celery_app worker -Q policy -l info

  # WebSocket Service
  websocket:
    build:
      context: ./services/websocket
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    environment:
      REDIS_URL: redis://redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: redpanda:29092
      API_URL: http://api:8000
    depends_on:
      redis:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    volumes:
      - ./services/websocket:/app
    command: python main.py

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8000
      NEXT_PUBLIC_WS_URL: ws://localhost:8001
      NEXT_PUBLIC_MAPBOX_TOKEN: ${NEXT_PUBLIC_MAPBOX_TOKEN:-}
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-dev-secret-change-me}
      AZURE_AD_CLIENT_ID: ${AZURE_AD_CLIENT_ID:-}
      AZURE_AD_CLIENT_SECRET: ${AZURE_AD_CLIENT_SECRET:-}
      AZURE_AD_TENANT_ID: ${AZURE_AD_TENANT_ID:-}
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      - api
      - websocket

  # Radio Simulator
  radio-simulator:
    build:
      context: ./simulators
      dockerfile: Dockerfile
    environment:
      KAFKA_BOOTSTRAP_SERVERS: redpanda:29092
      SIMULATOR_TYPE: radio
      API_URL: http://api:8000
    depends_on:
      redpanda:
        condition: service_healthy
    command: python radio_simulator.py

  # GPS Simulator
  gps-simulator:
    build:
      context: ./simulators
      dockerfile: Dockerfile
    environment:
      KAFKA_BOOTSTRAP_SERVERS: redpanda:29092
      SIMULATOR_TYPE: gps
      API_URL: http://api:8000
    depends_on:
      redpanda:
        condition: service_healthy
    command: python gps_simulator.py

volumes:
  postgres_data:
