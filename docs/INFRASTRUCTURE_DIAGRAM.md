# CTAFleet - Infrastructure Architecture Diagrams

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Internet / Users                                │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                    ┌───────────┴──────────┐
                    │   Azure Front Door   │
                    │  (Global CDN + WAF)  │
                    └───────────┬──────────┘
                                │
┌───────────────────────────────┴──────────────────────────────────────────────┐
│                          Azure Region (Primary - East US 2)                   │
│                                                                               │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                    Azure Kubernetes Service (AKS)                       │ │
│  │                                                                         │ │
│  │  ┌──────────────────────────────────────────────────────────────────┐ │ │
│  │  │                    Ingress Layer                                  │ │ │
│  │  │  ┌────────────────────────────────────────────────────────────┐  │ │ │
│  │  │  │            NGINX Ingress Controller                         │  │ │ │
│  │  │  │  - SSL/TLS Termination (cert-manager + Let's Encrypt)      │  │ │ │
│  │  │  │  - Load Balancing                                          │  │ │ │
│  │  │  │  - Rate Limiting                                           │  │ │ │
│  │  │  └────────────────────────────────────────────────────────────┘  │ │ │
│  │  └──────────────┬─────────────────────────┬──────────────────────────┘ │ │
│  │                 │                         │                             │ │
│  │  ┌──────────────┴────────────┐  ┌────────┴────────────────────────┐   │ │
│  │  │    Frontend Services      │  │      Backend Services           │   │ │
│  │  │  ┌────────────────────┐   │  │  ┌──────────────────────────┐  │   │ │
│  │  │  │ Frontend (Nginx)   │   │  │  │   API (Node.js)          │  │   │ │
│  │  │  │ - React SPA        │   │  │  │   - Express              │  │   │ │
│  │  │  │ - Replicas: 3-10   │   │  │  │   - Replicas: 3-10       │  │   │ │
│  │  │  │ - HPA Enabled      │   │  │  │   - HPA Enabled          │  │   │ │
│  │  │  └────────────────────┘   │  │  └──────────┬───────────────┘  │   │ │
│  │  └───────────────────────────┘  │             │                   │   │ │
│  │                                  │  ┌──────────┴───────────────┐  │   │ │
│  │                                  │  │  Python Microservices    │  │   │ │
│  │                                  │  │  - Test Orchestrator     │  │   │ │
│  │                                  │  │  - RAG Indexer           │  │   │ │
│  │                                  │  │  - Playwright Runner     │  │   │ │
│  │                                  │  └──────────┬───────────────┘  │   │ │
│  │                                  └─────────────┼──────────────────┘   │ │
│  │                                                │                       │ │
│  │  ┌─────────────────────────────────────────────┼────────────────────┐ │ │
│  │  │               Data & Cache Layer            │                    │ │ │
│  │  │  ┌──────────────────────┐    ┌──────────────┴──────────────┐    │ │ │
│  │  │  │  PostgreSQL (HA)     │    │  Redis Cache (HA)           │    │ │ │
│  │  │  │  - Zone Redundant    │    │  - Zone Redundant           │    │ │ │
│  │  │  │  - Auto Failover     │    │  - Persistence Enabled      │    │ │ │
│  │  │  │  - Daily Backups     │    │  - LRU Eviction             │    │ │ │
│  │  │  └──────────────────────┘    └─────────────────────────────┘    │ │ │
│  │  └──────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                        Managed Azure Services                           │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌───────────────┐                │ │
│  │  │ Blob Storage │  │  Key Vault   │  │ App Insights  │                │ │
│  │  │ - Files      │  │  - Secrets   │  │ - APM         │                │ │
│  │  │ - Backups    │  │  - Keys      │  │ - Logs        │                │ │
│  │  └──────────────┘  └──────────────┘  └───────────────┘                │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌───────────────┐                │ │
│  │  │ Azure Maps   │  │  OpenAI      │  │ Cognitive     │                │ │
│  │  │ - Geocoding  │  │  - GPT-4     │  │ Services      │                │ │
│  │  │ - Routing    │  │  - Embeddings│  │ - OCR         │                │ │
│  │  └──────────────┘  └──────────────┘  └───────────────┘                │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                     Monitoring & Observability                          │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌──────────────┐  │ │
│  │  │ Prometheus  │  │  Grafana    │  │   ELK       │  │  App         │  │ │
│  │  │ - Metrics   │  │  - Dashbds  │  │   - Logs    │  │  Insights    │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └──────────────┘  │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────────┐
│                   Azure Region (DR - West US 2)                               │
│  - Geo-Redundant Database Replica                                            │
│  - Geo-Redundant Storage                                                     │
│  - Standby AKS Cluster (can be activated)                                    │
└───────────────────────────────────────────────────────────────────────────────┘
```

## Network Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Virtual Network (10.0.0.0/16)                         │
│                                                                               │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                    AKS Subnet (10.0.1.0/24)                             │ │
│  │  - Kubernetes Nodes                                                     │ │
│  │  - Pod Network (Azure CNI)                                              │ │
│  │  - Network Policies Enabled                                             │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                  Database Subnet (10.0.2.0/24)                          │ │
│  │  - PostgreSQL Flexible Server                                           │ │
│  │  - Redis Cache                                                           │ │
│  │  - Private Endpoints                                                     │ │
│  │  - Service Endpoints Enabled                                             │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │              Application Gateway Subnet (10.0.3.0/24)                   │ │
│  │  - Azure Application Gateway (Optional)                                 │ │
│  │  - WAF Rules                                                             │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                   Network Security Groups (NSG)                         │ │
│  │  - Inbound: 443 (HTTPS), 80 (HTTP redirect)                            │ │
│  │  - Outbound: Azure Services, HTTPS to external APIs                     │ │
│  │  - Deny All Other Traffic                                               │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────────────────┘
```

## Deployment Flow

```
┌─────────────┐
│  Developer  │
│   Commits   │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────────┐
│                      GitHub Actions CI/CD                        │
│                                                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌──────────┐ │
│  │   Lint &   │→ │   Build    │→ │  Security  │→ │  Test    │ │
│  │ Type Check │  │            │  │   Scan     │  │          │ │
│  └────────────┘  └────────────┘  └────────────┘  └──────────┘ │
│                                                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐               │
│  │   Build    │→ │   Push to  │→ │  Deploy to │               │
│  │   Docker   │  │    ACR     │  │   Staging  │               │
│  └────────────┘  └────────────┘  └────────────┘               │
│                                          │                      │
│                                          ▼                      │
│                                  ┌───────────────┐             │
│                                  │ Staging Tests │             │
│                                  │  - Smoke      │             │
│                                  │  - E2E        │             │
│                                  └───────┬───────┘             │
│                                          │                      │
│                                   [Manual Approval]            │
│                                          │                      │
│                                          ▼                      │
│                                  ┌───────────────┐             │
│                                  │  Deploy to    │             │
│                                  │  Production   │             │
│                                  └───────┬───────┘             │
└─────────────────────────────────────────┼────────────────────┘
                                          │
                                          ▼
                              ┌─────────────────────┐
                              │ Post-Deploy Verify  │
                              │  - Health Checks    │
                              │  - Smoke Tests      │
                              │  - Monitoring       │
                              └─────────────────────┘
```

## Data Flow

```
┌──────────┐                                                    ┌──────────┐
│  User /  │                                                    │  Admin   │
│  Driver  │                                                    │  Portal  │
└────┬─────┘                                                    └────┬─────┘
     │                                                                │
     │  HTTPS                                                  HTTPS  │
     ▼                                                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Azure Front Door                                │
│  - DDoS Protection                                                       │
│  - WAF Rules                                                             │
│  - SSL/TLS Termination                                                   │
│  - CDN Caching                                                           │
└────────────────────────────┬────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      NGINX Ingress Controller                            │
│  - Request Routing                                                       │
│  - Rate Limiting                                                         │
│  - Security Headers                                                      │
└────────────┬───────────────────────────────────┬────────────────────────┘
             │                                   │
    /api/*   │                                   │  /*
             ▼                                   ▼
    ┌─────────────────┐              ┌──────────────────────┐
    │   API Service   │              │  Frontend Service    │
    │   (Node.js)     │              │  (Nginx + React)     │
    │                 │              │                      │
    │  - Auth         │              │  - Serve Static      │
    │  - Business     │              │  - SPA Routing       │
    │  - Validation   │              │  - Asset Caching     │
    └────────┬────────┘              └──────────────────────┘
             │
      ┌──────┴───────┬──────────────┬──────────────┐
      │              │              │              │
      ▼              ▼              ▼              ▼
┌──────────┐  ┌──────────┐  ┌────────────┐  ┌──────────────┐
│PostgreSQL│  │  Redis   │  │ Azure Blob │  │ Azure OpenAI │
│          │  │  Cache   │  │  Storage   │  │              │
│- Tenants │  │- Session │  │- Files     │  │- AI Features │
│- Users   │  │- Cache   │  │- Images    │  │- Embeddings  │
│- Vehicles│  │- Queues  │  │- Backups   │  │- Completion  │
│- Data    │  │          │  │            │  │              │
└──────────┘  └──────────┘  └────────────┘  └──────────────┘
```

## Monitoring & Alerting Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Application Services                          │
│  - API Pods                                                      │
│  - Frontend Pods                                                 │
│  - Python Services                                               │
│  - Databases                                                     │
└────────┬─────────────────────────────────────┬──────────────────┘
         │ Metrics                             │ Logs
         ▼                                     ▼
┌─────────────────┐                   ┌────────────────────┐
│   Prometheus    │                   │    Logstash        │
│  - Metrics      │                   │  - Log Collection  │
│  - Scraping     │                   │  - Parsing         │
│  - Alerting     │                   │  - Filtering       │
└────────┬────────┘                   └─────────┬──────────┘
         │                                      │
         ▼                                      ▼
┌─────────────────┐                   ┌────────────────────┐
│ Alert Manager   │                   │  Elasticsearch     │
│  - Routing      │                   │  - Index Storage   │
│  - Grouping     │                   │  - Search          │
│  - Throttling   │                   └─────────┬──────────┘
└────────┬────────┘                             │
         │                                      ▼
         │                             ┌────────────────────┐
         │                             │      Kibana        │
         │                             │  - Visualization   │
         │                             │  - Analysis        │
         │                             └────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Notification Channels                       │
│  ┌─────────┐  ┌──────────┐  ┌───────────┐  ┌───────────────┐  │
│  │  Email  │  │  Slack   │  │   Teams   │  │  PagerDuty    │  │
│  └─────────┘  └──────────┘  └───────────┘  └───────────────┘  │
└─────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────┐
│   On-Call       │
│   Engineer      │
└─────────────────┘
```

## Disaster Recovery Architecture

```
┌───────────────────────────────────────────────────────────────────┐
│                    Primary Region (East US 2)                      │
│                                                                    │
│  ┌──────────────┐   Continuous    ┌──────────────────────────┐   │
│  │  PostgreSQL  │ ──── Repl ────→ │  Standby PostgreSQL      │   │
│  │  (Primary)   │                 │  (Read Replica)          │   │
│  └──────────────┘                 └──────────────────────────┘   │
│                                                                    │
│  ┌──────────────┐   Daily         ┌──────────────────────────┐   │
│  │   AKS Prod   │ ── Backups ───→ │   Blob Storage (GRS)     │   │
│  │   Cluster    │                 │   - DB Backups           │   │
│  └──────────────┘                 │   - Config Backups       │   │
│                                    └────────┬─────────────────┘   │
└─────────────────────────────────────────────┼───────────────────────┘
                                              │
                                        Geo-Replication
                                              │
                                              ▼
┌─────────────────────────────────────────────┼───────────────────────┐
│                    DR Region (West US 2)    │                       │
│                                             │                       │
│  ┌──────────────────────────────────────────┴────────────────┐     │
│  │               Blob Storage (GRS)                           │     │
│  │  - Replicated DB Backups                                  │     │
│  │  - Replicated Config                                      │     │
│  └──────────────────┬─────────────────────────────────────────┘     │
│                     │                                               │
│                     │ Restore (on DR activation)                    │
│                     ▼                                               │
│  ┌──────────────────────────────────────────────────────────┐      │
│  │              AKS DR Cluster (Standby)                     │      │
│  │  - Can be scaled up on demand                            │      │
│  │  - Pre-configured with all manifests                     │      │
│  └──────────────────────────────────────────────────────────┘      │
└───────────────────────────────────────────────────────────────────┘

RTO: 30 minutes
RPO: 15 minutes
```
