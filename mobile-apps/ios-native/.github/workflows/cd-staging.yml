name: iOS CD - Staging Deployment

on:
  push:
    branches:
      - staging
      - develop
    paths:
      - 'mobile-apps/ios-native/**'
      - '.github/workflows/cd-staging.yml'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (not recommended)'
        required: false
        type: boolean
        default: false

env:
  DEVELOPER_DIR: /Applications/Xcode_15.0.app/Contents/Developer
  XCODE_PROJECT: "App.xcodeproj"
  XCODE_SCHEME: "App"
  WORKING_DIRECTORY: mobile-apps/ios-native
  FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 120
  FASTLANE_XCODE_LIST_TIMEOUT: 120

jobs:
  # ============================================================================
  # PRE-DEPLOYMENT CHECKS
  # ============================================================================

  pre-deployment:
    name: Pre-Deployment Checks
    runs-on: macos-13

    outputs:
      version: ${{ steps.version.outputs.version }}
      build: ${{ steps.version.outputs.build }}

    steps:
      - name: Checkout code
        # SECURITY: Pinned to SHA for supply chain security
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4
        with:
          fetch-depth: 0

      - name: Extract version info
        id: version
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          VERSION=$(grep -A1 "CFBundleShortVersionString" App/Info.plist | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
          BUILD=$(grep -A1 "CFBundleVersion" App/Info.plist | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/')

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build=${BUILD}" >> $GITHUB_OUTPUT

          echo "## Version Information" >> $GITHUB_STEP_SUMMARY
          echo "- Version: **${VERSION}**" >> $GITHUB_STEP_SUMMARY
          echo "- Build: **${BUILD}**" >> $GITHUB_STEP_SUMMARY

      - name: Check changelog
        run: |
          if [ -f "${{ env.WORKING_DIRECTORY }}/CHANGELOG.md" ]; then
            echo "‚úÖ Changelog exists"
          else
            echo "‚ö†Ô∏è  Warning: No CHANGELOG.md found"
          fi

  # ============================================================================
  # BUILD & TEST
  # ============================================================================

  build-and-test:
    name: Build and Test Staging
    runs-on: macos-13
    needs: [pre-deployment]
    if: ${{ !inputs.skip_tests }}

    steps:
      - name: Checkout code
        # SECURITY: Pinned to SHA for supply chain security
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer
          xcodebuild -version

      - name: Setup Ruby
        # SECURITY: Pinned to SHA for supply chain security
        uses: ruby/setup-ruby@5f19ec79cedfadb78ab837f95b87734d0003c899  # v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Install Fastlane
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          gem install fastlane -v '~> 2.217'
          fastlane --version

      - name: Cache CocoaPods
        # SECURITY: Pinned to SHA for supply chain security
        uses: actions/cache@704facf57e6136b1bc63b828d79edcd491f0ee84  # v3
        with:
          path: |
            ${{ env.WORKING_DIRECTORY }}/Pods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-pods-${{ hashFiles(format('{0}/Podfile.lock', env.WORKING_DIRECTORY)) }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          if [ -f Podfile ]; then
            gem install cocoapods -v '~> 1.12'
            pod install --repo-update
          fi

      - name: Run tests
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          fastlane test || true

      - name: Upload test results
        if: always()
        # SECURITY: Pinned to SHA for supply chain security
        uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32  # v3
        with:
          name: staging-test-results
          path: ${{ env.WORKING_DIRECTORY }}/test_output/
          retention-days: 14

  # ============================================================================
  # DEPLOY TO TESTFLIGHT
  # ============================================================================

  deploy-testflight:
    name: Deploy to TestFlight
    runs-on: macos-13
    needs: [pre-deployment, build-and-test]
    if: ${{ always() && (needs.build-and-test.result == 'success' || inputs.skip_tests) }}
    environment:
      name: staging
      url: https://appstoreconnect.apple.com

    steps:
      - name: Checkout code
        # SECURITY: Pinned to SHA for supply chain security
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4
        with:
          fetch-depth: 0

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer
          xcodebuild -version

      - name: Setup Ruby
        # SECURITY: Pinned to SHA for supply chain security
        uses: ruby/setup-ruby@5f19ec79cedfadb78ab837f95b87734d0003c899  # v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Install Fastlane
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          gem install fastlane -v '~> 2.217'
          gem install xcpretty
          fastlane --version

      - name: Cache CocoaPods
        # SECURITY: Pinned to SHA for supply chain security
        uses: actions/cache@704facf57e6136b1bc63b828d79edcd491f0ee84  # v3
        with:
          path: |
            ${{ env.WORKING_DIRECTORY }}/Pods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-pods-${{ hashFiles(format('{0}/Podfile.lock', env.WORKING_DIRECTORY)) }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          if [ -f Podfile ]; then
            gem install cocoapods -v '~> 1.12'
            pod install --repo-update
          fi

      - name: Setup CI keychain
        run: |
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

      - name: Import certificates
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_KEYCHAIN_NAME: build.keychain
          MATCH_KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          fastlane match appstore --readonly || echo "Match failed, continuing..."

      - name: Build staging app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          fastlane build_staging

      - name: Upload to TestFlight
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          fastlane beta

      - name: Upload build artifacts
        if: always()
        # SECURITY: Pinned to SHA for supply chain security
        uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32  # v3
        with:
          name: staging-build
          path: |
            ${{ env.WORKING_DIRECTORY }}/builds/staging/
            ${{ env.WORKING_DIRECTORY }}/fastlane/report.xml
          retention-days: 30

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain build.keychain || true

      - name: Deployment summary
        if: success()
        run: |
          echo "## üöÄ TestFlight Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.pre-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ needs.pre-deployment.outputs.build }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The app has been uploaded to TestFlight and will be available for testing shortly." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View on [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # NOTIFICATIONS
  # ============================================================================

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [pre-deployment, deploy-testflight]
    if: always()

    steps:
      - name: Deployment Status
        run: |
          if [[ "${{ needs.deploy-testflight.result }}" == "success" ]]; then
            echo "‚úÖ Staging deployment successful"
            echo "STATUS=success" >> $GITHUB_ENV
          else
            echo "‚ùå Staging deployment failed"
            echo "STATUS=failure" >> $GITHUB_ENV
          fi

      - name: Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [[ "${{ env.STATUS }}" == "success" ]]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"‚úÖ iOS Staging Deployment Successful\nVersion: ${{ needs.pre-deployment.outputs.version }} (Build ${{ needs.pre-deployment.outputs.build }})\nBranch: ${{ github.ref_name }}"}' \
              $SLACK_WEBHOOK_URL
          else
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"‚ùå iOS Staging Deployment Failed\nBranch: ${{ github.ref_name }}\nWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
              $SLACK_WEBHOOK_URL
          fi
