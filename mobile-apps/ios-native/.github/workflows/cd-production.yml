name: iOS CD - Production Deployment

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'mobile-apps/ios-native/**'
      - '.github/workflows/cd-production.yml'
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: false
        type: choice
        options:
          - none
          - patch
          - minor
          - major
        default: 'none'
      submit_for_review:
        description: 'Submit for App Store review after upload'
        required: false
        type: boolean
        default: false

env:
  DEVELOPER_DIR: /Applications/Xcode_15.0.app/Contents/Developer
  XCODE_PROJECT: "App.xcodeproj"
  XCODE_SCHEME: "App"
  WORKING_DIRECTORY: mobile-apps/ios-native
  FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 120
  FASTLANE_XCODE_LIST_TIMEOUT: 120

jobs:
  # ============================================================================
  # VALIDATION & CHECKS
  # ============================================================================

  validate:
    name: Validate Production Release
    runs-on: macos-13

    outputs:
      version: ${{ steps.version.outputs.version }}
      build: ${{ steps.version.outputs.build }}
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify branch
        run: |
          BRANCH="${{ github.ref_name }}"
          if [[ "$BRANCH" != "main" ]] && [[ "$BRANCH" != "master" ]]; then
            echo "‚ùå Production deployments must be from main/master branch"
            exit 1
          fi
          echo "‚úÖ Branch verified: $BRANCH"

      - name: Check for release tag
        id: tag
        run: |
          if git describe --exact-match --tags HEAD 2>/dev/null; then
            echo "‚úÖ Commit is tagged"
            echo "is_tagged=true" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è  Commit is not tagged"
            echo "is_tagged=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract version info
        id: version
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          VERSION=$(grep -A1 "CFBundleShortVersionString" App/Info.plist | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
          BUILD=$(grep -A1 "CFBundleVersion" App/Info.plist | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/')

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build=${BUILD}" >> $GITHUB_OUTPUT

          echo "## Production Release Information" >> $GITHUB_STEP_SUMMARY
          echo "- Version: **${VERSION}**" >> $GITHUB_STEP_SUMMARY
          echo "- Build: **${BUILD}**" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: **${GITHUB_REF_NAME}**" >> $GITHUB_STEP_SUMMARY

      - name: Extract changelog
        id: changelog
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          if [ -f CHANGELOG.md ]; then
            CHANGELOG=$(head -n 20 CHANGELOG.md)
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "## Changelog" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$CHANGELOG" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è  No CHANGELOG.md found"
            echo "changelog=No changelog available" >> $GITHUB_OUTPUT
          fi

      - name: Run pre-flight checks
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "## Pre-flight Checks" >> $GITHUB_STEP_SUMMARY

          # Check for TODO/FIXME comments
          TODO_COUNT=$(grep -r "TODO\|FIXME" --include="*.swift" App/ 2>/dev/null | wc -l || echo "0")
          echo "- TODO/FIXME comments: ${TODO_COUNT}" >> $GITHUB_STEP_SUMMARY

          # Check for debug code
          DEBUG_COUNT=$(grep -r "print(\|debugPrint(\|NSLog(" --include="*.swift" App/ 2>/dev/null | wc -l || echo "0")
          if [ "$DEBUG_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è  - Debug statements found: ${DEBUG_COUNT}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ - No debug statements" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for placeholder values
          if grep -r "TODO\|PLACEHOLDER\|CHANGEME" --include="*.swift" --include="*.plist" App/ 2>/dev/null; then
            echo "‚ö†Ô∏è  Warning: Placeholder values detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ - No placeholder values" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # COMPREHENSIVE TESTING
  # ============================================================================

  test:
    name: Run Production Tests
    runs-on: macos-13
    needs: [validate]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer
          xcodebuild -version

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Install Fastlane
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          gem install fastlane -v '~> 2.217'
          fastlane --version

      - name: Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.WORKING_DIRECTORY }}/Pods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-pods-${{ hashFiles(format('{0}/Podfile.lock', env.WORKING_DIRECTORY)) }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          if [ -f Podfile ]; then
            gem install cocoapods -v '~> 1.12'
            pod install --repo-update
          fi

      - name: Run comprehensive test suite
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          fastlane test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: production-test-results
          path: ${{ env.WORKING_DIRECTORY }}/test_output/
          retention-days: 90

      - name: Test summary
        if: success()
        run: |
          echo "## ‚úÖ All Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "The app is ready for production deployment." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # MANUAL APPROVAL
  # ============================================================================

  approval:
    name: Production Deployment Approval
    runs-on: ubuntu-latest
    needs: [validate, test]
    environment:
      name: production
      url: https://appstoreconnect.apple.com

    steps:
      - name: Request approval
        run: |
          echo "## üîí Approval Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow is waiting for approval to proceed with production deployment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ needs.validate.outputs.build }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è  **This will deploy to the App Store. Please verify all checks have passed.**" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # BUILD PRODUCTION
  # ============================================================================

  build:
    name: Build Production Release
    runs-on: macos-13
    needs: [validate, test, approval]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer
          xcodebuild -version

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Install Fastlane
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          gem install fastlane -v '~> 2.217'
          gem install xcpretty
          fastlane --version

      - name: Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.WORKING_DIRECTORY }}/Pods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-pods-${{ hashFiles(format('{0}/Podfile.lock', env.WORKING_DIRECTORY)) }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          if [ -f Podfile ]; then
            gem install cocoapods -v '~> 1.12'
            pod install --repo-update
          fi

      - name: Version bump (if requested)
        if: ${{ inputs.version_bump != 'none' }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          fastlane version_bump type:${{ inputs.version_bump }}

      - name: Setup CI keychain
        run: |
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

      - name: Import certificates
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_KEYCHAIN_NAME: build.keychain
          MATCH_KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          fastlane match appstore --readonly

      - name: Build production app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          fastlane build_production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: production-build
          path: |
            ${{ env.WORKING_DIRECTORY }}/builds/production/
            ${{ env.WORKING_DIRECTORY }}/fastlane/report.xml
          retention-days: 90

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain build.keychain || true

  # ============================================================================
  # DEPLOY TO APP STORE
  # ============================================================================

  deploy:
    name: Deploy to App Store
    runs-on: macos-13
    needs: [validate, build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer
          xcodebuild -version

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Install Fastlane
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          gem install fastlane -v '~> 2.217'
          fastlane --version

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: production-build
          path: ${{ env.WORKING_DIRECTORY }}/builds/production/

      - name: Upload to App Store
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          fastlane release

      - name: Submit for review (if requested)
        if: ${{ inputs.submit_for_review }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          fastlane submit_review

      - name: Create Git tag
        if: success()
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          BUILD="${{ needs.validate.outputs.build }}"
          git tag -a "v${VERSION}-${BUILD}" -m "Release v${VERSION} (${BUILD})"
          git push origin "v${VERSION}-${BUILD}"

      - name: Deployment summary
        if: success()
        run: |
          echo "## üéâ Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ needs.validate.outputs.build }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The app has been successfully uploaded to App Store Connect." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.submit_for_review }}" == "true" ]]; then
            echo "‚úÖ **Submitted for App Store review**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è  **Not submitted for review** - Submit manually from App Store Connect" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View on [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # NOTIFICATIONS
  # ============================================================================

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: always()

    steps:
      - name: Deployment Status
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "‚úÖ Production deployment successful"
            echo "STATUS=success" >> $GITHUB_ENV
          else
            echo "‚ùå Production deployment failed"
            echo "STATUS=failure" >> $GITHUB_ENV
          fi

      - name: Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [[ "${{ env.STATUS }}" == "success" ]]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"üéâ iOS Production Deployment Successful\nVersion: ${{ needs.validate.outputs.version }} (Build ${{ needs.validate.outputs.build }})\nThe app is now available on the App Store!"}' \
              $SLACK_WEBHOOK_URL
          else
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"‚ùå iOS Production Deployment Failed\nVersion: ${{ needs.validate.outputs.version }}\nWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
              $SLACK_WEBHOOK_URL
          fi

      - name: Create GitHub Release
        if: needs.deploy.result == 'success'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.validate.outputs.version }}-${{ needs.validate.outputs.build }}
          release_name: iOS Release v${{ needs.validate.outputs.version }}
          body: |
            ## iOS App Release v${{ needs.validate.outputs.version }}

            Build: ${{ needs.validate.outputs.build }}

            ### Changelog
            ${{ needs.validate.outputs.changelog }}

            ### Download
            Available on the App Store: https://apps.apple.com/app/dcf-fleet-management

            ### Deployment Information
            - Deployed: ${{ github.event.head_commit.timestamp }}
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}
          draft: false
          prerelease: false
