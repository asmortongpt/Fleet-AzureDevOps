# HOTFIX: Deploy pre-built dist folder from fleet-local (WORKING VERSION)
# This Dockerfile bypasses the build step and uses the verified working dist
FROM nginx:alpine

# Copy pre-built dist folder (already verified working on port 4173)
COPY dist /usr/share/nginx/html

# Copy nginx configuration
COPY nginx.conf /etc/nginx/nginx.conf

# Create runtime-config.js at container startup
RUN echo '#!/bin/sh' > /docker-entrypoint.d/99-create-runtime-config.sh && \
    echo 'cat > /usr/share/nginx/html/runtime-config.js <<EOF' >> /docker-entrypoint.d/99-create-runtime-config.sh && \
    echo 'window.__RUNTIME_CONFIG__ = {' >> /docker-entrypoint.d/99-create-runtime-config.sh && \
    echo '  API_URL: "${VITE_API_URL:-}",  ' >> /docker-entrypoint.d/99-create-runtime-config.sh && \
    echo '  ENVIRONMENT: "${VITE_ENVIRONMENT:-production}",  ' >> /docker-entrypoint.d/99-create-runtime-config.sh && \
    echo '  BUILD_VERSION: "${VITE_BUILD_VERSION:-fleet-local-working}"  ' >> /docker-entrypoint.d/99-create-runtime-config.sh && \
    echo '};' >> /docker-entrypoint.d/99-create-runtime-config.sh && \
    echo 'EOF' >> /docker-entrypoint.d/99-create-runtime-config.sh && \
    chmod +x /docker-entrypoint.d/99-create-runtime-config.sh

EXPOSE 3000

HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1
