CTA Performance Analysis (for demo) â€” extracted on 2025-12-24T03:24:40
================================================================================


################################################################################
SHEET: Caching_Analysis
################################################################################

| Issue                                                                                                               | Finding                                                                                                                                                                                                             | Recommendation                                                                                                                                            | Proposed Benefits                                                                                                                                                                                                                     |
|:--------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| The claimed cache implementations : I found cache functions as highlighted in the cache.ts file :                   | - None of these functions are called from routes registered for drivers, vehicles or dahboards                                                                                                                      | - getVehicleListings() - should use as GET /api/vehicles in the route api/src/routes/vehicles.enhanced.ts ( Wrap vehicle query with cache function)       | some of these queries are complex and hit the database everytime , the cached query result will give you great performance and user experince boost (based on number of concurrent users, the caching can help with 50x faster speed) |
| - getVehicleListings                                                                                                |                                                                                                                                                                                                                     |                                                                                                                                                           |                                                                                                                                                                                                                                       |
| - getDriverProfile                                                                                                  | - functions defined in the proposed cache middle ware but not called on any routes                                                                                                                                  | - getDriverProfile() - should use as GET /api/drivers/:id in the route api/src/routes/drivers.ts ( Wrap driver profile query with cache function )        |                                                                                                                                                                                                                                       |
| - getDashboardStats                                                                                                 |                                                                                                                                                                                                                     |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     | - Example :                                                                                                                                                                                                         | - getDashboardStats() - should use as GET /api/dashboard/stats in the route api/src/routes/dashboard-stats.ts ( Create route + integrate cache function ) |                                                                                                                                                                                                                                       |
|                                                                                                                     |     - `api/src/routes/vehicles.ts` - Only has single vehicle by ID endpoint, NO caching                                                                                                                             |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |     - `api/src/routes/vehicles.enhanced.ts` - Has vehicle listings endpoint, but NO cache middleware applied                                                                                                        |                                                                                                                                                           |                                                                                                                                                                                                                                       |
| Invalidate Cache                                                                                                    | - didnt find the cache invalidation code . for example lets say i add a new nehicle and i already have the cache for that . then i need to invalidate the cache when i add a vehicle                                | - we can add code like this :                                                                                                                             | - if you don't invalidate cache , the new entries wont show up                                                                                                                                                                        |
|                                                                                                                     |                                                                                                                                                                                                                     |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     | - for all the routes we are helping cache , we should identify the invalidate cache terms as well                                                                                                                   | router.put('/:id', async (req: AuthRequest, res: Response) => {                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     |   const tenantId = req.user!.tenant_id                                                                                                                    |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     |   const vehicleId = req.params.id                                                                                                                         |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     |   // Update vehicle                                                                                                                                       |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     |   await updateVehicle(vehicleId, req.body)                                                                                                                |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     |   // Invalidate cache                                                                                                                                     |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     |   await redis.del(`${tenantId}:vehicleListings:all`)                                                                                                      |                                                                                                                                                                                                                                       |
| Routes that can use caching (help with overall user experience with faster loads)                                   | - **Route:** `GET /api/vehicles`                                                                                                                                                                                    | - recommended TTL : 300 seconds                                                                                                                           | - we are talking about instant loading cut down                                                                                                                                                                                       |
|                                                                                                                     | - **File:** `api/src/routes/vehicles.enhanced.ts                                                                                                                                                                    |                                                                                                                                                           |                                                                                                                                                                                                                                       |
| - please note that there would be other routes also , but I could find these based on usage at the time of analysis |                                                                                                                                                                                                                     | - we can use Cache Key Pattern ():** `{tenantId}:vehicles:list:page:{page}:limit:{limit}:filters:{hash(filters)}`                                         |                                                                                                                                                                                                                                       |
|                                                                                                                     | - this one is called on every vehicle page load and usually wont have vehicles added every other minute so safe ROI                                                                                                 |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     | - this pattern will help us as there are 10+ filter parameters used                                                                                       |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     | - Invalidation Triggers:** POST/PUT/DELETE to `/api/vehicles/*                                                                                            |                                                                                                                                                                                                                                       |
|                                                                                                                     | **Route:** `GET /api/drivers`                                                                                                                                                                                       | - recommended TTL : 300 seconds                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     | - **File:** `api/src/routes/drivers.ts                                                                                                                                                                              |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     | - Cache Key Pattern:** `{tenantId}:drivers:list:page:{page}:limit:{limit}:query:{hash(query)}`                                                            |                                                                                                                                                                                                                                       |
|                                                                                                                     | - this thing is called from drop downs, list views  and other pages                                                                                                                                                 |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     | - Invalidation Triggers:** POST/PUT/DELETE to `/api/drivers/*                                                                                             |                                                                                                                                                                                                                                       |
|                                                                                                                     | **Route:** `GET /api/fuel-transactions`                                                                                                                                                                             | - recommended TTL : 180 seconds                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     | - **File:** `api/src/routes/fuel-transactions.ts                                                                                                                                                                    |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     | - Cache Key Pattern:** `{tenantId}:fuel:list:page:{page}:filters:{hash(filters)}`                                                                         |                                                                                                                                                                                                                                       |
|                                                                                                                     | - some of the pages where is found use of this (there could be more too) :                                                                                                                                          |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |    - Fuel transaction list views                                                                                                                                                                                    | - Invalidation Triggers:** POST/PUT/DELETE to `/api/fuel-transactions/*                                                                                   |                                                                                                                                                                                                                                       |
|                                                                                                                     |   - Cost analysis dashboards                                                                                                                                                                                        |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |   - Vehicle detail pages (fuel history)                                                                                                                                                                             |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |   - Driver detail pages (fuel usage)                                                                                                                                                                                |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     | **Route:** `GET /api/cost-analysis/summary`                                                                                                                                                                         | - Recommended TTL:** 600 seconds                                                                                                                          |                                                                                                                                                                                                                                       |
|                                                                                                                     | - **File:** `api/src/routes/cost-analysis.routes.ts                                                                                                                                                                 |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     | - Cache Key Pattern:** `{tenantId}:cost:summary:start:{startDate}:end:{endDate}`                                                                          |                                                                                                                                                                                                                                       |
|                                                                                                                     | - why consider this for caching :                                                                                                                                                                                   |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |  - ML-based cost breakdown analysis                                                                                                                                                                                 | - Invalidation Triggers:** POST/PUT/DELETE to `/api/cost-tracking/*`, `/api/fuel-transactions/*`, `/api/maintenance/*                                     |                                                                                                                                                                                                                                       |
|                                                                                                                     |   - Anomaly detection                                                                                                                                                                                               |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |   - Trend calculation (increasing/decreasing/stable)                                                                                                                                                                |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |   - Forecasted amount calculation                                                                                                                                                                                   |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     | ** Route:** `GET /api/cost-analysis/by-category`                                                                                                                                                                    | - Recommended TTL:** 600 seconds                                                                                                                          |                                                                                                                                                                                                                                       |
|                                                                                                                     | - **File:** `api/src/routes/cost-analysis.routes.ts                                                                                                                                                                 |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     | - Cache Key Pattern:** `{tenantId}:cost:by-category:start:{startDate}:end:{endDate}`                                                                      |                                                                                                                                                                                                                                       |
|                                                                                                                     | - why consoder this for caching (specially for demo):                                                                                                                                                               |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |   - complex query that scans from 1000 - 10000 rows and more with data growing                                                                                                                                      | - Invalidation Triggers:** POST/PUT/DELETE to cost-related endpoints                                                                                      |                                                                                                                                                                                                                                       |
|                                                                                                                     |   - Used for pie charts and category breakdown visualizations in cost analysis dashboards                                                                                                                           |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     | **Route:** `GET /api/cost-analysis/trends`                                                                                                                                                                          | - Recommended TTL:** 1800 seconds                                                                                                                         |                                                                                                                                                                                                                                       |
|                                                                                                                     | - **File:** `api/src/routes/cost-analysis.routes.ts                                                                                                                                                                 |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     | - Cache Key Pattern:** `{tenantId}:cost:trends:category:{category}:months:{months}`                                                                       |                                                                                                                                                                                                                                       |
|                                                                                                                     | - this one has lot of aggregations including time series aggregations like date_trunc                                                                                                                               |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     | - its more like historical data trends which could scan a lt of rows , so we can cache this                                                                                                                         | - Invalidation Triggers:** POST/PUT/DELETE to cost-related endpoints                                                                                      |                                                                                                                                                                                                                                       |
|                                                                                                                     | some others that can also use caching (looked like use cases for caching) :                                                                                                                                         |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     | - GET /api/driver-scorecard/leaderboard                                                                                                                                                                             |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     | - GET /api/fleet-optimizer/utilization-heatmap                                                                                                                                                                      |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     |                                                                                                                                                                                                                     |                                                                                                                                                           |                                                                                                                                                                                                                                       |
|                                                                                                                     | - GET /api/fleet-optimizer/vehicle/:vehicleId                                                                                                                                                                       |                                                                                                                                                           |                                                                                                                                                                                                                                       |
| - Cache Implementation                                                                                              | - there are some industry paractices that can be applied for a scalable cache in the future (just adding a header , so that whoever is working on this knows this) : like service level cahing for partial data etc |                                                                                                                                                           |                                                                                                                                                                                                                                       |


################################################################################
SHEET: n+1 Queries
################################################################################

| Issue                                                                                                                                                                                                  | Finding                                                                         | Recommendation                                                                | Proposed Benefits                                                                                                                                                   |
|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------|:------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| - routes like GET /communications/:id use N+1 quwry pattern , where results of one query are iterated to fetch next set of records from the database (each loop adding one more databse /netwrk hit).  | // GET /communications/:id                                                      | // GET /communications/:id                                                    | - we save a lot of CPU cycle , network hops and aggregatins with joining in such cases . the response return time decreases exponentials with the number of records |
|                                                                                                                                                                                                        | router.get('/:id', authenticateJWT, async (req: AuthRequest, res) => {          | router.get('/:id', authenticateJWT, async (req: AuthRequest, res) => {        |                                                                                                                                                                     |
| - some more routes that i found the same :                                                                                                                                                             |   try {                                                                         |   try {                                                                       |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     // Query 1: Get communication                                               |     // âœ… Single query with JOINs and JSON aggregation                        |                                                                                                                                                                     |
|       - api/src/routes/work-orders.ts                                                                                                                                                                  |     const result = await pool.query(                                            |     const result = await pool.query(`                                         |                                                                                                                                                                     |
|                                                                                                                                                                                                        |       'SELECT * FROM communications WHERE id = $1 AND tenant_id = $2',          |       SELECT                                                                  |                                                                                                                                                                     |
|       - api/src/routes/inspections.ts                                                                                                                                                                  |       [req.params.id, req.user!.tenant_id]                                      |         c.*,                                                                  |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     )                                                                           |         COALESCE(                                                             |                                                                                                                                                                     |
|       - api/src/routes/fuel-transactions.ts                                                                                                                                                            |                                                                                 |           json_agg(                                                           |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     if (result.rows.length === 0) {                                             |             DISTINCT jsonb_build_object(                                      |                                                                                                                                                                     |
|       - api/src/routes/assets.ts                                                                                                                                                                       |       return res.status(404).json({ error: 'Communication not found' })         |               'entity_type', cel.entity_type,                                 |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     }                                                                           |               'entity_id', cel.entity_id,                                     |                                                                                                                                                                     |
|      - api/src/routes/facilities.ts                                                                                                                                                                    |                                                                                 |               'link_type', cel.link_type,                                     |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     const communication = result.rows[0]                                        |               'relevance_score', cel.relevance_score,                         |                                                                                                                                                                     |
|                                                                                                                                                                                                        |                                                                                 |               'auto_detected', cel.auto_detected                              |                                                                                                                                                                     |
| -  please note there could be other routes too that have the same issues                                                                                                                               |     // âŒ Query 2: Get linked entities (N+1 problem)                            |             )                                                                 |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     const linksResult = await pool.query(                                       |           ) FILTER (WHERE cel.id IS NOT NULL),                                |                                                                                                                                                                     |
| - need to check the query properly (i could not verify with non acess to DB - secrets issue)                                                                                                           |       `SELECT entity_type, entity_id, link_type, relevance_score, auto_detected |           '[]'                                                                |                                                                                                                                                                     |
|                                                                                                                                                                                                        |        FROM communication_entity_links                                          |         ) as linked_entities,                                                 |                                                                                                                                                                     |
|                                                                                                                                                                                                        |        WHERE communication_id = $1                                              |         COALESCE(                                                             |                                                                                                                                                                     |
|                                                                                                                                                                                                        |        ORDER BY relevance_score DESC`,                                          |           json_agg(                                                           |                                                                                                                                                                     |
|                                                                                                                                                                                                        |       [req.params.id]                                                           |             DISTINCT jsonb_build_object(                                      |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     )                                                                           |               'id', ca.id,                                                    |                                                                                                                                                                     |
|                                                                                                                                                                                                        |                                                                                 |               'filename', ca.filename,                                        |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     // âŒ Query 3: Get attachments (N+1 problem)                                |               'file_url', ca.file_url,                                        |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     const attachmentsResult = await pool.query(                                 |               'file_type', ca.file_type,                                      |                                                                                                                                                                     |
|                                                                                                                                                                                                        |       `SELECT id, filename, file_url, file_type, file_size, uploaded_at         |               'file_size', ca.file_size,                                      |                                                                                                                                                                     |
|                                                                                                                                                                                                        |        FROM communication_attachments                                           |               'uploaded_at', ca.uploaded_at                                   |                                                                                                                                                                     |
|                                                                                                                                                                                                        |        WHERE communication_id = $1`,                                            |             )                                                                 |                                                                                                                                                                     |
|                                                                                                                                                                                                        |       [req.params.id]                                                           |           ) FILTER (WHERE ca.id IS NOT NULL),                                 |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     )                                                                           |           '[]'                                                                |                                                                                                                                                                     |
|                                                                                                                                                                                                        |                                                                                 |         ) as attachments                                                      |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     communication.linked_entities = linksResult.rows                            |       FROM communications c                                                   |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     communication.attachments = attachmentsResult.rows                          |       LEFT JOIN communication_entity_links cel ON c.id = cel.communication_id |                                                                                                                                                                     |
|                                                                                                                                                                                                        |                                                                                 |       LEFT JOIN communication_attachments ca ON c.id = ca.communication_id    |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     res.json({ data: communication })                                           |       WHERE c.id = $1 AND c.tenant_id = $2                                    |                                                                                                                                                                     |
|                                                                                                                                                                                                        |   } catch (error) {                                                             |       GROUP BY c.id                                                           |                                                                                                                                                                     |
|                                                                                                                                                                                                        |     res.status(500).json({ error: 'Failed to fetch communication' })            |     `, [req.params.id, req.user!.tenant_id])                                  |                                                                                                                                                                     |
|                                                                                                                                                                                                        |   }                                                                             |                                                                               |                                                                                                                                                                     |
|                                                                                                                                                                                                        | })                                                                              |     if (result.rows.length === 0) {                                           |                                                                                                                                                                     |
|                                                                                                                                                                                                        |                                                                                 |       return res.status(404).json({ error: 'Communication not found' })       |                                                                                                                                                                     |
|                                                                                                                                                                                                        |                                                                                 |     }                                                                         |                                                                                                                                                                     |
|                                                                                                                                                                                                        |                                                                                 |                                                                               |                                                                                                                                                                     |
|                                                                                                                                                                                                        |                                                                                 |     res.json({ data: result.rows[0] })                                        |                                                                                                                                                                     |
|                                                                                                                                                                                                        |                                                                                 |   } catch (error) {                                                           |                                                                                                                                                                     |
|                                                                                                                                                                                                        |                                                                                 |     res.status(500).json({ error: 'Failed to fetch communication' })          |                                                                                                                                                                     |
|                                                                                                                                                                                                        |                                                                                 |   }                                                                           |                                                                                                                                                                     |
|                                                                                                                                                                                                        |                                                                                 | })                                                                            |                                                                                                                                                                     |


################################################################################
SHEET: react_memoization
################################################################################

| Issue                                                                                                                                                                                                                             | Finding                                                                                                                                                    | Recommendation                                                                                                 | Proposed Benefits                                                                                                                                                            |
|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| we dont use REACT MEMOIZATION : is a performance optimization technique where React caches the result of a component render or an expensive calculation and reuses it as long as the inputs (props/dependencies) have not changed | i found more than 8+ instances (which could be way more) : where we can use memoization to achieve better user experience. some of the files i found are : | import { useMemo, useCallback } from 'react'                                                                   | - will help get down page load speed by more than 5x times on an average and more time can be saved if that pages uses mutiple such expensive calcuations, filters logic etc |
|                                                                                                                                                                                                                                   |                                                                                                                                                            |                                                                                                                |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   | - src/components/modules/procurement/InventoryManagement.tsx                                                                                               | export function InventoryManagement() {                                                                        |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   | - src/components/modules/assets/AssetManagement.tsx                                                                                                        |   const { parts, isLoading } = useInventory()                                                                  |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |  - src/components/modules/fleet/FleetDashboard.tsx                                                                                                         |   const [filters, setFilters] = useState<InventoryFilters>({})                                                 |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |  - src/components/modules/maintenance/MaintenanceScheduling.tsx                                                                                            |   const [selectedPart, setSelectedPart] = useState<Part | null>(null)                                          |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |                                                                                                                                                            |   const [sortBy, setSortBy] = useState<string>('name')                                                         |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |                                                                                                                                                            |   const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('asc')                                            |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |                                                                                                                                                            |                                                                                                                |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   | - there could be many more such incidences                                                                                                                 |   // âœ… Memoize expensive calculations                                                                         |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |                                                                                                                                                            |   const metrics = useMemo(() => ({                                                                             |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   | - Let me give an example of this using inventory management:                                                                                               |     totalParts: parts.length,                                                                                  |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |                                                                                                                                                            |     totalValue: parts.reduce((sum, p) => sum + (p.quantityOnHand * p.unitCost), 0),                            |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   | export function InventoryManagement() {                                                                                                                    |     lowStock: parts.filter(p => p.quantityOnHand <= p.reorderPoint).length,                                    |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   const { parts, isLoading } = useInventory()                                                                                                              |     outOfStock: parts.filter(p => p.quantityOnHand === 0).length                                               |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   const [filters, setFilters] = useState<InventoryFilters>({})                                                                                             |   }), [parts])                                                                                                 |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   const [selectedPart, setSelectedPart] = useState<Part | null>(null)                                                                                      |                                                                                                                |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   const [sortBy, setSortBy] = useState<string>('name')                                                                                                     |   // âœ… Memoize filtered data                                                                                  |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('asc')                                                                                        |   const filteredParts = useMemo(() => {                                                                        |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   // ... 10+ more useState hooks                                                                                                                           |     return parts.filter(p => {                                                                                 |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |                                                                                                                                                            |       if (filters.category && p.category !== filters.category) return false                                    |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   // âŒ PROBLEM 1: Expensive calculation runs on EVERY render                                                                                              |       if (filters.status && p.status !== filters.status) return false                                          |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   const metrics = {                                                                                                                                        |       if (filters.searchTerm && !p.name.toLowerCase().includes(filters.searchTerm.toLowerCase())) return false |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     totalParts: parts.length,                                                                                                                              |       return true                                                                                              |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     totalValue: parts.reduce((sum, p) => sum + (p.quantityOnHand * p.unitCost), 0),                                                                        |     })                                                                                                         |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     lowStock: parts.filter(p => p.quantityOnHand <= p.reorderPoint).length,                                                                                |   }, [parts, filters])                                                                                         |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     outOfStock: parts.filter(p => p.quantityOnHand === 0).length                                                                                           |                                                                                                                |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   }                                                                                                                                                        |   // âœ… Memoize sorted data                                                                                    |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |                                                                                                                                                            |   const sortedParts = useMemo(() => {                                                                          |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   // âŒ PROBLEM 2: Filter logic runs on EVERY render                                                                                                       |     return [...filteredParts].sort((a, b) => {                                                                 |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   const filteredParts = parts.filter(p => {                                                                                                                |       const aVal = a[sortBy]                                                                                   |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     if (filters.category && p.category !== filters.category) return false                                                                                  |       const bVal = b[sortBy]                                                                                   |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     if (filters.status && p.status !== filters.status) return false                                                                                        |       if (sortOrder === 'asc') return aVal > bVal ? 1 : -1                                                     |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     if (filters.searchTerm && !p.name.toLowerCase().includes(filters.searchTerm.toLowerCase())) return false                                               |       return aVal < bVal ? 1 : -1                                                                              |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     return true                                                                                                                                            |     })                                                                                                         |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   })                                                                                                                                                       |   }, [filteredParts, sortBy, sortOrder])                                                                       |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |                                                                                                                                                            |                                                                                                                |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   // âŒ PROBLEM 3: Sort logic runs on EVERY render                                                                                                         |   // âœ… Memoize event handlers                                                                                 |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   const sortedParts = filteredParts.sort((a, b) => {                                                                                                       |   const handleAddPart = useCallback(async () => {                                                              |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     const aVal = a[sortBy]                                                                                                                                 |     if (!newPart.partNumber || !newPart.name) {                                                                |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     const bVal = b[sortBy]                                                                                                                                 |       toast.error("Part Number and Name are required")                                                         |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     if (sortOrder === 'asc') return aVal > bVal ? 1 : -1                                                                                                   |       return                                                                                                   |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     return aVal < bVal ? 1 : -1                                                                                                                            |     }                                                                                                          |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   })                                                                                                                                                       |     await addPart(newPart as Part)                                                                             |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |                                                                                                                                                            |     toast.success("Part added to inventory")                                                                   |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   // âŒ PROBLEM 4: Event handlers recreated on EVERY render                                                                                                |     setIsAddDialogOpen(false)                                                                                  |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   const handleAddPart = async () => {                                                                                                                      |   }, [newPart, addPart])                                                                                       |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     if (!newPart.partNumber || !newPart.name) {                                                                                                            |                                                                                                                |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |       toast.error("Part Number and Name are required")                                                                                                     |   return (                                                                                                     |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |       return                                                                                                                                               |     <div>                                                                                                      |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     }                                                                                                                                                      |       <MetricsCards metrics={metrics} />                                                                       |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     await addPart(newPart as Part)                                                                                                                         |       <PartsTable parts={sortedParts} onAdd={handleAddPart} />                                                 |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     toast.success("Part added to inventory")                                                                                                               |     </div>                                                                                                     |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     setIsAddDialogOpen(false)                                                                                                                              |   )                                                                                                            |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   }                                                                                                                                                        | }                                                                                                              |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |                                                                                                                                                            |                                                                                                                |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   return (                                                                                                                                                 | // âœ… Memoize child components                                                                                 |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     <div>                                                                                                                                                  | const MetricsCards = React.memo(({ metrics }: { metrics: Metrics }) => {                                       |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |       <MetricsCards metrics={metrics} /> {/* Re-renders unnecessarily */}                                                                                  |   return <div>{/* ... */}</div>                                                                                |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |       <PartsTable parts={sortedParts} onAdd={handleAddPart} /> {/* Re-renders unnecessarily */}                                                            | })                                                                                                             |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |     </div>                                                                                                                                                 |                                                                                                                |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |   )                                                                                                                                                        | const PartsTable = React.memo(({ parts, onAdd }: Props) => {                                                   |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   | }                                                                                                                                                          |   return <table>{/* ... */}</table>                                                                            |                                                                                                                                                                              |
|                                                                                                                                                                                                                                   |                                                                                                                                                            | })                                                                                                             |                                                                                                                                                                              |


################################################################################
SHEET: virtual_scrolling
################################################################################

| Issue                                                                                                                                                                                                                       | Finding                                                                                                                                                    | Recommendation                                                                              | Proposed Benefits                                                                                       |
|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------|
| we dont use REACT VIRTUAL SCROLLING: performance optimization technique where only the list items visible in the viewport (plus a small buffer) are actually rendered to the DOM, while the rest are â€œvirtualâ€ placeholders | i found more than 3+ instances (which could be way more) : where we can use memoization to achieve better user experience. some of the files i found are : | import { useVirtualizer } from '@tanstack/react-virtual'                                    | - will help get down page load as we are not waiting to fetch all thousands of records or even hundreds |
|                                                                                                                                                                                                                             |                                                                                                                                                            | import { useRef } from 'react'                                                              |                                                                                                         |
|                                                                                                                                                                                                                             | - src/components/modules/assets/AssetManagement.tsx                                                                                                        |                                                                                             |                                                                                                         |
|                                                                                                                                                                                                                             | -src/components/modules/data/DataWorkbench.tsx                                                                                                             | export function AssetManagement() {                                                         |                                                                                                         |
|                                                                                                                                                                                                                             | -src/components/modules/fleet/FleetDashboard.tsx                                                                                                           |   const { assets, isLoading } = useAssets()                                                 |                                                                                                         |
|                                                                                                                                                                                                                             | -src/components/modules/fuel/FuelManagement.tsx                                                                                                            |   const [filters, setFilters] = useState<AssetFilters>({})                                  |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |   const parentRef = useRef<HTMLDivElement>(null)                                            |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |                                                                                             |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |   const filteredAssets = useMemo(() => {                                                    |                                                                                                         |
|                                                                                                                                                                                                                             | - there could be many more such incidences                                                                                                                 |     return assets.filter(a => {                                                             |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |       if (filters.category && a.category !== filters.category) return false                 |                                                                                                         |
|                                                                                                                                                                                                                             | - Let me give an example of this using asset management:                                                                                                   |       if (filters.status && a.status !== filters.status) return false                       |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |       return true                                                                           |                                                                                                         |
|                                                                                                                                                                                                                             | export function AssetManagement() {                                                                                                                        |     })                                                                                      |                                                                                                         |
|                                                                                                                                                                                                                             |   const { assets, isLoading } = useAssets()                                                                                                                |   }, [assets, filters])                                                                     |                                                                                                         |
|                                                                                                                                                                                                                             |   const [filters, setFilters] = useState<AssetFilters>({})                                                                                                 |                                                                                             |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |   // âœ… Virtual scrolling - only renders visible rows                                       |                                                                                                         |
|                                                                                                                                                                                                                             |   const filteredAssets = useMemo(() => {                                                                                                                   |   const virtualizer = useVirtualizer({                                                      |                                                                                                         |
|                                                                                                                                                                                                                             |     return assets.filter(a => {                                                                                                                            |     count: filteredAssets.length,                                                           |                                                                                                         |
|                                                                                                                                                                                                                             |       if (filters.category && a.category !== filters.category) return false                                                                                |     getScrollElement: () => parentRef.current,                                              |                                                                                                         |
|                                                                                                                                                                                                                             |       if (filters.status && a.status !== filters.status) return false                                                                                      |     estimateSize: () => 60, // Row height in pixels                                         |                                                                                                         |
|                                                                                                                                                                                                                             |       return true                                                                                                                                          |     overscan: 5, // Render 5 extra rows above/below viewport                                |                                                                                                         |
|                                                                                                                                                                                                                             |     })                                                                                                                                                     |   })                                                                                        |                                                                                                         |
|                                                                                                                                                                                                                             |   }, [assets, filters])                                                                                                                                    |                                                                                             |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |   return (                                                                                  |                                                                                                         |
|                                                                                                                                                                                                                             |   return (                                                                                                                                                 |     <Card>                                                                                  |                                                                                                         |
|                                                                                                                                                                                                                             |     <Card>                                                                                                                                                 |       <CardContent className="p-0">                                                         |                                                                                                         |
|                                                                                                                                                                                                                             |       <CardContent className="p-0">                                                                                                                        |         {/* âœ… Scrollable container */}                                                     |                                                                                                         |
|                                                                                                                                                                                                                             |         <Table>                                                                                                                                            |         <div ref={parentRef} className="h-[600px] overflow-auto">                           |                                                                                                         |
|                                                                                                                                                                                                                             |           <TableHeader>                                                                                                                                    |           {/* âœ… Total height placeholder */}                                               |                                                                                                         |
|                                                                                                                                                                                                                             |             <TableRow>                                                                                                                                     |           <div style={{ height: `${virtualizer.getTotalSize()}px`, position: 'relative' }}> |                                                                                                         |
|                                                                                                                                                                                                                             |               <TableHead>Asset Tag</TableHead>                                                                                                             |             {/* âœ… Only render visible rows */}                                             |                                                                                                         |
|                                                                                                                                                                                                                             |               <TableHead>Name</TableHead>                                                                                                                  |             {virtualizer.getVirtualItems().map((virtualRow) => {                            |                                                                                                         |
|                                                                                                                                                                                                                             |               <TableHead>Type</TableHead>                                                                                                                  |               const asset = filteredAssets[virtualRow.index]                                |                                                                                                         |
|                                                                                                                                                                                                                             |               <TableHead>Status</TableHead>                                                                                                                |               return (                                                                      |                                                                                                         |
|                                                                                                                                                                                                                             |               <TableHead>Condition</TableHead>                                                                                                             |                 <div                                                                        |                                                                                                         |
|                                                                                                                                                                                                                             |               <TableHead>Location</TableHead>                                                                                                              |                   key={asset.id}                                                            |                                                                                                         |
|                                                                                                                                                                                                                             |               <TableHead>Assigned To</TableHead>                                                                                                           |                   style={{                                                                  |                                                                                                         |
|                                                                                                                                                                                                                             |               <TableHead>Value</TableHead>                                                                                                                 |                     position: 'absolute',                                                   |                                                                                                         |
|                                                                                                                                                                                                                             |             </TableRow>                                                                                                                                    |                     top: 0,                                                                 |                                                                                                         |
|                                                                                                                                                                                                                             |           </TableHeader>                                                                                                                                   |                     left: 0,                                                                |                                                                                                         |
|                                                                                                                                                                                                                             |           <TableBody>                                                                                                                                      |                     width: '100%',                                                          |                                                                                                         |
|                                                                                                                                                                                                                             |             {/* âŒ PROBLEM: Renders ALL 5000 assets (45,000 DOM nodes) */}                                                                                 |                     height: `${virtualRow.size}px`,                                         |                                                                                                         |
|                                                                                                                                                                                                                             |             {filteredAssets.map((asset) => (                                                                                                               |                     transform: `translateY(${virtualRow.start}px)`,                         |                                                                                                         |
|                                                                                                                                                                                                                             |               <TableRow key={asset.id}>                                                                                                                    |                   }}                                                                        |                                                                                                         |
|                                                                                                                                                                                                                             |                 <TableCell>{asset.asset_tag}</TableCell>                                                                                                   |                 >                                                                           |                                                                                                         |
|                                                                                                                                                                                                                             |                 <TableCell>{asset.asset_name}</TableCell>                                                                                                  |                   <AssetRow asset={asset} />                                                |                                                                                                         |
|                                                                                                                                                                                                                             |                 <TableCell>{asset.asset_type}</TableCell>                                                                                                  |                 </div>                                                                      |                                                                                                         |
|                                                                                                                                                                                                                             |                 <TableCell>{asset.status}</TableCell>                                                                                                      |               )                                                                             |                                                                                                         |
|                                                                                                                                                                                                                             |                 <TableCell>{asset.condition}</TableCell>                                                                                                   |             })}                                                                             |                                                                                                         |
|                                                                                                                                                                                                                             |                 <TableCell>{asset.location}</TableCell>                                                                                                    |           </div>                                                                            |                                                                                                         |
|                                                                                                                                                                                                                             |                 <TableCell>{asset.assigned_to}</TableCell>                                                                                                 |         </div>                                                                              |                                                                                                         |
|                                                                                                                                                                                                                             |                 <TableCell>${asset.current_value}</TableCell>                                                                                              |       </CardContent>                                                                        |                                                                                                         |
|                                                                                                                                                                                                                             |               </TableRow>                                                                                                                                  |     </Card>                                                                                 |                                                                                                         |
|                                                                                                                                                                                                                             |             ))}                                                                                                                                            |   )                                                                                         |                                                                                                         |
|                                                                                                                                                                                                                             |           </TableBody>                                                                                                                                     | }                                                                                           |                                                                                                         |
|                                                                                                                                                                                                                             |         </Table>                                                                                                                                           |                                                                                             |                                                                                                         |
|                                                                                                                                                                                                                             |       </CardContent>                                                                                                                                       | // âœ… Memoized row component                                                                |                                                                                                         |
|                                                                                                                                                                                                                             |     </Card>                                                                                                                                                | const AssetRow = React.memo(({ asset }: { asset: Asset }) => {                              |                                                                                                         |
|                                                                                                                                                                                                                             |   )                                                                                                                                                        |   return (                                                                                  |                                                                                                         |
|                                                                                                                                                                                                                             | }                                                                                                                                                          |     <div className="flex items-center gap-4 p-4 border-b">                                  |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |       <span>{asset.asset_tag}</span>                                                        |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |       <span>{asset.asset_name}</span>                                                       |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |       <span>{asset.asset_type}</span>                                                       |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |       <span>{asset.status}</span>                                                           |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |       <span>{asset.condition}</span>                                                        |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |       <span>{asset.location}</span>                                                         |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |       <span>{asset.assigned_to}</span>                                                      |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |       <span>${asset.current_value}</span>                                                   |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |     </div>                                                                                  |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            |   )                                                                                         |                                                                                                         |
|                                                                                                                                                                                                                             |                                                                                                                                                            | })                                                                                          |                                                                                                         |


################################################################################
SHEET: search_debouncing
################################################################################

| Issue                                                                                                                                                                                                | Finding                                                                                                                                         | Recommendation                                                                       | Proposed Benefits                                                                                                |
|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------------|
| we dont use seach debouncing : delaying a function (like an API search call) until the user stops typing for a specified time, which prevents firing on every keystroke and reduces unnecessary work | i found more than 2+ instances (which could be way more) : where every key stroke is an api hit rather than waitinf oe user to type eveeything  | // src/hooks/useDebounce.ts                                                          | - every key hit wont be a dabatase hit (in the left side example civic honda will rusult in 11 hits to database) |
|                                                                                                                                                                                                      | -src/components/modules/fleet/VehicleSearch.tsx                                                                                                 | import { useState, useEffect } from 'react'                                          |                                                                                                                  |
|                                                                                                                                                                                                      | -src/components/modules/people/DriverSearch.tsx                                                                                                 |                                                                                      |                                                                                                                  |
|                                                                                                                                                                                                      | -src/components/modules/assets/AssetSearch.tsx                                                                                                  | export function useDebounce<T>(value: T, delay: number): T {                         |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |   const [debouncedValue, setDebouncedValue] = useState<T>(value)                     |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |                                                                                      |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |   useEffect(() => {                                                                  |                                                                                                                  |
|                                                                                                                                                                                                      | - there could be many more such incidences                                                                                                      |     const handler = setTimeout(() => {                                               |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |       setDebouncedValue(value)                                                       |                                                                                                                  |
|                                                                                                                                                                                                      | - Let me give an example of this using vehicle search                                                                                           |     }, delay)                                                                        |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |                                                                                      |                                                                                                                  |
|                                                                                                                                                                                                      | // src/components/modules/VehicleSearch.tsx                                                                                                     |     return () => {                                                                   |                                                                                                                  |
|                                                                                                                                                                                                      | export function VehicleSearch() {                                                                                                               |       clearTimeout(handler)                                                          |                                                                                                                  |
|                                                                                                                                                                                                      |   const [searchTerm, setSearchTerm] = useState('')                                                                                              |     }                                                                                |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |   }, [value, delay])                                                                 |                                                                                                                  |
|                                                                                                                                                                                                      |   // âŒ API call on EVERY keystroke                                                                                                             |                                                                                      |                                                                                                                  |
|                                                                                                                                                                                                      |   const { data: vehicles } = useVehicles({ search: searchTerm })                                                                                |   return debouncedValue                                                              |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 | }                                                                                    |                                                                                                                  |
|                                                                                                                                                                                                      |   const handleSearch = (e: React.ChangeEvent<HTMLInputElement>) => {                                                                            |                                                                                      |                                                                                                                  |
|                                                                                                                                                                                                      |     setSearchTerm(e.target.value)  // Triggers API call immediately                                                                             | // src/components/modules/VehicleSearch.tsx                                          |                                                                                                                  |
|                                                                                                                                                                                                      |   }                                                                                                                                             | import { useDebounce } from '@/hooks/useDebounce'                                    |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |                                                                                      |                                                                                                                  |
|                                                                                                                                                                                                      |   return (                                                                                                                                      | export function VehicleSearch() {                                                    |                                                                                                                  |
|                                                                                                                                                                                                      |     <Input                                                                                                                                      |   const [searchTerm, setSearchTerm] = useState('')                                   |                                                                                                                  |
|                                                                                                                                                                                                      |       placeholder="Search vehicles..."                                                                                                          |                                                                                      |                                                                                                                  |
|                                                                                                                                                                                                      |       value={searchTerm}                                                                                                                        |   // âœ… Debounce search term (500ms delay)                                           |                                                                                                                  |
|                                                                                                                                                                                                      |       onChange={handleSearch}                                                                                                                   |   const debouncedSearchTerm = useDebounce(searchTerm, 500)                           |                                                                                                                  |
|                                                                                                                                                                                                      |     />                                                                                                                                          |                                                                                      |                                                                                                                  |
|                                                                                                                                                                                                      |   )                                                                                                                                             |   // âœ… API call only after user stops typing for 500ms                              |                                                                                                                  |
|                                                                                                                                                                                                      | }                                                                                                                                               |   const { data: vehicles, isLoading } = useVehicles({ search: debouncedSearchTerm }) |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |                                                                                      |                                                                                                                  |
|                                                                                                                                                                                                      | // âŒ User types "honda civic" (11 characters)                                                                                                  |   const handleSearch = (e: React.ChangeEvent<HTMLInputElement>) => {                 |                                                                                                                  |
|                                                                                                                                                                                                      | // â†’ 11 API calls: "h", "ho", "hon", "hond", "honda", "honda ", etc.                                                                            |     setSearchTerm(e.target.value)                                                    |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |   }                                                                                  |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |                                                                                      |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |   return (                                                                           |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |     <div>                                                                            |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |       <Input                                                                         |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |         placeholder="Search vehicles..."                                             |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |         value={searchTerm}                                                           |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |         onChange={handleSearch}                                                      |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |       />                                                                             |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |       {isLoading && <Spinner />}                                                     |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |     </div>                                                                           |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |   )                                                                                  |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 | }                                                                                    |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 |                                                                                      |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 | // âœ… User types "honda civic" (11 characters)                                       |                                                                                                                  |
|                                                                                                                                                                                                      |                                                                                                                                                 | // â†’ 1 API call after user stops typing for 500ms                                    |                                                                                                                  |


################################################################################
SHEET: misc_findings
################################################################################

| Issue                              | Finding                                                                            | Recommendation                                                                        | Proposed Benefits                                                                                                         |
|:-----------------------------------|:-----------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------|
| MISSING PAGINATION                 | found routes like below that has no pagination set : api/src/routes/maintenance.ts | // api/src/routes/maintenance.ts                                                      | - page loads are much miuch quicker with page not waiting for fetching all records                                        |
|                                    |                                                                                    | // GET /maintenance                                                                   |                                                                                                                           |
|                                    |                                                                                    | router.get('/', authenticateJWT, async (req: AuthRequest, res) => {                   |                                                                                                                           |
|                                    | // api/src/routes/maintenance.ts                                                   |   try {                                                                               |                                                                                                                           |
|                                    | // GET /maintenance                                                                |     // âœ… Parse pagination parameters                                                 |                                                                                                                           |
|                                    | router.get('/', authenticateJWT, async (req: AuthRequest, res) => {                |     const page = parseInt(req.query.page as string) || 1                              |                                                                                                                           |
|                                    |   try {                                                                            |     const limit = Math.min(parseInt(req.query.limit as string) || 50, 100) // Max 100 |                                                                                                                           |
|                                    |     // âŒ PROBLEM: Returns ALL records (no LIMIT/OFFSET)                           |     const offset = (page - 1) * limit                                                 |                                                                                                                           |
|                                    |     const result = await pool.query(                                               |                                                                                       |                                                                                                                           |
|                                    |       `SELECT * FROM maintenance_records                                           |     // âœ… Query with LIMIT and OFFSET                                                 |                                                                                                                           |
|                                    |        WHERE tenant_id = $1                                                        |     const result = await pool.query(                                                  |                                                                                                                           |
|                                    |        ORDER BY created_at DESC`,                                                  |       `SELECT * FROM maintenance_records                                              |                                                                                                                           |
|                                    |       [req.user!.tenant_id]                                                        |        WHERE tenant_id = $1                                                           |                                                                                                                           |
|                                    |     )                                                                              |        ORDER BY created_at DESC                                                       |                                                                                                                           |
|                                    |                                                                                    |        LIMIT $2 OFFSET $3`,                                                           |                                                                                                                           |
|                                    |     // âŒ Returns 5000+ records (20 MB response)                                   |       [req.user!.tenant_id, limit, offset]                                            |                                                                                                                           |
|                                    |     res.json({ data: result.rows })                                                |     )                                                                                 |                                                                                                                           |
|                                    |   } catch (error) {                                                                |                                                                                       |                                                                                                                           |
|                                    |     res.status(500).json({ error: 'Failed to fetch maintenance records' })         |     // âœ… Get total count for pagination metadata                                     |                                                                                                                           |
|                                    |   }                                                                                |     const countResult = await pool.query(                                             |                                                                                                                           |
|                                    | })                                                                                 |       `SELECT COUNT(*) FROM maintenance_records WHERE tenant_id = $1`,                |                                                                                                                           |
|                                    |                                                                                    |       [req.user!.tenant_id]                                                           |                                                                                                                           |
|                                    |                                                                                    |     )                                                                                 |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    |     const total = parseInt(countResult.rows[0].count)                                 |                                                                                                                           |
|                                    |                                                                                    |     const totalPages = Math.ceil(total / limit)                                       |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    |     res.json({                                                                        |                                                                                                                           |
|                                    |                                                                                    |       data: result.rows,                                                              |                                                                                                                           |
|                                    |                                                                                    |       pagination: {                                                                   |                                                                                                                           |
|                                    |                                                                                    |         page,                                                                         |                                                                                                                           |
|                                    |                                                                                    |         limit,                                                                        |                                                                                                                           |
|                                    |                                                                                    |         total,                                                                        |                                                                                                                           |
|                                    |                                                                                    |         totalPages,                                                                   |                                                                                                                           |
|                                    |                                                                                    |         hasNext: page < totalPages,                                                   |                                                                                                                           |
|                                    |                                                                                    |         hasPrev: page > 1                                                             |                                                                                                                           |
|                                    |                                                                                    |       }                                                                               |                                                                                                                           |
|                                    |                                                                                    |     })                                                                                |                                                                                                                           |
|                                    |                                                                                    |   } catch (error) {                                                                   |                                                                                                                           |
|                                    |                                                                                    |     res.status(500).json({ error: 'Failed to fetch maintenance records' })            |                                                                                                                           |
|                                    |                                                                                    |   }                                                                                   |                                                                                                                           |
|                                    |                                                                                    | })                                                                                    |                                                                                                                           |
| UNOPTIMIZED SQL QUERIES (SELECT *) | - many routes like api/src/routes/vehicles.ts                                      | // api/src/routes/vehicles.ts                                                         |                                                                                                                           |
|                                    |                                                                                    | router.get('/', authenticateJWT, async (req: AuthRequest, res) => {                   |                                                                                                                           |
|                                    | - // api/src/routes/vehicles.ts                                                    |   try {                                                                               |                                                                                                                           |
|                                    | router.get('/', authenticateJWT, async (req: AuthRequest, res) => {                |     // âœ… SELECT only needed columns                                                  |                                                                                                                           |
|                                    |   try {                                                                            |     const result = await pool.query(                                                  |                                                                                                                           |
|                                    |     // âŒ PROBLEM: SELECT * returns ALL 30 columns                                 |       `SELECT                                                                         |                                                                                                                           |
|                                    |     const result = await pool.query(                                               |         id,                                                                           |                                                                                                                           |
|                                    |       `SELECT * FROM vehicles WHERE tenant_id = $1`,                               |         vin,                                                                          |                                                                                                                           |
|                                    |       [req.user!.tenant_id]                                                        |         make,                                                                         |                                                                                                                           |
|                                    |     )                                                                              |         model,                                                                        |                                                                                                                           |
|                                    |                                                                                    |         status                                                                        |                                                                                                                           |
|                                    |     // âŒ Returns 30 columns when only 5 are needed                                |        FROM vehicles                                                                  |                                                                                                                           |
|                                    |     // Columns returned: id, tenant_id, vin, make, model, year, color,             |        WHERE tenant_id = $1                                                           |                                                                                                                           |
|                                    |     // license_plate, status, mileage, fuel_type, engine_size, transmission,       |        ORDER BY make, model`,                                                         |                                                                                                                           |
|                                    |     // purchase_date, purchase_price, current_value, insurance_policy,             |       [req.user!.tenant_id]                                                           |                                                                                                                           |
|                                    |     // insurance_expiry, registration_expiry, last_service_date,                   |     )                                                                                 |                                                                                                                           |
|                                    |     // next_service_date, driver_id, location_id, notes, created_at,               |                                                                                       |                                                                                                                           |
|                                    |     // updated_at, deleted_at, metadata, custom_fields, tags                       |     res.json({ data: result.rows })                                                   |                                                                                                                           |
|                                    |                                                                                    |   } catch (error) {                                                                   |                                                                                                                           |
|                                    |     res.json({ data: result.rows })                                                |     res.status(500).json({ error: 'Failed to fetch vehicles' })                       |                                                                                                                           |
|                                    |   } catch (error) {                                                                |   }                                                                                   |                                                                                                                           |
|                                    |     res.status(500).json({ error: 'Failed to fetch vehicles' })                    | })                                                                                    |                                                                                                                           |
|                                    |   }                                                                                |                                                                                       |                                                                                                                           |
|                                    | })                                                                                 | // âœ… For detailed view, select more columns                                          |                                                                                                                           |
|                                    |                                                                                    | router.get('/:id', authenticateJWT, async (req: AuthRequest, res) => {                |                                                                                                                           |
|                                    |                                                                                    |   try {                                                                               |                                                                                                                           |
|                                    |                                                                                    |     const result = await pool.query(                                                  |                                                                                                                           |
|                                    |                                                                                    |       `SELECT                                                                         |                                                                                                                           |
|                                    |                                                                                    |         id, tenant_id, vin, make, model, year, color,                                 |                                                                                                                           |
|                                    |                                                                                    |         license_plate, status, mileage, fuel_type,                                    |                                                                                                                           |
|                                    |                                                                                    |         purchase_date, purchase_price, current_value,                                 |                                                                                                                           |
|                                    |                                                                                    |         insurance_policy, insurance_expiry, registration_expiry,                      |                                                                                                                           |
|                                    |                                                                                    |         last_service_date, next_service_date, driver_id,                              |                                                                                                                           |
|                                    |                                                                                    |         location_id, notes, created_at, updated_at                                    |                                                                                                                           |
|                                    |                                                                                    |        FROM vehicles                                                                  |                                                                                                                           |
|                                    |                                                                                    |        WHERE id = $1 AND tenant_id = $2`,                                             |                                                                                                                           |
|                                    |                                                                                    |       [req.params.id, req.user!.tenant_id]                                            |                                                                                                                           |
|                                    |                                                                                    |     )                                                                                 |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    |     if (result.rows.length === 0) {                                                   |                                                                                                                           |
|                                    |                                                                                    |       return res.status(404).json({ error: 'Vehicle not found' })                     |                                                                                                                           |
|                                    |                                                                                    |     }                                                                                 |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    |     res.json({ data: result.rows[0] })                                                |                                                                                                                           |
|                                    |                                                                                    |   } catch (error) {                                                                   |                                                                                                                           |
|                                    |                                                                                    |     res.status(500).json({ error: 'Failed to fetch vehicle' })                        |                                                                                                                           |
|                                    |                                                                                    |   }                                                                                   |                                                                                                                           |
|                                    |                                                                                    | })                                                                                    |                                                                                                                           |
| NO CONNECTION POOLING LIMITS       | // api/src/database.ts                                                             | // api/src/database.ts                                                                | - every connection consimes cpu resources and with no cap on max connections it will degrade perfiemce over time for sure |
|                                    | import { Pool } from 'pg'                                                          | import { Pool } from 'pg'                                                             |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    | // âŒ PROBLEM: No max connection limit                                             | // âœ… Configure connection pool with limits                                           |                                                                                                                           |
|                                    | export const pool = new Pool({                                                     | export const pool = new Pool({                                                        |                                                                                                                           |
|                                    |   host: process.env.DB_HOST,                                                       |   host: process.env.DB_HOST,                                                          |                                                                                                                           |
|                                    |   port: parseInt(process.env.DB_PORT || '5432'),                                   |   port: parseInt(process.env.DB_PORT || '5432'),                                      |                                                                                                                           |
|                                    |   database: process.env.DB_NAME,                                                   |   database: process.env.DB_NAME,                                                      |                                                                                                                           |
|                                    |   user: process.env.DB_USER,                                                       |   user: process.env.DB_USER,                                                          |                                                                                                                           |
|                                    |   password: process.env.DB_PASSWORD,                                               |   password: process.env.DB_PASSWORD,                                                  |                                                                                                                           |
|                                    |   // âŒ No max limit - pool can grow to 500+ connections                           |                                                                                       |                                                                                                                           |
|                                    |   // âŒ No idle timeout - connections never released                               |   // âœ… Connection pool limits                                                        |                                                                                                                           |
|                                    |   // âŒ No connection timeout - hangs forever                                      |   max: 20,                    // Maximum 20 connections                               |                                                                                                                           |
|                                    | })                                                                                 |   min: 2,                     // Minimum 2 connections                                |                                                                                                                           |
|                                    |                                                                                    |   idleTimeoutMillis: 30000,   // Close idle connections after 30s                     |                                                                                                                           |
|                                    | // âŒ Under load:                                                                  |   connectionTimeoutMillis: 5000, // Timeout after 5s if no connection available       |                                                                                                                           |
|                                    | // - Pool grows to 500+ connections                                                |                                                                                       |                                                                                                                           |
|                                    | // - Database runs out of connections (max 100)                                    |   // âœ… Query timeout                                                                 |                                                                                                                           |
|                                    | // - New requests hang forever                                                     |   statement_timeout: 30000,   // Kill queries after 30s                               |                                                                                                                           |
|                                    | // - Database crashes                                                              |                                                                                       |                                                                                                                           |
|                                    |                                                                                    |   // âœ… Keep-alive to prevent connection drops                                        |                                                                                                                           |
|                                    |                                                                                    |   keepAlive: true,                                                                    |                                                                                                                           |
|                                    |                                                                                    |   keepAliveInitialDelayMillis: 10000                                                  |                                                                                                                           |
|                                    |                                                                                    | })                                                                                    |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    | // âœ… Graceful shutdown                                                               |                                                                                                                           |
|                                    |                                                                                    | process.on('SIGTERM', async () => {                                                   |                                                                                                                           |
|                                    |                                                                                    |   console.log('SIGTERM received, closing database pool...')                           |                                                                                                                           |
|                                    |                                                                                    |   await pool.end()                                                                    |                                                                                                                           |
|                                    |                                                                                    |   process.exit(0)                                                                     |                                                                                                                           |
|                                    |                                                                                    | })                                                                                    |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    | // âœ… Connection error handling                                                       |                                                                                                                           |
|                                    |                                                                                    | pool.on('error', (err, client) => {                                                   |                                                                                                                           |
|                                    |                                                                                    |   console.error('Unexpected error on idle client', err)                               |                                                                                                                           |
|                                    |                                                                                    |   // Don't exit - pool will handle reconnection                                       |                                                                                                                           |
|                                    |                                                                                    | })                                                                                    |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    | // âœ… Monitor pool metrics                                                            |                                                                                                                           |
|                                    |                                                                                    | pool.on('connect', () => {                                                            |                                                                                                                           |
|                                    |                                                                                    |   console.log('New database connection established')                                  |                                                                                                                           |
|                                    |                                                                                    | })                                                                                    |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    | pool.on('remove', () => {                                                             |                                                                                                                           |
|                                    |                                                                                    |   console.log('Database connection removed from pool')                                |                                                                                                                           |
|                                    |                                                                                    | })                                                                                    |                                                                                                                           |
| NO WEBSOCKET CONNECTION POOLING    | File: src/hooks/useVehicleTelemetry.ts                                             | // src/lib/websocket-manager.ts                                                       | - 1 connections per user vs 10 needed as currently coded                                                                  |
|                                    | src/lib/websocket-manager.ts                                                       | class WebSocketManager {                                                              |                                                                                                                           |
|                                    |                                                                                    |   private ws: WebSocket | null = null                                                 |                                                                                                                           |
|                                    |                                                                                    |   private subscribers = new Map<string, Set<(data: any) => void>>()                   |                                                                                                                           |
|                                    | - // src/hooks/useVehicleTelemetry.ts                                              |   private reconnectAttempts = 0                                                       |                                                                                                                           |
|                                    | import { useEffect, useState } from 'react'                                        |   private maxReconnectAttempts = 5                                                    |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    | export function useVehicleTelemetry(vehicleId: string) {                           |   connect() {                                                                         |                                                                                                                           |
|                                    |   const [data, setData] = useState(null)                                           |     if (this.ws?.readyState === WebSocket.OPEN) return                                |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |   useEffect(() => {                                                                |     // âœ… Single WebSocket connection                                                 |                                                                                                                           |
|                                    |     // âŒ PROBLEM: New WebSocket for each vehicle                                  |     this.ws = new WebSocket('wss://api.fleet.com/telemetry')                          |                                                                                                                           |
|                                    |     const ws = new WebSocket(`wss://api.fleet.com/telemetry/${vehicleId}`)         |                                                                                       |                                                                                                                           |
|                                    |                                                                                    |     this.ws.onopen = () => {                                                          |                                                                                                                           |
|                                    |     ws.onmessage = (event) => {                                                    |       console.log('WebSocket connected')                                              |                                                                                                                           |
|                                    |       setData(JSON.parse(event.data))                                              |       this.reconnectAttempts = 0                                                      |                                                                                                                           |
|                                    |     }                                                                              |       // Subscribe to all active channels                                             |                                                                                                                           |
|                                    |                                                                                    |       this.subscribers.forEach((_, channel) => {                                      |                                                                                                                           |
|                                    |     return () => ws.close()                                                        |         this.send({ type: 'subscribe', channel })                                     |                                                                                                                           |
|                                    |   }, [vehicleId])                                                                  |       })                                                                              |                                                                                                                           |
|                                    |                                                                                    |     }                                                                                 |                                                                                                                           |
|                                    |   return data                                                                      |                                                                                       |                                                                                                                           |
|                                    | }                                                                                  |     this.ws.onmessage = (event) => {                                                  |                                                                                                                           |
|                                    |                                                                                    |       const { channel, data } = JSON.parse(event.data)                                |                                                                                                                           |
|                                    | // âŒ Issues:                                                                      |       // âœ… Notify all subscribers for this channel                                   |                                                                                                                           |
|                                    | // - 10 vehicles = 10 WebSocket connections                                        |       this.subscribers.get(channel)?.forEach(callback => callback(data))              |                                                                                                                           |
|                                    | // - High server load                                                              |     }                                                                                 |                                                                                                                           |
|                                    | // - Connection limit reached                                                      |                                                                                       |                                                                                                                           |
|                                    | // - Inefficient resource usage                                                    |     this.ws.onclose = () => {                                                         |                                                                                                                           |
|                                    |                                                                                    |       console.log('WebSocket closed, reconnecting...')                                |                                                                                                                           |
|                                    |                                                                                    |       if (this.reconnectAttempts < this.maxReconnectAttempts) {                       |                                                                                                                           |
|                                    |                                                                                    |         setTimeout(() => {                                                            |                                                                                                                           |
|                                    |                                                                                    |           this.reconnectAttempts++                                                    |                                                                                                                           |
|                                    |                                                                                    |           this.connect()                                                              |                                                                                                                           |
|                                    |                                                                                    |         }, 1000 * Math.pow(2, this.reconnectAttempts))                                |                                                                                                                           |
|                                    |                                                                                    |       }                                                                               |                                                                                                                           |
|                                    |                                                                                    |     }                                                                                 |                                                                                                                           |
|                                    |                                                                                    |   }                                                                                   |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    |   subscribe(channel: string, callback: (data: any) => void) {                         |                                                                                                                           |
|                                    |                                                                                    |     if (!this.subscribers.has(channel)) {                                             |                                                                                                                           |
|                                    |                                                                                    |       this.subscribers.set(channel, new Set())                                        |                                                                                                                           |
|                                    |                                                                                    |       // âœ… Subscribe to channel                                                      |                                                                                                                           |
|                                    |                                                                                    |       this.send({ type: 'subscribe', channel })                                       |                                                                                                                           |
|                                    |                                                                                    |     }                                                                                 |                                                                                                                           |
|                                    |                                                                                    |     this.subscribers.get(channel)!.add(callback)                                      |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    |     // Return unsubscribe function                                                    |                                                                                                                           |
|                                    |                                                                                    |     return () => {                                                                    |                                                                                                                           |
|                                    |                                                                                    |       const subs = this.subscribers.get(channel)                                      |                                                                                                                           |
|                                    |                                                                                    |       subs?.delete(callback)                                                          |                                                                                                                           |
|                                    |                                                                                    |       if (subs?.size === 0) {                                                         |                                                                                                                           |
|                                    |                                                                                    |         this.subscribers.delete(channel)                                              |                                                                                                                           |
|                                    |                                                                                    |         this.send({ type: 'unsubscribe', channel })                                   |                                                                                                                           |
|                                    |                                                                                    |       }                                                                               |                                                                                                                           |
|                                    |                                                                                    |     }                                                                                 |                                                                                                                           |
|                                    |                                                                                    |   }                                                                                   |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    |   private send(data: any) {                                                           |                                                                                                                           |
|                                    |                                                                                    |     if (this.ws?.readyState === WebSocket.OPEN) {                                     |                                                                                                                           |
|                                    |                                                                                    |       this.ws.send(JSON.stringify(data))                                              |                                                                                                                           |
|                                    |                                                                                    |     }                                                                                 |                                                                                                                           |
|                                    |                                                                                    |   }                                                                                   |                                                                                                                           |
|                                    |                                                                                    | }                                                                                     |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    | export const wsManager = new WebSocketManager()                                       |                                                                                                                           |
|                                    |                                                                                    | wsManager.connect()                                                                   |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    | // src/hooks/useVehicleTelemetry.ts                                                   |                                                                                                                           |
|                                    |                                                                                    | import { useEffect, useState } from 'react'                                           |                                                                                                                           |
|                                    |                                                                                    | import { wsManager } from '@/lib/websocket-manager'                                   |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    | export function useVehicleTelemetry(vehicleId: string) {                              |                                                                                                                           |
|                                    |                                                                                    |   const [data, setData] = useState(null)                                              |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    |   useEffect(() => {                                                                   |                                                                                                                           |
|                                    |                                                                                    |     // âœ… Subscribe to channel (reuses single connection)                             |                                                                                                                           |
|                                    |                                                                                    |     const unsubscribe = wsManager.subscribe(`vehicle:${vehicleId}`, setData)          |                                                                                                                           |
|                                    |                                                                                    |     return unsubscribe                                                                |                                                                                                                           |
|                                    |                                                                                    |   }, [vehicleId])                                                                     |                                                                                                                           |
|                                    |                                                                                    |                                                                                       |                                                                                                                           |
|                                    |                                                                                    |   return data                                                                         |                                                                                                                           |
|                                    |                                                                                    | }                                                                                     |                                                                                                                           |


################################################################################
SHEET: request_batching
################################################################################

| Issue                                                    | Finding                                                                                                                    | Recommendation                                                                                                   | Proposed Benefits                                                                                                                                                              |
|:---------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| more than 40+ api calls on page load for fleet dashboard | - we are fetching vehicle list, driver managment, work orders fuel transactions, maintanence records and more              | - we can probably have a batch request which runs a parallel call and returns data                               | - huge impact on page load time. we can consider this for fleet dahviard page as that is the page that loads up first in the application and that should not take time to load |
|                                                          |                                                                                                                            |                                                                                                                  |                                                                                                                                                                                |
|                                                          | - these calls are sequential with all api's taking time on their own one at a time which adds up to overall response time  | - following is just temp code to show how it can be done (dont replace as such)                                  |                                                                                                                                                                                |
|                                                          |                                                                                                                            |                                                                                                                  |                                                                                                                                                                                |
|                                                          | - useEffect(() => {                                                                                                        | - something like this :                                                                                          |                                                                                                                                                                                |
|                                                          |     //  separate API calls on dashboard load                                                                               | try {                                                                                                            |                                                                                                                                                                                |
|                                                          |     const fetchData = async () => {                                                                                        |     // âœ… Execute all requests in parallel                                                                       |                                                                                                                                                                                |
|                                                          |       // Call 1: Fetch vehicles                                                                                            |     const results = await Promise.all(                                                                           |                                                                                                                                                                                |
|                                                          |       const vehiclesRes = await fetch('/api/vehicles')                                                                     |       requests.map(async (request) => {                                                                          |                                                                                                                                                                                |
|                                                          |       const vehiclesData = await vehiclesRes.json()                                                                        |         try {                                                                                                    |                                                                                                                                                                                |
|                                                          |       setVehicles(vehiclesData)                                                                                            |           switch (request.url) {                                                                                 |                                                                                                                                                                                |
|                                                          |                                                                                                                            |             case '/api/vehicles':                                                                                |                                                                                                                                                                                |
|                                                          |       // Fetch driver for EACH vehicle (N+1 problem)                                                                       |               const vehicles = await pool.query(                                                                 |                                                                                                                                                                                |
|                                                          |       for (const vehicle of vehiclesData) {                                                                                |                 'SELECT * FROM vehicles WHERE tenant_id = $1',                                                   |                                                                                                                                                                                |
|                                                          |         const driverRes = await fetch(`/api/drivers/${vehicle.driver_id}`)                                                 |                 [tenant_id]                                                                                      |                                                                                                                                                                                |
|                                                          |         const driverData = await driverRes.json()                                                                          |               )                                                                                                  |                                                                                                                                                                                |
|                                                          |         // Update driver data...                                                                                           |               return { id: request.id, status: 200, data: vehicles.rows }                                        |                                                                                                                                                                                |
|                                                          |       }                                                                                                                    |                                                                                                                  |                                                                                                                                                                                |
|                                                          |                                                                                                                            |             case '/api/drivers':                                                                                 |                                                                                                                                                                                |
|                                                          |       //  Fetch work orders                                                                                                |               const drivers = await pool.query(                                                                  |                                                                                                                                                                                |
|                                                          |       const workOrdersRes = await fetch('/api/work-orders')                                                                |                 'SELECT * FROM drivers WHERE tenant_id = $1',                                                    |                                                                                                                                                                                |
|                                                          |       setWorkOrders(await workOrdersRes.json())                                                                            |                 [tenant_id]                                                                                      |                                                                                                                                                                                |
|                                                          |                                                                                                                            |               )                                                                                                  |                                                                                                                                                                                |
|                                                          |       // Fetch fuel transactions                                                                                           |               return { id: request.id, status: 200, data: drivers.rows }                                         |                                                                                                                                                                                |
|                                                          |       const fuelRes = await fetch('/api/fuel-transactions')                                                                |                                                                                                                  |                                                                                                                                                                                |
|                                                          |       setFuelData(await fuelRes.json())                                                                                    |             case '/api/work-orders':                                                                             |                                                                                                                                                                                |
|                                                          |                                                                                                                            |               const workOrders = await pool.query(                                                               |                                                                                                                                                                                |
|                                                          |       // Fetch maintenance records                                                                                         |                 'SELECT * FROM work_orders WHERE tenant_id = $1',                                                |                                                                                                                                                                                |
|                                                          |       const maintenanceRes = await fetch('/api/maintenance')                                                               |                 [tenant_id]                                                                                      |                                                                                                                                                                                |
|                                                          |       setMaintenanceData(await maintenanceRes.json())                                                                      |               )                                                                                                  |                                                                                                                                                                                |
|                                                          |     }                                                                                                                      |               return { id: request.id, status: 200, data: workOrders.rows }                                      |                                                                                                                                                                                |
|                                                          |                                                                                                                            |                                                                                                                  |                                                                                                                                                                                |
|                                                          |                                                                                                                            |             case '/api/fuel-transactions':                                                                       |                                                                                                                                                                                |
|                                                          |                                                                                                                            |               const fuel = await pool.query(                                                                     |                                                                                                                                                                                |
|                                                          |                                                                                                                            |                 'SELECT * FROM fuel_transactions WHERE tenant_id = $1 ORDER BY transaction_date DESC LIMIT 100', |                                                                                                                                                                                |
|                                                          |                                                                                                                            |                 [tenant_id]                                                                                      |                                                                                                                                                                                |
|                                                          |                                                                                                                            |               )                                                                                                  |                                                                                                                                                                                |
|                                                          |                                                                                                                            |               return { id: request.id, status: 200, data: fuel.rows }                                            |                                                                                                                                                                                |
|                                                          |                                                                                                                            |                                                                                                                  |                                                                                                                                                                                |
|                                                          |                                                                                                                            |             case '/api/maintenance':                                                                             |                                                                                                                                                                                |
|                                                          |                                                                                                                            |               const maintenance = await pool.query(                                                              |                                                                                                                                                                                |
|                                                          |                                                                                                                            |                 'SELECT * FROM maintenance_records WHERE tenant_id = $1 ORDER BY service_date DESC LIMIT 100',   |                                                                                                                                                                                |
|                                                          |                                                                                                                            |                 [tenant_id]                                                                                      |                                                                                                                                                                                |
|                                                          |                                                                                                                            |               )                                                                                                  |                                                                                                                                                                                |
|                                                          |                                                                                                                            |               return { id: request.id, status: 200, data: maintenance.rows }                                     |                                                                                                                                                                                |
|                                                          |                                                                                                                            |                                                                                                                  |                                                                                                                                                                                |
|                                                          |                                                                                                                            |             default:                                                                                             |                                                                                                                                                                                |
|                                                          |                                                                                                                            |               return { id: request.id, status: 404, error: 'Endpoint not found' }                                |                                                                                                                                                                                |
|                                                          |                                                                                                                            |           }                                                                                                      |                                                                                                                                                                                |
|                                                          |                                                                                                                            |                                                                                                                  |                                                                                                                                                                                |
|                                                          |                                                                                                                            |                                                                                                                  |                                                                                                                                                                                |
|                                                          |                                                                                                                            |                                                                                                                  |                                                                                                                                                                                |
|                                                          |                                                                                                                            |                                                                                                                  |                                                                                                                                                                                |
|                                                          |                                                                                                                            | - and then use this in your router request ---useEffect(() => {                                                  |                                                                                                                                                                                |
|                                                          |                                                                                                                            |     const fetchData = async () => {                                                                              |                                                                                                                                                                                |
|                                                          |                                                                                                                            |       // âœ… Single API call fetches all data                                                                     |                                                                                                                                                                                |
|                                                          |                                                                                                                            |       const results = await fetchBatch([                                                                         |                                                                                                                                                                                |
|                                                          |                                                                                                                            |         { id: 'vehicles', method: 'GET', url: '/api/vehicles' },                                                 |                                                                                                                                                                                |
|                                                          |                                                                                                                            |         { id: 'drivers', method: 'GET', url: '/api/drivers' },                                                   |                                                                                                                                                                                |
|                                                          |                                                                                                                            |         { id: 'work-orders', method: 'GET', url: '/api/work-orders' },                                           |                                                                                                                                                                                |
|                                                          |                                                                                                                            |         { id: 'fuel', method: 'GET', url: '/api/fuel-transactions' },                                            |                                                                                                                                                                                |
|                                                          |                                                                                                                            |         { id: 'maintenance', method: 'GET', url: '/api/maintenance' }                                            |                                                                                                                                                                                |
|                                                          |                                                                                                                            |       ])                                                                                                         |                                                                                                                                                                                |