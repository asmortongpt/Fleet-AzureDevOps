# Azure DevOps CI Pipeline for Fleet Management System
# Triggers on every push to main and develop branches
# Performs: Build, Test, Security Scanning, and Docker Image Creation

trigger:
  branches:
    include:
      - main
      - develop
      - stage-*
  paths:
    exclude:
      - README.md
      - docs/**
      - '*.md'

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '20.x'
  REGISTRY: fleetappregistry.azurecr.io
  IMAGE_NAME_FRONTEND: fleet-frontend
  IMAGE_NAME_API: fleet-api
  ACR_NAME: 'fleetappregistry'

stages:
  # ====================================
  # Stage 1: Code Quality & Linting
  # ====================================
  - stage: CodeQuality
    displayName: 'Code Quality & Linting'
    jobs:
      - job: LintAndTypeCheck
        displayName: 'Lint and Type Check'
        timeoutInMinutes: 15
        steps:
          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: $(NODE_VERSION)

          - task: Cache@2
            displayName: 'Cache npm dependencies'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(Pipeline.Workspace)/.npm

          - script: |
              npm ci --cache $(Pipeline.Workspace)/.npm
            displayName: 'Install frontend dependencies'

          - script: |
              cd api && npm ci --cache $(Pipeline.Workspace)/.npm
            displayName: 'Install API dependencies'

          - script: |
              npm run lint || echo "Linting completed with warnings"
            displayName: 'Lint frontend code'
            continueOnError: true

          - script: |
              cd api && npm run lint || echo "Linting completed with warnings"
            displayName: 'Lint API code'
            continueOnError: true

          - script: |
              npx tsc --noEmit || echo "Type check completed with warnings"
            displayName: 'Check TypeScript types (Frontend)'
            continueOnError: true

          - script: |
              cd api && npx tsc --noEmit || echo "Type check completed with warnings"
            displayName: 'Check TypeScript types (API)'
            continueOnError: true

  # ====================================
  # Stage 2: Security Scanning
  # ====================================
  - stage: Security
    displayName: 'Security Scanning'
    dependsOn: []
    jobs:
      - job: SecurityScan
        displayName: 'Security Vulnerability Scan'
        timeoutInMinutes: 20
        steps:
          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: |
              npm audit --audit-level=moderate || true
            displayName: 'NPM Audit - Frontend'
            continueOnError: true

          - script: |
              cd api && npm audit --audit-level=moderate || true
            displayName: 'NPM Audit - API'
            continueOnError: true

          # Trivy security scan
          - script: |
              wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
              echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
              sudo apt-get update
              sudo apt-get install trivy
              trivy fs --severity HIGH,CRITICAL --format sarif -o trivy-results.sarif .
            displayName: 'Trivy filesystem scan'
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Security Reports'
            condition: always()
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/trivy-results.sarif'
              ArtifactName: 'security-reports'

  # ====================================
  # Stage 3: Frontend Tests
  # ====================================
  - stage: TestFrontend
    displayName: 'Frontend Tests'
    dependsOn: CodeQuality
    jobs:
      - job: FrontendTests
        displayName: 'Frontend Unit & E2E Tests'
        timeoutInMinutes: 30
        steps:
          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: |
              npm ci
            displayName: 'Install dependencies'

          - script: |
              npm run test:unit -- --run --coverage
            displayName: 'Run unit tests with coverage'
            continueOnError: true

          - task: PublishCodeCoverageResults@1
            displayName: 'Publish code coverage'
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage/cobertura-coverage.xml'

          - script: |
              npx playwright install --with-deps chromium
            displayName: 'Install Playwright browsers'

          - script: |
              npm run test:smoke
            displayName: 'Run smoke tests'
            env:
              CI: true
            continueOnError: true

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results/*.xml'
              failTaskOnFailedTests: false

          - task: PublishBuildArtifacts@1
            displayName: 'Publish test artifacts'
            condition: always()
            inputs:
              PathtoPublish: 'playwright-report'
              ArtifactName: 'playwright-report'

  # ====================================
  # Stage 4: API Tests
  # ====================================
  - stage: TestAPI
    displayName: 'API Tests'
    dependsOn: CodeQuality
    jobs:
      - job: APITests
        displayName: 'API Unit Tests'
        timeoutInMinutes: 30
        steps:
          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: |
              cd api && npm ci
            displayName: 'Install dependencies'

          - script: |
              cd api && npm run test
            displayName: 'Run API tests'
            env:
              NODE_ENV: test
            continueOnError: true

          - script: |
              cd api && npm run test:coverage
            displayName: 'Run API coverage'
            env:
              NODE_ENV: test
            continueOnError: true

          - task: PublishCodeCoverageResults@1
            displayName: 'Publish API coverage'
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/api/coverage/cobertura-coverage.xml'

  # ====================================
  # Stage 5: Build Docker Images
  # ====================================
  - stage: Build
    displayName: 'Build Docker Images'
    dependsOn:
      - Security
      - TestFrontend
      - TestAPI
    condition: succeeded()
    jobs:
      - job: BuildFrontend
        displayName: 'Build Frontend Image'
        timeoutInMinutes: 30
        steps:
          - task: Docker@2
            displayName: 'Login to Azure Container Registry'
            inputs:
              command: login
              containerRegistry: $(ACR_SERVICE_CONNECTION)

          - task: Docker@2
            displayName: 'Build Frontend Image'
            inputs:
              command: build
              repository: $(IMAGE_NAME_FRONTEND)
              dockerfile: Dockerfile
              tags: |
                $(Build.SourceBranchName)-$(Build.BuildId)
                $(Build.SourceBranchName)-latest
              arguments: |
                --build-arg NODE_ENV=$(Build.SourceBranchName)
                --build-arg BUILD_DATE=$(Build.BuildId)
                --build-arg VCS_REF=$(Build.SourceVersion)

          - task: Docker@2
            displayName: 'Push Frontend Image'
            inputs:
              command: push
              repository: $(IMAGE_NAME_FRONTEND)
              tags: |
                $(Build.SourceBranchName)-$(Build.BuildId)
                $(Build.SourceBranchName)-latest

      - job: BuildAPI
        displayName: 'Build API Image'
        timeoutInMinutes: 30
        steps:
          - task: Docker@2
            displayName: 'Login to Azure Container Registry'
            inputs:
              command: login
              containerRegistry: $(ACR_SERVICE_CONNECTION)

          - task: Docker@2
            displayName: 'Build API Image'
            inputs:
              command: build
              repository: $(IMAGE_NAME_API)
              dockerfile: api/Dockerfile
              context: api
              tags: |
                $(Build.SourceBranchName)-$(Build.BuildId)
                $(Build.SourceBranchName)-latest
              arguments: |
                --build-arg NODE_ENV=$(Build.SourceBranchName)
                --build-arg BUILD_DATE=$(Build.BuildId)
                --build-arg VCS_REF=$(Build.SourceVersion)

          - task: Docker@2
            displayName: 'Push API Image'
            inputs:
              command: push
              repository: $(IMAGE_NAME_API)
              tags: |
                $(Build.SourceBranchName)-$(Build.BuildId)
                $(Build.SourceBranchName)-latest

          # Scan images for vulnerabilities
          - script: |
              docker run --rm aquasec/trivy image --severity HIGH,CRITICAL \
                $(REGISTRY)/$(IMAGE_NAME_API):$(Build.SourceBranchName)-$(Build.BuildId)
            displayName: 'Scan API Image'
            continueOnError: true

  # ====================================
  # Stage 6: Publish Build Info
  # ====================================
  - stage: PublishArtifacts
    displayName: 'Publish Build Artifacts'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: PublishInfo
        displayName: 'Publish Build Information'
        steps:
          - script: |
              echo "Frontend Image: $(REGISTRY)/$(IMAGE_NAME_FRONTEND):$(Build.SourceBranchName)-$(Build.BuildId)" > build-info.txt
              echo "API Image: $(REGISTRY)/$(IMAGE_NAME_API):$(Build.SourceBranchName)-$(Build.BuildId)" >> build-info.txt
              echo "Build ID: $(Build.BuildId)" >> build-info.txt
              echo "Commit: $(Build.SourceVersion)" >> build-info.txt
              echo "Branch: $(Build.SourceBranchName)" >> build-info.txt
              echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> build-info.txt
            displayName: 'Create build info file'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish build info'
            inputs:
              PathtoPublish: 'build-info.txt'
              ArtifactName: 'build-info'
