/**
 * VehicleShowroom3D - Interactive 3D Vehicle Showcase
 *
 * Features:
 * - Multiple vehicle selection
 * - Real-time customization
 * - Color picker with presets
 * - Paint type selection (metallic, pearl, matte, gloss)
 * - Quality settings
 * - Environment presets
 * - AR mode integration
 * - Share functionality
 * - Comparison mode
 */

import {
  Car,
  Palette,
  Settings,
  Camera,
  Share2,
  Download,
  Sun,
  Moon,
  Zap,
  Sparkles,
  Eye,
  ArrowLeft
} from 'lucide-react';
import { useState, useCallback, useEffect } from 'react';
import { useSearchParams , useNavigate } from 'react-router-dom';

import ARModeExport from '@/components/3d/ARModeExport';
import VehicleViewer3D from '@/components/3d/VehicleViewer3D';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { VEHICLE_COLORS, type MaterialQuality, type PaintType } from '@/lib/3d/pbr-materials';


import logger from '@/utils/logger';
import logger from '@/utils/logger';
interface Vehicle {
  id: number;
  make: string;
  model: string;
  year: number;
  vehicleType: 'sedan' | 'suv' | 'truck' | 'van' | 'pickup' | 'bus';
  modelUrl: string;
  usdzUrl?: string;
  glbUrl?: string;
  exteriorColor?: string;
  interiorColor?: string;
  trim?: string;
}

export default function VehicleShowroom3D() {
  const navigate = useNavigate();
  const [searchParams, setSearchParams] = useSearchParams();

  // Get vehicle ID from URL params
  const vehicleIdParam = searchParams.get('id');

  // State
  const [selectedVehicle, setSelectedVehicle] = useState<Vehicle | null>(null);
  const [exteriorColor, setExteriorColor] = useState<string>('#ffffff');
  const [interiorColor, setInteriorColor] = useState<string>('#333333');
  const [paintType, setPaintType] = useState<PaintType>('metallic');
  const [quality, setQuality] = useState<MaterialQuality>('medium');
  const [environment, setEnvironment] = useState<'studio' | 'sunset' | 'city' | 'night'>('studio');
  const [autoRotate, setAutoRotate] = useState(false);
  const [showDamage, setShowDamage] = useState(false);

  // Mock vehicle data - In production, fetch from API
  const mockVehicles: Vehicle[] = [
    {
      id: 1,
      make: 'Ford',
      model: 'F-150',
      year: 2024,
      vehicleType: 'pickup',
      modelUrl: '/models/vehicles/ford-f150.glb',
      usdzUrl: '/models/vehicles/ford-f150.usdz',
      exteriorColor: '#1a1a1a',
      trim: 'Lariat',
    },
    {
      id: 2,
      make: 'Chevrolet',
      model: 'Silverado',
      year: 2024,
      vehicleType: 'pickup',
      modelUrl: '/models/vehicles/chevy-silverado.glb',
      exteriorColor: '#c0c0c0',
      trim: 'LT',
    },
    {
      id: 3,
      make: 'Toyota',
      model: 'Camry',
      year: 2024,
      vehicleType: 'sedan',
      modelUrl: '/models/vehicles/toyota-camry.glb',
      exteriorColor: '#0066cc',
      trim: 'XSE',
    },
    {
      id: 4,
      make: 'Honda',
      model: 'CR-V',
      year: 2024,
      vehicleType: 'suv',
      modelUrl: '/models/vehicles/honda-crv.glb',
      exteriorColor: '#ff0000',
      trim: 'EX-L',
    },
  ];

  // Load vehicle on mount or when ID changes
  useEffect(() => {
    if (vehicleIdParam) {
      const vehicle = mockVehicles.find(v => v.id === parseInt(vehicleIdParam));
      if (vehicle) {
        setSelectedVehicle(vehicle);
        setExteriorColor(vehicle.exteriorColor || '#ffffff');
        setInteriorColor(vehicle.interiorColor || '#333333');
      }
    } else {
      // Default to first vehicle
      setSelectedVehicle(mockVehicles[0]);
      setExteriorColor(mockVehicles[0].exteriorColor || '#ffffff');
    }
  }, [vehicleIdParam]);

  const handleVehicleSelect = useCallback((vehicle: Vehicle) => {
    setSelectedVehicle(vehicle);
    setExteriorColor(vehicle.exteriorColor || '#ffffff');
    setInteriorColor(vehicle.interiorColor || '#333333');
    setSearchParams({ id: vehicle.id.toString() });
  }, [setSearchParams]);

  const handleShare = useCallback(async () => {
    const shareData = {
      title: `${selectedVehicle?.year} ${selectedVehicle?.make} ${selectedVehicle?.model}`,
      text: 'Check out this vehicle in 3D!',
      url: window.location.href,
    };

    try {
      if (navigator.share) {
        await navigator.share(shareData);
      } else {
        await navigator.clipboard.writeText(window.location.href);
        alert('Link copied to clipboard!');
      }
    } catch (err) {
      logger.error('Error sharing:', err);
    }
  }, [selectedVehicle]);

  if (!selectedVehicle) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center space-y-2">
          <Car className="w-16 h-16 text-muted-foreground mx-auto" />
          <p className="text-muted-foreground">Loading vehicle...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="border-b bg-card">
        <div className="container mx-auto px-2 py-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Button
                variant="ghost"
                size="sm"
                onClick={() => navigate('/virtual-garage')}
              >
                <ArrowLeft className="w-4 h-4 mr-2" />
                Back to Garage
              </Button>
              <div className="flex items-center gap-3">
                <Car className="w-4 h-4 text-primary" />
                <div>
                  <h1 className="text-sm font-bold">
                    {selectedVehicle.year} {selectedVehicle.make} {selectedVehicle.model}
                  </h1>
                  {selectedVehicle.trim && (
                    <p className="text-sm text-muted-foreground">{selectedVehicle.trim}</p>
                  )}
                </div>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <ARModeExport
                vehicleId={selectedVehicle.id}
                vehicleData={selectedVehicle}
                modelUrl={selectedVehicle.modelUrl}
                usdzUrl={selectedVehicle.usdzUrl}
                glbUrl={selectedVehicle.glbUrl}
              />
              <Button variant="outline" size="sm" onClick={handleShare}>
                <Share2 className="w-4 h-4 mr-2" />
                Share
              </Button>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="container mx-auto px-2 py-3">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-2">
          {/* Left Sidebar - Vehicle Selection */}
          <div className="lg:col-span-1 space-y-2">
            <Card className="p-2">
              <h2 className="font-semibold mb-3 flex items-center gap-2">
                <Car className="w-4 h-4" />
                Fleet Vehicles
              </h2>
              <div className="space-y-2">
                {mockVehicles.map((vehicle) => (
                  <button
                    key={vehicle.id}
                    onClick={() => handleVehicleSelect(vehicle)}
                    className={`w-full text-left p-3 rounded-lg border transition-colors ${
                      selectedVehicle?.id === vehicle.id
                        ? 'bg-primary text-primary-foreground border-primary'
                        : 'bg-card hover:bg-muted border-border'
                    }`}
                  >
                    <div className="font-medium text-sm">
                      {vehicle.year} {vehicle.make}
                    </div>
                    <div className="text-xs opacity-80">{vehicle.model}</div>
                    {vehicle.trim && (
                      <Badge variant="secondary" className="mt-1 text-xs">
                        {vehicle.trim}
                      </Badge>
                    )}
                  </button>
                ))}
              </div>
            </Card>

            {/* Quick Stats */}
            <Card className="p-2">
              <h3 className="font-semibold mb-3 text-sm">Vehicle Stats</h3>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Type</span>
                  <span className="font-medium capitalize">{selectedVehicle.vehicleType}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Year</span>
                  <span className="font-medium">{selectedVehicle.year}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Color</span>
                  <div className="flex items-center gap-2">
                    <div
                      className="w-4 h-4 rounded border"
                      style={{ backgroundColor: exteriorColor }}
                    />
                    <span className="font-medium text-xs">Custom</span>
                  </div>
                </div>
              </div>
            </Card>
          </div>

          {/* Center - 3D Viewer */}
          <div className="lg:col-span-2">
            <Card className="overflow-hidden">
              <VehicleViewer3D
                vehicleId={selectedVehicle.id}
                modelUrl={selectedVehicle.modelUrl}
                usdzUrl={selectedVehicle.usdzUrl}
                vehicleData={{
                  ...selectedVehicle,
                  exteriorColor,
                  interiorColor,
                }}
                quality={quality}
                autoRotate={autoRotate}
                showControls={true}
                className="w-full"
              />
            </Card>
          </div>

          {/* Right Sidebar - Customization */}
          <div className="lg:col-span-1 space-y-2">
            <Card className="p-2">
              <Tabs defaultValue="colors" className="w-full">
                <TabsList className="grid w-full grid-cols-2">
                  <TabsTrigger value="colors">
                    <Palette className="w-4 h-4 mr-2" />
                    Colors
                  </TabsTrigger>
                  <TabsTrigger value="settings">
                    <Settings className="w-4 h-4 mr-2" />
                    Settings
                  </TabsTrigger>
                </TabsList>

                {/* Colors Tab */}
                <TabsContent value="colors" className="space-y-2 mt-2">
                  {/* Paint Type */}
                  <div className="space-y-2">
                    <Label className="text-sm font-medium">Paint Type</Label>
                    <Select
                      value={paintType}
                      onValueChange={(value) => setPaintType(value as PaintType)}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="metallic">
                          <div className="flex items-center gap-2">
                            <Sparkles className="w-4 h-4" />
                            Metallic
                          </div>
                        </SelectItem>
                        <SelectItem value="pearl">
                          <div className="flex items-center gap-2">
                            <Sparkles className="w-4 h-4" />
                            Pearl
                          </div>
                        </SelectItem>
                        <SelectItem value="matte">Matte</SelectItem>
                        <SelectItem value="gloss">Gloss</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  {/* Exterior Color Presets */}
                  <div className="space-y-2">
                    <Label className="text-sm font-medium">Exterior Color</Label>
                    <div className="grid grid-cols-5 gap-2">
                      {Object.entries(VEHICLE_COLORS).slice(0, 15).map(([name, color]) => (
                        <button
                          key={name}
                          onClick={() => setExteriorColor(color)}
                          className={`w-10 h-8 rounded-lg border-2 transition-all ${
                            exteriorColor === color
                              ? 'border-primary ring-2 ring-primary ring-offset-2'
                              : 'border-border hover:border-primary/50'
                          }`}
                          style={{ backgroundColor: color }}
                          title={name.replace(/_/g, ' ')}
                        />
                      ))}
                    </div>
                  </div>

                  {/* Custom Color Picker */}
                  <div className="space-y-2">
                    <Label htmlFor="custom-color" className="text-sm font-medium">
                      Custom Color
                    </Label>
                    <input
                      id="custom-color"
                      type="color"
                      value={exteriorColor}
                      onChange={(e) => setExteriorColor(e.target.value)}
                      className="w-full h-9 rounded-lg border cursor-pointer"
                    />
                  </div>

                  {/* Interior Color */}
                  <div className="space-y-2">
                    <Label htmlFor="interior-color" className="text-sm font-medium">
                      Interior Color
                    </Label>
                    <input
                      id="interior-color"
                      type="color"
                      value={interiorColor}
                      onChange={(e) => setInteriorColor(e.target.value)}
                      className="w-full h-9 rounded-lg border cursor-pointer"
                    />
                  </div>
                </TabsContent>

                {/* Settings Tab */}
                <TabsContent value="settings" className="space-y-2 mt-2">
                  {/* Quality */}
                  <div className="space-y-2">
                    <Label className="text-sm font-medium">Render Quality</Label>
                    <Select
                      value={quality}
                      onValueChange={(value) => setQuality(value as MaterialQuality)}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="low">Low (Faster)</SelectItem>
                        <SelectItem value="medium">Medium</SelectItem>
                        <SelectItem value="high">High</SelectItem>
                        <SelectItem value="ultra">Ultra (Slower)</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  {/* Environment */}
                  <div className="space-y-2">
                    <Label className="text-sm font-medium">Environment</Label>
                    <Select
                      value={environment}
                      onValueChange={(value) => setEnvironment(value as any)}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="studio">
                          <div className="flex items-center gap-2">
                            <Zap className="w-4 h-4" />
                            Studio
                          </div>
                        </SelectItem>
                        <SelectItem value="sunset">
                          <div className="flex items-center gap-2">
                            <Sun className="w-4 h-4" />
                            Sunset
                          </div>
                        </SelectItem>
                        <SelectItem value="city">City</SelectItem>
                        <SelectItem value="night">
                          <div className="flex items-center gap-2">
                            <Moon className="w-4 h-4" />
                            Night
                          </div>
                        </SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  {/* Auto Rotate */}
                  <div className="flex items-center justify-between">
                    <Label htmlFor="auto-rotate" className="text-sm font-medium">
                      Auto Rotate
                    </Label>
                    <Switch
                      id="auto-rotate"
                      checked={autoRotate}
                      onCheckedChange={setAutoRotate}
                    />
                  </div>

                  {/* Show Damage */}
                  <div className="flex items-center justify-between">
                    <Label htmlFor="show-damage" className="text-sm font-medium">
                      Show Damage
                    </Label>
                    <Switch
                      id="show-damage"
                      checked={showDamage}
                      onCheckedChange={setShowDamage}
                    />
                  </div>
                </TabsContent>
              </Tabs>
            </Card>

            {/* Action Buttons */}
            <Card className="p-2 space-y-2">
              <Button variant="outline" className="w-full justify-start" size="sm">
                <Download className="w-4 h-4 mr-2" />
                Download Screenshot
              </Button>
              <Button variant="outline" className="w-full justify-start" size="sm">
                <Camera className="w-4 h-4 mr-2" />
                360Â° View
              </Button>
              <Button variant="outline" className="w-full justify-start" size="sm">
                <Eye className="w-4 h-4 mr-2" />
                Interior View
              </Button>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}
