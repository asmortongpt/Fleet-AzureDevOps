/**
 * FLAIR Expense Submission Component
 * Interface for submitting expenses to Florida's FLAIR accounting system
 * Supports travel mileage, fuel, maintenance, and other fleet-related expenses
 */

import React, { useState, useEffect } from 'react';
import { 
  flairIntegrationService, 
  FLAIRExpenseEntry, 
  FLAIRBatchSubmission, 
  FLAIRDocument,
  DCF_ACCOUNT_CODES 
} from '../../services/FLAIRIntegration';
import { useAuth } from '../../auth/AuthProviderFactory';

// Component props
interface FLAIRExpenseSubmissionProps {
  onSubmissionComplete?: (entry: FLAIRExpenseEntry) => void;
  onError?: (error: string) => void;
  className?: string;
}

// Expense type configuration
type ExpenseType = 'travel_mileage' | 'fuel' | 'maintenance' | 'vehicle_rental' | 'parking' | 'tolls';

const EXPENSE_TYPES: Record<ExpenseType, { 
  label: string; 
  icon: string; 
  description: string;
  requiresApproval: boolean;
  documentationRequired: boolean;
}> = {
  travel_mileage: {
    label: 'Travel Mileage',
    icon: 'üöó',
    description: 'Mileage reimbursement for official travel',
    requiresApproval: true,
    documentationRequired: true
  },
  fuel: {
    label: 'Fuel Purchase',
    icon: '‚õΩ',
    description: 'Fuel purchases for state vehicles',
    requiresApproval: false,
    documentationRequired: true
  },
  maintenance: {
    label: 'Vehicle Maintenance',
    icon: 'üîß',
    description: 'Vehicle maintenance and repairs',
    requiresApproval: true,
    documentationRequired: true
  },
  vehicle_rental: {
    label: 'Vehicle Rental',
    icon: 'üöô',
    description: 'Vehicle rental expenses',
    requiresApproval: true,
    documentationRequired: true
  },
  parking: {
    label: 'Parking Fees',
    icon: 'üÖøÔ∏è',
    description: 'Parking fees during official travel',
    requiresApproval: false,
    documentationRequired: false
  },
  tolls: {
    label: 'Toll Charges',
    icon: 'üí≥',
    description: 'Toll charges during official travel',
    requiresApproval: false,
    documentationRequired: false
  }
};

// Expense type selector
const ExpenseTypeSelector: React.FC<{
  selectedType: ExpenseType | null;
  onSelect: (type: ExpenseType) => void;
}> = ({ selectedType, onSelect }) => {
  return (
    <div className="space-y-4">
      <h3 className="text-lg font-semibold text-gray-900">Select Expense Type</h3>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {Object.entries(EXPENSE_TYPES).map(([type, config]) => (
          <button
            key={type}
            onClick={() => onSelect(type as ExpenseType)}
            className={`p-4 rounded-lg border-2 text-left transition-all ${
              selectedType === type
                ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200'
                : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
            }`}
          >
            <div className="flex items-start space-x-3">
              <span className="text-2xl">{config.icon}</span>
              <div>
                <h4 className="font-medium text-gray-900">{config.label}</h4>
                <p className="text-sm text-gray-600 mt-1">{config.description}</p>
                <div className="flex space-x-2 mt-2">
                  {config.requiresApproval && (
                    <span className="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded">
                      Approval Required
                    </span>
                  )}
                  {config.documentationRequired && (
                    <span className="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">
                      Documentation Required
                    </span>
                  )}
                </div>
              </div>
            </div>
          </button>
        ))}
      </div>
    </div>
  );
};

// Travel mileage form
const TravelMileageForm: React.FC<{
  onSubmit: (data: any) => void;
  onCancel: () => void;
  isSubmitting: boolean;
}> = ({ onSubmit, onCancel, isSubmitting }) => {
  const [formData, setFormData] = useState({
    originAddress: '',
    destinationAddress: '',
    mileage: '',
    mileageRate: '0.67', // Current Florida rate
    travelDate: '',
    purposeCode: '',
    description: ''
  });

  const purposeCodes = [
    { code: 'MEETING', label: 'Official Meeting' },
    { code: 'TRAINING', label: 'Training/Conference' },
    { code: 'INSPECTION', label: 'Site Inspection' },
    { code: 'CLIENT_VISIT', label: 'Client Visit' },
    { code: 'COURT', label: 'Court Appearance' },
    { code: 'OTHER', label: 'Other Official Business' }
  ];

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    onSubmit({
      ...formData,
      mileage: parseFloat(formData.mileage),
      mileageRate: parseFloat(formData.mileageRate)
    });
  };

  const totalAmount = (parseFloat(formData.mileage) || 0) * (parseFloat(formData.mileageRate) || 0);

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Origin Address
          </label>
          <input
            type="text"
            value={formData.originAddress}
            onChange={(e) => setFormData({ ...formData, originAddress: e.target.value })}
            placeholder="e.g., 1317 Winewood Blvd, Tallahassee, FL 32399"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Destination Address
          </label>
          <input
            type="text"
            value={formData.destinationAddress}
            onChange={(e) => setFormData({ ...formData, destinationAddress: e.target.value })}
            placeholder="e.g., 2555 Shumard Oak Blvd, Tallahassee, FL 32399"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Mileage
          </label>
          <input
            type="number"
            value={formData.mileage}
            onChange={(e) => setFormData({ ...formData, mileage: e.target.value })}
            placeholder="0.0"
            step="0.1"
            min="0"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Mileage Rate (per mile)
          </label>
          <input
            type="number"
            value={formData.mileageRate}
            onChange={(e) => setFormData({ ...formData, mileageRate: e.target.value })}
            step="0.01"
            min="0"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Travel Date
          </label>
          <input
            type="date"
            value={formData.travelDate}
            onChange={(e) => setFormData({ ...formData, travelDate: e.target.value })}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Purpose Code
          </label>
          <select
            value={formData.purposeCode}
            onChange={(e) => setFormData({ ...formData, purposeCode: e.target.value })}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="">Select purpose...</option>
            {purposeCodes.map((purpose) => (
              <option key={purpose.code} value={purpose.code}>
                {purpose.label}
              </option>
            ))}
          </select>
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          Description
        </label>
        <textarea
          value={formData.description}
          onChange={(e) => setFormData({ ...formData, description: e.target.value })}
          placeholder="Brief description of the travel purpose"
          rows={3}
          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      {/* Total amount display */}
      {totalAmount > 0 && (
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div className="flex items-center justify-between">
            <span className="text-sm font-medium text-blue-800">Total Reimbursement:</span>
            <span className="text-lg font-bold text-blue-600">${totalAmount.toFixed(2)}</span>
          </div>
        </div>
      )}

      {/* Form actions */}
      <div className="flex justify-between pt-4">
        <button
          type="button"
          onClick={onCancel}
          className="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors"
        >
          ‚Üê Back
        </button>
        <button
          type="submit"
          disabled={isSubmitting || totalAmount <= 0}
          className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
        >
          {isSubmitting ? 'Submitting...' : 'Submit to FLAIR'}
        </button>
      </div>
    </form>
  );
};

// Document upload component
const DocumentUpload: React.FC<{
  documents: FLAIRDocument[];
  onDocumentAdd: (document: FLAIRDocument) => void;
  onDocumentRemove: (documentId: string) => void;
  required?: boolean;
}> = ({ documents, onDocumentAdd, onDocumentRemove, required = false }) => {
  const [isDragging, setIsDragging] = useState(false);

  const handleFileUpload = async (files: FileList) => {
    for (const file of Array.from(files)) {
      if (file.size > 10 * 1024 * 1024) { // 10MB limit
        alert(`File ${file.name} is too large. Maximum size is 10MB.`);
        continue;
      }

      // Convert to base64
      const base64 = await new Promise<string>((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result as string);
        reader.readAsDataURL(file);
      });

      const document: FLAIRDocument = {
        id: `doc_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`,
        fileName: file.name,
        fileType: file.type,
        fileSize: file.size,
        uploadedAt: new Date().toISOString(),
        documentType: 'receipt', // Default type
        base64Content: base64.split(',')[1], // Remove data URL prefix
        checksum: `md5_${Date.now()}` // Would be actual MD5 in production
      };

      onDocumentAdd(document);
    }
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(false);
    handleFileUpload(e.dataTransfer.files);
  };

  const handleFileInput = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      handleFileUpload(e.target.files);
    }
  };

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h4 className="font-medium text-gray-900">Supporting Documents</h4>
        {required && (
          <span className="text-sm text-red-600">* Required</span>
        )}
      </div>

      {/* Upload area */}
      <div
        className={`border-2 border-dashed rounded-lg p-6 transition-colors ${
          isDragging 
            ? 'border-blue-400 bg-blue-50' 
            : 'border-gray-300 hover:border-gray-400'
        }`}
        onDragOver={(e) => {
          e.preventDefault();
          setIsDragging(true);
        }}
        onDragLeave={() => setIsDragging(false)}
        onDrop={handleDrop}
      >
        <div className="text-center">
          <div className="text-4xl mb-2">üìé</div>
          <div className="text-sm text-gray-600 mb-2">
            Drag and drop files here, or{' '}
            <label className="text-blue-600 hover:text-blue-700 cursor-pointer">
              browse
              <input
                type="file"
                multiple
                accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx"
                onChange={handleFileInput}
                className="hidden"
              />
            </label>
          </div>
          <div className="text-xs text-gray-500">
            Supports PDF, images, and Office documents (max 10MB each)
          </div>
        </div>
      </div>

      {/* Document list */}
      {documents.length > 0 && (
        <div className="space-y-2">
          {documents.map((doc) => (
            <div key={doc.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div className="flex items-center space-x-3">
                <span className="text-lg">üìÑ</span>
                <div>
                  <div className="font-medium text-sm">{doc.fileName}</div>
                  <div className="text-xs text-gray-500">
                    {(doc.fileSize / 1024).toFixed(1)} KB ‚Ä¢ Uploaded {new Date(doc.uploadedAt).toLocaleString()}
                  </div>
                </div>
              </div>
              <button
                onClick={() => onDocumentRemove(doc.id)}
                className="text-red-600 hover:text-red-800 transition-colors"
              >
                üóëÔ∏è
              </button>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

// Main FLAIR expense submission component
export const FLAIRExpenseSubmission: React.FC<FLAIRExpenseSubmissionProps> = ({
  onSubmissionComplete,
  onError,
  className = ''
}) => {
  const { user } = useAuth();
  const [currentStep, setCurrentStep] = useState<'select' | 'form' | 'documents' | 'review'>('select');
  const [selectedType, setSelectedType] = useState<ExpenseType | null>(null);
  const [formData, setFormData] = useState<any>(null);
  const [documents, setDocuments] = useState<FLAIRDocument[]>([]);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState('');

  // Handle expense type selection
  const handleTypeSelect = (type: ExpenseType) => {
    setSelectedType(type);
    setCurrentStep('form');
  };

  // Handle form submission
  const handleFormSubmit = (data: any) => {
    setFormData(data);
    const config = EXPENSE_TYPES[selectedType!];
    
    if (config.documentationRequired) {
      setCurrentStep('documents');
    } else {
      setCurrentStep('review');
    }
  };

  // Handle document management
  const handleDocumentAdd = (document: FLAIRDocument) => {
    setDocuments(prev => [...prev, document]);
  };

  const handleDocumentRemove = (documentId: string) => {
    setDocuments(prev => prev.filter(doc => doc.id !== documentId));
  };

  // Handle final submission
  const handleFinalSubmit = async () => {
    if (!selectedType || !formData || !user) {
      setError('Missing required information');
      return;
    }

    setIsSubmitting(true);
    setError('');

    try {
      let expenseEntry: FLAIRExpenseEntry;

      if (selectedType === 'travel_mileage') {
        expenseEntry = await flairIntegrationService.submitTravelMileageExpense({
          employeeId: user.employeeId,
          employeeName: user.fullName,
          department: user.department,
          originAddress: formData.originAddress,
          destinationAddress: formData.destinationAddress,
          mileage: formData.mileage,
          mileageRate: formData.mileageRate,
          travelDate: formData.travelDate,
          purposeCode: formData.purposeCode,
          supportingDocuments: documents
        });
      } else if (selectedType === 'fuel') {
        expenseEntry = await flairIntegrationService.submitFuelExpense({
          employeeId: user.employeeId,
          employeeName: user.fullName,
          department: user.department,
          vehicleId: formData.vehicleId,
          fuelAmount: formData.fuelAmount,
          fuelCost: formData.fuelCost,
          transactionDate: formData.transactionDate,
          vendorName: formData.vendorName,
          supportingDocuments: documents
        });
      } else if (selectedType === 'maintenance') {
        expenseEntry = await flairIntegrationService.submitMaintenanceExpense({
          employeeId: user.employeeId,
          employeeName: user.fullName,
          department: user.department,
          vehicleId: formData.vehicleId,
          maintenanceType: formData.maintenanceType,
          amount: formData.amount,
          transactionDate: formData.transactionDate,
          vendorName: formData.vendorName,
          workOrderNumber: formData.workOrderNumber,
          supportingDocuments: documents
        });
      } else {
        throw new Error('Unsupported expense type');
      }

      console.log?.('‚úÖ Expense submitted to FLAIR:', expenseEntry.id);
      onSubmissionComplete?.(expenseEntry);
      
      // Reset form
      setCurrentStep('select');
      setSelectedType(null);
      setFormData(null);
      setDocuments([]);
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Submission failed';
      setError(errorMessage);
      onError?.(errorMessage);
    } finally {
      setIsSubmitting(false);
    }
  };

  // Render current step
  const renderStep = () => {
    switch (currentStep) {
      case 'select':
        return (
          <ExpenseTypeSelector
            selectedType={selectedType}
            onSelect={handleTypeSelect}
          />
        );

      case 'form':
        if (selectedType === 'travel_mileage') {
          return (
            <TravelMileageForm
              onSubmit={handleFormSubmit}
              onCancel={() => setCurrentStep('select')}
              isSubmitting={isSubmitting}
            />
          );
        }
        // Add other expense type forms here
        return <div>Form for {selectedType} coming soon...</div>;

      case 'documents':
        const config = EXPENSE_TYPES[selectedType!];
        return (
          <div className="space-y-6">
            <DocumentUpload
              documents={documents}
              onDocumentAdd={handleDocumentAdd}
              onDocumentRemove={handleDocumentRemove}
              required={config.documentationRequired}
            />
            <div className="flex justify-between pt-4">
              <button
                onClick={() => setCurrentStep('form')}
                className="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors"
              >
                ‚Üê Back
              </button>
              <button
                onClick={() => setCurrentStep('review')}
                disabled={config.documentationRequired && documents.length === 0}
                className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
              >
                Continue to Review ‚Üí
              </button>
            </div>
          </div>
        );

      case 'review':
        const expenseConfig = EXPENSE_TYPES[selectedType!];
        const totalAmount = selectedType === 'travel_mileage' 
          ? (formData?.mileage || 0) * (formData?.mileageRate || 0)
          : formData?.amount || 0;

        return (
          <div className="space-y-6">
            <h3 className="text-lg font-semibold text-gray-900">Review Submission</h3>
            
            <div className="bg-gray-50 rounded-lg p-6 space-y-4">
              <div className="flex items-center space-x-3">
                <span className="text-2xl">{expenseConfig.icon}</span>
                <div>
                  <h4 className="font-medium text-gray-900">{expenseConfig.label}</h4>
                  <p className="text-sm text-gray-600">{expenseConfig.description}</p>
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span className="font-medium text-gray-700">Employee:</span>
                  <div>{user?.fullName}</div>
                </div>
                <div>
                  <span className="font-medium text-gray-700">Department:</span>
                  <div>{user?.department}</div>
                </div>
                <div>
                  <span className="font-medium text-gray-700">Amount:</span>
                  <div className="text-lg font-semibold text-green-600">${totalAmount.toFixed(2)}</div>
                </div>
                <div>
                  <span className="font-medium text-gray-700">Documents:</span>
                  <div>{documents.length} attached</div>
                </div>
              </div>
            </div>

            {expenseConfig.requiresApproval && (
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div className="flex items-start space-x-2">
                  <span className="text-yellow-600">‚ö†Ô∏è</span>
                  <div className="text-sm text-yellow-800">
                    <strong>Approval Required:</strong> This expense will require supervisor approval before processing.
                  </div>
                </div>
              </div>
            )}

            <div className="flex justify-between pt-4">
              <button
                onClick={() => setCurrentStep(documents.length > 0 ? 'documents' : 'form')}
                className="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors"
              >
                ‚Üê Back
              </button>
              <button
                onClick={handleFinalSubmit}
                disabled={isSubmitting}
                className="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
              >
                {isSubmitting ? 'Submitting to FLAIR...' : 'Submit to FLAIR'}
              </button>
            </div>
          </div>
        );

      default:
        return null;
    }
  };

  return (
    <div className={`max-w-4xl mx-auto p-6 bg-white rounded-lg shadow-lg ${className}`}>
      {/* Header */}
      <div className="mb-8">
        <h2 className="text-2xl font-bold text-gray-900 mb-2">
          FLAIR Expense Submission
        </h2>
        <p className="text-gray-600">
          Submit fleet-related expenses to Florida's FLAIR accounting system
        </p>
      </div>

      {/* Error display */}
      {error && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
          <div className="flex items-center space-x-2">
            <span className="text-red-600">‚ùå</span>
            <span className="text-red-800">{error}</span>
          </div>
        </div>
      )}

      {/* Step content */}
      {renderStep()}
    </div>
  );
};

export default FLAIRExpenseSubmission;