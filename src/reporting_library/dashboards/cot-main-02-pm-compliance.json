{
  "id": "cot-main-02",
  "title": "PM Compliance",
  "domain": "pm",
  "category": "city_tallahassee_main",
  "description": "PM due vs completed by shop for selected month",
  "datasource": {
    "type": "sqlView",
    "view": "vw_pm_compliance",
    "parameters": {
      "month": "{{month}}",
      "shop": "{{shop}}"
    }
  },
  "filters": [
    {
      "name": "month",
      "type": "month",
      "default": "current_month",
      "required": true
    },
    {
      "name": "shop",
      "type": "multiSelect",
      "values": "dynamic",
      "default": "All"
    }
  ],
  "visuals": [
    {
      "id": "kpis",
      "type": "kpiTiles",
      "title": "PM Summary",
      "measures": [
        {
          "id": "total_due",
          "label": "PMs Due",
          "format": "integer",
          "aggregation": "sum",
          "field": "pm_due_count"
        },
        {
          "id": "completed",
          "label": "Completed",
          "format": "integer",
          "aggregation": "sum",
          "field": "pm_completed_count"
        },
        {
          "id": "compliance_rate",
          "label": "Compliance Rate",
          "format": "percent",
          "expression": "pm_completed_count/pm_due_count"
        },
        {
          "id": "overdue",
          "label": "Overdue",
          "format": "integer",
          "aggregation": "sum",
          "field": "pm_overdue_count"
        }
      ],
      "layout": {
        "x": 0,
        "y": 0,
        "w": 12,
        "h": 2
      }
    },
    {
      "id": "shop_compliance",
      "type": "groupedBar",
      "title": "PM Compliance by Shop",
      "encoding": {
        "x": {"field": "shop_name", "type": "nominal"},
        "y": {"field": "count", "type": "quantitative", "aggregate": "sum"},
        "color": {
          "field": "status",
          "type": "nominal",
          "scale": {
            "domain": ["Completed", "Due", "Overdue"],
            "range": ["#10b981", "#3b82f6", "#ef4444"]
          }
        }
      },
      "layout": {"x": 0, "y": 2, "w": 12, "h": 4},
      "interactions": {"drilldown": true, "tooltip": ["shop_name", "status", "count", "percentage"]}
    },
    {
      "id": "detail_table",
      "type": "table",
      "title": "PM Detail by Shop",
      "columns": [
        {"field": "shop_name", "label": "Shop"},
        {"field": "pm_due_count", "label": "Due", "format": "integer"},
        {"field": "pm_completed_count", "label": "Completed", "format": "integer"},
        {"field": "pm_overdue_count", "label": "Overdue", "format": "integer"},
        {"field": "compliance_rate", "label": "Compliance %", "format": "percent"}
      ],
      "pagination": {"pageSize": 50},
      "layout": {"x": 0, "y": 6, "w": 12, "h": 6}
    }
  ],
  "drilldowns": [
    {
      "fromVisual": "shop_compliance",
      "hierarchy": [
        {"level": "shop", "field": "shop_name"},
        {"level": "equipment", "field": "equipment_key"},
        {"level": "pm_task", "field": "pm_task_id"}
      ],
      "targetVisual": "detail_table"
    }
  ],
  "exports": [
    {"format": "csv", "dataset": "detail_table"},
    {"format": "xlsx", "dataset": "detail_table"},
    {"format": "pdf", "layout": "page"}
  ],
  "security": {
    "rowLevel": [
      {"role": "ShopManager", "rule": "shop_name IN user.shops"},
      {"role": "Admin", "rule": "TRUE"}
    ]
  }
}
