{
  "id": "billing-09",
  "title": "Billing & Finance Report 9",
  "domain": "billing",
  "description": "Build-ready report definition for Billing & Finance Report 9. Includes filters, visuals, drilldowns, drillthrough, exports, and RLS stubs.",
  "datasource": {
    "type": "sqlView",
    "view": "vw_billing_09",
    "parameters": {
      "date_start": "{{dateRange.start}}",
      "date_end": "{{dateRange.end}}",
      "business_area": "{{businessArea}}"
    }
  },
  "filters": [
    {
      "name": "dateRange",
      "type": "dateRange",
      "default": "last_12_months",
      "required": true
    },
    {
      "name": "businessArea",
      "type": "select",
      "values": [
        "Fleet",
        "StarMetro",
        "All"
      ],
      "default": "All"
    },
    {
      "name": "division",
      "type": "select",
      "values": "dynamic",
      "default": "All"
    },
    {
      "name": "department",
      "type": "select",
      "values": "dynamic",
      "default": "All"
    },
    {
      "name": "shop",
      "type": "select",
      "values": "dynamic",
      "default": "All"
    }
  ],
  "visuals": [
    {
      "id": "kpis",
      "type": "kpiTiles",
      "title": "Summary KPIs",
      "measures": [
        {
          "id": "total_cost",
          "label": "Total Cost",
          "format": "currency",
          "aggregation": "sum",
          "field": "amount"
        },
        {
          "id": "work_order_count",
          "label": "Work Orders",
          "format": "integer",
          "aggregation": "distinctCount",
          "field": "work_order_number"
        },
        {
          "id": "availability_pct",
          "label": "Availability %",
          "format": "percent",
          "expression": "available_vehicle_count/total_vehicle_count"
        }
      ],
      "layout": {
        "x": 0,
        "y": 0,
        "w": 12,
        "h": 2
      }
    },
    {
      "id": "trend",
      "type": "line",
      "title": "Monthly Trend",
      "encoding": {
        "x": {
          "field": "month",
          "type": "temporal"
        },
        "y": {
          "field": "amount",
          "type": "quantitative",
          "aggregate": "sum"
        },
        "color": {
          "field": "category",
          "type": "nominal"
        }
      },
      "layout": {
        "x": 0,
        "y": 2,
        "w": 12,
        "h": 4
      },
      "interactions": {
        "drilldown": true,
        "tooltip": [
          "month",
          "category",
          "amount"
        ]
      }
    },
    {
      "id": "detail",
      "type": "table",
      "title": "Detail",
      "columns": [
        {
          "field": "month",
          "label": "Month"
        },
        {
          "field": "category",
          "label": "Category"
        },
        {
          "field": "department",
          "label": "Department"
        },
        {
          "field": "equipment_key",
          "label": "Equipment"
        },
        {
          "field": "work_order_number",
          "label": "Work Order"
        },
        {
          "field": "amount",
          "label": "Amount",
          "format": "currency"
        }
      ],
      "pagination": {
        "pageSize": 50
      },
      "layout": {
        "x": 0,
        "y": 6,
        "w": 12,
        "h": 6
      }
    }
  ],
  "drilldowns": [
    {
      "fromVisual": "trend",
      "hierarchy": [
        {
          "level": "category",
          "field": "category"
        },
        {
          "level": "department",
          "field": "department"
        },
        {
          "level": "equipment",
          "field": "equipment_key"
        },
        {
          "level": "transaction",
          "field": "transaction_id"
        }
      ],
      "targetVisual": "detail"
    }
  ],
  "drillthrough": [
    {
      "label": "Transaction Detail",
      "targetReport": "billing-01",
      "paramsMap": {
        "transaction_id": "transaction_id"
      }
    }
  ],
  "exports": [
    {
      "format": "csv",
      "dataset": "detail"
    },
    {
      "format": "xlsx",
      "dataset": "detail"
    },
    {
      "format": "pdf",
      "layout": "page"
    }
  ],
  "security": {
    "rowLevel": [
      {
        "role": "DepartmentUser",
        "rule": "department IN user.departments"
      },
      {
        "role": "DivisionUser",
        "rule": "division = user.division"
      },
      {
        "role": "Admin",
        "rule": "TRUE"
      }
    ]
  },
  "validation": {
    "reconciliationChecks": [
      "Sum(detail.amount) equals KPI.total_cost",
      "If businessArea != All then totals match filtered BusinessArea"
    ]
  }
}