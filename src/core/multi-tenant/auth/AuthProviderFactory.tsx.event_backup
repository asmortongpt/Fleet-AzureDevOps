import { useEffect } from "react";
import { useState } from "react";
/**
 * Authentication Provider Factory for DCF Fleet Management
 * Dynamically selects authentication provider based on environment configuration
 * Supports seamless switching between Mock and Production Okta SAML authentication
 */

import React, { ReactNode } from 'react';
import { MockAuthProvider } from './MockAuthProvider.tsx';
import { OktaSAMLProvider } from './OktaSAMLProvider.tsx';
import { getOktaConfiguration } from './okta.config.tsx';

// Environment detection and configuration
const getAuthProviderConfig = () => {
  const isProduction = import.meta.env.VITE_NODE_ENV === 'production';
  const forceOkta = import.meta.env.VITE_REACT_APP_FORCE_OKTA_AUTH === 'true';
  const forceMock = import.meta.env.VITE_REACT_APP_FORCE_MOCK_AUTH === 'true';
  const oktaConfigured = Boolean(
    import.meta.env.VITE_REACT_APP_OKTA_ISSUER && 
    import.meta.env.VITE_REACT_APP_OKTA_CLIENT_ID
  );

  // Decision matrix for authentication provider
  const useOkta = (isProduction || forceOkta) && !forceMock && oktaConfigured;
  
  console.log?.('üîê Authentication Provider Configuration:', {
    isProduction,
    forceOkta,
    forceMock,
    oktaConfigured,
    selectedProvider: useOkta ? 'Okta SAML 2.0' : 'Mock Authentication',
    environment: import.meta.env.VITE_REACT_APP_DEPLOYMENT_ENV || import.meta.env.VITE_NODE_ENV
  });

  return {
    useOkta,
    isProduction,
    oktaConfigured,
    environment: import.meta.env.VITE_REACT_APP_DEPLOYMENT_ENV || import.meta.env.VITE_NODE_ENV
  };
};

// Authentication Provider Factory Props
interface AuthProviderFactoryProps {
  children: ReactNode;
  fallbackToMock?: boolean; // Allow fallback to mock if Okta fails
  onAuthProviderChange?: (provider: 'okta' | 'mock') => void;
}

// Development Authentication Selector Component
const DevAuthSelector: React.FC<{
  currentProvider: 'okta' | 'mock';
  onProviderChange: (provider: 'okta' | 'mock') => void;
}> = ({ currentProvider, onProviderChange }) => {
  if (import.meta.env.VITE_NODE_ENV === 'production') {
    return null; // Don't show in production
  }

  return (
    <div className="fixed top-4 right-4 z-50 bg-yellow-100 border border-yellow-400 rounded-lg p-3 shadow-lg">
      <div className="text-sm font-medium text-yellow-800 mb-2">
        üîß Development Auth Provider
      </div>
      <div className="space-x-2">
        <button
          onClick={() => onProviderChange('mock')}
          className={`px-3 py-1 text-xs rounded ${
            currentProvider === 'mock'
              ? 'bg-yellow-500 text-white'
              : 'bg-white text-yellow-700 hover:bg-yellow-50'
          }`}
        >
          Mock Auth
        </button>
        <button
          onClick={() => onProviderChange('okta')}
          className={`px-3 py-1 text-xs rounded ${
            currentProvider === 'okta'
              ? 'bg-yellow-500 text-white'
              : 'bg-white text-yellow-700 hover:bg-yellow-50'
          }`}
        >
          Okta SAML
        </button>
      </div>
    </div>
  );
};

// Error Boundary for Authentication Providers
class AuthProviderErrorBoundary extends React.Component<
  { children: ReactNode; fallbackProvider: () => ReactNode },
  { hasError: boolean; error: Error | null }
> {
  constructor(props: any) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: any) {
    console.error('‚ùå Authentication Provider Error:', error, errorInfo);
    
    // Log to monitoring service in production
    if (import.meta.env.VITE_NODE_ENV === 'production') {
      // Send error to logging service
      if (typeof window !== "undefined" && window.Sentry) {
        typeof window !== "undefined" && window.Sentry.captureException(error, {
          tags: { component: 'AuthProvider' },
          extra: errorInfo
        });
      }
    }
  }

  render() {
    if (this.state.hasError) {
      console.warn('üîÑ Falling back to alternative authentication provider');
      return this.props.fallbackProvider();
    }

    return this.props.children;
  }
}

// Main Authentication Provider Factory
export const AuthProviderFactory: React.FC<AuthProviderFactoryProps> = ({
  children,
  fallbackToMock = true,
  onAuthProviderChange
}) => {
  const [currentProvider, setCurrentProvider] = React.useState<'okta' | 'mock'>('mock');
  const [authConfig, setAuthConfig] = React.useState(getAuthProviderConfig());

  // Initialize provider selection
  React.useEffect(() => {
    const config = getAuthProviderConfig();
    setAuthConfig(config);
    setCurrentProvider(config.useOkta ? 'okta' : 'mock');
  }, []);

  // Handle provider change (development only)
  const handleProviderChange = (provider: 'okta' | 'mock') => {
    if (import.meta.env.VITE_NODE_ENV === 'production') {
      console.warn('Provider switching disabled in production');
      return;
    }

    console.log?.(`üîÑ Switching authentication provider to: ${provider}`);
    setCurrentProvider(provider);
    onAuthProviderChange?.(provider);

    // Store preference in localStorage for development
    localStorage.setItem('dev_auth_provider', provider);
  };

  // Load saved provider preference in development
  React.useEffect(() => {
    if (import.meta.env.VITE_NODE_ENV === 'development') {
      const savedProvider = localStorage.getItem('dev_auth_provider') as 'okta' | 'mock';
      if (savedProvider && (savedProvider === 'okta' || savedProvider === 'mock')) {
        setCurrentProvider(savedProvider);
      }
    }
  }, []);

  // Render Okta SAML Provider
  const renderOktaProvider = () => (
    <AuthProviderErrorBoundary
      fallbackProvider={() => (
        fallbackToMock ? (
          <>
            <div className="fixed top-4 left-4 z-50 bg-red-100 border border-red-400 rounded-lg p-3 shadow-lg max-w-sm">
              <div className="text-sm font-medium text-red-800 mb-1">
                ‚ö†Ô∏è Okta Authentication Failed
              </div>
              <div className="text-xs text-red-700">
                Falling back to mock authentication for development.
              </div>
            </div>
            <MockAuthProvider>{children}</MockAuthProvider>
          </>
        ) : (
          <div className="min-h-screen flex items-center justify-center bg-gray-50">
            <div className="max-w-md w-full space-y-8">
              <div className="text-center">
                <h2 className="mt-6 text-3xl font-extrabold text-gray-900">
                  Authentication Error
                </h2>
                <p className="mt-2 text-sm text-gray-600">
                  The authentication system is currently unavailable.
                  Please contact your system administrator.
                </p>
              </div>
            </div>
          </div>
        )
      )}
    >
      <OktaSAMLProvider>{children}</OktaSAMLProvider>
    </AuthProviderErrorBoundary>
  );

  // Render Mock Provider
  const renderMockProvider = () => (
    <>
      {import.meta.env.VITE_NODE_ENV === 'development' && (
        <div className="fixed top-4 left-4 z-50 bg-blue-100 border border-blue-400 rounded-lg p-3 shadow-lg max-w-sm">
          <div className="text-sm font-medium text-blue-800 mb-1">
            üß™ Development Mode
          </div>
          <div className="text-xs text-blue-700">
            Using mock authentication. Switch to Okta using the selector.
          </div>
        </div>
      )}
      <MockAuthProvider>{children}</MockAuthProvider>
    </>
  );

  // Render configuration status
  const renderConfigStatus = () => {
    if (import.meta.env.VITE_NODE_ENV === 'production') {
      return null;
    }

    return (
      <div className="fixed bottom-4 left-4 z-50 bg-gray-100 border border-gray-300 rounded-lg p-2 shadow-sm text-xs">
        <div className="font-medium text-gray-800">Auth Config Status:</div>
        <div className="text-gray-600 space-y-1">
          <div>Environment: {authConfig.environment}</div>
          <div>Okta Configured: {authConfig.oktaConfigured ? '‚úÖ' : '‚ùå'}</div>
          <div>Current Provider: {currentProvider}</div>
          <div>Production Mode: {authConfig.isProduction ? '‚úÖ' : '‚ùå'}</div>
        </div>
      </div>
    );
  };

  return (
    <>
      {/* Development Auth Provider Selector */}
      {import.meta.env.VITE_NODE_ENV === 'development' && (
        <DevAuthSelector
          currentProvider={currentProvider}
          onProviderChange={handleProviderChange}
        />
      )}

      {/* Configuration Status Display */}
      {renderConfigStatus()}

      {/* Authentication Provider */}
      {currentProvider === 'okta' ? renderOktaProvider() : renderMockProvider()}
    </>
  );
};

// Hook to get current authentication provider info
export const useAuthProviderInfo = () => {
  const config = getAuthProviderConfig();
  
  return {
    provider: config.useOkta ? 'okta' : 'mock',
    isProduction: config.isProduction,
    oktaConfigured: config.oktaConfigured,
    environment: config.environment,
    canSwitchProvider: import.meta.env.VITE_NODE_ENV === 'development'
  };
};

// Utility function to check if Okta is available
export const checkOktaAvailability = async (): Promise<boolean> => {
  try {
    const oktaConfig = getOktaConfiguration();
    const response = await fetch(`${oktaConfig.config.issuer}/.well-known/openid_configuration`, {
      method: 'GET',
      mode: 'cors',
      timeout: 5000
    });
    
    return response.ok;
  } catch (error) {
    console.warn('Okta availability check failed:', error);
    return false;
  }
};

// Production authentication provider wrapper
export const ProductionAuthProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  // In production, always use the factory with strict settings
  return (
    <AuthProviderFactory fallbackToMock={false}>
      {children}
    </AuthProviderFactory>
  );
};

// Development authentication provider wrapper
export const DevelopmentAuthProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  // In development, allow fallback and provider switching
  return (
    <AuthProviderFactory fallbackToMock={true}>
      {children}
    </AuthProviderFactory>
  );
};

export default AuthProviderFactory;