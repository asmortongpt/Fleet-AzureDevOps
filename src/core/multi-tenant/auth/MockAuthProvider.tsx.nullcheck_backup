/**
 * MockAuthProvider - Simple authentication provider for testing and development
 * DCF ITB 2425-077 Fleet Management System
 */

import React, { createContext, useContext, useEffect, useState } from 'react';
import type { ReactNode } from 'react';

export interface MockUserProfile {
  id: string;
  email: string;
  firstName: string;
  lastName: string;
  department: string;
  role: 'admin' | 'legislature' | 'department' | 'driver';
  permissions: string[];
  mfaEnabled: boolean;
  lastLogin: Date;
  sessionTimeout: number;
}

interface MockAuthContextType {
  user: MockUserProfile | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  login: (username?: string) => Promise<void>;
  logout: () => Promise<void>;
  switchRole: (role: MockUserProfile['role']) => void;
  hasPermission: (permission: string) => boolean;
  hasRole: (role: MockUserProfile['role']) => boolean;
  getAuthHeaders: () => Promise<Record<string, string>>;
}

const MockAuthContext = createContext<MockAuthContextType | undefined>(undefined);

interface MockAuthProviderProps {
  children: ReactNode;
  defaultRole?: MockUserProfile['role'];
  autoLogin?: boolean;
}

// Mock user profiles for different roles
const MOCK_USERS: Record<MockUserProfile['role'], MockUserProfile> = {
  admin: {
    id: 'mock-admin-001',
    email: 'admin@dcf.florida.gov',
    firstName: 'Fleet',
    lastName: 'Administrator',
    department: 'DCF Fleet Operations',
    role: 'admin',
    permissions: ['read', 'write', 'admin', 'fleet:manage', 'drivers:manage', 'maintenance:manage'],
    mfaEnabled: true,
    lastLogin: new Date(),
    sessionTimeout: 3600
  },
  legislature: {
    id: 'mock-legislature-001',
    email: 'legislature@flhouse.gov',
    firstName: 'Legislature',
    lastName: 'Member',
    department: 'Florida House of Representatives',
    role: 'legislature',
    permissions: ['read', 'fleet:view', 'analytics:view'],
    mfaEnabled: true,
    lastLogin: new Date(),
    sessionTimeout: 3600
  },
  department: {
    id: 'mock-department-001',
    email: 'manager@dcf.florida.gov',
    firstName: 'Department',
    lastName: 'Manager',
    department: 'DCF Fleet Operations',
    role: 'department',
    permissions: ['read', 'write', 'fleet:manage', 'drivers:view'],
    mfaEnabled: true,
    lastLogin: new Date(),
    sessionTimeout: 3600
  },
  driver: {
    id: 'mock-driver-001',
    email: 'driver@dcf.florida.gov',
    firstName: 'Fleet',
    lastName: 'Driver',
    department: 'DCF Field Operations',
    role: 'driver',
    permissions: ['read', 'vehicle:checkout', 'maintenance:report'],
    mfaEnabled: false,
    lastLogin: new Date(),
    sessionTimeout: 1800
  }
};

export const MockAuthProvider: React.FC<MockAuthProviderProps> = ({ 
  children, 
  defaultRole = 'admin',
  autoLogin = true 
}) => {
  const [user, setUser] = useState<MockUserProfile | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isAuthenticated, setIsAuthenticated] = useState(false);

  useEffect(() => {
    initializeMockAuth();
  }, []);

  const initializeMockAuth = async () => {
    try {
      setIsLoading(true);
      
      // Check if there's a stored auth state
      const storedState = localStorage.getItem('mock-auth-state');
      if (storedState) {
        const { isAuthenticated: stored, user: storedUser } = JSON.parse(storedState);
        if (stored && storedUser) {
          setUser(storedUser);
          setIsAuthenticated(true);
          setIsLoading(false);
          return;
        }
      }
      
      // Auto-login with default role if enabled
      if (autoLogin) {
        const mockUser = MOCK_USERS[defaultRole];
        setUser(mockUser);
        setIsAuthenticated(true);
        
        // Store auth state
        localStorage.setItem('mock-auth-state', JSON.stringify({
          isAuthenticated: true,
          user: mockUser
        }));
      }
      
    } catch (error) {
      console.error('Mock auth initialization failed:', error);
      setUser(null);
      setIsAuthenticated(false);
    } finally {
      setIsLoading(false);
    }
  };

  const login = async (username?: string): Promise<void> => {
    try {
      setIsLoading(true);
      
      // Simulate network delay
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Determine role from username or use default
      let targetRole: MockUserProfile['role'] = defaultRole;
      if (username) {
        if (username.includes('admin')) targetRole = 'admin';
        else if (username.includes('legislature')) targetRole = 'legislature';
        else if (username.includes('department')) targetRole = 'department';
        else if (username.includes('driver')) targetRole = 'driver';
      }
      
      const mockUser = { ...MOCK_USERS[targetRole] };
      if (username) {
        mockUser.email = username;
      }
      
      setUser(mockUser);
      setIsAuthenticated(true);
      
      // Store auth state
      localStorage.setItem('mock-auth-state', JSON.stringify({
        isAuthenticated: true,
        user: mockUser
      }));
      
    } catch (error) {
      console.error('Mock login failed:', error);
      throw error;
    } finally {
      setIsLoading(false);
    }
  };

  const logout = async (): Promise<void> => {
    try {
      setIsLoading(true);
      
      // Simulate network delay
      await new Promise(resolve => setTimeout(resolve, 300));
      
      setUser(null);
      setIsAuthenticated(false);
      localStorage.removeItem('mock-auth-state');
      
    } catch (error) {
      console.error('Mock logout failed:', error);
      throw error;
    } finally {
      setIsLoading(false);
    }
  };

  const switchRole = (role: MockUserProfile['role']): void => {
    if (!isAuthenticated) return;
    
    const newUser = { ...MOCK_USERS[role] };
    setUser(newUser);
    
    // Update stored auth state
    localStorage.setItem('mock-auth-state', JSON.stringify({
      isAuthenticated: true,
      user: newUser
    }));
  };

  const hasPermission = (permission: string): boolean => {
    return user?.permissions?.includes(permission) || false;
  };

  const hasRole = (role: MockUserProfile['role']): boolean => {
    return user?.role === role;
  };

  const getAuthHeaders = async (): Promise<Record<string, string>> => {
    return {
      'Authorization': `Bearer mock-jwt-token-${user?.id}`,
      'Content-Type': 'application/json',
      'X-User-Role': user?.role || 'unknown'
    };
  };

  const contextValue: MockAuthContextType = {
    user,
    isLoading,
    isAuthenticated,
    login,
    logout,
    switchRole,
    hasPermission,
    hasRole,
    getAuthHeaders
  };

  return (
    <MockAuthContext.Provider value={contextValue}>
      {children}
    </MockAuthContext.Provider>
  );
};

export const useMockAuth = (): MockAuthContextType => {
  const context = useContext(MockAuthContext);
  if (!context) {
    throw new Error('useMockAuth must be used within a MockAuthProvider');
  }
  return context;
};

// Loading component for auth states
export const MockAuthLoading: React.FC = () => (
  <div style={{
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    minHeight: '100vh',
    backgroundColor: '#f8fafc'
  }}>
    <div style={{
      padding: '20px',
      textAlign: 'center',
      background: 'white',
      borderRadius: '8px',
      boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
    }}>
      <div style={{
        width: '40px',
        height: '40px',
        border: '4px solid #e5e7eb',
        borderTop: '4px solid #1e40af',
        borderRadius: '50%',
        animation: 'spin 1s linear infinite',
        margin: '0 auto 16px'
      }}></div>
      <p style={{ color: '#6b7280' }}>Initializing authentication...</p>
    </div>
  </div>
);

// Login prompt for unauthenticated users
export const MockLoginPrompt: React.FC = () => {
  const { login, isLoading } = useMockAuth();
  const [selectedRole, setSelectedRole] = useState<MockUserProfile['role']>('admin');

  const handleLogin = async () => {
    try {
      const roleEmails = {
        admin: 'admin@dcf.florida.gov',
        legislature: 'legislature@flhouse.gov',
        department: 'manager@dcf.florida.gov',
        driver: 'driver@dcf.florida.gov'
      };
      await login(roleEmails[selectedRole]);
    } catch (error) {
      console.error('Login failed:', error);
    }
  };

  return (
    <div style={{
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      minHeight: '100vh',
      backgroundColor: '#f8fafc',
      padding: '20px'
    }}>
      <div style={{
        width: '400px',
        padding: '32px',
        background: 'white',
        borderRadius: '12px',
        boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
      }}>
        <div style={{ textAlign: 'center', marginBottom: '24px' }}>
          <h1 style={{ 
            fontSize: '24px', 
            fontWeight: 'bold', 
            color: '#1e40af',
            marginBottom: '8px'
          }}>
            ðŸš› Fleet Management
          </h1>
          <p style={{ color: '#6b7280' }}>Mock Authentication System</p>
        </div>

        <div style={{ marginBottom: '20px' }}>
          <label style={{ 
            display: 'block', 
            marginBottom: '8px', 
            fontSize: '14px', 
            fontWeight: '500' 
          }}>
            Select Role:
          </label>
          <select
            value={selectedRole}
            onChange={(e) => setSelectedRole(e.target.value as MockUserProfile['role'])}
            style={{
              width: '100%',
              padding: '8px 12px',
              border: '1px solid #d1d5db',
              borderRadius: '6px',
              fontSize: '14px'
            }}
          >
            <option value="admin">Admin - Full Access</option>
            <option value="legislature">Legislature - Read Only</option>
            <option value="department">Department Manager</option>
            <option value="driver">Driver - Limited Access</option>
          </select>
        </div>

        <button
          onClick={handleLogin}
          disabled={isLoading}
          style={{
            width: '100%',
            padding: '12px',
            backgroundColor: isLoading ? '#9ca3af' : '#1e40af',
            color: 'white',
            border: 'none',
            borderRadius: '6px',
            fontSize: '16px',
            fontWeight: '500',
            cursor: isLoading ? 'not-allowed' : 'pointer'
          }}
        >
          {isLoading ? 'Signing in...' : 'Sign In'}
        </button>

        <div style={{
          marginTop: '16px',
          padding: '12px',
          backgroundColor: '#fef3c7',
          borderRadius: '6px',
          fontSize: '12px',
          color: '#92400e'
        }}>
          This is a mock authentication system for development and testing.
        </div>
      </div>
    </div>
  );
};

// Role switching component
export const MockRoleSwitcher: React.FC = () => {
  const { user, switchRole, logout } = useMockAuth();

  if (!user) return null;

  return (
    <div style={{
      position: 'fixed',
      top: '20px',
      right: '20px',
      background: 'white',
      padding: '12px',
      borderRadius: '8px',
      boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
      border: '1px solid #e5e7eb',
      zIndex: 1000
    }}>
      <div style={{ marginBottom: '8px', fontSize: '12px', color: '#6b7280' }}>
        Current: {user.firstName} {user.lastName} ({user.role})
      </div>
      <div style={{ display: 'flex', gap: '8px', marginBottom: '8px' }}>
        {(['admin', 'legislature', 'department', 'driver'] as const).map(role => (
          <button
            key={role}
            onClick={() => switchRole(role)}
            style={{
              padding: '4px 8px',
              fontSize: '12px',
              border: '1px solid #d1d5db',
              borderRadius: '4px',
              background: user.role === role ? '#1e40af' : 'white',
              color: user.role === role ? 'white' : '#374151',
              cursor: 'pointer'
            }}
          >
            {role}
          </button>
        ))}
      </div>
      <button
        onClick={logout}
        style={{
          width: '100%',
          padding: '4px 8px',
          fontSize: '12px',
          border: '1px solid #dc2626',
          borderRadius: '4px',
          background: '#dc2626',
          color: 'white',
          cursor: 'pointer'
        }}
      >
        Logout
      </button>
    </div>
  );
};