apiVersion: v1
kind: ConfigMap
metadata:
  name: fleet-config
  namespace: fleet-management-staging
data:
  # Application Configuration
  NODE_ENV: "staging"
  LOG_LEVEL: "info"
  PORT: "3000"

  # Feature Flags - All enabled for staging testing
  ENABLE_GIS_MAPPING: "true"
  ENABLE_ROUTE_OPTIMIZATION: "true"
  ENABLE_VIDEO_TELEMATICS: "true"
  ENABLE_EV_CHARGING: "true"
  ENABLE_POLICY_ENGINE: "true"
  ENABLE_AI_ASSISTANT: "true"

  # Multi-Tenant Configuration
  MULTI_TENANT_ENABLED: "true"
  TENANT_ISOLATION_MODE: "row-level"

  # Security Configuration (Production-like)
  SESSION_TIMEOUT: "1800"
  MFA_REQUIRED: "false"
  PASSWORD_MIN_LENGTH: "12"
  PASSWORD_ROTATION_DAYS: "90"

  # Database Configuration
  DB_HOST: "fleet-postgres-service"
  DB_PORT: "5432"
  DB_NAME: "fleetdb_staging"
  DB_POOL_SIZE: "20"
  DB_SSL_MODE: "require"

  # Redis Configuration
  REDIS_HOST: "fleet-redis-service"
  REDIS_PORT: "6379"
  REDIS_TTL: "3600"

  # External APIs
  WEATHER_API_URL: "https://api.weather.gov"
  TRAFFIC_API_ENABLED: "true"

  # Performance
  MAX_REQUEST_SIZE: "50mb"
  REQUEST_TIMEOUT: "30000"
  RATE_LIMIT_WINDOW: "900000"
  RATE_LIMIT_MAX: "100"

  # Monitoring
  METRICS_ENABLED: "true"
  METRICS_PORT: "9090"
  HEALTH_CHECK_PATH: "/health"

  # Azure Configuration
  AZURE_REGION: "eastus"
  AZURE_STORAGE_ACCOUNT: "fleetmanagementstorage"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fleet-api-config
  namespace: fleet-management-staging
data:
  DB_HOST: "fleet-postgres-service"
  DB_PORT: "5432"
  DB_NAME: "fleetdb_staging"
  DB_USER: "fleetadmin"
  DB_SSL: "true"
  PORT: "3000"
  NODE_ENV: "staging"
  CORS_ORIGIN: "https://fleet-staging.capitaltechalliance.com"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: module-config
  namespace: fleet-management-staging
data:
  modules.json: |
    {
      "enabledModules": {
        "core": true,
        "gis-mapping": true,
        "advanced-routing": true,
        "telematics": true,
        "video-telematics": true,
        "ev-charging": true,
        "maintenance": true,
        "procurement": true,
        "safety-compliance": true,
        "policy-automation": true,
        "communications": true,
        "financial": true,
        "analytics": true
      },
      "moduleRoutes": {
        "core": ["/", "/dashboard", "/gps-tracking", "/people", "/garage", "/fuel", "/workbench"],
        "gis-mapping": ["/gis-map", "/map-layers", "/geofences"],
        "advanced-routing": ["/route-optimization", "/routes"],
        "telematics": ["/vehicle-telemetry"],
        "video-telematics": ["/video-telematics"],
        "ev-charging": ["/ev-charging"],
        "maintenance": ["/predictive-maintenance", "/maintenance-scheduling"],
        "procurement": ["/vendor-management", "/parts-inventory", "/purchase-orders", "/invoices"],
        "safety-compliance": ["/osha-forms", "/form-builder"],
        "policy-automation": ["/policy-engine"],
        "communications": ["/ai-assistant", "/teams-integration", "/email-center", "/communication-log"],
        "financial": ["/receipt-processing", "/mileage"],
        "analytics": ["/comprehensive", "/driver-mgmt"]
      }
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: fleet-management-staging
data:
  postgresql.conf: |
    # Connection Settings (Production-like)
    max_connections = 200
    shared_buffers = 1GB
    effective_cache_size = 3GB
    maintenance_work_mem = 256MB
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB
    default_statistics_target = 100
    random_page_cost = 1.1
    effective_io_concurrency = 200
    work_mem = 5242kB
    min_wal_size = 1GB
    max_wal_size = 4GB
    max_worker_processes = 4
    max_parallel_workers_per_gather = 2
    max_parallel_workers = 4
    max_parallel_maintenance_workers = 2

    # Logging
    log_destination = 'stderr'
    logging_collector = on
    log_directory = 'log'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_rotation_size = 100MB
    log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    log_timezone = 'UTC'

    # Replication
    wal_level = replica
    max_wal_senders = 3
    max_replication_slots = 3

    # Performance
    shared_preload_libraries = 'pg_stat_statements'
    pg_stat_statements.track = all

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-config
  namespace: fleet-management-staging
data:
  redis.conf: |
    # Network
    bind 0.0.0.0
    port 6379
    tcp-backlog 511
    timeout 0
    tcp-keepalive 300

    # Security
    requirepass ${REDIS_PASSWORD}

    # Memory Management
    maxmemory 768mb
    maxmemory-policy allkeys-lru

    # Persistence
    save 900 1
    save 300 10
    save 60 10000
    stop-writes-on-bgsave-error yes
    rdbcompression yes
    rdbchecksum yes
    dbfilename dump.rdb
    dir /data

    # Append Only File
    appendonly yes
    appendfilename "appendonly.aof"
    appendfsync everysec
    no-appendfsync-on-rewrite no
    auto-aof-rewrite-percentage 100
    auto-aof-rewrite-min-size 64mb

    # Logging
    loglevel notice
    logfile ""

    # Performance
    slowlog-log-slower-than 10000
    slowlog-max-len 128

    # Advanced
    hash-max-ziplist-entries 512
    hash-max-ziplist-value 64
    list-max-ziplist-size -2
    set-max-intset-entries 512
    zset-max-ziplist-entries 128
    zset-max-ziplist-value 64
    hll-sparse-max-bytes 3000

    # Active rehashing
    activerehashing yes

    # Client output buffer limits
    client-output-buffer-limit normal 0 0 0
    client-output-buffer-limit replica 256mb 64mb 60
    client-output-buffer-limit pubsub 32mb 8mb 60

    # Frequency
    hz 10
