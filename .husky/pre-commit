#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit Hook - Agent 5 Test Coverage & QA
# Runs before each commit to ensure code quality

echo "ğŸ” Running pre-commit checks..."

# 1. Run linter on staged files
echo "\nğŸ“ Linting staged files..."
npx lint-staged

# 2. Type check
echo "\nğŸ”· TypeScript type checking..."
npx tsc --noEmit || {
  echo "âŒ TypeScript errors found. Please fix before committing."
  exit 1
}

# 3. Run unit tests for changed files
echo "\nğŸ§ª Running unit tests for changed files..."
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -n "$CHANGED_FILES" ]; then
  # Run tests for changed files
  npm run test:unit -- --run --changed || {
    echo "âŒ Unit tests failed. Please fix before committing."
    exit 1
  }
else
  echo "â­ï¸  No TypeScript files changed, skipping unit tests"
fi

# 4. Security checks
echo "\nğŸ”’ Running security checks..."
npm audit --audit-level=high || {
  echo "âš ï¸  High severity vulnerabilities found. Please review."
  # Don't fail the commit, just warn
}

# 5. Check for secrets
echo "\nğŸ” Scanning for secrets..."
if command -v git-secrets &> /dev/null; then
  git secrets --pre_commit_hook || {
    echo "âŒ Potential secrets detected. Please remove before committing."
    exit 1
  }
else
  echo "â­ï¸  git-secrets not installed, skipping secret scan"
fi

echo "\nâœ… Pre-commit checks passed!"
echo "ğŸ“Š Your changes are ready to commit."
