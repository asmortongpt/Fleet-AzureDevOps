/**
 * Deployment Test Suite
 * Auto-generated by App Test Toolkit
 */

import https from 'https';
import http from 'http';

const DEPLOYMENT_URL = 'https://green-pond-0f040980f.3.azurestaticapps.net';
const TIMEOUT = 10000;

function fetchWithTimeout(url, timeout = TIMEOUT) {
  return new Promise((resolve, reject) => {
    const parsedUrl = new URL(url);
    const client = parsedUrl.protocol === 'https:' ? https : http;

    const timer = setTimeout(() => {
      reject(new Error(`Request timeout after ${timeout}ms`));
    }, timeout);

    client.get(parsedUrl, (res) => {
      clearTimeout(timer);
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        resolve({
          statusCode: res.statusCode,
          headers: res.headers,
          body: data
        });
      });
    }).on('error', (err) => {
      clearTimeout(timer);
      reject(err);
    });
  });
}

async function runTests() {
  console.log('\nðŸ§ª Deployment Test Suite');
  console.log('='.repeat(60));
  console.log(`Testing: ${DEPLOYMENT_URL}\n`);

  const tests = [
    testHomepage,
    testSecurityHeaders,
    testResponseTime,
    testHTTPS
  ];

  let passed = 0;
  let failed = 0;

  for (const test of tests) {
    try {
      await test();
      console.log(`âœ… ${test.name} - PASSED`);
      passed++;
    } catch (error) {
      console.log(`âŒ ${test.name} - FAILED: ${error.message}`);
      failed++;
    }
  }

  console.log('\n' + '='.repeat(60));
  console.log(`Results: ${passed} passed, ${failed} failed`);
  console.log('='.repeat(60) + '\n');

  process.exit(failed > 0 ? 1 : 0);
}

async function testHomepage() {
  const response = await fetchWithTimeout(DEPLOYMENT_URL);

  if (response.statusCode !== 200) {
    throw new Error(`Expected 200, got ${response.statusCode}`);
  }

  if (!response.body.includes('<!DOCTYPE html>') && !response.body.includes('<!doctype html>')) {
    throw new Error('Response does not contain valid HTML');
  }
}

async function testSecurityHeaders() {
  const response = await fetchWithTimeout(DEPLOYMENT_URL);

  if (!response.headers['x-content-type-options']) {
    console.warn('  âš ï¸  Missing X-Content-Type-Options header');
  }
}

async function testResponseTime() {
  const start = Date.now();
  await fetchWithTimeout(DEPLOYMENT_URL);
  const duration = Date.now() - start;

  console.log(`  â±ï¸  Response time: ${duration}ms`);

  if (duration > 5000) {
    throw new Error(`Response time too slow: ${duration}ms`);
  }
}

async function testHTTPS() {
  if (!DEPLOYMENT_URL.startsWith('https://') && !DEPLOYMENT_URL.startsWith('http://localhost')) {
    throw new Error('Deployment URL should use HTTPS');
  }
}

if (DEPLOYMENT_URL === 'YOUR_DEPLOYMENT_URL') {
  console.log('\nâš ï¸  Please update DEPLOYMENT_URL in .app-test.json\n');
  process.exit(1);
}

runTests().catch((error) => {
  console.error('Test suite failed:', error);
  process.exit(1);
});
